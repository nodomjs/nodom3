"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class DefineElementManager{static add(e,t){if(Array.isArray(e))for(let t of e)this.elements.set(t.name.toUpperCase(),t);else this.elements.set((t||e.name).toUpperCase(),e)}static get(e){return this.elements.get(e.toUpperCase())}static has(e){return this.elements.has(e.toUpperCase())}}DefineElementManager.elements=new Map;class DirectiveType{constructor(e,t,s){this.name=e,this.prio=s>=0?s:10,this.handle=t}}class DirectiveManager{static addType(e,t,s){this.directiveTypes.set(e,new DirectiveType(e,t,s))}static removeType(e){this.directiveTypes.delete(e)}static getType(e){return this.directiveTypes.get(e)}static hasType(e){return this.directiveTypes.has(e)}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function e(e,t,s,i){return new(s||(s=Promise))((function(r,n){function o(e){try{l(i.next(e))}catch(e){n(e)}}function a(e){try{l(i.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}l((i=i.apply(e,t||[])).next())}))}DirectiveManager.directiveTypes=new Map;const t={TipWords:{application:"Application",system:"System",module:"Module",moduleClass:"ModuleClass",model:"Model",directive:"Directive",directiveType:"Directive-type",expression:"Expression",event:"Event",method:"Method",filter:"Filter",filterType:"Filter-type",data:"Data",dataItem:"Data-item",route:"Route",routeView:"Route-container",plugin:"Plugin",resource:"Resource",root:"Root",element:"VirtualDom"},ErrorMsgs:{unknown:"unknown error",paramException:"{0} '{1}' parameter error，see api",invoke:"method {0} parameter {1} must be {2}",invoke1:"method {0} parameter {1} must be {2} or {3}",invoke2:"method {0} parameter {1} or {2} must be {3}",invoke3:"method {0} parameter {1} not allowed empty",exist:"{0} is already exist",exist1:"{0} '{1}' is already exist",notexist:"{0} is not exist",notexist1:"{0} '{1}' is not exist",notupd:"{0} not allow to change",notremove:"{0} not allow to delete",notremove1:"{0} {1} not allow to delete",namedinvalid:"{0} {1} name error，see name rules",initial:"{0} init parameter error",jsonparse:"JSON parse error",timeout:"request overtime",config:"{0} config parameter error",config1:"{0} config parameter '{1}' error",itemnotempty:"{0} '{1}' config item '{2}' not allow empty",itemincorrect:"{0} '{1}' config item '{2}' error",wrongTemplate:"wrong template"},WeekDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},s={TipWords:{application:"应用",system:"系统",module:"模块",moduleClass:"模块类",model:"模型",directive:"指令",directiveType:"指令类型",expression:"表达式",event:"事件",method:"方法",filter:"过滤器",filterType:"过滤器类型",data:"数据",dataItem:"数据项",route:"路由",routeView:"路由容器",plugin:"插件",resource:"资源",root:"根",element:"元素"},ErrorMsgs:{unknown:"未知错误",paramException:"{0}'{1}'方法参数错误，请参考api",invoke:"{0} 方法参数 {1} 必须为 {2}",invoke1:"{0} 方法参数 {1} 必须为 {2} 或 {3}",invoke2:"{0} 方法参数 {1} 或 {2} 必须为 {3}",invoke3:"{0} 方法参数 {1} 不能为空",exist:"{0} 已存在",exist1:"{0} '{1}' 已存在",notexist:"{0} 不存在",notexist1:"{0} '{1}' 不存在",notupd:"{0} 不可修改",notremove:"{0} 不可删除",notremove1:"{0} {1} 不可删除",namedinvalid:"{0} {1} 命名错误，请参考用户手册对应命名规范",initial:"{0} 初始化参数错误",jsonparse:"JSON解析错误",timeout:"请求超时",config:"{0} 配置参数错误",config1:"{0} 配置参数 '{1}' 错误",itemnotempty:"{0} '{1}' 配置项 '{2}' 不能为空",itemincorrect:"{0} '{1}' 配置项 '{2}' 错误",compile1:"{0} 标签未闭合",compile2:"结束标签 {0} 未找到与之匹配的开始标签",compile3:"请检查模板标签闭合情况，模板需要有一个闭合的根节点",wrongTemplate:"模版格式错误"},WeekDays:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"]};class ModuleFactory{static add(e){0===this.modules.size&&(this.mainModule=e),this.modules.set(e.id,e),this.addClass(e.constructor)}static get(e){return"number"==typeof e?this.modules.get(e):this.getInstance(e)}static hasClass(e){return this.classes.has(e.toLowerCase())}static addClass(e,t){let s=e.name.toLowerCase();this.classes.has(s)||(this.classes.set(s,e),t&&this.classes.set(t.toLowerCase(),e))}static getInstance(e){let t,s="string"==typeof e?e:e.name.toLowerCase();if(t=this.classes.has(s)||"function"!=typeof e?this.classes.get(s):e,!t)return;let i=Reflect.construct(t,[]);return i.init(),i}static remove(e){this.modules.delete(e)}static setMain(e){this.mainModule=e}static getMain(){return this.mainModule}}ModuleFactory.modules=new Map,ModuleFactory.classes=new Map;class Expression{constructor(e){if(this.id=Util.genId(),this.allModelField=!0,!e)return;const t=this.compile(e);this.execFunc=new Function("$model","return "+t)}compile(e){const t=/('[\s\S]*?')|("[\s\S]*?")|(`[\s\S]*?`)|([a-zA-Z$_][\w$]*\s*?:)|((\.{3}|\.)?[a-zA-Z$_][\w$]*(\.[a-zA-Z$_][\w$]*)*(\s*[\[\(](\s*\))?)?)/g;let s,i="",r=0;for(;null!==(s=t.exec(e));){let o=s[0];if(r<s.index&&(i+=e.substring(r,s.index)),"'"===o[0]||'"'===o[0]||"`"===o[0])i+=o;else{let e=o[o.length-1];if(":"===e)i+=o;else if("("===e||")"===e)i+=n(o);else if(o.startsWith("this.")||"$model"===o||o.startsWith("$model.")||Util.isKeyWord(o)||"."===o[0]&&"."!==o[1])i+=o;else{let e="";o.startsWith("...")&&(e="...",o=o.substring(3)),i+=e+"$model."+o,-1!==o.indexOf(".")&&(this.allModelField=!1)}}r=t.lastIndex}return r<e.length&&(i+=e.substring(r)),i;function n(e){let t=e.indexOf(".");if(-1===t){let t=e.lastIndexOf("("),s=e.substring(0,t);if(!Util.isKeyWord(s)){return")"!==e[e.length-1]?'this.invokeMethod("'+s+'",':'this.invokeMethod("'+s+'")'}}else if("."!==e[0]){let s=e.substring(0,t);if(!Util.isKeyWord(s))return"$model."+e}return e}}val(e,t){let s;try{s=this.execFunc.apply(e,[t])}catch(e){}return this.value=s,s}clone(){return this}}class CssManager{static handleStyleDom(e,t,s,i){if("style"!==t.tagName.toLowerCase())return!1;if(i){let i=this.cssPreName+e.id;s.props.class?s.props.class=t.props.class+" "+i:s.props.class=i}return!0}static handleStyleTextDom(e,t){return!(!t.parent||"style"!==t.parent.tagName.toLowerCase())&&(CssManager.addRules(e,t.textContent,"this"===t.parent.props.scope?"."+this.cssPreName+e.id:void 0),!0)}static addRules(e,t,s){if(!this.sheet){let e=document.createElement("style");document.head.appendChild(e),this.sheet=document.styleSheets[0]}s&&this.clearModuleRules(e);const i=/(@[a-zA-Z]+\s+url\(.+?\))|([.#@a-zA-Z]\S*(\s*\S*\s*?)?{)|\}/g,r=/@[a-zA-Z]+\s+url/;let n,o=-1,a=0;for(;null!==(n=i.exec(t));)if(r.test(n[0]))d(n[0]);else if("}"===n[0]){if(o>=0&&--a<=0){let i=t.substring(o,n.index+1);"@"===i[0]?this.sheet.insertRule(i,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0):l(e,i,s),o=-1,a=0}}else-1===o?(o=n.index,a++):a++;function l(e,t,s){let i=/.+(?=\{)/.exec(t);if(i){if(s){let r=e.objectManager.get("$cssRules");r||(r=[],e.objectManager.set("$cssRules",r)),r.push(s+" "+i[0]),t=s+" "+t}CssManager.sheet.insertRule(t,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0)}}function d(e){let t=e.indexOf("("),s=e.lastIndexOf(")");if(-1===t||-1===s||t>=s)return;let i=e.substring(t,s);CssManager.importMap.has(i)||(CssManager.sheet.insertRule(e,CssManager.importIndex++),CssManager.importMap.set(i,!0))}}static clearModuleRules(e){let t=e.objectManager.get("$cssRules");if(t&&0!==t.length){for(let e=0;e<this.sheet.cssRules.length;e++){let s=this.sheet.cssRules[e];s.selectorText&&-1!==t.indexOf(s.selectorText)&&this.sheet.deleteRule(e--)}e.objectManager.set("$cssRules",[])}}}CssManager.importMap=new Map,CssManager.importIndex=0,CssManager.cssPreName="___nodommodule___";class NEvent{constructor(e,t,s,i){if(this.id=Util.genId(),this.module=e,this.name=t,s){let e=typeof s;if("string"===e){s.trim().split(":").forEach(((e,t)=>{if(e=e.trim(),0===t)this.handler=e;else switch(e){case"delg":this.delg=!0;break;case"nopopo":this.nopopo=!0;break;case"once":this.once=!0;break;case"capture":this.capture=!0}}))}else"function"===e&&(i=s)}if(i&&(this.handler=i),document.ontouchend)switch(this.name){case"click":this.name="tap";break;case"mousedown":this.name="touchstart";break;case"mouseup":this.name="touchend";break;case"mousemove":this.name="touchmove"}else switch(this.name){case"tap":this.name="click";break;case"touchstart":this.name="mousedown";break;case"touchend":this.name="mouseup";break;case"touchmove":this.name="mousemove"}}setParam(e,t,s,i){e.objectManager.setEventParam(this.id,t.key,s,i)}getParam(e,t,s){return e.objectManager.getEventParam(this.id,t.key,s)}removeParam(e,t,s){return e.objectManager.removeEventParam(this.id,t.key,s)}clearParam(e,t){e.objectManager.clearEventParam(this.id,t.key)}}class EventManager{static bind(e,t){const s=e.eventFactory.getEvent(t.key);if(!s)return;const i=t.parent;for(let n of s)if("bindMap"!==n[0]){if(n[1].toDelg)for(let s=0;s<n[1].toDelg.length;s++){let o=n[1].toDelg[s];e.eventFactory.addEvent(i.key,o,t.key),e.eventFactory.bind(i.key,n[0],r,o.capture)}n[1].own&&e.eventFactory.bind(t.key,n[0],r,n[1].capture)}function r(t){let s=t.currentTarget;const i=s.$vdom,r=e.eventFactory.getEvent(i.key);if(!i||!r||!r.has(t.type))return;const n=r.get(t.type);function o(s){if(!s)return;let r=!1;for(let n=0;n<s.length;n++){const o=s[n];"string"==typeof o.handler?e.invokeMethod(o.handler,i.model,i,o,t):"function"==typeof o.handler&&o.handler.apply(e,[i.model,i,o,t]),o.once&&s.splice(n--,1),r=o.nopopo}r&&t.stopPropagation()}function a(r){if(!r)return!1;let n=!1;for(let o=0;o<r.length;o++){const a=r[o],l=a.event;for(let d=0;d<t.path.length&&t.path[d]!==s;d++)if(t.path[d].$vdom&&t.path[d].$vdom.key===a.key){const s=t.path[d].$vdom;"string"==typeof l.handler?e.invokeMethod(l.handler,i.model,i,l,t):"function"==typeof l.handler&&l.handler.apply(e,[i.model,i,l,t]),n=l.nopopo,l.once&&(r.splice(o--,1),e.eventFactory.removeEvent(s.key,l,null,!0));break}}return n}n.capture?(o(n.own),a(n.delg)):a(n.delg)||o(n.own),n.own&&0===n.own.length&&delete n.own,n.delg&&0===n.delg.length&&delete n.delg}}static handleExtendEvent(e,t,s){let i=this.get(s.name);if(!i)return!1;for(let r of Object.keys(i)){let n=new NEvent(e,r,i[r]);n.capture=s.capture,n.nopopo=s.nopopo,n.delg=s.delg,n.once=s.once,n.dependEvent=s,e.eventFactory.addEvent(t.key,n)}return!0}static regist(e,t){this.extendEventMap.set(e,t)}static unregist(e){return this.extendEventMap.delete(e)}static get(e){return this.extendEventMap.get(e)}}EventManager.extendEventMap=new Map;class Renderer{static add(e){this.waitList.includes(e.id)||this.waitList.push(e.id)}static remove(e){let t;-1!==(t=this.waitList.indexOf(e))&&this.waitList.splice(t,1,null)}static render(){for(;this.waitList.length>0;){let e=this.waitList[0];e&&ModuleFactory.get(e).render(),this.waitList.shift()}}static renderDom(e,t,s,i,r){let n={key:r?t.key+"_"+r:t.key,vdom:t};if(t.tagName?(n.tagName=t.tagName,n.props={}):n.textContent=t.textContent,s=t.model||s,i?(s||(s=i.model),n.parent=i):this.currentModuleRoot=n,s||(s=e.model),n.model=s,n.staticNum=t.staticNum,t.staticNum>0&&t.staticNum--,t.directives&&t.directives.length>0&&"model"===t.directives[0].type.name&&t.directives[0].exec(e,n),n.tagName){if(!n.notChange){if(function(){if(!t.props||0===t.props.size)return;const s=/^style$/i,i=/^class$/i;let r;for(let o of t.props){if(Array.isArray(o[1])){r=[];for(let t=0;t<o[1].length;t++){let s=o[1][t];s instanceof Expression?(r.push(s.val(e,n.model)),n.staticNum=-1):r.push(s)}s.test(o[0])?r=t.getStyleString(r):i.test(o[0])&&(r=t.getClassString(r))}else o[1]instanceof Expression?(r=o[1].val(e,n.model),n.staticNum=-1):r=o[1];n.props[o[0]]=r}}(),!CssManager.handleStyleDom(e,t,Renderer.currentModuleRoot,"this"===t.getProp("scope"))&&t.assets&&t.assets.size>0)for(let e of t.assets)n[e[0]]=e[1];if(!function(){if(!t.directives||0===t.directives.length)return!0;n.staticNum=-1;for(let s of t.directives)if("model"!==s.type.name&&!s.exec(e,n))return!1;return!0}())return null}if(t.events&&!e.eventFactory.getEvent(n.key))for(let s of t.events)e.eventFactory.addEvent(n.key,s);if(t.children&&t.children.length>0){n.children=[];for(let s of t.children)Renderer.renderDom(e,s,n.model,n,r||null)}}else if(!n.notChange)if(t.expressions){let s="";t.expressions.forEach((t=>{if(t instanceof Expression){let i=t.val(e,n.model);s+=void 0!==i?i:""}else s+=t})),n.textContent=s,n.staticNum=-1}else n.textContent=t.textContent;return i&&i.children.push(n),n}static updateToHtml(e,t){let s=e.getElement(t.key);if(!s)return this.renderToHtml(e,t,null);if(t.tagName){s.$vdom=t,e.saveElement(t.key,s);let i=s.attributes,r=[];for(let e=0;e<i.length;e++)r.push(i[e].name);for(let e of Object.keys(t.props)){let i;s.setAttribute(e,void 0===t.props[e]?"":t.props[e]),-1!==(i=r.indexOf(e))&&r.splice(i,1)}if(r.length>0)for(let e of r)s.removeAttribute(e);if(t.assets)for(let e of Object.keys(t.assets))s[e]=t.assets[e]}else s.textContent=t.textContent;return s}static renderToHtml(e,t,s,i){let r;return r=t.tagName?n(t):o(t),r&&t.tagName&&i&&function e(t,s){s.children&&s.children.length>0&&s.children.forEach((s=>{let i;s.tagName?(i=n(s),e(i,s)):i=o(s),i&&t.appendChild(i)}))}(r,t),r&&s&&s.appendChild(r),r;function n(t){if("style"===t.tagName.toLowerCase())return;let s=document.createElement(t.tagName);if(s.$vdom=t,e.saveElement(t.key,s),t.props.key&&e.saveElement(t.props.key,s),!t.subModuleId){for(let e of Object.keys(t.props))s.setAttribute(e,void 0===t.props[e]?"":t.props[e]);if(t.assets)for(let e of Object.keys(t.assets))s[e]=t.assets[e];EventManager.bind(e,t)}return s}function o(t){if(CssManager.handleStyleTextDom(e,t))return;let s=document.createTextNode(t.textContent||"");return e.saveElement(t.key,s),s}}static handleChangedDoms(e,t){for(let s of t){let t={};s[1]&&(t.new=e.getElement(s[1].key)),s[2]&&(t.old=e.getElement(s[2].key)),s[3]&&(t.p=e.getElement(s[3].key)),s.els=t,3===s[0]?e.freeNode(s[1]):5===s[0]&&e.freeNode(s[2])}const s=[];for(let i of t){let t,r,n;switch(i[0]){case 1:t=i.els.p,r=Renderer.renderToHtml(e,i[1],null,!0),t.children&&t.children.length-1>i[4]?t.insertBefore(r,t.children[i[4]]):t.appendChild(r);break;case 2:Renderer.updateToHtml(e,i[1]);break;case 3:t=i.els.p,r=i.els.new,t&&r&&r.parentElement===t&&t.removeChild(r);break;case 4:t=i.els.p,r=e.getElement(i[1].key),r&&r!==t.children[i[4]]&&(t.children.length>i[4]?t.insertBefore(r,t.children[i[4]]):t.children.length===i[4]?t.appendChild(r):s.push(i));break;case 5:t=i.els.p,n=i.els.old,r=Renderer.renderToHtml(e,i[1],null,!0),t&&n&&t.replaceChild(r,n)}}for(let t=0;t<s.length;t++){const i=s[t],r=e.getElement(i[3].key),n=e.getElement(i[1].key);n&&n!==r.children[i[4]]&&(r.children.length>i[4]?r.insertBefore(n,r.children[i[4]]):r.appendChild(n))}}}Renderer.waitList=[];class ModelManager{static getMap(){return this.modelMap}static getModel(e,t){if(this.dataMap.has(e)){const t=this.dataMap.get(e);if(this.tempMap.has(e)){const s=this.getModuleIds(t),i=this.tempMap.get(e);this.tempMap.delete(e);for(let e of i)-1===s.indexOf(e)&&s.push(e)}return t}}static getModelKey(e){if(this.modelMap.has(e))return this.modelMap.get(e).key}static add(e,t,s){this.dataMap.set(e,t);let i=[];s&&(i=this.getModuleIds(s).slice(0)),this.modelMap.set(t,{key:Util.genId(),modules:i})}static bindToModule(e,t,s){this.modelMap.has(e)||this.modelMap.set(e,{key:Util.genId()});let i=this.modelMap.get(e);i.modules?-1===i.modules.indexOf(t.id)&&i.modules.push(t.id):i.modules=[t.id],s&&function e(s,i){for(let r of Object.keys(s))if(s[r]&&"object"==typeof s[r]){let n=s[r].___source;i.has(n)?i.get(n).push(t.id):i.set(n,[t.id]),e(s[r],i)}}(e,this.tempMap)}static getModuleIds(e){if(this.modelMap.has(e))return this.modelMap.get(e).modules}static update(e,t,s,i){const r=this.getModuleIds(e);if(!r)return;for(let e of r){const t=ModuleFactory.get(e);t&&Renderer.add(t)}let n=this.modelMap.get(e).watchers;if(!n)return;if(!n.has(t))return;let o=n.get(t);for(let r of o)for(let n of r[1]){const o=ModuleFactory.get(n);o&&r[0].call(o,e,t,s,i)}}static watch(e,t,s,i,r){let n=i?[i.id]:ModelManager.getModuleIds(e),o=[];if(Array.isArray(t))for(let i of t)a(e,i,s);else a(e,t,s);return()=>{if(o)for(let e of o){let t=ModelManager.modelMap.get(e.m).watchers;t&&t.has(e.k)&&(e.operate?t.get(e.k).has(e.operate)&&t.get(e.k).delete(e.operate):t.delete(e.k))}o=null};function a(e,t,s){let i=-1;if(-1!==(i=t.lastIndexOf("."))&&(e=ModelManager.get(e,t.substring(0,i)),t=t.substring(i+1)),!e)return;const l=ModelManager.modelMap.get(e);l.watchers||(l.watchers=new Map);let d=l.watchers;if(d.has(t)||d.set(t,new Map),d.get(t).set(s,n),o.push({m:e,k:t,f:s}),r&&e[t]&&"object"==typeof e[t])for(let i of Object.keys(e[t]))"function"!=typeof e[t][i]&&a(e[t],i,s)}}static get(e,t){if(t){if(-1!==t.indexOf(".")){let s=t.split(".");for(let t=0;t<s.length-1&&(e=e[s[t]]);t++);if(!e)return;t=s[s.length-1]}e=e[t]}return e}static set(e,t,s){if(-1!==t.indexOf(".")){let s=t.split(".");for(let t=0;t<s.length-1;t++)e[s[t]]||(e[s[t]]={}),e=e[s[t]];t=s[s.length-1]}e[t]=s}static isModel(e){return null!=e&&void 0!==e.___source}}ModelManager.dataMap=new WeakMap,ModelManager.modelMap=new Map,ModelManager.tempMap=new WeakMap;class Route{constructor(e,t){if(this.params=[],this.data={},this.children=[],e&&!Util.isEmpty(e.path)){this.id=Util.genId();for(let t of Object.keys(e))this[t]=e[t];this.parent=t,this.path&&this.parse(),t&&t.addChild(this),e.routes&&Array.isArray(e.routes)&&e.routes.forEach((e=>{new Route(e,this)}))}}addChild(e){this.children.push(e),e.parent=this}parse(){let e=this.path.split("/"),t=this.parent,s=[],i=-1,r="";for(let n=0;n<e.length;n++){let o=e[n].trim();if(""!==o){if(o.startsWith(":"))0===s.length&&(i=n),s.push(o.substring(1));else{i=-1,s=[],this.path=o;let e=0;for(;e<t.children.length;e++){let s=t.children[e];if(s.path===o){t=s;break}}e===t.children.length&&(""!==r&&(new Route({path:r},t),t=t.children[t.children.length-1]),r=o)}this.params=-1===i?[]:s}else e.splice(n--,1)}}clone(){let e=new Route;return Object.getOwnPropertyNames(this).forEach((t=>{"data"!==t&&(e[t]=this[t])})),this.data&&(e.data=Util.clone(this.data)),e}}var i;exports.EModuleState=void 0,(i=exports.EModuleState||(exports.EModuleState={}))[i.READY=1]="READY",i[i.UNMOUNTED=3]="UNMOUNTED",i[i.MOUNTED=4]="MOUNTED";class Router{static go(e){e!==this.currentPath&&(-1===this.waitList.indexOf(e)&&this.waitList.push(e),setTimeout((()=>{this.load()}),0))}static load(){if(0===this.waitList.length)return;let e=this.waitList.shift();this.start(e).then((()=>{this.load()}))}static start(t){return e(this,void 0,void 0,(function*(){let e,s=this.compare(this.currentPath,t);e=null===s[0]?ModuleFactory.getMain():yield this.getModule(s[0]);for(let e=s[1].length-1;e>=0;e--){const t=s[1][e];if(!t.module)continue;let i=yield this.getModule(t);Util.isFunction(this.onDefaultLeave)&&this.onDefaultLeave(i.model),Util.isFunction(t.onLeave)&&t.onLeave(i.model),this.activeFieldMap.delete(i.id),i.unmount()}if(0===s[2].length){let e=s[0];if(null!==e){let t=yield this.getModule(e);this.dependHandle(t,e,s[3]?s[3].module:null)}}else for(let t=0;t<s[2].length;t++){let i=s[2][t];if(!i||!i.module)continue;let r=yield this.getModule(i);this.dependHandle(r,i,e),Util.isFunction(this.onDefaultEnter)&&this.onDefaultEnter(r.model),Util.isFunction(i.onEnter)&&i.onEnter(r.model),e=r}if(0===this.startStyle){let e=(Router.basePath||"")+t;t.startsWith(this.currentPath)?history.replaceState(e,"",e):history.pushState(e,"",e)}this.currentPath=t,this.startStyle=0}))}static redirect(e){this.go(e)}static getModule(t){return e(this,void 0,void 0,(function*(){let e=t.module;if("object"==typeof e)return e;if(!e.__proto__.name){const t=yield e();for(let s of Object.keys(t))if(t[s].name){e=t[s];break}}return"function"==typeof e&&(e=ModuleFactory.get(e)),t.module=e,e}))}static compare(e,t){let s=null,i=null;e&&(s=this.getRouteList(e,!0)),t&&(i=this.getRouteList(t));let r=0;null!==s&&(r=s.length),null!==i?i.length<r&&(r=i.length):r=0;let n=[],o=[],a=0;for(a=0;a<r&&s[a].id===i[a].id;a++)if(JSON.stringify(s[a].data)!==JSON.stringify(i[a].data)){a++;break}null!==s&&(n=s.slice(a)),null!==i&&(o=i.slice(a));let l=null,d=null;if(i&&a>0)for(let e=a-1;e>=0;e--)if(l){if(!d&&i[e].module){d=i[e];break}}else if(i[e].module){l=i[e];continue}return[l,n,o,d]}static addActiveField(e,t,s,i){if(!s||!i)return;let r=Router.activeFieldMap.get(e.id);r?void 0===r.find((e=>e.model===s&&e.field===i))&&r.push({path:t,model:s,field:i}):Router.activeFieldMap.set(e.id,[{path:t,model:s,field:i}])}static dependHandle(e,t,s){const i=this;let r={path:t.path};if(Util.isEmpty(t.data)||(r.data=t.data),e.model.$route=r,s)if(s.state===exports.EModuleState.MOUNTED)e.setContainer(s.getElement(Router.routerKeyMap.get(s.id))),e.active(),this.setDomActive(s,t.fullPath);else if(s.onMount){const r=s.onMount;s.onMount=n=>{r(n),e.setContainer(s.getElement(Router.routerKeyMap.get(s.id))),e.active(),i.setDomActive(s,t.fullPath),s.onMount=r}}else s.onMount=r=>{e.setContainer(s.getElement(Router.routerKeyMap.get(s.id))),e.active(),i.setDomActive(s,t.fullPath),delete s.onMount}}static setDomActive(e,t){let s=Router.activeFieldMap.get(e.id);if(s)for(let e of s)e.model[e.field]=e.path===t}static getRouteList(e,t){if(!this.root)return[];let s=e.split("/"),i=this.root,r=0,n=[],o="",a=this.root;for(let e=0;e<s.length;e++){let l=s[e].trim();if(""===l)continue;let d=!1;for(let e=0;e<i.children.length;e++)if(i.children[e].path===l){a!==this.root&&(a.fullPath=o,a.data=i.data,n.push(a)),i=t?i.children[e].clone():i.children[e],i.data={},a=i,d=!0,r=0;break}o+="/"+l,d||r<i.params.length&&(i.data[i.params[r++]]=l)}return i!==this.root&&(i.fullPath=o,n.push(i)),n}}Router.waitList=[],Router.startStyle=0,Router.activeFieldMap=new Map,Router.routerKeyMap=new Map,Router.root=new Route,window.addEventListener("popstate",(function(e){const t=history.state;t&&(Router.startStyle=1,Router.go(t))}));class Scheduler{static dispatch(){Scheduler.tasks.forEach((e=>{Util.isFunction(e.func)&&(e.thiser?e.func.call(e.thiser):e.func())}))}static start(e){Scheduler.dispatch(),window.requestAnimationFrame?window.requestAnimationFrame(Scheduler.start):window.setTimeout(Scheduler.start,e||50)}static addTask(e,t){if(!Util.isFunction(e))throw new NError("invoke","Scheduler.addTask","0","function");Scheduler.tasks.push({func:e,thiser:t})}static removeTask(e){if(!Util.isFunction(e))throw new NError("invoke","Scheduler.removeTask","0","function");let t=-1;-1!==(t=Scheduler.tasks.indexOf(e))&&Scheduler.tasks.splice(t,1)}}function r(e,t,s){return DirectiveManager.addType(e,t,s)}Scheduler.tasks=[],exports.NodomMessage=void 0;class NError extends Error{constructor(e,t,s,i,r){super(e);let n=exports.NodomMessage.ErrorMsgs[e];if(void 0===n)return void(this.message="未知错误");let o=[n];for(let e=1;e<arguments.length;e++)o.push(arguments[e]);this.message=this.compile.apply(null,o)}compile(e,t,s,i,r,n){let o,a=arguments,l=0;for(;-1!==e.indexOf("{"+l+"}");)o=new RegExp("\\{"+l+"\\}","g"),e=e.replace(o,a[l+1]),l++;return e}}class Util{static genId(){return this.generatedId++}static initKeyMap(){this.keyWordMap.set("arguments",!0),this.keyWordMap.set("boolean",!0),this.keyWordMap.set("break",!0),this.keyWordMap.set("byte",!0),this.keyWordMap.set("catch",!0),this.keyWordMap.set("char",!0),this.keyWordMap.set("const",!0),this.keyWordMap.set("default",!0),this.keyWordMap.set("delete",!0),this.keyWordMap.set("do",!0),this.keyWordMap.set("double",!0),this.keyWordMap.set("else",!0),this.keyWordMap.set("enum",!0),this.keyWordMap.set("eval",!0),this.keyWordMap.set("false",!0),this.keyWordMap.set("float",!0),this.keyWordMap.set("for",!0),this.keyWordMap.set("function",!0),this.keyWordMap.set("goto",!0),this.keyWordMap.set("if",!0),this.keyWordMap.set("in",!0),this.keyWordMap.set("instanceof",!0),this.keyWordMap.set("int",!0),this.keyWordMap.set("let",!0),this.keyWordMap.set("long",!0),this.keyWordMap.set("new",!0),this.keyWordMap.set("null",!0),this.keyWordMap.set("return",!0),this.keyWordMap.set("short",!0),this.keyWordMap.set("switch",!0),this.keyWordMap.set("this",!0),this.keyWordMap.set("throw",!0),this.keyWordMap.set("true",!0),this.keyWordMap.set("try",!0),this.keyWordMap.set("this",!0),this.keyWordMap.set("throw",!0),this.keyWordMap.set("typeof",!0),this.keyWordMap.set("var",!0),this.keyWordMap.set("while",!0),this.keyWordMap.set("with",!0),this.keyWordMap.set("Array",!0),this.keyWordMap.set("Date",!0),this.keyWordMap.set("JSON",!0),this.keyWordMap.set("Set",!0),this.keyWordMap.set("Map",!0),this.keyWordMap.set("eval",!0),this.keyWordMap.set("function",!0),this.keyWordMap.set("Infinity",!0),this.keyWordMap.set("isFinite",!0),this.keyWordMap.set("isNaN",!0),this.keyWordMap.set("isPrototypeOf",!0),this.keyWordMap.set("Math",!0),this.keyWordMap.set("NaN",!0),this.keyWordMap.set("Number",!0),this.keyWordMap.set("Object",!0),this.keyWordMap.set("prototype",!0),this.keyWordMap.set("String",!0),this.keyWordMap.set("isPrototypeOf",!0),this.keyWordMap.set("undefined",!0),this.keyWordMap.set("valueOf",!0)}static isKeyWord(e){return this.keyWordMap.has(e)}static clone(e,t,s){let i=this,r=new WeakMap;return n(e,t,s);function n(e,t,s){if(!e||"object"!=typeof e||Util.isFunction(e))return e;let n;return e.clone&&Util.isFunction(e.clone)?e.clone(s):(i.isObject(e)?(n=new Object,r.set(e,n),Object.getOwnPropertyNames(e).forEach((i=>{t&&(t.constructor===RegExp&&t.test(i)||Util.isArray(t)&&t.includes(i))||(n[i]=o(e[i],t,s))}))):i.isMap(e)?(n=new Map,e.forEach(((e,i)=>{t&&(t.constructor===RegExp&&t.test(i)||t.includes(i))||n.set(i,o(e,t,s))}))):i.isArray(e)&&(n=new Array,e.forEach((function(e,i){n[i]=o(e,t,s)}))),n)}function o(e,t,s){if("object"==typeof e&&!Util.isFunction(e)){let i=null;return i=r.has(e)?r.get(e):n(e,t,s),i}return e}}static merge(e,t,s,i,r,n){let o=this;for(let e=0;e<arguments.length;e++)if(!this.isObject(arguments[e]))throw new NError("invoke","Util.merge",e+"","object");let a=Object.assign.apply(null,arguments);return function(e){for(let t of Object.keys(e))(o.isObject(e[t])||o.isArray(e[t]))&&(a[t]=o.clone(a[t]))}(a),a}static assign(e,t){return Object.assign?Object.assign(e,t):this.getOwnProps(t).forEach((function(s){e[s]=t[s]})),e}static compare(e,t,s){if(!e&&!t)return!0;if("object"!=typeof e||"object"!=typeof t)return!1;const i=Object.getOwnPropertyNames(e);if(i.length!==Object.getOwnPropertyNames(t).length)return!1;for(let s of i)if(e[s]!==t[s])return!1;if(s)for(let s of i){if(!this.compare(e[s],t[s]))return!1}return!0}static getOwnProps(e){return e?Object.getOwnPropertyNames(e):[]}static isFunction(e){return null!=e&&e.constructor===Function}static isArray(e){return Array.isArray(e)}static isMap(e){return null!=e&&e.constructor===Map}static isObject(e){return null!=e&&e.constructor===Object}static isInt(e){return Number.isInteger(e)}static isNumber(e){return"number"==typeof e}static isBoolean(e){return"boolean"==typeof e}static isString(e){return"string"==typeof e}static isNumberString(e){return/^\d+\.?\d*$/.test(e)}static isEmpty(e){if(null==e)return!0;let t=typeof e;if(this.isObject(e)){let t=Object.keys(e);if(void 0!==t)return 0===t.length}else if("string"===t)return""===e;return!1}static replaceNode(e,t){let s=e.parentNode,i=e.nextSibling;if(null===s)return;s.removeChild(e);(this.isArray(t)?t:[t]).forEach((function(e){null==i?s.appendChild(e):s.insertBefore(e,i)}))}static empty(e){let t=e.childNodes;for(let s=t.length-1;s>=0;s--)e.removeChild(t[s])}static formatDate(e,t){if(this.isString(e)){if(!/^\d+$/.test(e))throw new NError("invoke","Util.formatDate","0","date string","date");e=Number(e)}let s=new Date(e);if(isNaN(s.getDay()))throw new NError("invoke","Util.formatDate","0","date string","date");let i,r={"M+":s.getMonth()+1,"d+":s.getDate(),"h+":s.getHours(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),S:s.getMilliseconds()};return(i=/(y+)/.exec(t))&&(t=t.replace(i[0],(s.getFullYear()+"").substring(4-i[0].length))),this.getOwnProps(r).forEach((function(e){(i=new RegExp("("+e+")").exec(t))&&(t=t.replace(i[0],1===i[0].length?r[e]:("00"+r[e]).substring((r[e]+"").length)))})),t=t.replace(/(E+)/,exports.NodomMessage.WeekDays[s.getDay()+""])}static compileStr(e,t,s,i,r,n){let o,a=arguments,l=0;for(;-1!==e.indexOf("{"+l+"}");)o=new RegExp("\\{"+l+"\\}","g"),e=e.replace(o,a[l+1]),l++;return e}static apply(e,t,s){if(e)return Reflect.apply(e,t||null,s)}static mergePath(e){return e.join("/").replace(/(\/{2,})|\\\//g,"/")}static eval(e){return new Function(`return(${e})`)()}static setNodeKey(e,t,s){if(e.key+="_"+(t||Util.genId()),s&&e.children)for(let i of e.children)Util.setNodeKey(i,t,s)}static setDomAsset(e,t,s){e.assets||(e.assets={}),e.assets[t]=s}static delDomAsset(e,t){e.assets&&delete e.assets[t]}}Util.generatedId=1,Util.keyWordMap=new Map,Util.initKeyMap();class Directive{constructor(e,t){if(this.id=Util.genId(),e&&(this.type=DirectiveManager.getType(e),!this.type))throw new NError("notexist1",exports.NodomMessage.TipWords.directive,e);Util.isString(t)?this.value=t.trim():t instanceof Expression?this.expression=t:this.value=t}exec(e,t){return!!this.disabled||(this.expression&&(this.value=this.expression.val(e,t.model)),this.type.handle.apply(this,[e,t]))}clone(){let e=new Directive;return e.type=this.type,e.expression=this.expression,e.value=this.value,e}}class VirtualDom{constructor(e,t,s){this.staticNum=0,this.allModelField=!0,this.key=t||(s?s.getDomKeyId():Util.genId())+"",e&&(this.tagName=e)}removeDirectives(e){this.directives&&e.forEach((e=>{this.removeDirective(e)}))}removeDirective(e){if(!this.directives)return;let t;-1!==(t=this.directives.findIndex((t=>t.type.name===e)))&&this.directives.splice(t,1),0===this.directives.length&&delete this.directives}addDirective(e,t){if(this.directives){if(this.directives.find((t=>t.type.name===e.type.name)))return}else this.directives=[];this.directives.push(e),t&&this.sortDirective()}sortDirective(){this.directives&&this.directives.length>1&&this.directives.sort(((e,t)=>DirectiveManager.getType(e.type.name).prio<DirectiveManager.getType(t.type.name).prio?-1:1))}hasDirective(e){return this.directives&&-1!==this.directives.findIndex((t=>t.type.name===e))}getDirective(e){if(this.directives)return this.directives.find((t=>t.type.name===e))}add(e,t){this.children||(this.children=[]),t?this.children.splice(t,0,e):this.children.push(e),e.parent=this}remove(e){let t=this.children.indexOf(e);-1!==t&&this.children.splice(t,1)}addClass(e){if(this.addProp("class",e),this.removedClassMap&&this.removedClassMap.size>0){let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.delete(e)}}removeClass(e){if(!this.getProp("class"))return;this.removedClassMap||(this.removedClassMap=new Map);let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.set(e,!0);this.setStaticOnce()}getClassString(e){let t=[];for(let s of e){let e=s.trim().split(/\s+/);for(let s of e)this.removedClassMap&&this.removedClassMap.has(s)||t.includes(s)||t.push(s)}if(t.length>0)return t.join(" ")}addStyle(e){if(this.addProp("style",e),"string"==typeof e&&this.removedStyleMap&&this.removedStyleMap.size>0){let t=e.trim().split(/\s*;\s*/);for(let e of t){if(""===e)continue;let t=e.split(/\s*:\s*/);""!==t[0].trim()&&this.removedClassMap.delete(t[0].trim())}}}removeStyle(e){this.removedClassMap||(this.removedClassMap=new Map);let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.set(e,!0);this.setStaticOnce()}getStyleString(e){let t=new Map;for(let s of e){let e=s.trim().split(/\s*;\s*/);for(let s of e){if(""===s)continue;let e=s.split(/\s*:\s*/);this.removedStyleMap&&this.removedStyleMap.has(e[0])||t.set(e[0],e[1])}}if(t.size>0)return[...t].map((e=>e.join(":"))).join(";")}hasProp(e){if(this.props)return this.props.has(e)}getProp(e,t){if(this.props)return this.props.get(e)}setProp(e,t){this.props||(this.props=new Map),"style"===e?this.removedStyleMap&&this.removedStyleMap.clear():"class"===e&&this.removedClassMap&&this.removedClassMap.clear(),this.props.set(e,t)}addProp(e,t){let s=this.getProp(e);if(s)if(Array.isArray(s)){if(s.includes(t))return!1;s.push(t)}else{if(s===t)return!1;this.setProp(e,[s,t])}else this.setProp(e,t);return this.setStaticOnce(),!0}delProp(e){if(this.props){if(Util.isArray(e))for(let t of e)this.props.delete(t);else this.props.delete(e);this.setStaticOnce()}}setAsset(e,t){this.assets||(this.assets=new Map),this.assets.set(e,t)}delAsset(e){this.assets&&this.assets.delete(e)}getEl(e){return e.getElement(this.key)}query(e){if(this.key===e)return this;if(this.children)for(let t=0;t<this.children.length;t++){let s=this.children[t].query(e);if(s)return s}}setParam(e,t,s){e.objectManager.setDomParam(this.key,t,s)}getParam(e,t){return e.objectManager.getDomParam(this.key,t)}removeParam(e,t){e.objectManager.removeDomParam(this.key,t)}setStaticOnce(){-1!==this.staticNum&&(this.staticNum=1)}clone(){let e=new VirtualDom(this.tagName,this.key);if(this.tagName){if(this.props&&this.props.size>0)for(let t of this.props)e.setProp(t[0],t[1]);if(this.assets&&this.assets.size>0)for(let t of this.assets)e.setAsset(t[0],t[1]);if(this.directives&&this.directives.length>0){e.directives=[];for(let t of this.directives)e.directives.push(t.clone())}if(e.events=this.events,this.children)for(let t of this.children)e.add(t.clone())}else e.expressions=this.expressions,e.textContent=this.textContent;return e.staticNum=this.staticNum,e}addEvent(e){this.events||(this.events=[]),this.events.push(e)}}class Compiler{constructor(e){this.module=e}compile(e){return this.compileTemplate(e)}compileTemplate(e){const t=this;e=e.replace(/\<\!\-\-[\s\S]*?\-\-\>/g,"");const s=/('[\s\S]*?')|("[\s\S]*?")|(`[\s\S]*?`)|({{{*)|(}*}})|([\w$-]+(\s*=)?)|(<\s*[a-zA-Z][a-zA-Z0-9-_]*)|(\/?>)|(<\/\s*[a-zA-Z][a-zA-Z0-9-_]*>)/g,i=/^[a-zA-Z_$][$-\w]*?\s*?=?$/,r=/^[\s\n\r\t\v]+$/;let n,o,a,l,d=[],c=[],h=0,p=!1,u=0,m=0;for(;null!==(l=s.exec(e));){let s=l[0];s.startsWith("{{")?(0===m&&(u=l.index),m+=s.length/2|0):s.endsWith("}}")&&(m-=s.length/2|0,0===m&&M()),0===m&&("<"===s[0]?(w(e.substring(h,l.index)),"/"===s[1]?f(s):(o=s.substring(1).trim().toLowerCase(),h=void 0,p="pre"===o,a=new VirtualDom(o,this.genKey()),t.root||(t.root=a),d.push(a),c.push(!1))):">"===s?v():"/>"===s?f():a&&a.tagName&&(i.test(s)?(n&&y(),s.endsWith("=")?n=s.substring(0,s.length-1).trim():(n=s,y())):n&&y(s)))}if(d.length>1||0!==m)throw new NError("wrongTemplate");return d[0];function f(e){if(e){let t=!1;const s=e.substring(2,e.length-1).trim().toLowerCase();for(let e=d.length-1;e>=0;e--)if(!c[e]&&d[e].tagName===s){d[e].children=d.slice(e+1);for(let t of d[e].children)t.parent=d[e],g(t);d.splice(e+1),c.splice(e+1),t=!0;break}if(!t)throw new NError("wrongTemplate")}let i=d[d.length-1];i===t.root&&g(i),c[c.length-1]=!0,a=void 0,n=void 0,h=s.lastIndex,m=0,u=0}function g(e){e.tagName&&(t.postHandleNode(e),e.sortDirective(),t.handleSlot(e))}function v(){a&&(h=s.lastIndex),a=void 0,n=void 0,m=0,u=0}function y(e){a&&n&&(e&&['"',"'","`"].includes(e[0])&&['"',"'","`"].includes(e[e.length-1])&&(e=e.substring(1,e.length-1).trim()),n.startsWith("x-")?a.addDirective(new Directive(n.substring(2),e)):n.startsWith("e-")?a.addEvent(new NEvent(t.module,n.substring(2),e)):a.setProp(n,e),n=void 0)}function M(){h>0&&u>h&&w(e.substring(h,u));const t=e.substring(u+2,s.lastIndex-2);m=0,u=0;let i=new Expression(t);a&&a.tagName?y(i):(k(i),h=s.lastIndex),a.allModelField=i.allModelField}function w(e){""===e||!p&&r.test(e)||k(e=t.preHandleText(e))}function k(e){a||(a=new VirtualDom(null,t.genKey()),d.push(a),c.push(!1)),a.expressions?a.expressions.push(e):"string"==typeof e?a.textContent=e:a.textContent?(a.expressions=[a.textContent,e],delete a.textContent):a.expressions=[e]}}handleSlot(e){if(!e.children||0===e.children.length||!e.hasDirective("module"))return;let t;for(let s=0;s<e.children.length;s++){let i=e.children[s];i.hasDirective("slot")||(t?e.children.splice(s--,1):(t=new VirtualDom("div",this.genKey()),t.addDirective(new Directive("slot",null)),e.children.splice(s,1,t)),t.add(i))}}postHandleNode(e){let t=DefineElementManager.get(e.tagName);if(t&&Reflect.construct(t,[e,this.module]),ModuleFactory.hasClass(e.tagName)){const t=new Directive("module",e.tagName);t.params={srcId:this.module.id},e.addDirective(t),e.tagName="div"}}preHandleText(e){if(/&[a-z]+;/.test(e)){let t=document.createElement("div");return t.innerHTML=e,t.textContent}return e}genKey(){return this.module.getDomKeyId()+""}}class DiffTool{static compare(e,t){const s=[];return i(e,t),s;function i(e,t){e.tagName?e.tagName!==t.tagName||e.subModuleId!==t.subModuleId?r(5,e,t,t.parent):((e.staticNum||t.staticNum&&function(e,t){for(let s of["props","assets"]){if(!e[s]&&t[s]||e[s]&&!t[s])return!0;if(e[s]&&t[s]){let i=Object.keys(e[s]),r=Object.keys(t[s]);if(i.length!==r.length)return!0;for(let r of i)if(e[s][r]!==t[s][r])return!0}}return!1}(e,t))&&r(2,e,null,t.parent),e.subModuleId||function(e,t){if(e.children&&0!==e.children.length)if(t.children&&0!==t.children.length){let n={},[o,a,l,d]=[0,e.children.length-1,0,t.children.length-1],[c,h,p,u]=[e.children[o],e.children[a],t.children[l],t.children[d]];for(;o<=a&&l<=d;)p.key===c.key?(i(c,p),o!==l&&r(4,c,null,t,o),c=e.children[++o],p=t.children[++l]):u.key===h.key?(i(h,u),d!==a&&r(4,h,null,t,a),h=e.children[--a],u=t.children[--d]):c.key===u.key?(i(c,u),o!==d&&r(4,c,null,t,o),c=e.children[++o],u=t.children[--d]):h.key===p.key?(i(h,p),a!==l&&r(4,h,null,t,a),h=e.children[--a],p=t.children[++l]):(n[c.key]=r(1,c,null,t,o),c=e.children[++o]);if(o<=a)for(let s=o;s<=a;s++)r(1,e.children[s],null,t,s);if(l<=d)for(let e=l,o=e;e<=d;e++,o++){let a=t.children[e];if(n.hasOwnProperty(a.key)){let e=n[a.key];if(o!==e[4])e[0]=4,i(e[1],a);else{let t;-1!==(t=s.findIndex((t=>t[1].key===e[1].key)))&&s.splice(t,1)}}else r(3,a,null,t),o--}}else e.children.forEach(((e,s)=>r(1,e,null,t,s)));else t.children&&t.children.length>0&&t.children.forEach((e=>r(3,e,null,t)))}(e,t)):t.tagName?r(5,e,t,t.parent):(e.staticNum||t.staticNum)&&e.textContent!==t.textContent&&r(2,e,null,t.parent),e.staticNum>0&&e.staticNum--}function r(e,t,i,r,n){const o=[e,t,i,r,n];return s.push(o),o}}}class DefineElement{constructor(e){e.hasProp("tag")?(e.tagName=e.getProp("tag"),e.delProp("tag")):e.tagName="div"}}class EventFactory{constructor(e){this.module=e,this.eventMap=new Map}addEvent(e,t,s){let i;this.eventMap.has(e)||this.eventMap.set(e,new Map),i=this.eventMap.get(e),i.has(t.name)||i.set(t.name,{});let r=i.get(t.name);if(s)if(r.delg){let e=r.delg;e.find((e=>e.key===s&&e.event===t))||e.push({key:s,event:t})}else r.delg=[{key:s,event:t}];else{if(t.delg)if(r.toDelg){let e=r.toDelg;e.find((e=>e===t))&&e.push(t)}else r.toDelg=[t];else if(r.own){let e=r.own;e.find((e=>e===t))&&e.push(t)}else r.own=[t];r.capture=t.capture}}getEvent(e){return this.eventMap.get(e)}removeEvent(e,t,s,i){if(!this.eventMap.has(e))return;let r=this.eventMap.get(e);if(!r.has(t.name))return;let n=r.get(t.name);if(s){if(!n.delg)return;{let e=n.delg.findIndex((e=>e.key===s&&e.event===t));-1!==e&&(n.delg.splice(e,1),0===n.delg.length&&delete n.delg)}}else if(i&&n.toDelg){let e=n.toDelg.findIndex((e=>e===t));-1!==e&&(n.toDelg.splice(e,1),0===n.toDelg.length&&delete n.toDelg)}else if(n.own){let e=n.own.findIndex((e=>e===t));-1!==e&&(n.own.splice(e,1),0===n.own.length&&delete n.own)}}bind(e,t,s,i){if(!this.eventMap.has(e))return!1;const r=this.eventMap.get(e);if(!r.has(t))return!1;if(r.bindMap){if(r.bindMap.has(t))return!1}else r.bindMap=new Map;const n=this.module.getElement(e);return n&&n.addEventListener(t,s,i),r.bindMap.set(t,{handler:s,capture:i}),!0}unbind(e,t){if(!this.eventMap.has(e))return;const s=this.eventMap.get(e);if(!s.bindMap||!s.has(t))return;const i=this.module.getElement(e),r=s.bindMap.get(t);i&&r&&i.removeEventListener(t,r.handler,r.capture),s.bindMap.delete(t)}unbindAll(e){if(!this.eventMap.has(e))return;const t=this.eventMap.get(e);if(!t.bindMap)return;const s=this.module.getElement(e);if(s)for(let e of t.bindMap)s.removeEventListener(e[0],e[1].handler,e[1].capture);t.bindMap.clear()}hasEvent(e){return this.eventMap.has(e)}cloneEvent(e,t){if(e===t)return;let s=this.eventMap.get(e);if(!s)return;let i=new Map;for(let e of s){if("bindMap"===e[0])continue;let t={capture:e[1].capture};e[1].own&&(t.own=e[1].own.slice(0)),e[1].delg&&(t.delg=e[1].delg.slice(0)),e[1].toDelg&&(t.toDelg=e[1].toDelg.slice(0)),i.set(e[0],t)}this.eventMap.set(t,i)}}class NCache{constructor(){this.subscribeMap=new Map,this.cacheData={}}get(e){let t=this.cacheData;if(-1!==e.indexOf(".")){let s=e.split(".");if(s.length>1){for(let e=0;e<s.length-1&&t;e++)t=t[s[e]];t&&(e=s[s.length-1])}}if(t)return t[e]}set(e,t){let s=this.cacheData,i=e;if(-1!==e.indexOf(".")){let t=e.split(".");if(t.length>1){for(let e=0;e<t.length-1;e++)s[t[e]]&&"object"==typeof s[t[e]]||(s[t[e]]={}),s=s[t[e]];e=t[t.length-1]}}if(s&&(s[e]=t),this.subscribeMap.has(i)){let e=this.subscribeMap.get(i);for(let s of e)this.invokeSubscribe(s.module,s.handler,t)}}remove(e){let t=this.cacheData;if(-1!==e.indexOf(".")){let s=e.split(".");if(s.length>1){for(let e=0;e<s.length-1&&t;e++)t=t[s[e]];t&&(e=s[s.length-1])}}t&&delete t[e]}subscribe(e,t,s){if(this.subscribeMap.has(t)){let i=this.subscribeMap.get(t);i.find((t=>t.module===e&&t.handler===s))||i.push({module:e,handler:s})}else this.subscribeMap.set(t,[{module:e,handler:s}]);let i=this.get(t);i&&this.invokeSubscribe(e,s,i)}invokeSubscribe(e,t,s){"string"==typeof t?e.invokeMethod(t,s):t.call(e,s)}}class GlobalCache{static set(e,t){this.cache.set(e,t)}static get(e){return this.cache.get(e)}static subscribe(e,t,s){this.cache.subscribe(e,t,s)}static remove(e){this.cache.remove(e)}}GlobalCache.cache=new NCache;class Model{constructor(e,t){if(!e)return;let s;return e.___source?s=e:(s=new Proxy(e,{set(e,t,s,i){if(null!==s&&"object"==typeof s&&(s=s.___source||s),e[t]===s)return!0;let r=e[t],n=Reflect.set(e,t,s,i);return ModelManager.update(i,t,r,s),n},get(e,t,s){if("___source"===t)return e;let i=Reflect.get(e,t,s);if(i&&(i.constructor===Object||i.constructor===Array)){let e=ModelManager.getModel(i,s);e||(e=new Model(i,s),ModelManager.add(i,e,s)),i=e}return i},deleteProperty(e,t){let s=e[t];return delete e[t],ModelManager.update(ModelManager.getModel(e),t,s,void 0),!0}}),ModelManager.add(e,s)),t&&ModelManager.bindToModule(s,t,void 0!==e.___source),s}}class ObjectManager{constructor(e){this.module=e,this.cache=new NCache}set(e,t){this.cache.set(e,t)}get(e){return this.cache.get(e)}remove(e){this.cache.remove(e)}setEventParam(e,t,s,i){this.cache.set("$events."+e+".$params."+t+"."+s,i)}getEventParam(e,t,s){return this.get("$events."+e+".$params."+t+"."+s)}removeEventParam(e,t,s){this.remove("$events."+e+".$params."+t+"."+s)}clearEventParam(e,t){t?this.remove("$events."+e+".$params."+t):this.remove("$events."+e+".$params")}setDomParam(e,t,s){this.set("$domparam."+e+"."+t,s)}getDomParam(e,t){return this.get("$domparam."+e+"."+t)}removeDomParam(e,t){this.remove("$domparam."+e+"."+t)}clearDomParams(e){this.remove("$domparam."+e)}clearAllDomParams(){this.remove("$domparam")}}DefineElementManager.add([class MODULE extends DefineElement{constructor(e,t){super(e);let s=e.getProp("name");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"MODULE","className");e.delProp("name"),e.addDirective(new Directive("module",s))}},class FOR extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"FOR","cond");e.delProp("cond"),e.addDirective(new Directive("repeat",s))}},class IF extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"IF","cond");e.delProp("cond"),e.addDirective(new Directive("if",s))}},class RECUR extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");e.delProp("cond"),e.addDirective(new Directive("recur",s))}},class ELSE extends DefineElement{constructor(e,t){super(e),e.addDirective(new Directive("else",null))}},class ELSEIF extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"ELSEIF","cond");e.delProp("cond"),e.addDirective(new Directive("elseif",s))}},class ENDIF extends DefineElement{constructor(e,t){super(e),e.addDirective(new Directive("endif",null))}},class SLOT extends DefineElement{constructor(e,t){super(e);let s=e.getProp("name")||"default";e.delProp("name"),e.addDirective(new Directive("slot",s))}}]),r("module",(function(e,t){const s=t.vdom;let i,r=e.objectManager.getDomParam(t.key,"moduleId"),n=!0;if(r)i=ModuleFactory.get(r),n=!t.props.renderOnce;else{if(i=ModuleFactory.get(this.value),!i)return!0;this.params&&this.params.srcId&&(i.compileMid=this.params.srcId),r=i.id,e.objectManager.setDomParam(t.key,"moduleId",r),e.addChild(i),s.hasProp("useDomModel")&&(i.model=t.model,ModelManager.bindToModule(i.model,i),delete t.props.useDomModel)}if(t.subModuleId=r,delete t.tagName,n){let e={};if(t.props)for(let s of Object.keys(t.props)){let i=t.props[s];"$"===s[0]?(e.$data||(e.$data={}),e.$data[s.substring(1)]=i,delete t.props[s]):e[s]=i}i.setProps(e,t)}return!0}),8),r("model",(function(e,t){let s=ModelManager.get(t.model,this.value);return s&&(t.model=s),!0}),1),r("repeat",(function(e,t){let s=this.value;if(!Util.isArray(s)||0===s.length)return!1;const i=t.vdom,r=i.getProp("$index"),n=t.parent;this.disabled=!0,delete i.model;for(let t=0;t<s.length;t++){if(!s[t])continue;r&&(s[t][r]=t),i.staticNum++;let o=Renderer.renderDom(e,i,s[t],n,ModelManager.getModelKey(s[t])+"");r&&delete o.props.$index}return this.disabled=!1,!1}),2),r("recur",(function(e,t){const s=t.vdom;if(t.props.hasOwnProperty("ref")){s.children=[];const i="$recurs."+(t.props.ref||"default");let r=e.objectManager.get(i);if(!r)return!0;let n=t.model[r.getDirective("recur").value];if(!n)return!0;let o=r.clone();Array.isArray(n)||(o.model=n,Util.setNodeKey(o,ModelManager.getModelKey(n)+"",!0)),s.children=[o],o.parent=s}else{if(!t.model[this.value])return!0;const i="$recurs."+(t.props.name||"default");e.objectManager.get(i)||e.objectManager.set(i,s)}return!0}),2),r("if",(function(e,t){if(t.parent)return e.objectManager.setDomParam(t.parent.key,"$if",this.value),this.value}),5),r("else",(function(e,t){if(t.parent)return!e.objectManager.getDomParam(t.parent.key,"$if")}),5),r("elseif",(function(e,t){if(t.parent)return!0!==e.objectManager.getDomParam(t.parent.key,"$if")&&!!this.value&&(e.objectManager.setDomParam(t.parent.key,"$if",!0),!0)}),5),r("endif",(function(e,t){if(t.parent)return e.objectManager.removeDomParam(t.parent.key,"$if"),!1}),5),r("show",(function(e,t){let s=e.objectManager.getDomParam(t.key,"$show");if(!(this.value||s&&s.rendered))return!1;s||(s={},e.objectManager.setDomParam(t.key,"$show",s));let i,r,n=t.props.style;return n&&(i=/display\s*\:[\w\-]+/.exec(n),null!==i)&&(r=i[0].split(":")[1].trim(),s.origin||"none"===r||(s.origin=r)),this.value?(s.rendered=!0,"none"===r&&(n=s.origin?n.substring(0,i.index)+"display:"+s.origin+n.substring(i.index+i[0].length):n.substring(0,i.index)+n.substring(i.index+i[0].length))):n?r?"none"!==r&&(n=n.substring(0,i.index)+"display:none"+n.substring(i.index+i[0].length)):n+=";display:none":n="display:none",n&&(t.props.style=n),!0}),5),r("field",(function(e,t){const s=t.props.type||"text",i=t.tagName.toLowerCase(),r=t.model;if(!r)return!0;let n=ModelManager.get(r,this.value);if("radio"===s)n==t.props.value?(t.props.checked="checked",Util.setDomAsset(t,"checked",!0)):(delete t.props.checked,Util.setDomAsset(t,"checked",!1));else if("checkbox"===s){let e=t.props["yes-value"];n==e?(t.props.value=e,Util.setDomAsset(t,"checked",!0)):(t.props.value=t.props["no-value"],Util.setDomAsset(t,"checked",!1))}else if("select"===i)t.props.value=n,Util.setDomAsset(t,"value",n);else{let e=null!=n?n:"";t.props.value=e,Util.setDomAsset(t,"value",e)}let o=GlobalCache.get("$fieldChangeEvent");return o||(o=new NEvent(null,"change",(function(e,t){const s=this.getElement(t.key);if(!s)return;let i=t.vdom.getDirective("field"),r=t.props.type,n=i.value,o=s.value;"checkbox"===r?o=t.props["yes-value"]==o?t.props["no-value"]:t.props["yes-value"]:"radio"===r&&(s.checked||(o=void 0));let a=n.split(".");if(1===a.length)e[n]=o;else{let t=e;n=a.pop();for(let e=0;e<a.length&&t;e++)t=t[a[e]];t&&(t[n]=o)}})),GlobalCache.set("$fieldChangeEvent",o)),t.vdom.addEvent(o),!0}),10),r("route",(function(e,t){if("a"===t.tagName.toLowerCase()&&(t.props.href="javascript:void(0)"),t.props.path=this.value,t.props.active){let s=t.props.active;delete t.props.active,Router.addActiveField(e,this.value,t.model,s),this.value.startsWith(Router.currentPath)&&t.model[s]&&Router.go(this.value)}let s=GlobalCache.get("$routeClickEvent");return s||(s=new NEvent(null,"click",(function(e,t,s,i){let r=t.props.path;Util.isEmpty(r)||Router.go(r)})),GlobalCache.set("$routeClickEvent",s)),t.vdom.addEvent(s),!0}),10),r("router",(function(e,t){return Router.routerKeyMap.set(e.id,t.key),!0}),10),r("slot",(function(e,t){this.value=this.value||"default";let s=t.parent.subModuleId;const i=t.vdom;if(s){let e=ModuleFactory.get(s);e&&e.objectManager.set("$slots."+this.value,{dom:i,model:t.model})}else{const s=e.objectManager.get("$slots."+this.value),r=s?s.dom.children:i.children;if(r)for(let n of r){let r;i.hasProp("innerRender")?r=t.model:s&&(r=new Model(s.model,e)),Renderer.renderDom(e,n,r,t.parent,t.key+"s")}}return!1}),5),r("animation",(function(e,t){var s,i,r,n,o,a,l,d,c,h,p,u,m,f,g,v,y,M,w,k;const E=this.value;if(!Util.isObject(E))return new Error("未找到animation配置对象");const b=0!=E.tigger,x=E.type||"transition",D=0!=E.isAppear,N=(null===(s=E.name)||void 0===s?void 0:s.enter)||E.name,C=(null===(i=E.name)||void 0===i?void 0:i.leave)||E.name,P=(null===(r=E.duration)||void 0===r?void 0:r.enter)||E.duration||"",T=(null===(n=E.duration)||void 0===n?void 0:n.leavr)||E.duration||"",O=(null===(o=E.delay)||void 0===o?void 0:o.enter)||E.delay||"0s",R=(null===(a=E.delay)||void 0===a?void 0:a.leave)||E.delay||"0s",F=(null===(l=E.timingFunction)||void 0===l?void 0:l.enter)||E.timingFunction||"ease",S=(null===(d=E.timingFunction)||void 0===d?void 0:d.leave)||E.timingFunction||"ease",W=(null===(h=null===(c=E.hooks)||void 0===c?void 0:c.enter)||void 0===h?void 0:h.before)?E.hooks.enter.before:(null===(p=E.hooks)||void 0===p?void 0:p.before)||void 0,j=(null===(m=null===(u=E.hooks)||void 0===u?void 0:u.enter)||void 0===m?void 0:m.after)?E.hooks.enter.after:(null===(f=E.hooks)||void 0===f?void 0:f.after)||void 0,$=(null===(v=null===(g=E.hooks)||void 0===g?void 0:g.leave)||void 0===v?void 0:v.before)?E.hooks.leave.before:(null===(y=E.hooks)||void 0===y?void 0:y.before)||void 0,L=(null===(w=null===(M=E.hooks)||void 0===M?void 0:M.leave)||void 0===w?void 0:w.after)?E.hooks.leave.after:(null===(k=E.hooks)||void 0===k?void 0:k.after)||void 0;let A=()=>{const s=e.getElement(t.key);b?(j&&j.apply(e.model,[e]),s.classList.remove(N+"-enter-active"),"animation"==x&&s.classList.add(N+"-enter-to")):(D&&(s.style.display="none"),L&&L.apply(e.model,[e]),[s.style.width,s.style.height]=function(e){const t=e.vdom.getProp("style");let s,i;if(t){let e=t.trim().split(/;\s*/);for(const t of e)t.startsWith("width")&&(s=t.split(":")[1]),t.startsWith("height")&&(i=t.split(":")[1])}return s=s||"",i=i||"",[s,i]}(t),s.classList.remove(C+"-leave-active"),"animation"==x&&s.classList.add(C+"-leave-to")),s.removeEventListener("animationend",A),s.removeEventListener("transitionend",A)},U=e.getElement(t.key);if(b){if(U){if(-1!=U.getAttribute("class").indexOf(`${N}-enter-to`))return t.props.class+=` ${N}-enter-to`,!0;D&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),_(U)}else D&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),setTimeout((()=>{let s=e.getElement(t.key);D&&(t.props.class+=` ${N}-enter-to`,s.style.display="none"),_(s)}),0);return!0}return U?-1!=U.getAttribute("class").indexOf(`${C}-leave-to`)?(t.props.class+=` ${C}-leave-to`,D&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),!0):(I(U),!0):(D&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),setTimeout((()=>{let s=e.getElement(t.key);D?(s.classList.add(`${C}-leave-to`),t.props.class+=` ${C}-leave-to`,s.style.display="none"):I(s)}),0),!0);function I(t){if("transition"==x){let[s,i]=K(t);requestAnimationFrame((()=>{t.classList.remove(N+"-enter-to"),t.classList.add(C+"-leave-active"),t.classList.add(C+"-leave-from"),"fold-height"==C?t.style.height=i:"fold-width"==C&&(t.style.width=s),t.style.transitionDelay=O,""!=P&&(t.style.transitionDuration=P),"ease"!=F&&(t.style.transitionTimingFunction=F),$&&$.apply(e.model,[e]),requestAnimationFrame((()=>{t.classList.add(C+"-leave-to"),t.classList.remove(C+"-leave-from"),"fold-height"==C?t.style.height="0px":"fold-width"==C&&(t.style.width="0px"),t.addEventListener("transitionend",A)}))}))}else requestAnimationFrame((()=>{t.classList.remove(N+"-enter-to"),t.style.animationDelay=R,""!=T&&(t.style.animationDuration=T),"ease"!=S&&(t.style.animationTimingFunction=S),$&&$.apply(e.model,[e]),t.offsetWidth,t.classList.add(C+"-leave-active"),t.addEventListener("animationend",A)}))}function _(t){if("transition"==x){t.style.transitionDelay="0s";let s=1e3*parseFloat(O);setTimeout((()=>{let[s,i]=K(t);t.classList.remove(C+"-leave-to"),t.classList.add(N+"-enter-active"),t.classList.add(N+"-enter-from"),"fold-height"==N?t.style.height="0px":"fold-width"==N&&(t.style.width="0px"),""!=P&&(t.style.transitionDuration=P),"ease"!=F&&(t.style.transitionTimingFunction=F),requestAnimationFrame((()=>{D&&(t.style.display=""),requestAnimationFrame((()=>{W&&W.apply(e.model,[e]),t.classList.add(N+"-enter-to"),t.classList.remove(N+"-enter-from"),"fold-height"==N?t.style.height=i:"fold-width"==N&&(t.style.width=s),t.addEventListener("transitionend",A)}))}))}),s)}else{t.style.animationDelay="0s";let s=1e3*parseFloat(O);setTimeout((()=>{requestAnimationFrame((()=>{t.classList.remove(C+"-leave-to"),""!=P&&(t.style.animationDuration=P),"ease"!=F&&(t.style.animationTimingFunction=P),D&&(t.style.display=""),W&&W.apply(e.model,[e]),t.offsetWidth,t.classList.add(N+"-enter-active"),t.addEventListener("animationend",A)}))}),s)}}function K(e){if("none"==e.style.display){const t=window.getComputedStyle(e).getPropertyValue("position"),s=window.getComputedStyle(e).getPropertyValue("visibility");e.style.position="absolute",e.style.visibility="hidden",e.style.display="";let i=window.getComputedStyle(e).getPropertyValue("width"),r=window.getComputedStyle(e).getPropertyValue("height");return e.style.position=t,e.style.visibility=s,e.style.display="none",[i,r]}return[window.getComputedStyle(e).getPropertyValue("width"),window.getComputedStyle(e).getPropertyValue("height")]}}),10),EventManager.regist("tap",{touchstart(e,t,s,i){let r=i.touches[0];s.dependEvent.setParam(t,e,"pos",{sx:r.pageX,sy:r.pageY,t:Date.now()})},touchmove(e,t,s,i){let r=s.dependEvent.getParam(t,e,"pos");if(!r)return;let n=i.touches[0],o=n.pageX-r.sx,a=n.pageY-r.sy;(Math.abs(o)>5||Math.abs(a)>5)&&(r.move=!0)},touchend(e,t,s,i){let r=s.dependEvent.getParam(t,e,"pos");if(!r)return;s.dependEvent.removeParam(t,e,"pos");let n=Date.now()-r.t;if(!r.move&&n<200){let r=s.dependEvent.handler;"string"==typeof r?t.invokeMethod(s.dependEvent.handler,e.model,e,s.dependEvent,i):r.apply(t,[e.model,e,s.dependEvent,i])}}}),EventManager.regist("swipe",{touchstart(e,t,s,i){let r=i.touches[0],n=Date.now();s.dependEvent.setParam(t,e,"swipe",{oldTime:[n,n],speedLoc:[{x:r.pageX,y:r.pageY},{x:r.pageX,y:r.pageY}],oldLoc:{x:r.pageX,y:r.pageY}})},touchmove(e,t,s,i){let r=Date.now(),n=i.touches[0],o=s.dependEvent.getParam(t,e,"swipe");r-o.oldTime[1]>50&&(o.speedLoc[0]={x:o.speedLoc[1].x,y:o.speedLoc[1].y},o.speedLoc[1]={x:n.pageX,y:n.pageY},o.oldTime[0]=o.oldTime[1],o.oldTime[1]=r),o.oldLoc={x:n.pageX,y:n.pageY}},touchend(e,t,s,i){let r=s.dependEvent.getParam(t,e,"swipe"),n=Date.now(),o=n-r.oldTime[1]<30?0:1,a=r.oldLoc.x-r.speedLoc[o].x,l=r.oldLoc.y-r.speedLoc[o].y,d=Math.sqrt(a*a+l*l),c=n-r.oldTime[o];if(c>300||d<10)return;let h=d/c;if(h>.05){let r="";if(a<0&&Math.abs(l/a)<1&&(i.v0=h,r="swipeleft"),a>0&&Math.abs(l/a)<1&&(i.v0=h,r="swiperight"),l>0&&Math.abs(a/l)<1&&(i.v0=h,r="swipedown"),l<0&&Math.abs(a/l)<1&&(i.v0=h,r="swipeup"),s.dependEvent.name===r){let r=s.dependEvent.handler;"string"==typeof r?t.invokeMethod(r,e.model,e,s.dependEvent,i):"function"==typeof r&&r.apply(t,[e.model,e,s.dependEvent,i])}}}}),EventManager.regist("swipeleft",EventManager.get("swipe")),EventManager.regist("swiperight",EventManager.get("swipe")),EventManager.regist("swipeup",EventManager.get("swipe")),EventManager.regist("swipedown",EventManager.get("swipe")),EventManager.regist("dblclick",{click(e,t,s,i){let r=s.dependEvent.getParam(t,e,"firstClick");if(r){if(Date.now()-r<300){let r=s.dependEvent.handler;"string"==typeof r?t.invokeMethod(s.dependEvent.handler,e.model,e,s.dependEvent,i):r.apply(t,[e.model,e,s.dependEvent,i])}}else s.dependEvent.setParam(t,e,"firstClick",Date.now());setTimeout((()=>{s.dependEvent.removeParam(t,e,"firstClick")}),500)}}),exports.$get=function(e,t){return ModelManager.get(e,t)},exports.$set=function(e,t,s){return ModelManager.set(e,t,s)},exports.Compiler=Compiler,exports.CssManager=CssManager,exports.DefineElement=DefineElement,exports.DefineElementManager=DefineElementManager,exports.DiffTool=DiffTool,exports.Directive=Directive,exports.DirectiveManager=DirectiveManager,exports.DirectiveType=DirectiveType,exports.EventFactory=EventFactory,exports.EventManager=EventManager,exports.Expression=Expression,exports.GlobalCache=GlobalCache,exports.Model=Model,exports.ModelManager=ModelManager,exports.Module=class Module{constructor(){this.originProps=new Map,this.children=[],this.elementMap=new Map,this.id=Util.genId(),this.objectManager=new ObjectManager(this),this.eventFactory=new EventFactory(this),ModuleFactory.add(this)}init(){if(this.model=new Model(this.data()||{},this),this.modules&&Array.isArray(this.modules)){for(let e of this.modules)ModuleFactory.addClass(e);delete this.modules}this.state=exports.EModuleState.READY}template(e){return null}data(){return{}}render(){if(this.state===exports.EModuleState.UNMOUNTED)return;let e=this.template(this.props);if(e!==this.oldTemplate&&(this.oldTemplate=e,this.compile()),!this.originTree)return;if(this.doModuleEvent("onBeforeRender"))return;this.hasRendered||this.doModuleEvent("onBeforeFirstRender");const t=this.renderTree;if(this.renderTree=Renderer.renderDom(this,this.originTree,this.model),!this.renderTree)return this.unmount(),void(this.hasRendered=!0);if(this.hasRendered||(this.doModuleEvent("onFirstRender"),this.hasRendered=!0),this.doModuleEvent("onRender"),this.state===exports.EModuleState.MOUNTED){if(t&&this.model){let e=DiffTool.compare(this.renderTree,t);e.length>0&&Renderer.handleChangedDoms(this,e)}}else this.mount()}addChild(e){let t;"number"==typeof e?(t=e,e=ModuleFactory.get(t)):t=e.id,this.children.includes(t)||(this.children.push(t),e.parentId=this.id,e.active())}removeChild(e){let t=this.children.indexOf(e.id);-1!==t&&(e.unmount(),this.children.splice(t,1))}active(){this.state===exports.EModuleState.UNMOUNTED&&(this.state=exports.EModuleState.READY),Renderer.add(this)}mount(){const e=Renderer.renderToHtml(this,this.renderTree,null,!0);if(this.container)this.container.appendChild(e);else if(this.srcDom){const t=this.getParent();if(!t)return;const s=t.getElement(this.srcDom.key);s&&s.parentElement.replaceChild(e,s),t.saveElement(this.srcDom.key,e)}this.state=exports.EModuleState.MOUNTED,this.doModuleEvent("onMount")}unmount(){if(this.state===exports.EModuleState.UNMOUNTED||ModuleFactory.getMain()===this)return;Renderer.remove(this.id),this.eventFactory=new EventFactory(this),delete this.renderTree;const e=this.getElement("1");if(e)if(this.container)this.container.removeChild(e);else if(this.srcDom){const t=this.getParent();if(!t)return;const s=document.createTextNode("");e.parentElement&&e.parentElement.replaceChild(s,e),t.saveElement(this.srcDom.key,s)}if(this.clearElementMap(),this.state=exports.EModuleState.UNMOUNTED,this.children)for(let e of this.children){let t=ModuleFactory.get(e);t&&t.unmount()}}clearElementMap(e){e?this.elementMap.delete(e):this.elementMap.clear()}getParent(){if(this.parentId)return ModuleFactory.get(this.parentId)}doModuleEvent(e){let t=this[e];if(t&&"function"==typeof t)return t.apply(this,[this.model])}getMethod(e){return this[e]}setContainer(e){this.container=e}invokeMethod(e,t,s,i,r,n,o,a,l){let d=this,c=d[e];if(!c&&this.compileMid&&(d=ModuleFactory.get(this.compileMid),d&&(c=d[e])),c&&"function"==typeof c){let e=[];for(let t=1;t<arguments.length;t++)e.push(arguments[t]);return c.apply(d,e)}}setProps(e,t){let s=e.$data;if(this.changedProps={},delete e.$data,s)for(let e of Object.keys(s)){let t=s[e];t&&"object"==typeof t&&this.model[e]!==t&&(t=new Model(t,this)),this.model[e]=t}this.srcDom=t;let i=!1;if(this.props)for(let t of Object.keys(e))e[t]!==this.props[t]&&(i=!0,this.changedProps[t]=e[t]);else this.changedProps=e,i=!0;i&&this.mergeProps(this.changedProps),(i||this.state===exports.EModuleState.UNMOUNTED)&&this.active(),this.props=e}compile(){if(this.domKeyId=0,this.children=[],CssManager.clearModuleRules(this),this.objectManager.clearAllDomParams(),!this.oldTemplate)return;if(this.originTree=new Compiler(this).compile(this.oldTemplate),this.originTree.props)for(let e of this.originTree.props)this.originProps.set(e[0],e[1]);this.mergeProps(this.props);let e=this.getParent();if(e){const t=e.eventFactory.getEvent(this.srcDom.key);if(t)for(let e of t)if(e[1].own)for(let t of e[1].own)this.originTree.addEvent(t)}this.doModuleEvent("onCompile")}setExcludeProps(e){this.excludedProps=e}mergeProps(e){if(e&&this.originTree){this.originTree.staticNum=1;for(let t of Object.keys(e))this.excludedProps&&this.excludedProps.includes(t)||(this.originProps.has(t)?this.originTree.setProp(t,[e[t],this.originProps.get(t)]):this.originTree.setProp(t,e[t]))}}getElement(e){return this.elementMap.get(e)}saveElement(e,t){this.elementMap.set(e,t)}freeNode(e){if(e.subModuleId){let t=ModuleFactory.get(e.subModuleId);t&&t.unmount()}else if(this.clearElementMap(e.key),this.eventFactory.unbindAll(e.key),e.children)for(let t of e.children)this.freeNode(t)}getOriginDom(e){return this.originTree?function t(s){if(s.key===e)return s;if(s.children)for(let e of s.children){let s=t(e);if(s)return s}}(this.originTree):null}getRenderedDom(e){if(!this.renderTree)return;const t=function e(t,s){if(t.key===s)return t;if(t.children)for(let i of t.children){let t=e(i,s);if(t)return t}}(this.renderTree,e);return t}getModule(e,t,s){if(this.children)for(let i of this.children){let r=ModuleFactory.get(i);if(r&&r.constructor){if(r.constructor.name===e){if(!s)return r;{let e=!0;for(let t of Object.keys(s))if(!r.props||r.props[t]!==s[t]){e=!1;break}if(e)return r}}if(t){let t=r.getModule(e,!0,s);if(t)return t}}}}getModules(e,t){if(!this.children)return;let s=[];return function i(r){if(!r.children)return;for(let n of r.children){let r=ModuleFactory.get(n);r&&r.constructor&&(r.constructor.name===e&&s.push(r),t&&i(r))}}(this),s}getDomKeyId(){return++this.domKeyId}},exports.ModuleFactory=ModuleFactory,exports.NCache=NCache,exports.NError=NError,exports.NEvent=NEvent,exports.NFactory=class NFactory{constructor(e){this.items=new Map,void 0!==e&&(this.moduleId=e.id)}add(e,t){this.items.set(e,t)}get(e){return this.items.get(e)}remove(e){this.items.delete(e)}has(e){return this.items.has(e)}},exports.NodomMessage_en=t,exports.NodomMessage_zh=s,exports.Renderer=Renderer,exports.Route=Route,exports.Router=Router,exports.Scheduler=Scheduler,exports.Util=Util,exports.VirtualDom=VirtualDom,exports.createDirective=r,exports.createRoute=function(e,t){let s;if(t=t||Router.root,Util.isArray(e))for(let i of e)s=new Route(i,t);else s=new Route(e,t);return s},exports.getmkey=function(e){return ModelManager.getModelKey(e)},exports.nodom=function(i,r,n){return e(this,void 0,void 0,(function*(){switch(n||"zh"){case"zh":exports.NodomMessage=s;break;case"en":exports.NodomMessage=t}Scheduler.addTask(Renderer.render,Renderer),Scheduler.start();let e=ModuleFactory.get(i);e.setContainer(document.querySelector(r)),e.active()}))},exports.registModule=function(e,t){ModuleFactory.addClass(e,t)},exports.request=function(t){return e(this,void 0,void 0,(function*(){return new Promise(((e,s)=>{"string"==typeof t&&(t={url:t}),t.params=t.params||{},t.rand&&(t.params.$rand=Math.random());let i=t.url;const r=!1!==t.async,n=new XMLHttpRequest;n.withCredentials=t.withCredentials;const o=(t.method||"GET").toUpperCase();n.timeout=r?t.timeout:0,n.onload=()=>{if(200===n.status){let i=n.responseText;if("json"===t.type)try{i=JSON.parse(i)}catch(e){s({type:"jsonparse"})}e(i)}else s({type:"error",url:i})},n.ontimeout=()=>s({type:"timeout"}),n.onerror=()=>s({type:"error",url:i});let a=null;switch(o){case"GET":let e;if(Util.isObject(t.params)){let s=[];for(let e of Object.keys(t.params)){const i=t.params[e];null!=i&&s.push(e+"="+i)}e=s.join("&")}void 0!==e&&(-1!==i.indexOf("?")?i+="&"+e:i+="?"+e);break;case"POST":if(t.params instanceof FormData)a=t.params;else{let e=new FormData;for(let s of Object.keys(t.params)){const i=t.params[s];null!=i&&e.append(s,i)}a=e}}n.open(o,i,r,t.user,t.pwd),t.header&&Util.getOwnProps(t.header).forEach((e=>{n.setRequestHeader(e,t.header[e])})),n.send(a)})).catch((e=>{switch(e.type){case"error":throw new NError("notexist1",exports.NodomMessage.TipWords.resource,e.url);case"timeout":throw new NError("timeout");case"jsonparse":throw new NError("jsonparse")}}))}))},exports.watch=function(e,t,s,i,r){return ModelManager.watch(e,t,s,i,r)};
//# sourceMappingURL=nodom.cjs.min.js.map
