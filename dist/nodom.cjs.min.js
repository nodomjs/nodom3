"use strict";function e(e){if(e&&e.__esModule)return e;var t=Object.create(null);return e&&Object.keys(e).forEach((function(s){if("default"!==s){var r=Object.getOwnPropertyDescriptor(e,s);Object.defineProperty(t,s,r.get?r:{enumerable:!0,get:function(){return e[s]}})}})),t.default=e,Object.freeze(t)}Object.defineProperty(exports,"__esModule",{value:!0});class DefineElementManager{static add(e,t){if(Array.isArray(e))for(let t of e)this.elements.set(t.name.toUpperCase(),t);else this.elements.set((t||e.name).toUpperCase(),e)}static get(e){return this.elements.get(e.toUpperCase())}static has(e){return this.elements.has(e.toUpperCase())}}DefineElementManager.elements=new Map;class DirectiveType{constructor(e,t,s){this.name=e,this.prio=s>=0?s:10,this.handle=t}}class DirectiveManager{static addType(e,t,s){this.directiveTypes.set(e,new DirectiveType(e,t,s))}static removeType(e){this.directiveTypes.delete(e)}static getType(e){return this.directiveTypes.get(e)}static hasType(e){return this.directiveTypes.has(e)}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */
function t(e,t,s,r){return new(s||(s=Promise))((function(i,n){function o(e){try{l(r.next(e))}catch(e){n(e)}}function a(e){try{l(r.throw(e))}catch(e){n(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(o,a)}l((r=r.apply(e,t||[])).next())}))}DirectiveManager.directiveTypes=new Map;const s={TipWords:{application:"Application",system:"System",module:"Module",moduleClass:"ModuleClass",model:"Model",directive:"Directive",directiveType:"Directive-type",expression:"Expression",event:"Event",method:"Method",filter:"Filter",filterType:"Filter-type",data:"Data",dataItem:"Data-item",route:"Route",routeView:"Route-container",plugin:"Plugin",resource:"Resource",root:"Root",element:"VirtualDom"},ErrorMsgs:{unknown:"unknown error",paramException:"{0} '{1}' parameter error，see api",invoke:"method {0} parameter {1} must be {2}",invoke1:"method {0} parameter {1} must be {2} or {3}",invoke2:"method {0} parameter {1} or {2} must be {3}",invoke3:"method {0} parameter {1} not allowed empty",exist:"{0} is already exist",exist1:"{0} '{1}' is already exist",notexist:"{0} is not exist",notexist1:"{0} '{1}' is not exist",notupd:"{0} not allow to change",notremove:"{0} not allow to delete",notremove1:"{0} {1} not allow to delete",namedinvalid:"{0} {1} name error，see name rules",initial:"{0} init parameter error",jsonparse:"JSON parse error",timeout:"request overtime",config:"{0} config parameter error",config1:"{0} config parameter '{1}' error",itemnotempty:"{0} '{1}' config item '{2}' not allow empty",itemincorrect:"{0} '{1}' config item '{2}' error",needEndTag:"element {0} is not closed",needStartTag:"without start tag matchs {0}",tagError:"element {0} error",wrongTemplate:"wrong template",wrongExpression:"expression error: {0} "},WeekDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},r={TipWords:{application:"应用",system:"系统",module:"模块",moduleClass:"模块类",model:"模型",directive:"指令",directiveType:"指令类型",expression:"表达式",event:"事件",method:"方法",filter:"过滤器",filterType:"过滤器类型",data:"数据",dataItem:"数据项",route:"路由",routeView:"路由容器",plugin:"插件",resource:"资源",root:"根",element:"元素"},ErrorMsgs:{unknown:"未知错误",paramException:"{0}'{1}'方法参数错误，请参考api",invoke:"{0} 方法参数 {1} 必须为 {2}",invoke1:"{0} 方法参数 {1} 必须为 {2} 或 {3}",invoke2:"{0} 方法参数 {1} 或 {2} 必须为 {3}",invoke3:"{0} 方法参数 {1} 不能为空",exist:"{0} 已存在",exist1:"{0} '{1}' 已存在",notexist:"{0} 不存在",notexist1:"{0} '{1}' 不存在",notupd:"{0} 不可修改",notremove:"{0} 不可删除",notremove1:"{0} {1} 不可删除",namedinvalid:"{0} {1} 命名错误，请参考用户手册对应命名规范",initial:"{0} 初始化参数错误",jsonparse:"JSON解析错误",timeout:"请求超时",config:"{0} 配置参数错误",config1:"{0} 配置参数 '{1}' 错误",itemnotempty:"{0} '{1}' 配置项 '{2}' 不能为空",itemincorrect:"{0} '{1}' 配置项 '{2}' 错误",needEndTag:"{0} 标签未闭合",needStartTag:"未找到与 {0} 匹配的开始标签",tagError:"标签 {0} 错误",wrongTemplate:"模版格式错误",wrongExpression:"表达式 {0} 错误"},WeekDays:["星期日","星期一","星期二","星期三","星期四","星期五","星期六"]};class ModuleFactory{static add(e){0===this.modules.size&&(this.mainModule=e),this.modules.set(e.id,e),this.addClass(e.constructor)}static get(e){let t=typeof e;return"number"===t?this.modules.get(e):"string"!==t?Reflect.construct(e,[]):(this.classes.has(e)||(e=this.aliasMap.get(e)),this.classes.has(e)?Reflect.construct(this.classes.get(e),[]):void 0)}static hasClass(e){const t=e.toLowerCase();return this.classes.has(t)||this.aliasMap.has(t)}static addClass(e,t){let s=e.name.toLowerCase();this.classes.has(s)||(this.classes.set(s,e),t&&this.aliasMap.set(t.toLowerCase(),s))}static getClass(e){return e=e.toLowerCase(),this.classes.has(e)?this.classes.get(e):this.classes.get(this.aliasMap.get(e))}static load(s){return t(this,void 0,void 0,(function*(){let t=yield(r=s,Promise.resolve().then((function(){return e(require(r))})));var r;if(t)for(let e of Object.keys(t))if(t[e].name)return this.addClass(t[e]),t[e]}))}static remove(e){this.modules.delete(e)}static setMain(e){this.mainModule=e}static getMain(){return this.mainModule}}ModuleFactory.modules=new Map,ModuleFactory.classes=new Map,ModuleFactory.aliasMap=new Map;class Expression{constructor(e){if(this.id=Util.genId(),this.allModelField=!0,!e)return;this.exprStr=e;const t=this.compile(e);this.execFunc=new Function("$model","return "+t)}compile(e){const t=/('[\s\S]*?')|("[\s\S]*?")|(`[\s\S]*?`)|([a-zA-Z$_][\w$]*\s*?:)|((\.{3}|\.)?[a-zA-Z$_][\w$]*(\.[a-zA-Z$_][\w$]*)*(\s*[\[\(](\s*\))?)?)/g;let s,r="",i=0;for(;null!==(s=t.exec(e));){let o=s[0];if(i<s.index&&(r+=e.substring(i,s.index)),"'"===o[0]||'"'===o[0]||"`"===o[0])r+=o;else{let e=o[o.length-1];if(":"===e)r+=o;else if("("===e||")"===e)r+=n(o);else if(o.startsWith("this.")||Util.isKeyWord(o)||"."===o[0]&&"."!==o[1])r+=o;else{let e="";o.startsWith("...")&&(e="...",o=o.substring(3)),r+=e+"$model."+o,-1!==o.indexOf(".")&&(this.allModelField=!1)}}i=t.lastIndex}return i<e.length&&(r+=e.substring(i)),r;function n(e){const t=e.lastIndexOf("("),s=e.indexOf("."),r=(-1!==s?e.substring(0,s):e.substring(0,t)).trim();return Util.isKeyWord(r)||"."===e[0]?e:-1===s?"this."+r+e.substring(r.length):"$model."+e}}val(e,t){let s;try{s=this.execFunc.call(e,t)}catch(e){console.error(new NError("wrongExpression",this.exprStr).message),console.error(e)}return this.value=s,s}}class CssManager{static handleStyleDom(e,t,s,r){if("style"!==t.tagName.toLowerCase())return!1;if(r){let r=this.cssPreName+e.id;s.props.class?s.props.class=t.props.class+" "+r:s.props.class=r}return!0}static handleStyleTextDom(e,t){return!(!t.parent||"style"!==t.parent.tagName.toLowerCase())&&(CssManager.addRules(e,t.textContent,"this"===t.parent.props.scope?"."+this.cssPreName+e.id:void 0),!0)}static addRules(e,t,s){if(!this.sheet){let e=document.createElement("style");document.head.appendChild(e),this.sheet=document.styleSheets[0]}s&&this.clearModuleRules(e);const r=/(@[a-zA-Z]+\s+url\(.+?\))|([.#@a-zA-Z]\S*(\s*\S*\s*?)?{)|\}/g,i=/@[a-zA-Z]+\s+url/;let n,o=-1,a=0;for(;null!==(n=r.exec(t));)if(i.test(n[0]))d(n[0]);else if("}"===n[0]){if(o>=0&&--a<=0){let r=t.substring(o,n.index+1);"@"===r[0]?this.sheet.insertRule(r,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0):l(e,r,s),o=-1,a=0}}else-1===o?(o=n.index,a++):a++;function l(e,t,s){let r=/.+(?=\{)/.exec(t);if(r){if(s){let i=e.objectManager.get("$cssRules");i||(i=[],e.objectManager.set("$cssRules",i)),i.push(s+" "+r[0]),t=s+" "+t}CssManager.sheet.insertRule(t,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0)}}function d(e){let t=e.indexOf("("),s=e.lastIndexOf(")");if(-1===t||-1===s||t>=s)return;let r=e.substring(t,s);CssManager.importMap.has(r)||(CssManager.sheet.insertRule(e,CssManager.importIndex++),CssManager.importMap.set(r,!0))}}static clearModuleRules(e){let t=e.objectManager.get("$cssRules");if(t&&0!==t.length){for(let e=0;e<this.sheet.cssRules.length;e++){let s=this.sheet.cssRules[e];s.selectorText&&-1!==t.indexOf(s.selectorText)&&this.sheet.deleteRule(e--)}e.objectManager.set("$cssRules",[])}}}CssManager.importMap=new Map,CssManager.importIndex=0,CssManager.cssPreName="___nodommodule___";class Renderer{static add(e){this.waitList.includes(e.id)||this.waitList.push(e.id)}static remove(e){let t;-1!==(t=this.waitList.indexOf(e))&&this.waitList.splice(t,1,null)}static render(){for(;this.waitList.length>0;){let e=this.waitList[0];if(e){ModuleFactory.get(e).render()}this.waitList.shift()}}static renderDom(e,t,s,r,i){const n=i?Util.genUniqueKey(t.key,i):t.key;s=t.model||s;let o={key:n,vdom:t};if(t.tagName?(o.tagName=t.tagName,o.props={}):o.textContent=t.textContent,r?(s||(s=r.model),o.parent=r):(this.currentModuleRoot=o,s||(s=e.model)),o.model=s,o.staticNum=t.staticNum,t.directives&&t.directives.length>0&&"model"===t.directives[0].type.name&&t.directives[0].exec(e,o),o.tagName){if(function(){if(!t.props||0===t.props.size)return;const s=/^style$/i,r=/^class$/i;let i;for(let n of t.props){if(Array.isArray(n[1])){i=[];for(let t=0;t<n[1].length;t++){let s=n[1][t];s instanceof Expression?i.push(s.val(e,o.model)):i.push(s)}s.test(n[0])?i=t.getStyleString(i):r.test(n[0])&&(i=t.getClassString(i))}else i=n[1]instanceof Expression?n[1].val(e,o.model):n[1];o.props[n[0]]=i}}(),!CssManager.handleStyleDom(e,t,Renderer.currentModuleRoot,"this"===t.getProp("scope"))&&t.assets&&t.assets.size>0)for(let e of t.assets)o[e[0]]=e[1];if(!function(){if(!t.directives||0===t.directives.length)return!0;for(let s of t.directives)if("model"!==s.type.name&&!s.exec(e,o))return!1;return!0}())return null;if(t.events)for(let s of t.events)e.eventFactory.addEvent(o,s);if(t.children&&t.children.length>0){o.children=[];for(let s of t.children)Renderer.renderDom(e,s,o.model,o,i||null)}}else if(t.expressions){let s="";for(let r of t.expressions)if(r instanceof Expression){let t=r.val(e,o.model);s+=void 0!==t?t:""}else s+=r;o.textContent=s}else o.textContent=t.textContent;return 1===t.staticNum&&(t.staticNum=0),r&&o.parent.children.push(o),o}static updateToHtml(e,t){let s=e.getElement(t.key);if(!s)return this.renderToHtml(e,t,null);if(t.tagName){s.key=t.key;let e=s.attributes,r=[];for(let t=0;t<e.length;t++)r.push(e[t].name);for(let e of Object.keys(t.props)){let i;s.setAttribute(e,void 0===t.props[e]?"":t.props[e]),-1!==(i=r.indexOf(e))&&r.splice(i,1)}if(r.length>0)for(let e of r)s.removeAttribute(e);if(t.assets)for(let e of Object.keys(t.assets))s[e]=t.assets[e]}else s.textContent=t.textContent;return s}static renderToHtml(e,t,s,r){let i;return i=t.tagName?n(t):o(t),i&&t.tagName&&r&&function e(t,s){s.children&&s.children.length>0&&s.children.forEach((s=>{let r;s.tagName?(r=n(s),e(r,s)):r=o(s),r&&t.appendChild(r)}))}(i,t),i&&s&&s.appendChild(i),i;function n(t,s){if("style"===t.tagName)return;let r=document.createElement(t.tagName);e.saveElement(t.key,r),r.key=t.key;for(let e of Object.keys(t.props))r.setAttribute(e,void 0===t.props[e]?"":t.props[e]);if(t.assets)for(let e of Object.keys(t.assets))r[e]=t.assets[e];return e.eventFactory.bind(t),r}function o(t){if(CssManager.handleStyleTextDom(e,t))return;let s=document.createTextNode(t.textContent||"");return e.saveElement(t.key,s),s}}static handleChangedDoms(e,t){const s=[],r=[];for(let i of t)if(2===i[0])Renderer.updateToHtml(e,i[1]);else if(3===i[0]){const t=e.getElement(i[3].key),s=e.getElement(i[1].key);t&&s&&s.parentElement===t&&t.removeChild(s),e.domManager.freeNode(i[1])}else 5===i[0]?s.push(i):r.push(i);if(s.length>0)for(let t of s){const s=e.getElement(t[3].key);let r;t[2].moduleId?(e.domManager.freeNode(t[2]),r=e.getElement(t[2].key)):(r=e.getElement(t[2].key),e.domManager.freeNode(t[2]));const i=Renderer.renderToHtml(e,t[1],null,!0);s&&r&&s.replaceChild(i,r)}r.length>0&&r.sort(((e,t)=>e[4]>t[4]?1:-1));for(let t of r){const s=e.getElement(t[3].key);if(1===t[0]){const r=Renderer.renderToHtml(e,t[1],null,!0);s.childNodes&&s.childNodes.length-1>t[4]?s.insertBefore(r,s.childNodes[t[4]]):s.appendChild(r)}else{const r=e.getElement(t[1].key);r&&r!==s.childNodes[t[4]]&&(s.childNodes.length-1>t[4]?s.insertBefore(r,s.childNodes[t[4]]):r!==s.childNodes[s.childNodes.length-1]&&s.appendChild(r))}}}}Renderer.waitList=[];class RequestManager{static request(e){return t(this,void 0,void 0,(function*(){const t=Date.now();if(this.requestMap.has(e.url)){const s=this.requestMap.get(e.url);if(t-s.time<this.rejectReqTick&&Util.compare(s.params,e.params))return}return this.requestMap.set(e.url,{time:t,params:e.params}),new Promise(((t,s)=>{"string"==typeof e&&(e={url:e}),e.params=e.params||{},e.rand&&(e.params.$rand=Math.random());let r=e.url;const i=!1!==e.async,n=new XMLHttpRequest;n.withCredentials=e.withCredentials;const o=(e.method||"GET").toUpperCase();n.timeout=i?e.timeout:0,n.onload=()=>{if(200===n.status){let r=n.responseText;if("json"===e.type)try{r=JSON.parse(r)}catch(e){s({type:"jsonparse"})}t(r)}else s({type:"error",url:r})},n.ontimeout=()=>s({type:"timeout"}),n.onerror=()=>s({type:"error",url:r});let a=null;switch(o){case"GET":let t;if(Util.isObject(e.params)){let s=[];for(let t of Object.keys(e.params)){const r=e.params[t];null!=r&&s.push(t+"="+r)}t=s.join("&")}void 0!==t&&(-1!==r.indexOf("?")?r+="&"+t:r+="?"+t);break;case"POST":if(e.params instanceof FormData)a=e.params;else{let t=new FormData;for(let s of Object.keys(e.params)){const r=e.params[s];null!=r&&t.append(s,r)}a=t}}n.open(o,r,i,e.user,e.pwd),e.header&&Util.getOwnProps(e.header).forEach((t=>{n.setRequestHeader(t,e.header[t])})),n.send(a)})).catch((e=>{switch(e.type){case"error":throw new NError("notexist1",exports.NodomMessage.TipWords.resource,e.url);case"timeout":throw new NError("timeout");case"jsonparse":throw new NError("jsonparse")}}))}))}static clearCache(){const e=Date.now();for(let t of this.requestMap.keys())e-this.requestMap.get(t).time>this.rejectReqTick&&this.requestMap.delete(t)}}RequestManager.rejectReqTick=500,RequestManager.requestMap=new Map;class Route{constructor(e,t){if(this.params=[],this.data={},this.children=[],e&&!Util.isEmpty(e.path)){this.id=Util.genId();for(let t of Object.keys(e))this[t]=e[t];this.parent=t,this.path&&this.parse(),t&&t.addChild(this),e.routes&&Array.isArray(e.routes)&&e.routes.forEach((e=>{new Route(e,this)}))}}addChild(e){this.children.push(e),e.parent=this}parse(){let e=this.path.split("/"),t=this.parent,s=[],r=-1,i="";for(let n=0;n<e.length;n++){let o=e[n].trim();if(""!==o){if(o.startsWith(":"))0===s.length&&(r=n),s.push(o.substring(1));else{r=-1,s=[],this.path=o;let e=0;for(;e<t.children.length;e++){let s=t.children[e];if(s.path===o){t=s;break}}e===t.children.length&&(""!==i&&(new Route({path:i},t),t=t.children[t.children.length-1]),i=o)}this.params=-1===r?[]:s}else e.splice(n--,1)}}clone(){let e=new Route;return Object.getOwnPropertyNames(this).forEach((t=>{"data"!==t&&(e[t]=this[t])})),this.data&&(e.data=Util.clone(this.data)),e}}var i;exports.EModuleState=void 0,(i=exports.EModuleState||(exports.EModuleState={}))[i.READY=1]="READY",i[i.UNMOUNTED=3]="UNMOUNTED",i[i.MOUNTED=4]="MOUNTED";class Router{static go(e){e!==this.currentPath&&(-1===this.waitList.indexOf(e)&&this.waitList.push(e),setTimeout((()=>{this.load()}),0))}static load(){if(0===this.waitList.length)return;let e=this.waitList.shift();this.start(e).then((()=>{this.load()}))}static start(e){return t(this,void 0,void 0,(function*(){let t,s=this.compare(this.currentPath,e);if(null===s[0]){if(t=ModuleFactory.getMain(),this.routerKeyMap.size>0){const e=this.routerKeyMap.keys().next().value;if(e!==t.id){const s=ModuleFactory.get(e);s&&(t=s)}}}else t=yield this.getModule(s[0]);for(let e=s[1].length-1;e>=0;e--){const t=s[1][e];if(!t.module)continue;const r=yield this.getModule(t);Util.isFunction(this.onDefaultLeave)&&this.onDefaultLeave(r.model),Util.isFunction(t.onLeave)&&t.onLeave(r.model),this.activeFieldMap.delete(r.id),r.unmount()}if(0===s[2].length){let e=s[0];if(null!==e){const t=yield this.getModule(e);this.dependHandle(t,e,s[3]?s[3].module:null)}}else for(let e=0;e<s[2].length;e++){const r=s[2][e];if(!r||!r.module)continue;const i=yield this.getModule(r);this.dependHandle(i,r,t),Util.isFunction(this.onDefaultEnter)&&this.onDefaultEnter(i.model),Util.isFunction(r.onEnter)&&r.onEnter(i.model),t=i}if(0===this.startStyle){let t=(Router.basePath||"")+e;e.startsWith(this.currentPath)?history.replaceState(t,"",t):history.pushState(t,"",t)}this.currentPath=e,this.startStyle=0}))}static redirect(e){this.go(e)}static getModule(e){return t(this,void 0,void 0,(function*(){let t=e.module;return"object"==typeof t?t:("string"==typeof t&&(t=yield ModuleFactory.load(t)),"function"==typeof t&&(e.module=ModuleFactory.get(t)),e.module)}))}static compare(e,t){let s=null,r=null;e&&(s=this.getRouteList(e,!0)),t&&(r=this.getRouteList(t));let i=0;null!==s&&(i=s.length),null!==r?r.length<i&&(i=r.length):i=0;let n=[],o=[],a=0;for(a=0;a<i&&s[a].id===r[a].id;a++)if(JSON.stringify(s[a].data)!==JSON.stringify(r[a].data)){a++;break}null!==s&&(n=s.slice(a)),null!==r&&(o=r.slice(a));let l=null,d=null;if(r&&a>0)for(let e=a-1;e>=0;e--)if(l){if(!d&&r[e].module){d=r[e];break}}else if(r[e].module){l=r[e];continue}return[l,n,o,d]}static addActiveField(e,t,s,r){if(!s||!r)return;let i=Router.activeFieldMap.get(e.id);i?void 0===i.find((e=>e.model===s&&e.field===r))&&i.push({path:t,model:s,field:r}):Router.activeFieldMap.set(e.id,[{path:t,model:s,field:r}])}static dependHandle(e,t,s){const r=this;let i={path:t.path};if(Util.isEmpty(t.data)||(i.data=t.data),e.model.$route=i,s)if(s.state===exports.EModuleState.MOUNTED)e.setContainer(s.getElement(Router.routerKeyMap.get(s.id))),e.active(),this.setDomActive(s,t.fullPath);else if(s.onMount){const i=s.onMount;s.onMount=n=>{i(n),e.setContainer(s.getElement(Router.routerKeyMap.get(s.id))),e.active(),r.setDomActive(s,t.fullPath),s.onMount=i}}else s.onMount=i=>{e.setContainer(s.getElement(Router.routerKeyMap.get(s.id))),e.active(),r.setDomActive(s,t.fullPath),delete s.onMount}}static setDomActive(e,t){let s=Router.activeFieldMap.get(e.id);if(s)for(let e of s)e.model[e.field]=e.path===t}static getRouteList(e,t){if(!this.root)return[];let s=e.split("/"),r=this.root,i=0,n=[],o="",a=this.root;for(let e=0;e<s.length;e++){let l=s[e].trim();if(""===l)continue;let d=!1;for(let e=0;e<r.children.length;e++)if(r.children[e].path===l){a!==this.root&&(a.fullPath=o,a.data=r.data,n.push(a)),r=t?r.children[e].clone():r.children[e],r.data={},a=r,d=!0,i=0;break}o+="/"+l,d||i<r.params.length&&(r.data[r.params[i++]]=l)}return r!==this.root&&(r.fullPath=o,n.push(r)),n}}Router.waitList=[],Router.startStyle=0,Router.activeFieldMap=new Map,Router.routerKeyMap=new Map,Router.root=new Route,window.addEventListener("popstate",(function(e){const t=history.state;t&&(Router.startStyle=1,Router.go(t))}));class Scheduler{static dispatch(){Scheduler.tasks.forEach((e=>{Util.isFunction(e.func)&&(e.thiser?e.func.call(e.thiser):e.func())}))}static start(e){Scheduler.dispatch(),window.requestAnimationFrame?window.requestAnimationFrame(Scheduler.start):window.setTimeout(Scheduler.start,e||50)}static addTask(e,t){if(!Util.isFunction(e))throw new NError("invoke","Scheduler.addTask","0","function");Scheduler.tasks.push({func:e,thiser:t})}static removeTask(e){if(!Util.isFunction(e))throw new NError("invoke","Scheduler.removeTask","0","function");let t=-1;-1!==(t=Scheduler.tasks.indexOf(e))&&Scheduler.tasks.splice(t,1)}}function n(e,t,s){return DirectiveManager.addType(e,t,s)}Scheduler.tasks=[],exports.NodomMessage=void 0;class NError extends Error{constructor(e,t,s,r,i){super(e);let n=exports.NodomMessage.ErrorMsgs[e];if(void 0===n)return void(this.message="未知错误");let o=[n];for(let e=1;e<arguments.length;e++)o.push(arguments[e]);this.message=this.compile.apply(null,o)}compile(e,t,s,r,i,n){let o,a=arguments,l=0;for(;-1!==e.indexOf("{"+l+"}");)o=new RegExp("\\{"+l+"\\}","g"),e=e.replace(o,a[l+1]),l++;return e}}class Util{static genId(){return this.generatedId++}static initKeyMap(){["arguments","boolean","break","byte","catch","char","const","default","delete","do","double","else","enum","eval","false","float","for","function","goto","if","in","instanceof","int","let","long","null","return","short","switch","this","throw","true","try","this","throw","typeof","var","while","with","Array","Date","JSON","Set","Map","eval","Infinity","isFinite","isNaN","isPrototypeOf","Math","NaN","Number","Object","prototype","String","isPrototypeOf","undefined","valueOf"].forEach((e=>{this.keyWordMap.set(e,!0)}))}static isKeyWord(e){return this.keyWordMap.has(e)}static clone(e,t,s){let r=this,i=new WeakMap;return n(e,t,s);function n(e,t,s){if(!e||"object"!=typeof e||Util.isFunction(e))return e;let n;return e.clone&&Util.isFunction(e.clone)?e.clone(s):(r.isObject(e)?(n=new Object,i.set(e,n),Object.getOwnPropertyNames(e).forEach((r=>{t&&(t.constructor===RegExp&&t.test(r)||Util.isArray(t)&&t.includes(r))||(n[r]=o(e[r],t,s))}))):r.isMap(e)?(n=new Map,e.forEach(((e,r)=>{t&&(t.constructor===RegExp&&t.test(r)||t.includes(r))||n.set(r,o(e,t,s))}))):r.isArray(e)&&(n=new Array,e.forEach((function(e,r){n[r]=o(e,t,s)}))),n)}function o(e,t,s){if("object"==typeof e&&!Util.isFunction(e)){let r=null;return r=i.has(e)?i.get(e):n(e,t,s),r}return e}}static merge(e,t,s,r,i,n){let o=this;for(let e=0;e<arguments.length;e++)if(!this.isObject(arguments[e]))throw new NError("invoke","Util.merge",e+"","object");let a=Object.assign.apply(null,arguments);return function(e){for(let t of Object.keys(e))(o.isObject(e[t])||o.isArray(e[t]))&&(a[t]=o.clone(a[t]))}(a),a}static assign(e,t){return Object.assign?Object.assign(e,t):this.getOwnProps(t).forEach((function(s){e[s]=t[s]})),e}static compare(e,t){return function e(t,s){if(t===s)return!0;let r=Object.keys(t),i=Object.keys(s);if(r.length!==i.length)return!1;for(let i of r)if("object"==typeof t[i]&&"object"==typeof s[i]){let r=e(t[i],s[i]);if(!r)return!1}else if(t[i]!==s[i])return!1;return!0}(e,t)}static getOwnProps(e){return e?Object.getOwnPropertyNames(e):[]}static isFunction(e){return null!=e&&e.constructor===Function}static isArray(e){return Array.isArray(e)}static isMap(e){return null!=e&&e.constructor===Map}static isObject(e){return null!=e&&e.constructor===Object}static isInt(e){return Number.isInteger(e)}static isNumber(e){return"number"==typeof e}static isBoolean(e){return"boolean"==typeof e}static isString(e){return"string"==typeof e}static isNumberString(e){return/^\d+\.?\d*$/.test(e)}static isEmpty(e){if(null==e)return!0;let t=typeof e;if(this.isObject(e)){let t=Object.keys(e);if(void 0!==t)return 0===t.length}else if("string"===t)return""===e;return!1}static replaceNode(e,t){let s=e.parentNode,r=e.nextSibling;if(null===s)return;s.removeChild(e);(this.isArray(t)?t:[t]).forEach((function(e){null==r?s.appendChild(e):s.insertBefore(e,r)}))}static empty(e){let t=e.childNodes;for(let s=t.length-1;s>=0;s--)e.removeChild(t[s])}static formatDate(e,t){if(this.isString(e)){if(!/^\d+$/.test(e))throw new NError("invoke","Util.formatDate","0","date string","date");e=Number(e)}let s=new Date(e);if(isNaN(s.getDay()))throw new NError("invoke","Util.formatDate","0","date string","date");let r,i={"M+":s.getMonth()+1,"d+":s.getDate(),"h+":s.getHours(),"H+":s.getHours(),"m+":s.getMinutes(),"s+":s.getSeconds(),S:s.getMilliseconds()};return(r=/(y+)/.exec(t))&&(t=t.replace(r[0],(s.getFullYear()+"").substring(4-r[0].length))),this.getOwnProps(i).forEach((function(e){(r=new RegExp("("+e+")").exec(t))&&(t=t.replace(r[0],1===r[0].length?i[e]:("00"+i[e]).substring((i[e]+"").length)))})),t=t.replace(/(E+)/,exports.NodomMessage.WeekDays[s.getDay()+""])}static compileStr(e,t,s,r,i,n){let o,a=arguments,l=0;for(;-1!==e.indexOf("{"+l+"}");)o=new RegExp("\\{"+l+"\\}","g"),e=e.replace(o,a[l+1]),l++;return e}static apply(e,t,s){if(e)return Reflect.apply(e,t||null,s)}static mergePath(e){return e.join("/").replace(/(\/{2,})|\\\//g,"/")}static eval(e){return new Function(`return(${e})`)()}static setNodeKey(e,t,s){if(e.key=this.genUniqueKey(e.key,t),s&&e.children)for(let s of e.children)Util.setNodeKey(s,t,!0)}static setDomAsset(e,t,s){e.assets||(e.assets={}),e.assets[t]=s}static genUniqueKey(e,t){return e+"_"+t}}Util.generatedId=1,Util.keyWordMap=new Map,Util.initKeyMap();class Directive{constructor(e,t){if(this.id=Util.genId(),e&&(this.type=DirectiveManager.getType(e),!this.type))throw new NError("notexist1",exports.NodomMessage.TipWords.directive,e);Util.isString(t)?this.value=t.trim():t instanceof Expression?this.expression=t:this.value=t}exec(e,t){return!!this.disabled||(this.expression&&(this.value=this.expression.val(e,t.model)),this.type.handle.apply(this,[e,t]))}clone(){let e=new Directive;return e.type=this.type,e.expression=this.expression,e.value=this.value,e}}class NEvent{constructor(e,t,s,r){if(this.id=Util.genId(),this.module=e,this.name=t,s){let e=typeof s;if("string"===e){s.trim().split(":").forEach(((e,t)=>{if(e=e.trim(),0===t)this.handler=e;else switch(e){case"delg":this.delg=!0;break;case"nopopo":this.nopopo=!0;break;case"once":this.once=!0;break;case"capture":this.capture=!0}}))}else"function"===e&&(r=s)}if(r&&(this.handler=r),document.ontouchend)switch(this.name){case"click":this.name="tap";break;case"mousedown":this.name="touchstart";break;case"mouseup":this.name="touchend";break;case"mousemove":this.name="touchmove"}else switch(this.name){case"tap":this.name="click";break;case"touchstart":this.name="mousedown";break;case"touchend":this.name="mouseup";break;case"touchmove":this.name="mousemove"}}setParam(e,t,s,r){e.objectManager.setEventParam(this.id,t.key,s,r)}getParam(e,t,s){return e.objectManager.getEventParam(this.id,t.key,s)}removeParam(e,t,s){return e.objectManager.removeEventParam(this.id,t.key,s)}clearParam(e,t){e.objectManager.clearEventParam(this.id,t.key)}}class VirtualDom{constructor(e,t,s){this.allModelField=!0,this.selfClosed=!1,this.key=t||(s?s.getDomKeyId():Util.genId()),this.staticNum=1,e&&(this.tagName=e)}removeDirectives(e){this.directives&&e.forEach((e=>{this.removeDirective(e)}))}removeDirective(e){if(!this.directives)return;let t;-1!==(t=this.directives.findIndex((t=>t.type.name===e)))&&this.directives.splice(t,1),0===this.directives.length&&delete this.directives}addDirective(e,t){if(this.directives){if(this.directives.find((t=>t.type.name===e.type.name)))return}else this.directives=[];this.directives.push(e),t&&this.sortDirective()}sortDirective(){this.directives&&this.directives.length>1&&this.directives.sort(((e,t)=>DirectiveManager.getType(e.type.name).prio<DirectiveManager.getType(t.type.name).prio?-1:1))}hasDirective(e){return this.directives&&-1!==this.directives.findIndex((t=>t.type.name===e))}getDirective(e){if(this.directives)return this.directives.find((t=>t.type.name===e))}add(e,t){this.children||(this.children=[]),t?this.children.splice(t,0,e):this.children.push(e),e.parent=this}remove(e){let t=this.children.indexOf(e);-1!==t&&this.children.splice(t,1)}addClass(e){if(this.addProp("class",e),this.removedClassMap&&this.removedClassMap.size>0){let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.delete(e)}}removeClass(e){if(!this.getProp("class"))return;this.removedClassMap||(this.removedClassMap=new Map);let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.set(e,!0);this.setStaticOnce()}getClassString(e){let t=[];for(let s of e){let e=s.trim().split(/\s+/);for(let s of e)this.removedClassMap&&this.removedClassMap.has(s)||t.includes(s)||t.push(s)}if(t.length>0)return t.join(" ")}addStyle(e){if(this.addProp("style",e),"string"==typeof e&&this.removedStyleMap&&this.removedStyleMap.size>0){let t=e.trim().split(/\s*;\s*/);for(let e of t){if(""===e)continue;let t=e.split(/\s*:\s*/);""!==t[0].trim()&&this.removedClassMap.delete(t[0].trim())}}this.setStaticOnce()}removeStyle(e){this.removedClassMap||(this.removedClassMap=new Map);let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.set(e,!0);this.setStaticOnce()}getStyleString(e){let t=new Map;for(let s of e){let e=s.trim().split(/\s*;\s*/);for(let s of e){if(""===s)continue;let e=s.split(/\s*:\s*/);this.removedStyleMap&&this.removedStyleMap.has(e[0])||t.set(e[0],e[1])}}if(t.size>0)return[...t].map((e=>e.join(":"))).join(";")}hasProp(e){if(this.props)return this.props.has(e)}getProp(e,t){if(this.props)return this.props.get(e)}setProp(e,t){this.props||(this.props=new Map),"style"===e?this.removedStyleMap&&this.removedStyleMap.clear():"class"===e&&this.removedClassMap&&this.removedClassMap.clear(),this.props.set(e,t),this.setStaticOnce()}addProp(e,t){let s=this.getProp(e);if(s)if(Array.isArray(s)){if(s.includes(t))return!1;s.push(t)}else{if(s===t)return!1;this.setProp(e,[s,t])}else this.setProp(e,t);return!0}delProp(e){if(this.props){if(Util.isArray(e))for(let t of e)this.props.delete(t);else this.props.delete(e);this.setStaticOnce()}}setAsset(e,t){this.assets||(this.assets=new Map),this.assets.set(e,t),this.setStaticOnce()}delAsset(e){this.assets&&(this.assets.delete(e),this.setStaticOnce())}setParam(e,t,s){e.objectManager.setDomParam(this.key,t,s)}getParam(e,t){return e.objectManager.getDomParam(this.key,t)}removeParam(e,t){e.objectManager.removeDomParam(this.key,t)}setStaticOnce(){-1!==this.staticNum&&(this.staticNum=1)}clone(){let e=new VirtualDom(this.tagName,this.key);if(this.tagName){if(this.props&&this.props.size>0)for(let t of this.props)e.setProp(t[0],t[1]);if(this.assets&&this.assets.size>0)for(let t of this.assets)e.setAsset(t[0],t[1]);if(this.directives&&this.directives.length>0){e.directives=[];for(let t of this.directives)e.directives.push(t.clone())}if(e.events=this.events,this.children)for(let t of this.children)e.add(t.clone())}else e.expressions=this.expressions,e.textContent=this.textContent;return e.staticNum=this.staticNum,e}addEvent(e){this.events?this.events.includes(e)||this.events.push(e):this.events=[e]}}const o=new Set("area,base,br,col,embed,hr,img,input,link,meta,param,source,track,wbr".split(","));class Compiler{constructor(e){this.domArr=[],this.textArr=[],this.isExprText=!1,this.template="",this.module=e}compile(e){if(!e)return;if(this.template=e.replace(/\<\!\-\-[\s\S]*?\-\-\>/g,"").trim(),e=this.template,this.compileTemplate(e),0===this.domArr.length)throw new NError("wrongTemplate");for(let e=this.domArr.length-1;e>=1;e--)if(!this.domArr[e].isClosed&&(void 0!==this.domArr[e].tagName&&this.warnStartTagNotClose(this.domArr[e]),!this.domArr[e-1].isClosed)){this.domArr[e].isClosed=!0;let t=this.domArr.pop();this.domArr[e-1].add(t)}let t;if(this.domArr[this.domArr.length-1].isClosed||(this.domArr[this.domArr.length-1].isClosed=!0,this.warnStartTagNotClose(this.domArr[this.domArr.length-1])),this.domArr.length>1)t=new VirtualDom("div",this.genKey(),this.module),this.domArr.forEach((e=>{t.add(e)})),t.isClosed=!0;else{if(1!=this.domArr.length)throw new NError("wrongTemplate");this.domArr[0].tagName&&!this.domArr[0].hasDirective("module")?t=this.domArr[0]:(t=new VirtualDom("div",this.genKey(),this.module),t.add(this.domArr[0]),t.isClosed=!0)}return t}genKey(){return this.module.getDomKeyId()}compileTemplate(e){for(;0!==e.length;)e=e.startsWith("<")?"/"==e[1]?this.compileEndTag(e):this.compileStartTag(e):this.compileText(e)}compileStartTag(e){const t=/^<\s*([a-z][^\s\/\>]*)/i.exec(e);if(!t)return this.textArr.push(e[0]),e.substring(1);if(this.current=new VirtualDom(t[1].toLowerCase(),this.genKey(),this.module),this.domArr.push(this.current),this.current.tagStartPos=this.template.length-e.length,e=e.substring(t.index+t[0].length).trimStart(),(e=this.compileAttributes(e)).startsWith(">"))return this.current.tagEndPos=this.template.length-e.substring(1).length,this.isVoidTag(this.current)&&(this.current.selfClosed||this.warnStartTagNotClose(this.current),this.handleSelfClosingTag()),e.substring(1).trimStart();throw new NError("needEndTag",this.current.tagName)}compileAttributes(e){for(;0!=e.length&&!e.startsWith(">");){const t=/^(\/|\$?[a-z_][\w-]*)(?:\s*=\s*((?:'[^']*')|(?:"[^"]*")|(?:`[^`]*`)|(?:{{[^}}]*}})))?/i.exec(e);if(t){let e="$"!==t[1][0]?t[1].toLowerCase():t[1];if("/"===e)this.handleSelfClosingTag(),this.current.selfClosed=!0;else{let s=t[2]?t[2].startsWith('"')||t[2].startsWith("'")?t[2].substring(1,t[2].length-1):t[2]:void 0;s&&s.startsWith("{{")&&(s=new Expression(s.substring(2,s.length-2)),this.current.staticNum=-1),e.startsWith("x-")?this.current.addDirective(new Directive(e.substring(2),s)):e.startsWith("e-")?this.current.addEvent(new NEvent(this.module,e.substring(2),s)):this.current.setProp(e,s)}}if(!t){if(this.current)throw new NError("tagError",this.current.tagName);throw new NError("wrongTemplate")}e=e.substring(t.index+t[0].length).trimStart()}return e}compileEndTag(e){const t=/^<\/\s*([a-z][^\>]*)/i.exec(e);if(!t)throw new NError("needEndTag",this.current.tagName);{const s=t[1].toLowerCase().trim();if(!this.current||this.current.tagName!==s){if(0===this.domArr.length)this.warnEndTagNotMatch(s,e);else{let t=0;for(let e=this.domArr.length-1;e>=1;e--)if(!this.domArr[e].isClosed&&s===this.domArr[e].tagName){t=e;break}if(0!==t){for(let e=this.domArr.length-1;e>=t;e--)if(void 0!==this.domArr[e].tagName&&e!==t&&this.warnStartTagNotClose(this.domArr[e]),!this.domArr[e-1].isClosed){this.domArr[e].isClosed=!0;let t=this.domArr.pop();this.domArr[e-1].add(t)}this.current=void 0}else this.warnEndTagNotMatch(s,e)}return e.substring(t.index+t[0].length+1)}if(this.domArr.length<1)return e.substring(t.index+t[0].length+1);if(1==this.domArr.length)this.handleCloseTag(),this.current=void 0;else{let e=this.domArr.pop();this.handleCloseTag(),this.current=this.domArr[this.domArr.length-1].isClosed?void 0:this.domArr[this.domArr.length-1],this.current?this.current.add(e):this.domArr.push(e)}}return e.substring(t.index+t[0].length+1).trimStart()}compileText(e){for(;!e.startsWith("<")&&0!==e.length;)if(e.startsWith("{")){const t=/^{{([\s\S]*?)}}/i.exec(e);t?(this.textArr.push(new Expression(t[1])),this.isExprText=!0,e=e.substring(t.index+t[0].length)):("string"==typeof this.textArr[this.textArr.length]?this.textArr[this.textArr.length]+="{":this.textArr.push("{"),e=e.substring(1))}else{const t=/([^\<\{]*)/.exec(e);if(t){let s;s=(this.current&&this.current.tagName,this.preHandleText(e.substring(0,t.index+t[0].length))),this.textArr.push(s)}e=e.substring(t.index+t[0].length)}let t=new VirtualDom(void 0,this.genKey());return this.isExprText?(t.expressions=[...this.textArr],t.staticNum=-1):t.textContent=this.textArr.join(""),this.current?(this.isExprText||0!==t.textContent.length)&&this.current.add(t):(this.isExprText||0!==t.textContent.trim().length)&&this.domArr.push(t),t.isClosed=!0,this.isExprText=!1,this.textArr=[],e}preHandleText(e){if(/&[a-z]+;/.test(e)){let t=document.createElement("div");return t.innerHTML=e,t.textContent+""}return e}postHandleNode(){let e=DefineElementManager.get(this.current.tagName);e&&Reflect.construct(e,[this.current,this.module]);const t=this.current;if(ModuleFactory.hasClass(t.tagName)){const e=new Directive("module",t.tagName);e.params={srcId:this.module.id},t.addDirective(e),t.tagName="div"}}handleSlot(){let e,t=this.current;if(t.children&&0!==t.children.length&&t.hasDirective("module"))for(let s=0;s<t.children.length;s++){let r=t.children[s];r.hasDirective("slot")||(e?t.children.splice(s--,1):(e=new VirtualDom("div",this.genKey()),e.addDirective(new Directive("slot")),t.children.splice(s,1,e)),e.add(r))}}handleCloseTag(){this.postHandleNode(),this.current.sortDirective(),this.handleSlot(),this.current.isClosed=!0}handleSelfClosingTag(){this.postHandleNode(),this.current.sortDirective(),this.domArr.length>1?(this.domArr.pop(),this.domArr[this.domArr.length-1].add(this.current),this.current=this.domArr[this.domArr.length-1]):this.current=void 0}warnEndTagNotMatch(e,t){console.warn(`[Nodom warn]: 模块 %c${this.module.constructor.name}%c 中 </${e}> 未匹配到对应的开始标签。\n      \n\t ${this.template.substring(0,this.template.length-t.length)}%c</${e}>%c${t.substring(e.length+3)}`,"color:red;font-weight:bold;","","color:red;font-weight:bold;","")}warnStartTagNotClose(e){console.warn(`[Nodom warn]: 模块：%c${this.module.constructor.name}%c 中 ${e.tagName} 标签未闭合！ \n\t ${this.template.substring(0,e.tagStartPos)}%c${this.template.substring(e.tagStartPos,e.tagEndPos)}%c${this.template.substring(e.tagEndPos)}`,"color:red;font-weight:bold;","","color:red;font-weight:bold;","")}isVoidTag(e){return o.has(e.tagName)}}class DiffTool{static compare(e,t){const s=[];return r(e,t),s;function r(e,t){e.tagName?e.tagName!==t.tagName?i(5,e,t,t.parent):((e.staticNum||t.staticNum)&&function(e,t){for(let s of["props","assets"]){if(!e[s]&&t[s]||e[s]&&!t[s])return!0;if(e[s]&&t[s]){let r=Object.keys(e[s]),i=Object.keys(t[s]);if(r.length!==i.length)return!0;for(let i of r)if(e[s][i]!==t[s][i])return!0}}return!1}(e,t)&&i(2,e,null,t.parent),e.moduleId||function(e,t){if(e.children&&0!==e.children.length)if(t.children&&0!==t.children.length){let n={},[o,a,l,d]=[0,e.children.length-1,0,t.children.length-1],[h,c,u,p]=[e.children[o],e.children[a],t.children[l],t.children[d]];for(;o<=a&&l<=d;)u.key===h.key?(r(h,u),o!==l&&i(4,h,null,t,o),h=e.children[++o],u=t.children[++l]):p.key===c.key?(r(c,p),d!==a&&i(4,c,null,t,a),c=e.children[--a],p=t.children[--d]):h.key===p.key?(r(h,p),o!==d&&i(4,h,null,t,o),h=e.children[++o],p=t.children[--d]):c.key===u.key?(r(c,u),a!==l&&i(4,c,null,t,a),c=e.children[--a],u=t.children[++l]):(n[h.key]=i(1,h,null,t,o),h=e.children[++o]);if(o<=a)for(let s=o;s<=a;s++)i(1,e.children[s],null,t,s);if(l<=d)for(let e=l,o=e;e<=d;e++,o++){let a=t.children[e];if(n.hasOwnProperty(a.key)){let e=n[a.key];if(o!==e[4])e[0]=4,r(e[1],a);else{let t;-1!==(t=s.findIndex((t=>t[1].key===e[1].key)))&&s.splice(t,1)}}else i(3,a,null,t),o--}}else e.children.forEach(((e,s)=>i(1,e,null,t,s)));else t.children&&t.children.length>0&&t.children.forEach((e=>i(3,e,null,t)))}(e,t)):t.tagName?i(5,e,t,t.parent):(e.staticNum||t.staticNum)&&e.textContent!==t.textContent?i(2,e,null,t.parent):e.moduleId!==t.moduleId&&i(5,e,t,t.parent)}function i(e,t,r,i,n){const o=[e,t,r,i,n];return s.push(o),o}}}class DefineElement{constructor(e){e.hasProp("tag")?(e.tagName=e.getProp("tag"),e.delProp("tag")):e.tagName="div"}}class EventManager{static handleExtendEvent(e,t,s){let r=this.get(s.name);if(!r)return!1;for(let i of Object.keys(r)){let n=new NEvent(e,i,r[i]);n.capture=s.capture,n.nopopo=s.nopopo,n.delg=s.delg,n.once=s.once,n.dependEvent=s,e.eventFactory.addEvent(t,n)}return!0}static regist(e,t){this.extendEventMap.set(e,t)}static unregist(e){return this.extendEventMap.delete(e)}static get(e){return this.extendEventMap.get(e)}}EventManager.extendEventMap=new Map;class EventFactory{constructor(e){this.module=e,this.eventMap=new Map,this.addedEvents=new Map}addEvent(e,t){const s=e.key;this.addedEvents.has(s)&&this.addedEvents.get(s).includes(t)||(t.delg&&(e.parent?this.addToArr(e.parent.key,t,e.key):t.delg=!1),t.delg||this.addToArr(e.key,t),this.addedEvents.has(s)?this.addedEvents.get(s).push(t):this.addedEvents.set(s,[t]))}addToArr(e,t,s){let r,i,n;this.eventMap.has(e)?r=this.eventMap.get(e):(r={bindMap:{}},this.eventMap.set(e,r)),r[t.name]||(r[t.name]={delg:[],own:[]}),s?(i="delg",n={key:s,event:t}):(i="own",n=t,r[t.name].capture=t.capture||!1),r[t.name][i].push(n)}getEvent(e){return this.eventMap.get(e)}removeEvent(e,t){if(!this.addedEvents.has(e.key)||!this.addedEvents.get(e.key).includes(t))return;const s=this.addedEvents.get(e.key);if(s.splice(s.indexOf(t),1),t.delg){if(!e.parent||!this.eventMap.has(e.parent.key))return;let s=this.eventMap.get(e.parent.key);if(!s[t.name])return;let r=s[t.name],i=r.delg.findIndex((s=>s.key===e.key&&s.event===t));-1!==i&&(r.delg.splice(i,1),0===r.delg.length&&0===r.own.length&&this.unbind(e.parent.key,t.name))}else{let s=this.eventMap.get(e.key);if(!s[t.name])return;let r=s[t.name],i=r.own.findIndex((e=>e===t));-1!==i&&(r.own.splice(i,1),0===r.delg.length&&0===r.own.length&&this.unbind(e.key,t.name))}}bind(e){if(!this.eventMap.has(e.key))return;const t=this.module.getElement(e.key),s=this.eventMap.get(e.key);for(let e of Object.keys(s))"bindMap"!==e&&(t.addEventListener(e,i,s[e].capture),s.bindMap[e]={handler:i,capture:s[e].capture});const r=this;function i(e){r.handler.apply(r,[r.module,e])}}unbind(e,t){if(!this.eventMap.has(e))return;const s=this.eventMap.get(e);if(!s.bindMap||!s[t])return;const r=this.module.getElement(e),i=s.bindMap[t];r&&i&&r.removeEventListener(t,i.handler,i.capture),delete s.bindMap[t]}unbindAll(e){if(!this.eventMap.has(e))return;const t=this.eventMap.get(e);if(!t.bindMap)return;const s=this.module.getElement(e);if(s)for(let e of Object.keys(t.bindMap)){const r=t.bindMap[e];s.removeEventListener(e,r.handler,r.capture)}t.bindMap={}}hasEvent(e){return this.eventMap.has(e)}clear(){for(let e of this.addedEvents.keys())this.unbindAll(e);this.addedEvents.clear(),this.eventMap.clear()}handler(e,t){let s=t.currentTarget;const r=s.key,i=e.domManager.getRenderedDom(r);if(!i)return;const n=this.eventMap.get(r);if(!n||!n[t.type])return;const o=n[t.type];function a(s){if(!s)return;let r=!1;for(let n=0;n<s.length;n++){const o=s[n];"string"==typeof o.handler?e.invokeMethod(o.handler,i.model,i,o,t):"function"==typeof o.handler&&o.handler.apply(e,[i.model,i,o,t]),o.once&&s.splice(n--,1),r=o.nopopo}r&&t.stopPropagation()}function l(r){if(!r)return!1;const i=t.path||(t.composedPath?t.composedPath():[]);let n=!1;for(let o=0;o<r.length;o++){const a=r[o],l=a.event;for(let d=0;d<i.length&&i[d]!==s;d++){const s=i[d].key;if(s===a.key){const i=e.domManager.getRenderedDom(s);if("string"==typeof l.handler?e.invokeMethod(l.handler,i.model,i,l,t):"function"==typeof l.handler&&l.handler.apply(e,[i.model,i,l,t]),n=l.nopopo,l.once){r.splice(o--,1);const t=e.eventFactory.get(s).indexOf(l);e.eventFactory.get(s).splice(t,1)}break}}}return n}o.capture?(a(o.own),l(o.delg)):l(o.delg)||a(o.own)}}class NCache{constructor(){this.subscribeMap=new Map,this.cacheData={}}get(e){let t=this.cacheData;if(-1!==e.indexOf(".")){let s=e.split(".");if(s.length>1){for(let e=0;e<s.length-1&&t;e++)t=t[s[e]];t&&(e=s[s.length-1])}}if(t)return t[e]}set(e,t){let s=this.cacheData,r=e;if(-1!==e.indexOf(".")){let t=e.split(".");if(t.length>1){for(let e=0;e<t.length-1;e++)s[t[e]]&&"object"==typeof s[t[e]]||(s[t[e]]={}),s=s[t[e]];e=t[t.length-1]}}if(s&&(s[e]=t),this.subscribeMap.has(r)){let e=this.subscribeMap.get(r);for(let s of e)this.invokeSubscribe(s.module,s.handler,t)}}remove(e){let t=this.cacheData;if(-1!==e.indexOf(".")){let s=e.split(".");if(s.length>1){for(let e=0;e<s.length-1&&t;e++)t=t[s[e]];t&&(e=s[s.length-1])}}t&&delete t[e]}subscribe(e,t,s){if(this.subscribeMap.has(t)){let r=this.subscribeMap.get(t);r.find((t=>t.module===e&&t.handler===s))||r.push({module:e,handler:s})}else this.subscribeMap.set(t,[{module:e,handler:s}]);let r=this.get(t);r&&this.invokeSubscribe(e,s,r)}invokeSubscribe(e,t,s){"string"==typeof t?e.invokeMethod(t,s):t.call(e,s)}}class GlobalCache{static set(e,t){this.cache.set(e,t)}static get(e){return this.cache.get(e)}static subscribe(e,t,s){this.cache.subscribe(e,t,s)}static remove(e){this.cache.remove(e)}}GlobalCache.cache=new NCache;class Model{constructor(e,t,s,r){if(!e||e.__source)return;let i=new Proxy(e,{set(e,s,r,i){let n=r;if(r&&r.__source){const e=r.__source;e&&(r.__module!==t&&(t.modelManager.add(e,r),r.__module.modelManager.bindModel(r,t),t.modelManager.setModelName(r,s)),n=e)}if(e[s]===n)return!0;let o=e[s],a=Reflect.set(e,s,n,i);return t.modelManager.update(i,s,o,r),a},get(e,i,n){if("__source"===i)return n?e:void 0;if("__module"===i)return n?t:void 0;if("__key"===i)return n?t.modelManager.getModelKey(e):void 0;if("__parent"===i)return s;if("__name"===i)return r;let o=Reflect.get(e,i,n);if(o&&(o.constructor===Object||o.constructor===Array)){let e=t.modelManager.getModel(o);e||(e=new Model(o,t,n,i)),o=e}return o},deleteProperty(e,s){let r=e[s];return delete e[s],t.modelManager.update(i,s,r,void 0),!0}});return t.modelManager.add(e,i),i}}class ModelManager{constructor(e){this.dataMap=new WeakMap,this.nameMap=new WeakMap,this.watchMap=new WeakMap,this.hasDeepWatch=!1,this.bindMap=new WeakMap,this.module=e}getModel(e){return this.dataMap.has(e)?this.dataMap.get(e).model:void 0}getModelKey(e){return this.dataMap.has(e)?this.dataMap.get(e).key:void 0}setModelName(e,t){this.nameMap.has(e)||this.nameMap.set(e,t)}getModelName(e){return this.nameMap.get(e)}add(e,t){this.dataMap.has(e)||this.dataMap.set(e,{model:t,key:t.__key||Util.genId()})}bindModel(e,t){e&&function e(t,s,r){if(s.__module===r)return;let i;t.has(s)?i=t.get(s):(i=[],t.set(s,i));i.includes(r.id)||i.push(r.id);for(let i of Object.keys(s))s[i]&&"object"==typeof s[i]&&e(t,s[i],r)}(this.bindMap,e,t)}update(e,t,s,r){if(i(this.module,e),Renderer.add(this.module),this.bindMap.has(e))for(let t of this.bindMap.get(e)){const s=ModuleFactory.get(t);s&&(i(s,e),Renderer.add(s))}function i(e,i){const n=e.modelManager.watchMap;let o=n.get(i);if(o&&o[t])o[t].f.call(e,i,t,s,r);else if(e.modelManager.hasDeepWatch)for(let o=i;o&&o.__parent;o=o.__parent){let a=o.__parent.__module===e?o.__parent:e.model;if(!n.has(a))continue;const l=n.get(a),d=e.modelManager.getModelName(o)||o.__name;if(l&&l[d]){let n=l[d];if(n.deep){n.f.call(e,i,t,s,r);break}}}}}watch(e,t,s,r){if(!s||"function"!=typeof s)return;const i=this;this.hasDeepWatch=r;let n=[];if(Array.isArray(t))for(let r of t)o(e,r,s);else o(e,t,s);return()=>{if(Array.isArray(n)){for(let e of n){let t=i.watchMap.get(e.m);t&&(delete t[e.k],0===Object.keys(t).length&&i.watchMap.delete(e.m))}n=null}};function o(e,t,s){if(!e||"object"!=typeof e)return;let o;if(-1!==(o=t.lastIndexOf("."))&&(e=i.get(e,t.substring(0,o)),t=t.substring(o+1),!e||"object"!=typeof e))return;i.watchMap.has(e)||i.watchMap.set(e,{});i.watchMap.get(e)[t]={f:s,deep:r},n.push({m:e,k:t})}}get(e,t){if(t){if(-1!==t.indexOf(".")){let s=t.split(".");for(let t=0;t<s.length-1&&(e=e[s[t]]);t++);if(!e)return;t=s[s.length-1]}e=e[t]}return e}set(e,t,s){if(-1!==t.indexOf(".")){let s=t.split(".");for(let t=0;t<s.length-1;t++)e[s[t]]||(e[s[t]]={}),e=e[s[t]];t=s[s.length-1]}e[t]=s}}class ObjectManager{constructor(e){this.module=e,this.cache=new NCache}set(e,t){this.cache.set(e+"",t)}get(e){return this.cache.get(e)}remove(e){this.cache.remove(e)}setEventParam(e,t,s,r){this.cache.set("$events."+e+".$params."+t+"."+s,r)}getEventParam(e,t,s){return this.get("$events."+e+".$params."+t+"."+s)}removeEventParam(e,t,s){this.remove("$events."+e+".$params."+t+"."+s)}clearEventParam(e,t){t?this.remove("$events."+e+".$params."+t):this.remove("$events."+e+".$params")}setDomParam(e,t,s){this.set("$domparam."+e+"."+t,s)}getDomParam(e,t){return this.get("$domparam."+e+"."+t)}removeDomParam(e,t){this.remove("$domparam."+e+"."+t)}clearDomParams(e){this.remove("$domparam."+e)}clearAllDomParams(){this.remove("$domparam")}}class DomManager{constructor(e){this.elementMap=new Map,this.module=e}getOriginDom(e){return this.vdomTree?function t(s){if(s.key===e)return s;if(s.children)for(let e of s.children){let s=t(e);if(s)return s}}(this.vdomTree):null}getRenderedDom(e){if(this.renderedTree)return function e(t,s){if(t.key===s)return t;if(t.children)for(let r of t.children){if(!r)continue;let t=e(r,s);if(t)return t}}(this.renderedTree,e)}cloneRenderedDom(e,t){let s;if(s="string"==typeof e?this.getRenderedDom(e):e,!s)return null;let r={key:e,vdom:s.vdom,tagName:s.tagName,staticNum:s.staticNum,textContent:s.textContent,moduleId:s.moduleId};if(s.props){r.props={};for(let e of Object.keys(s.props))r.props[e]=s.props[e]}if(s.assets){r.assets={};for(let e of Object.keys(s.assets))r.assets[e]=s.assets[e]}if(t&&s.children){r.children=[];for(let e of s.children)r.children.push(this.cloneRenderedDom(e))}return r}clearElementMap(e){e?(this.elementMap.delete(e.key),e.props&&e.props.key&&this.elementMap.delete(e.props.key)):this.elementMap.clear()}getElement(e){return this.elementMap.get(e)}saveElement(e,t){this.elementMap.set(e,t)}freeNode(e){if(e.moduleId){let t=ModuleFactory.get(e.moduleId);t&&t.unmount()}else if(this.clearElementMap(e),this.module.eventFactory.unbindAll(e.key),e.children)for(let t of e.children)this.freeNode(t)}reset(){this.renderedTree=null,this.elementMap.clear()}}DefineElementManager.add([class MODULE extends DefineElement{constructor(e,t){super(e);let s=e.getProp("name");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"MODULE","className");e.delProp("name"),e.addDirective(new Directive("module",s))}},class FOR extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"FOR","cond");e.delProp("cond"),e.addDirective(new Directive("repeat",s))}},class IF extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"IF","cond");e.delProp("cond"),e.addDirective(new Directive("if",s))}},class RECUR extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");e.delProp("cond"),e.addDirective(new Directive("recur",s))}},class ELSE extends DefineElement{constructor(e,t){super(e),e.addDirective(new Directive("else",null))}},class ELSEIF extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"ELSEIF","cond");e.delProp("cond"),e.addDirective(new Directive("elseif",s))}},class ENDIF extends DefineElement{constructor(e,t){super(e),e.addDirective(new Directive("endif",null))}},class SLOT extends DefineElement{constructor(e,t){super(e);let s=e.getProp("name")||"default";e.delProp("name"),e.addDirective(new Directive("slot",s))}}]),n("module",(function(e,t){let s,r=e.objectManager.getDomParam(t.key,"moduleId");if(r)s=ModuleFactory.get(r);else{let i=this.value;if("string"==typeof i&&(i=i.toLocaleLowerCase()),s=ModuleFactory.get(i),!s)return!0;this.params&&this.params.srcId&&(s.compileMid=this.params.srcId),r=s.id,e.objectManager.setDomParam(t.key,"moduleId",r),e.addChild(s)}t.moduleId=r,delete t.tagName;let i={};if(t.props)for(let e of Object.keys(t.props)){let s=t.props[e];"$"===e[0]?(i.$data||(i.$data={}),i.$data[e.substring(1)]=s,delete t.props[e]):i[e]=s}return s.setProps(i,t),!0}),8),n("model",(function(e,t){let s=e.get(this.value,t.model);return s&&(t.model=s),!0}),1),n("repeat",(function(e,t){let s=this.value;if(!Util.isArray(s)||0===s.length)return!1;const r=t.vdom,i=r.getProp("index"),n=t.parent;this.disabled=!0,delete r.model;for(let t=0;t<s.length;t++){if(!s[t])continue;i&&(s[t][i]=t),r.staticNum++;let o=Renderer.renderDom(e,r,s[t],n,s[t].__key);i&&delete o.props.index}return this.disabled=!1,!1}),2),n("recur",(function(e,t){const s=t.vdom;if(t.props.hasOwnProperty("ref")){s.children=[];const r="$recurs."+(t.props.ref||"default");let i=e.objectManager.get(r);if(!i)return!0;let n=t.model[i.getDirective("recur").value];if(!n)return!0;let o=i.clone();Array.isArray(n)||(o.model=n,Util.setNodeKey(o,n.__key,!0)),s.children=[o],o.parent=s}else{if(!t.model[this.value])return!0;const r="$recurs."+(t.props.name||"default");e.objectManager.get(r)||e.objectManager.set(r,s)}return!0}),2),n("if",(function(e,t){if(t.parent)return e.objectManager.setDomParam(t.parent.key,"$if",this.value),this.value}),5),n("else",(function(e,t){if(t.parent)return!e.objectManager.getDomParam(t.parent.key,"$if")}),5),n("elseif",(function(e,t){if(t.parent)return!0!==e.objectManager.getDomParam(t.parent.key,"$if")&&!!this.value&&(e.objectManager.setDomParam(t.parent.key,"$if",!0),!0)}),5),n("endif",(function(e,t){if(t.parent)return e.objectManager.removeDomParam(t.parent.key,"$if"),!1}),5),n("show",(function(e,t){let s=e.objectManager.getDomParam(t.key,"$show");if(!(this.value||s&&s.rendered))return!1;s||(s={},e.objectManager.setDomParam(t.key,"$show",s));let r,i,n=t.props.style;return n&&(r=/display\s*\:[\w\-]+/.exec(n),null!==r)&&(i=r[0].split(":")[1].trim(),s.origin||"none"===i||(s.origin=i)),this.value?(s.rendered=!0,"none"===i&&(n=s.origin?n.substring(0,r.index)+"display:"+s.origin+n.substring(r.index+r[0].length):n.substring(0,r.index)+n.substring(r.index+r[0].length))):n?i?"none"!==i&&(n=n.substring(0,r.index)+"display:none"+n.substring(r.index+r[0].length)):n+=";display:none":n="display:none",n&&(t.props.style=n),!0}),5),n("field",(function(e,t){const s=t.props.type||"text",r=t.tagName.toLowerCase(),i=t.model;if(!i)return!0;let n=e.get(this.value,i);if("radio"===s)n==t.props.value?(t.props.checked="checked",Util.setDomAsset(t,"checked",!0)):(delete t.props.checked,Util.setDomAsset(t,"checked",!1));else if("checkbox"===s){let e=t.props["yes-value"];n==e?(t.props.value=e,Util.setDomAsset(t,"checked",!0)):(t.props.value=t.props["no-value"],Util.setDomAsset(t,"checked",!1))}else if("select"===r)t.props.value=n,Util.setDomAsset(t,"value",n);else{let e=null!=n?n:"";t.props.value=e,Util.setDomAsset(t,"value",e)}let o=GlobalCache.get("$fieldChangeEvent");return o||(o=new NEvent(null,"change",(function(e,t){const s=this.getElement(t.key);if(!s)return;let r=t.vdom.getDirective("field"),i=t.props.type,n=r.value,o=s.value;"checkbox"===i?o=t.props["yes-value"]==o?t.props["no-value"]:t.props["yes-value"]:"radio"===i&&(s.checked||(o=void 0));let a=n.split(".");if(1===a.length)e[n]=o;else{let t=e;n=a.pop();for(let e=0;e<a.length&&t;e++)t=t[a[e]];t&&(t[n]=o)}})),GlobalCache.set("$fieldChangeEvent",o)),t.vdom.addEvent(o),!0}),10),n("route",(function(e,t){if("a"===t.tagName.toLowerCase()&&(t.props.href="javascript:void(0)"),t.props.path=this.value,t.props.active){let s=t.props.active;delete t.props.active,Router.addActiveField(e,this.value,t.model,s),(Router.currentPath&&this.value.startsWith(Router.currentPath)||!Router.currentPath)&&t.model[s]&&Router.go(this.value)}let s=GlobalCache.get("$routeClickEvent");return s||(s=new NEvent(null,"click",(function(e,t,s,r){let i=t.props.path;Util.isEmpty(i)||Router.go(i)})),GlobalCache.set("$routeClickEvent",s)),t.vdom.addEvent(s),!0}),10),n("router",(function(e,t){return Router.routerKeyMap.set(e.id,t.key),!0}),10),n("slot",(function(e,t){this.value=this.value||"default";let s=t.parent.moduleId;const r=t.vdom;if(s){let e=ModuleFactory.get(s);e&&e.objectManager.set("$slots."+this.value,{dom:r,model:t.model})}else{const s=e.objectManager.get("$slots."+this.value),i=s?s.dom.children:r.children;if(i)for(let n of i){let i;r.hasProp("innerrender")?i=t.model:s&&(i=s.model,i.__module.modelManager.bindModel(i,e)),Renderer.renderDom(e,n,i,t.parent,r.key+"s")}}return!1}),5),n("animation",(function(e,t){var s,r,i,n,o,a,l,d,h,c,u,p,m,f,g,v,y,M,E,w;const x=this.value;if(!Util.isObject(x))return new Error("未找到animation配置对象");const b=0!=x.tigger,k=x.type||"transition",D=0!=x.isAppear,N=(null===(s=x.name)||void 0===s?void 0:s.enter)||x.name,C=(null===(r=x.name)||void 0===r?void 0:r.leave)||x.name,T=(null===(i=x.duration)||void 0===i?void 0:i.enter)||x.duration||"",P=(null===(n=x.duration)||void 0===n?void 0:n.leavr)||x.duration||"",A=(null===(o=x.delay)||void 0===o?void 0:o.enter)||x.delay||"0s",S=(null===(a=x.delay)||void 0===a?void 0:a.leave)||x.delay||"0s",R=(null===(l=x.timingFunction)||void 0===l?void 0:l.enter)||x.timingFunction||"ease",O=(null===(d=x.timingFunction)||void 0===d?void 0:d.leave)||x.timingFunction||"ease",F=(null===(c=null===(h=x.hooks)||void 0===h?void 0:h.enter)||void 0===c?void 0:c.before)?x.hooks.enter.before:(null===(u=x.hooks)||void 0===u?void 0:u.before)||void 0,j=(null===(m=null===(p=x.hooks)||void 0===p?void 0:p.enter)||void 0===m?void 0:m.after)?x.hooks.enter.after:(null===(f=x.hooks)||void 0===f?void 0:f.after)||void 0,U=(null===(v=null===(g=x.hooks)||void 0===g?void 0:g.leave)||void 0===v?void 0:v.before)?x.hooks.leave.before:(null===(y=x.hooks)||void 0===y?void 0:y.before)||void 0,L=(null===(E=null===(M=x.hooks)||void 0===M?void 0:M.leave)||void 0===E?void 0:E.after)?x.hooks.leave.after:(null===(w=x.hooks)||void 0===w?void 0:w.after)||void 0;let $=()=>{const s=e.getElement(t.key);b?(j&&j.apply(e.model,[e]),s.classList.remove(N+"-enter-active"),"animation"==k&&s.classList.add(N+"-enter-to")):(D&&(s.style.display="none"),L&&L.apply(e.model,[e]),[s.style.width,s.style.height]=function(e){const t=e.vdom.getProp("style");let s,r;if(t){let e=t.trim().split(/;\s*/);for(const t of e)t.startsWith("width")&&(s=t.split(":")[1]),t.startsWith("height")&&(r=t.split(":")[1])}return s=s||"",r=r||"",[s,r]}(t),s.classList.remove(C+"-leave-active"),"animation"==k&&s.classList.add(C+"-leave-to")),s.removeEventListener("animationend",$),s.removeEventListener("transitionend",$)},_=e.getElement(t.key);if(b){if(_){if(-1!=_.getAttribute("class").indexOf(`${N}-enter-to`))return t.props.class+=` ${N}-enter-to`,!0;D&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),W(_)}else D&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),setTimeout((()=>{let s=e.getElement(t.key);D&&(t.props.class+=` ${N}-enter-to`,s.style.display="none"),W(s)}),0);return!0}return _?-1!=_.getAttribute("class").indexOf(`${C}-leave-to`)?(t.props.class+=` ${C}-leave-to`,D&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),!0):(I(_),!0):(D&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),setTimeout((()=>{let s=e.getElement(t.key);D?(s.classList.add(`${C}-leave-to`),t.props.class+=` ${C}-leave-to`,s.style.display="none"):I(s)}),0),!0);function I(t){if("transition"==k){let[s,r]=q(t);requestAnimationFrame((()=>{t.classList.remove(N+"-enter-to"),t.classList.add(C+"-leave-active"),t.classList.add(C+"-leave-from"),"fold-height"==C?t.style.height=r:"fold-width"==C&&(t.style.width=s),t.style.transitionDelay=A,""!=T&&(t.style.transitionDuration=T),"ease"!=R&&(t.style.transitionTimingFunction=R),U&&U.apply(e.model,[e]),requestAnimationFrame((()=>{t.classList.add(C+"-leave-to"),t.classList.remove(C+"-leave-from"),"fold-height"==C?t.style.height="0px":"fold-width"==C&&(t.style.width="0px"),t.addEventListener("transitionend",$)}))}))}else requestAnimationFrame((()=>{t.classList.remove(N+"-enter-to"),t.style.animationDelay=S,""!=P&&(t.style.animationDuration=P),"ease"!=O&&(t.style.animationTimingFunction=O),U&&U.apply(e.model,[e]),t.offsetWidth,t.classList.add(C+"-leave-active"),t.addEventListener("animationend",$)}))}function W(t){if("transition"==k){t.style.transitionDelay="0s";let s=1e3*parseFloat(A);setTimeout((()=>{let[s,r]=q(t);t.classList.remove(C+"-leave-to"),t.classList.add(N+"-enter-active"),t.classList.add(N+"-enter-from"),"fold-height"==N?t.style.height="0px":"fold-width"==N&&(t.style.width="0px"),""!=T&&(t.style.transitionDuration=T),"ease"!=R&&(t.style.transitionTimingFunction=R),requestAnimationFrame((()=>{D&&(t.style.display=""),requestAnimationFrame((()=>{F&&F.apply(e.model,[e]),t.classList.add(N+"-enter-to"),t.classList.remove(N+"-enter-from"),"fold-height"==N?t.style.height=r:"fold-width"==N&&(t.style.width=s),t.addEventListener("transitionend",$)}))}))}),s)}else{t.style.animationDelay="0s";let s=1e3*parseFloat(A);setTimeout((()=>{requestAnimationFrame((()=>{t.classList.remove(C+"-leave-to"),""!=T&&(t.style.animationDuration=T),"ease"!=R&&(t.style.animationTimingFunction=T),D&&(t.style.display=""),F&&F.apply(e.model,[e]),t.offsetWidth,t.classList.add(N+"-enter-active"),t.addEventListener("animationend",$)}))}),s)}}function q(e){if("none"==e.style.display){const t=window.getComputedStyle(e).getPropertyValue("position"),s=window.getComputedStyle(e).getPropertyValue("visibility");e.style.position="absolute",e.style.visibility="hidden",e.style.display="";let r=window.getComputedStyle(e).getPropertyValue("width"),i=window.getComputedStyle(e).getPropertyValue("height");return e.style.position=t,e.style.visibility=s,e.style.display="none",[r,i]}return[window.getComputedStyle(e).getPropertyValue("width"),window.getComputedStyle(e).getPropertyValue("height")]}}),10),EventManager.regist("tap",{touchstart(e,t,s,r){let i=r.touches[0];s.dependEvent.setParam(t,e,"pos",{sx:i.pageX,sy:i.pageY,t:Date.now()})},touchmove(e,t,s,r){let i=s.dependEvent.getParam(t,e,"pos");if(!i)return;let n=r.touches[0],o=n.pageX-i.sx,a=n.pageY-i.sy;(Math.abs(o)>5||Math.abs(a)>5)&&(i.move=!0)},touchend(e,t,s,r){let i=s.dependEvent.getParam(t,e,"pos");if(!i)return;s.dependEvent.removeParam(t,e,"pos");let n=Date.now()-i.t;if(!i.move&&n<200){let i=s.dependEvent.handler;"string"==typeof i?t.invokeMethod(s.dependEvent.handler,e.model,e,s.dependEvent,r):i.apply(t,[e.model,e,s.dependEvent,r])}}}),EventManager.regist("swipe",{touchstart(e,t,s,r){let i=r.touches[0],n=Date.now();s.dependEvent.setParam(t,e,"swipe",{oldTime:[n,n],speedLoc:[{x:i.pageX,y:i.pageY},{x:i.pageX,y:i.pageY}],oldLoc:{x:i.pageX,y:i.pageY}})},touchmove(e,t,s,r){let i=Date.now(),n=r.touches[0],o=s.dependEvent.getParam(t,e,"swipe");i-o.oldTime[1]>50&&(o.speedLoc[0]={x:o.speedLoc[1].x,y:o.speedLoc[1].y},o.speedLoc[1]={x:n.pageX,y:n.pageY},o.oldTime[0]=o.oldTime[1],o.oldTime[1]=i),o.oldLoc={x:n.pageX,y:n.pageY}},touchend(e,t,s,r){let i=s.dependEvent.getParam(t,e,"swipe"),n=Date.now(),o=n-i.oldTime[1]<30?0:1,a=i.oldLoc.x-i.speedLoc[o].x,l=i.oldLoc.y-i.speedLoc[o].y,d=Math.sqrt(a*a+l*l),h=n-i.oldTime[o];if(h>300||d<10)return;let c=d/h;if(c>.05){let i="";if(a<0&&Math.abs(l/a)<1&&(r.v0=c,i="swipeleft"),a>0&&Math.abs(l/a)<1&&(r.v0=c,i="swiperight"),l>0&&Math.abs(a/l)<1&&(r.v0=c,i="swipedown"),l<0&&Math.abs(a/l)<1&&(r.v0=c,i="swipeup"),s.dependEvent.name===i){let i=s.dependEvent.handler;"string"==typeof i?t.invokeMethod(i,e.model,e,s.dependEvent,r):"function"==typeof i&&i.apply(t,[e.model,e,s.dependEvent,r])}}}}),EventManager.regist("swipeleft",EventManager.get("swipe")),EventManager.regist("swiperight",EventManager.get("swipe")),EventManager.regist("swipeup",EventManager.get("swipe")),EventManager.regist("swipedown",EventManager.get("swipe")),EventManager.regist("dblclick",{click(e,t,s,r){let i=s.dependEvent.getParam(t,e,"firstClick");if(i){if(Date.now()-i<300){let i=s.dependEvent.handler;"string"==typeof i?t.invokeMethod(s.dependEvent.handler,e.model,e,s.dependEvent,r):i.apply(t,[e.model,e,s.dependEvent,r])}}else s.dependEvent.setParam(t,e,"firstClick",Date.now());setTimeout((()=>{s.dependEvent.removeParam(t,e,"firstClick")}),500)}}),exports.Compiler=Compiler,exports.CssManager=CssManager,exports.DefineElement=DefineElement,exports.DefineElementManager=DefineElementManager,exports.DiffTool=DiffTool,exports.Directive=Directive,exports.DirectiveManager=DirectiveManager,exports.DirectiveType=DirectiveType,exports.EventFactory=EventFactory,exports.EventManager=EventManager,exports.Expression=Expression,exports.GlobalCache=GlobalCache,exports.Model=Model,exports.ModelManager=ModelManager,exports.Module=class Module{constructor(){this.originProps=new Map,this.children=[],this.id=Util.genId(),this.modelManager=new ModelManager(this),this.domManager=new DomManager(this),this.objectManager=new ObjectManager(this),this.eventFactory=new EventFactory(this),this.model=new Model(this.data()||{},this),this.state=exports.EModuleState.UNMOUNTED,ModuleFactory.add(this)}template(e){return null}data(){return{}}render(){if(this.state===exports.EModuleState.UNMOUNTED)return;let e=this.template(this.props);if(e!==this.oldTemplate&&(this.oldTemplate=e,this.compile()),!this.domManager.vdomTree)return;this.hasRendered||this.doModuleEvent("onBeforeFirstRender"),this.doModuleEvent("onBeforeRender");const t=this.domManager.renderedTree;if(this.domManager.renderedTree=Renderer.renderDom(this,this.domManager.vdomTree,this.model),this.hasRendered||(this.doModuleEvent("onFirstRender"),this.hasRendered=!0),this.doModuleEvent("onRender"),!this.domManager.renderedTree)return this.unmount(),void(this.hasRendered=!0);if(this.state===exports.EModuleState.MOUNTED){if(t&&this.model){let e=DiffTool.compare(this.domManager.renderedTree,t);this.doModuleEvent("onBeforeUpdate"),e.length>0&&(Renderer.handleChangedDoms(this,e),this.doModuleEvent("onUpdate"))}}else this.mount()}addChild(e){let t;"number"==typeof e?(t=e,e=ModuleFactory.get(t)):t=e.id,this.children.includes(t)||(this.children.push(t),e.parentId=this.id)}removeChild(e){let t=this.children.indexOf(e.id);-1!==t&&(e.unmount(),this.children.splice(t,1))}active(){this.state===exports.EModuleState.UNMOUNTED&&(this.state=exports.EModuleState.READY),Renderer.add(this)}mount(){this.doModuleEvent("onBeforeMount");let e=new DocumentFragment;const t=Renderer.renderToHtml(this,this.domManager.renderedTree,e,!0);if(this.container)this.container.appendChild(e);else if(this.srcDom){const e=this.getParent();if(!e)return;this.srcElement=e.getElement(this.srcDom.key),this.srcElement&&this.srcElement.parentElement.replaceChild(t,this.srcElement),e.saveElement(this.srcDom.key,t)}this.doModuleEvent("onMount"),this.state=exports.EModuleState.MOUNTED}unmount(){if(this.state===exports.EModuleState.UNMOUNTED||ModuleFactory.getMain()===this)return;Renderer.remove(this.id),this.eventFactory.clear(),this.doModuleEvent("onBeforeUnMount");const e=this.getElement(1);if(e)if(this.container)this.container.removeChild(e);else if(this.srcDom){const t=this.getParent();t&&(e.parentElement&&e.parentElement.replaceChild(this.srcElement,e),t.saveElement(this.srcDom.key,this.srcElement))}if(this.domManager.reset(),this.state=exports.EModuleState.UNMOUNTED,this.doModuleEvent("onUnMount"),this.children)for(let e of this.children){let t=ModuleFactory.get(e);t&&t.unmount()}}getParent(){if(this.parentId)return ModuleFactory.get(this.parentId)}doModuleEvent(e){let t=this[e];if(t&&"function"==typeof t)return t.apply(this,[this.model])}getMethod(e){return this[e]}setContainer(e){this.container=e}invokeMethod(e,t,s,r,i,n,o,a,l){let d=this,h=d[e];if(!h&&this.compileMid&&(d=ModuleFactory.get(this.compileMid),d&&(h=d[e])),h&&"function"==typeof h){let e=[];for(let t=1;t<arguments.length;t++)e.push(arguments[t]);return h.apply(d,e)}}setProps(e,t){let s=e.$data;if(this.changedProps={},delete e.$data,s)for(let e of Object.keys(s))this.model[e]=s[e];this.srcDom=t;let r=!1;if(this.props)for(let t of Object.keys(e))e[t]!==this.props[t]&&(r=!0,this.changedProps[t]=e[t]);else this.changedProps=e,r=!0;this.events=t.vdom.events,r&&this.mergeProps(this.changedProps),(r||this.state===exports.EModuleState.UNMOUNTED)&&this.active(),this.props=e}compile(){if(this.modules&&Array.isArray(this.modules)){for(let e of this.modules)ModuleFactory.addClass(e);delete this.modules}if(this.oldTemplate&&(this.domKeyId=0,this.children=[],CssManager.clearModuleRules(this),this.domManager.vdomTree=new Compiler(this).compile(this.oldTemplate),this.domManager.vdomTree)){if(this.domManager.vdomTree.props)for(let e of this.domManager.vdomTree.props)this.originProps.set(e[0],e[1]);if(this.mergeProps(this.props),this.events)for(let e of this.events)this.domManager.vdomTree.addEvent(e);this.doModuleEvent("onCompile")}}setExcludeProps(e){this.excludedProps=e}mergeProps(e){if(e&&this.domManager.vdomTree)for(let t of Object.keys(e))this.excludedProps&&this.excludedProps.includes(t)||(this.originProps.has(t)?this.domManager.vdomTree.setProp(t,[e[t],this.originProps.get(t)]):this.domManager.vdomTree.setProp(t,e[t]))}getElement(e){return this.domManager.elementMap.get(e)}saveElement(e,t){this.domManager.elementMap.set(e,t)}getModule(e,t,s){if(!this.children)return;const r=ModuleFactory.getClass(e);if(r)return function e(i){for(let n of i.children){let i=ModuleFactory.get(n);if(i){if(i.constructor===r){if(!s)return i;{let e=!0;for(let t of Object.keys(s))if(!i.props||i.props[t]!==s[t]){e=!1;break}if(e)return i}}if(t){let t=e(i);if(t)return t}}}}(this)}getModules(e,t){if(!this.children)return;let s=[];return function r(i){if(!i.children)return;for(let n of i.children){let i=ModuleFactory.get(n);i&&i.constructor&&(i.constructor.name===e&&s.push(i),t&&r(i))}}(this),s}watch(e,t,s,r){return e.__key?this.modelManager.watch(e,t,s,r):this.modelManager.watch(this.model,e,t,s)}set(e,t,s){e.__key?this.modelManager.set(e,t,s):this.modelManager.set(this.model,e,t)}get(e,t){return e.__key?this.modelManager.get(e,t):this.modelManager.get(this.model,e)}getDomKeyId(){return++this.domKeyId}},exports.ModuleFactory=ModuleFactory,exports.NCache=NCache,exports.NError=NError,exports.NEvent=NEvent,exports.NFactory=class NFactory{constructor(e){this.items=new Map,void 0!==e&&(this.moduleId=e.id)}add(e,t){this.items.set(e,t)}get(e){return this.items.get(e)}remove(e){this.items.delete(e)}has(e){return this.items.has(e)}},exports.NodomMessage_en=s,exports.NodomMessage_zh=r,exports.Renderer=Renderer,exports.Route=Route,exports.Router=Router,exports.Scheduler=Scheduler,exports.Util=Util,exports.VirtualDom=VirtualDom,exports.createDirective=n,exports.createRoute=function(e,t){let s;if(t=t||Router.root,Util.isArray(e))for(let r of e)s=new Route(r,t);else s=new Route(e,t);return s},exports.nodom=function(e,i,n){return t(this,void 0,void 0,(function*(){switch(n||"zh"){case"zh":exports.NodomMessage=r;break;case"en":exports.NodomMessage=s}Scheduler.addTask(Renderer.render,Renderer),Scheduler.start();let t=ModuleFactory.get(e);t.setContainer(document.querySelector(i)),t.active()}))},exports.registModule=function(e,t){ModuleFactory.addClass(e,t)},exports.request=function(e){return t(this,void 0,void 0,(function*(){return yield RequestManager.request(e)}))};
//# sourceMappingURL=nodom.cjs.min.js.map
