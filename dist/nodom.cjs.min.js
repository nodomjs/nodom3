"use strict";Object.defineProperty(exports,"__esModule",{value:!0});class DefineElementManager{static add(e,t){if(Array.isArray(e))for(let t of e)this.elements.set(t.name.toUpperCase(),t);else this.elements.set((t||e.name).toUpperCase(),e)}static get(e){return this.elements.get(e.toUpperCase())}static has(e){return this.elements.has(e.toUpperCase())}}DefineElementManager.elements=new Map;class DirectiveType{constructor(e,t,s){this.name=e,this.prio=s>=0?s:10,this.handle=t}}class DirectiveManager{static addType(e,t,s){this.directiveTypes.set(e,new DirectiveType(e,t,s))}static removeType(e){this.directiveTypes.delete(e)}static getType(e){return this.directiveTypes.get(e)}static hasType(e){return this.directiveTypes.has(e)}}DirectiveManager.directiveTypes=new Map;const e={TipWords:{application:"Application",system:"System",module:"Module",moduleClass:"ModuleClass",model:"Model",directive:"Directive",directiveType:"Directive-type",expression:"Expression",event:"Event",method:"Method",filter:"Filter",filterType:"Filter-type",data:"Data",dataItem:"Data-item",route:"Route",routeView:"Route-container",plugin:"Plugin",resource:"Resource",root:"Root",element:"VirtualDom"},ErrorMsgs:{unknown:"unknown error",paramException:"{0} '{1}' parameter error，see api",invoke:"method {0} parameter {1} must be {2}",invoke1:"method {0} parameter {1} must be {2} or {3}",invoke2:"method {0} parameter {1} or {2} must be {3}",invoke3:"method {0} parameter {1} not allowed empty",exist:"{0} is already exist",exist1:"{0} '{1}' is already exist",notexist:"{0} is not exist",notexist1:"{0} '{1}' is not exist",notupd:"{0} not allow to change",notremove:"{0} not allow to delete",notremove1:"{0} {1} not allow to delete",namedinvalid:"{0} {1} name error，see name rules",initial:"{0} init parameter error",jsonparse:"JSON parse error",timeout:"request overtime",config:"{0} config parameter error",config1:"{0} config parameter '{1}' error",itemnotempty:"{0} '{1}' config item '{2}' not allow empty",itemincorrect:"{0} '{1}' config item '{2}' error",wrongTemplate:"wrong template"},FormMsgs:{type:"please input valid {0}",unknown:"input error",required:"is required",min:"min value is {0}",max:"max value is {0}"},WeekDays:{0:"Sun",1:"Mon",2:"Tue",3:"Wed",4:"Thu",5:"Fri",6:"Sat"}};class NError extends Error{constructor(t,s,i,r,o){super(t);let n=e.ErrorMsgs[t];if(void 0===n)return void(this.message="未知错误");let a=[n];for(let e=1;e<arguments.length;e++)a.push(arguments[e]);this.message=this.compile.apply(null,a)}compile(e,t,s,i,r,o){let n,a=arguments,l=0;for(;-1!==e.indexOf("{"+l+"}");)n=new RegExp("\\{"+l+"\\}","g"),e=e.replace(n,a[l+1]),l++;return e}}class Util{static genId(){return this.generatedId++}static initKeyMap(){this.keyWordMap.set("arguments",!0),this.keyWordMap.set("boolean",!0),this.keyWordMap.set("break",!0),this.keyWordMap.set("byte",!0),this.keyWordMap.set("catch",!0),this.keyWordMap.set("char",!0),this.keyWordMap.set("const",!0),this.keyWordMap.set("default",!0),this.keyWordMap.set("delete",!0),this.keyWordMap.set("do",!0),this.keyWordMap.set("double",!0),this.keyWordMap.set("else",!0),this.keyWordMap.set("enum",!0),this.keyWordMap.set("eval",!0),this.keyWordMap.set("false",!0),this.keyWordMap.set("float",!0),this.keyWordMap.set("for",!0),this.keyWordMap.set("function",!0),this.keyWordMap.set("goto",!0),this.keyWordMap.set("if",!0),this.keyWordMap.set("in",!0),this.keyWordMap.set("instanceof",!0),this.keyWordMap.set("int",!0),this.keyWordMap.set("let",!0),this.keyWordMap.set("long",!0),this.keyWordMap.set("new",!0),this.keyWordMap.set("null",!0),this.keyWordMap.set("return",!0),this.keyWordMap.set("short",!0),this.keyWordMap.set("switch",!0),this.keyWordMap.set("this",!0),this.keyWordMap.set("throw",!0),this.keyWordMap.set("true",!0),this.keyWordMap.set("try",!0),this.keyWordMap.set("this",!0),this.keyWordMap.set("throw",!0),this.keyWordMap.set("typeof",!0),this.keyWordMap.set("var",!0),this.keyWordMap.set("while",!0),this.keyWordMap.set("with",!0),this.keyWordMap.set("Array",!0),this.keyWordMap.set("Date",!0),this.keyWordMap.set("JSON",!0),this.keyWordMap.set("Set",!0),this.keyWordMap.set("Map",!0),this.keyWordMap.set("eval",!0),this.keyWordMap.set("function",!0),this.keyWordMap.set("Infinity",!0),this.keyWordMap.set("isFinite",!0),this.keyWordMap.set("isNaN",!0),this.keyWordMap.set("isPrototypeOf",!0),this.keyWordMap.set("Math",!0),this.keyWordMap.set("NaN",!0),this.keyWordMap.set("Number",!0),this.keyWordMap.set("Object",!0),this.keyWordMap.set("prototype",!0),this.keyWordMap.set("String",!0),this.keyWordMap.set("isPrototypeOf",!0),this.keyWordMap.set("undefined",!0),this.keyWordMap.set("valueOf",!0)}static isKeyWord(e){return this.keyWordMap.has(e)}static clone(e,t,s){let i=this,r=new WeakMap;return o(e,t,s);function o(e,t,s){if(!e||"object"!=typeof e||Util.isFunction(e))return e;let o;return e.clone&&Util.isFunction(e.clone)?e.clone(s):(i.isObject(e)?(o=new Object,r.set(e,o),Object.getOwnPropertyNames(e).forEach((i=>{t&&(t.constructor===RegExp&&t.test(i)||Util.isArray(t)&&t.includes(i))||(o[i]=n(e[i],t,s))}))):i.isMap(e)?(o=new Map,e.forEach(((e,i)=>{t&&(t.constructor===RegExp&&t.test(i)||t.includes(i))||o.set(i,n(e,t,s))}))):i.isArray(e)&&(o=new Array,e.forEach((function(e,i){o[i]=n(e,t,s)}))),o)}function n(e,t,s){if("object"==typeof e&&!Util.isFunction(e)){let i=null;return i=r.has(e)?r.get(e):o(e,t,s),i}return e}}static merge(e,t,s,i,r,o){let n=this;for(let e=0;e<arguments.length;e++)if(!this.isObject(arguments[e]))throw new NError("invoke","Util.merge",e+"","object");let a=Object.assign.apply(null,arguments);return function(e){for(let t in e)(n.isObject(e[t])||n.isArray(e[t]))&&(a[t]=n.clone(a[t]))}(a),a}static assign(e,t){return Object.assign?Object.assign(e,t):this.getOwnProps(t).forEach((function(s){e[s]=t[s]})),e}static compare(e,t,s){if(!e&&!t)return!0;if("object"!=typeof e||"object"!=typeof t)return!1;const i=Object.getOwnPropertyNames(e);if(i.length!==Object.getOwnPropertyNames(t).length)return!1;for(let s of i)if(e[s]!==t[s])return!1;if(s)for(let s of i){if(!this.compare(e[s],t[s]))return!1}return!0}static getOwnProps(e){return e?Object.getOwnPropertyNames(e):[]}static isFunction(e){return null!=e&&e.constructor===Function}static isArray(e){return Array.isArray(e)}static isMap(e){return null!=e&&e.constructor===Map}static isObject(e){return null!=e&&e.constructor===Object}static isInt(e){return Number.isInteger(e)}static isNumber(e){return"number"==typeof e}static isBoolean(e){return"boolean"==typeof e}static isString(e){return"string"==typeof e}static isNumberString(e){return/^\d+\.?\d*$/.test(e)}static isEmpty(e){if(null==e)return!0;let t=typeof e;if(this.isObject(e)){let t=Object.keys(e);if(void 0!==t)return 0===t.length}else if("string"===t)return""===e;return!1}static replaceNode(e,t){let s=e.parentNode,i=e.nextSibling;if(null===s)return;s.removeChild(e);(this.isArray(t)?t:[t]).forEach((function(e){null==i?s.appendChild(e):s.insertBefore(e,i)}))}static empty(e){let t=e.childNodes;for(let s=t.length-1;s>=0;s--)e.removeChild(t[s])}static formatDate(t,s){let i;if(this.isString(t)){!0===/^\d+$/.test(t)&&(i=parseInt(t))}else{if(!this.isNumber(t))throw new NError("invoke","this.formatDate","0","date string","date");i=t}let r=new Date(i);if(isNaN(r.getDay()))return"";let o={"M+":r.getMonth()+1,"d+":r.getDate(),"h+":r.getHours()%12==0?12:r.getHours()%12,"H+":r.getHours(),"m+":r.getMinutes(),"s+":r.getSeconds(),"q+":Math.floor((r.getMonth()+3)/3),S:r.getMilliseconds()};return/(y+)/.test(s)&&(s=s.replace(RegExp.$1,(r.getFullYear()+"").substring(4-RegExp.$1.length))),this.getOwnProps(o).forEach((function(e){new RegExp("("+e+")").test(s)&&(s=s.replace(RegExp.$1,1==RegExp.$1.length?o[e]:("00"+o[e]).substring((""+o[e]).length)))})),/(E+)/.test(s)&&(s=s.replace(RegExp.$1,(RegExp.$1.length>1?RegExp.$1.length>2?"/u661f/u671f":"/u5468":"")+e.WeekDays[r.getDay()+""])),s}static compileStr(e,t,s,i,r,o){let n,a=arguments,l=0;for(;-1!==e.indexOf("{"+l+"}");)n=new RegExp("\\{"+l+"\\}","g"),e=e.replace(n,a[l+1]),l++;return e}static apply(e,t,s){if(e)return Reflect.apply(e,t||null,s)}static mergePath(e){return e.join("/").replace(/(\/{2,})|\\\//g,"/")}static eval(e){return new Function(`return(${e})`)()}static setNodeKey(e,t,s){if(e.key+="_"+(t||Util.genId()),s&&e.children)for(let i of e.children)Util.setNodeKey(i,t,s)}static setDomAsset(e,t,s){e.assets||(e.assets={}),e.assets[t]=s}static delDomAsset(e,t){e.assets&&delete e.assets[t]}}Util.generatedId=1,Util.keyWordMap=new Map,Util.initKeyMap();class Expression{constructor(e){if(this.id=Util.genId(),this.allModelField=!0,!e)return;const t=this.compile(e);this.execFunc=new Function("$model","return "+t)}compile(e){const t=/('[\s\S]*?')|("[\s\S]*?")|(`[\s\S]*?`)|([a-zA-Z$_][\w$]*\s*?:)|((\.{3}|\.)?[a-zA-Z$_][\w$]*(\.[a-zA-Z$_][\w$]*)*(\s*[\[\(](\s*\))?)?)/g;let s,i="",r=0;for(;null!==(s=t.exec(e));){let n=s[0];if(r<s.index&&(i+=e.substring(r,s.index)),"'"===n[0]||'"'===n[0]||"`"===n[0])i+=n;else{let e=n[n.length-1];if(":"===e)i+=n;else if("("===e||")"===e)i+=o(n);else if(n.startsWith("this.")||"$model"===n||n.startsWith("$model.")||Util.isKeyWord(n)||"."===n[0]&&"."!==n[1])i+=n;else{let e="";n.startsWith("...")&&(e="...",n=n.substring(3)),i+=e+"$model."+n,-1!==n.indexOf(".")&&(this.allModelField=!1)}}r=t.lastIndex}return r<e.length&&(i+=e.substring(r)),i;function o(e){let t=e.indexOf(".");if(-1===t){let t=e.lastIndexOf("("),s=e.substring(0,t);if(!Util.isKeyWord(s)){return")"!==e[e.length-1]?'this.invokeMethod("'+s+'",':'this.invokeMethod("'+s+'")'}}else if("."!==e[0]){let s=e.substring(0,t);if(!Util.isKeyWord(s))return"$model."+e}return e}}val(e,t){let s;try{s=this.execFunc.apply(e,[t])}catch(e){}return this.value=s,s}clone(){return this}}
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */function t(e,t,s,i){return new(s||(s=Promise))((function(r,o){function n(e){try{l(i.next(e))}catch(e){o(e)}}function a(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,a)}l((i=i.apply(e,t||[])).next())}))}class ModuleFactory{static add(e){0===this.modules.size&&(this.mainModule=e),this.modules.set(e.id,e),this.addClass(e.constructor)}static get(e){return"number"==typeof e?this.modules.get(e):this.getInstance(e)}static hasClass(e){return this.classes.has(e.toLowerCase())}static addClass(e,t){let s=e.name.toLowerCase();this.classes.has(s)||(this.classes.set(s,e),t&&this.classes.set(t.toLowerCase(),e))}static getInstance(e){let t,s="string"==typeof e?e:e.name.toLowerCase();if(t=this.classes.has(s)||"function"!=typeof e?this.classes.get(s):e,!t)return;let i=Reflect.construct(t,[]);return i.init(),i}static remove(e){this.modules.delete(e)}static setMain(e){this.mainModule=e}static getMain(){return this.mainModule}}ModuleFactory.modules=new Map,ModuleFactory.classes=new Map;class CssManager{static handleStyleDom(e,t,s,i){if("style"!==t.tagName.toLowerCase())return!1;if(i){let i=this.cssPreName+e.id;s.props.class?s.props.class=t.props.class+" "+i:s.props.class=i}return!0}static handleStyleTextDom(e,t){return!(!t.parent||"style"!==t.parent.tagName.toLowerCase())&&(CssManager.addRules(e,t.textContent,"this"===t.parent.props.scope?"."+this.cssPreName+e.id:void 0),!0)}static addRules(e,t,s){if(!this.sheet){let e=document.createElement("style");document.head.appendChild(e),this.sheet=document.styleSheets[0]}s&&this.clearModuleRules(e);const i=/(@[a-zA-Z]+\s+url\(.+?\))|([.#@a-zA-Z]\S*(\s*\S*\s*?)?{)|\}/g,r=/@[a-zA-Z]+\s+url/;let o,n=-1,a=0;for(;null!==(o=i.exec(t));)if(r.test(o[0]))d(o[0]);else if("}"===o[0]){if(n>=0&&--a<=0){let i=t.substring(n,o.index+1);"@"===i[0]?this.sheet.insertRule(i,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0):l(e,i,s),n=-1,a=0}}else-1===n?(n=o.index,a++):a++;function l(e,t,s){let i=/.+(?=\{)/.exec(t);if(i){if(s){let r=e.objectManager.get("$cssRules");r||(r=[],e.objectManager.set("$cssRules",r)),r.push(s+" "+i[0]),t=s+" "+t}CssManager.sheet.insertRule(t,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0)}}function d(e){let t=e.indexOf("("),s=e.lastIndexOf(")");if(-1===t||-1===s||t>=s)return;let i=e.substring(t,s);CssManager.importMap.has(i)||(CssManager.sheet.insertRule(e,CssManager.importIndex++),CssManager.importMap.set(i,!0))}}static clearModuleRules(e){let t=e.objectManager.get("$cssRules");if(t&&0!==t.length){for(let e=0;e<this.sheet.cssRules.length;e++){let s=this.sheet.cssRules[e];s.selectorText&&-1!==t.indexOf(s.selectorText)&&this.sheet.deleteRule(e--)}e.objectManager.set("$cssRules",[])}}}CssManager.importMap=new Map,CssManager.importIndex=0,CssManager.cssPreName="___nodommodule___";class NEvent{constructor(e,t,s,i){if(this.id=Util.genId(),this.module=e,this.name=t,s){let e=typeof s;if("string"===e){s.trim().split(":").forEach(((e,t)=>{if(e=e.trim(),0===t)this.handler=e;else switch(e){case"delg":this.delg=!0;break;case"nopopo":this.nopopo=!0;break;case"once":this.once=!0;break;case"capture":this.capture=!0}}))}else"function"===e&&(i=s)}if(i&&(this.handler=i),document.ontouchend)switch(this.name){case"click":this.name="tap";break;case"mousedown":this.name="touchstart";break;case"mouseup":this.name="touchend";break;case"mousemove":this.name="touchmove"}else switch(this.name){case"tap":this.name="click";break;case"touchstart":this.name="mousedown";break;case"touchend":this.name="mouseup";break;case"touchmove":this.name="mousemove"}}setParam(e,t,s,i){e.objectManager.setEventParam(this.id,t.key,s,i)}getParam(e,t,s){return e.objectManager.getEventParam(this.id,t.key,s)}removeParam(e,t,s){return e.objectManager.removeEventParam(this.id,t.key,s)}clearParam(e,t){e.objectManager.clearEventParam(this.id,t.key)}}class EventManager{static bind(e,t){const s=e.eventFactory.getEvent(t.key);if(!s)return;const i=t.parent;for(let o of s)if("bindMap"!==o[0]){if(o[1].toDelg)for(let s=0;s<o[1].toDelg.length;s++){let n=o[1].toDelg[s];e.eventFactory.addEvent(i.key,n,t.key),e.eventFactory.bind(i.key,o[0],r,n.capture)}o[1].own&&e.eventFactory.bind(t.key,o[0],r,o[1].capture)}function r(t){let s=t.currentTarget;const i=e.getVirtualDom(s.vdom),r=e.eventFactory.getEvent(i.key);if(!i||!r||!r.has(t.type))return;const o=r.get(t.type);function n(s){if(!s)return;let r=!1;for(let o=0;o<s.length;o++){const n=s[o];"string"==typeof n.handler?e.invokeMethod(n.handler,i.model,i,n,t):"function"==typeof n.handler&&n.handler.apply(e,[i.model,i,n,t]),n.once&&s.splice(o--,1),r=n.nopopo}r&&t.stopPropagation()}function a(r){if(!r)return!1;let o=!1;for(let n=0;n<r.length;n++){const a=r[n],l=a.event;for(let d=0;d<t.path.length&&t.path[d]!==s;d++)if(t.path[d].vdom===a.key){let s=e.getVirtualDom(a.key);"string"==typeof l.handler?e.invokeMethod(l.handler,i.model,i,l,t):"function"==typeof l.handler&&l.handler.apply(e,[i.model,i,l,t]),o=l.nopopo,l.once&&(r.splice(n--,1),e.eventFactory.removeEvent(s.key,l,null,!0));break}}return o}o.capture?(n(o.own),a(o.delg)):a(o.delg)||n(o.own),o.own&&0===o.own.length&&delete o.own,o.delg&&0===o.delg.length&&delete o.delg}}static handleExtendEvent(e,t,s){let i=this.get(s.name);if(!i)return!1;for(let r of Object.keys(i)){let o=new NEvent(e,r,i[r]);o.capture=s.capture,o.nopopo=s.nopopo,o.delg=s.delg,o.once=s.once,o.dependEvent=s,e.eventFactory.addEvent(t.key,o)}return!0}static regist(e,t){this.extendEventMap.set(e,t)}static unregist(e){return this.extendEventMap.delete(e)}static get(e){return this.extendEventMap.get(e)}}EventManager.extendEventMap=new Map;class Renderer{static add(e){e.dontAddToRender||this.waitList.includes(e.id)||this.waitList.push(e.id)}static render(){for(;this.waitList.length>0;)ModuleFactory.get(this.waitList.shift()).render()}static renderDom(e,t,s,i,r){let o={key:r?t.key+"_"+r:t.key,vdom:t};if(e.saveVirtualDom(o),t.tagName?(o.tagName=t.tagName,o.props={}):o.textContent=t.textContent,s=t.model||s,i?(s||(s=i.model),o.parent=i):this.currentModuleRoot=o,s||(s=e.model),o.model=s,o.staticNum=t.staticNum,t.staticNum>0&&t.staticNum--,t.directives&&t.directives.length>0&&"model"===t.directives[0].type.name&&t.directives[0].exec(e,o,t),o.tagName){if(!o.notChange){if(function(){if(!t.props||0===t.props.size)return;const s=/^style$/i,i=/^class$/i;let r;for(let n of t.props){if(Array.isArray(n[1])){r=[];for(let t=0;t<n[1].length;t++){let s=n[1][t];s instanceof Expression?(r.push(s.val(e,o.model)),o.staticNum=-1):r.push(s)}s.test(n[0])?r=t.getStyleString(r):i.test(n[0])&&(r=t.getClassString(r))}else n[1]instanceof Expression?(r=n[1].val(e,o.model),o.staticNum=-1):r=n[1];o.props[n[0]]=r}}(),!CssManager.handleStyleDom(e,t,Renderer.currentModuleRoot,"this"===t.getProp("scope"))&&t.assets&&t.assets.size>0)for(let e of t.assets)o[e[0]]=e[1];if(!function(){if(!t.directives||0===t.directives.length)return!0;o.staticNum=-1;for(let s of t.directives)if("model"!==s.type.name&&!s.exec(e,o,t))return!1;return!0}())return o}if(t.events&&!e.eventFactory.getEvent(o.key))for(let s of t.events)e.eventFactory.addEvent(o.key,s);if(t.children&&t.children.length>0){o.children=[];for(let s of t.children)Renderer.renderDom(e,s,o.model,o,r||null)}}else if(!o.notChange)if(t.expressions){let s="";t.expressions.forEach((t=>{if(t instanceof Expression){let i=t.val(e,o.model);s+=void 0!==i?i:""}else s+=t})),o.textContent=s,o.staticNum=-1}else o.textContent=t.textContent;return i&&i.children.push(o),o}static renderToHtml(e,t,s,i){let r=e.getNode(t.key);if(r)if(t.tagName){let e=r.attributes,s=[];for(let t=0;t<e.length;t++)s.push(e[t].name);for(let e of Object.keys(t.props)){let i;r.setAttribute(e,void 0===t.props[e]?"":t.props[e]),-1!==(i=s.indexOf(e))&&s.splice(i,1)}if(s.length>0)for(let e of s)r.removeAttribute(e);!function(e,t){if(e.assets)for(let s of Object.keys(e.assets))t[s]=e.assets[s]}(t,r)}else r.textContent=t.textContent;else r=t.tagName?o(t):n(t),r&&t.tagName&&i&&function e(t,s){s.children&&s.children.length>0&&s.children.forEach((s=>{let i;s.tagName?(i=o(s),e(i,s)):i=n(s),i&&t.appendChild(i)}))}(r,t),r&&s&&s.appendChild(r);return r;function o(t){if("style"===t.tagName.toLowerCase())return;let s=document.createElement(t.tagName);if(s.vdom=t.key,e.saveNode(t.key,s),t.props.key&&e.saveElement(t.props.key,s),!t.subModuleId){for(let e of Object.keys(t.props))s.setAttribute(e,void 0===t.props[e]?"":t.props[e]);if(t.assets)for(let e of Object.keys(t.assets))s[e]=t.assets[e];EventManager.bind(e,t)}return s}function n(t){if(CssManager.handleStyleTextDom(e,t))return;let s=document.createTextNode(t.textContent||"");return e.saveNode(t.key,s),s}}static handleChangedDoms(e,t){for(let s of t){let[t,i,r]=[s[1]?e.getNode(s[1].key):null,s[2]&&"object"==typeof s[2]?e.getNode(s[2].key):null,s[3]?e.getNode(s[3].key):null];switch(s[0]){case 1:Renderer.renderToHtml(e,s[1],r,!0),t=e.getNode(s[1].key),i?r.insertBefore(t,i):"number"==typeof s[2]&&r.childNodes.length-1>s[2]?r.insertBefore(t,r.childNodes[s[2]]):r.appendChild(t);break;case 2:Renderer.renderToHtml(e,s[1],null,!1);break;case 3:e.removeNode(s[1],!0),r&&t&&r.contains(t)&&r.removeChild(t);break;case 4:s[4]?i&&i.nextSibling?r.insertBefore(t,i.nextSibling):r.appendChild(t):r.insertBefore(t,i);break;default:Renderer.renderToHtml(e,s[1],r,!0),t=e.getNode(s[1].key),r&&r.replaceChild(t,i)}}}}Renderer.waitList=[];class Route{constructor(e,t){if(this.params=[],this.data={},this.children=[],e&&!Util.isEmpty(e.path)){this.id=Util.genId();for(let t in e)this[t]=e[t];this.parent=t,this.path&&this.parse(),t&&t.addChild(this),e.routes&&Array.isArray(e.routes)&&e.routes.forEach((e=>{new Route(e,this)}))}}addChild(e){this.children.push(e),e.parent=this}parse(){let e=this.path.split("/"),t=this.parent,s=[],i=-1,r="";for(let o=0;o<e.length;o++){let n=e[o].trim();if(""!==n){if(n.startsWith(":"))0===s.length&&(i=o),s.push(n.substring(1));else{i=-1,s=[],this.path=n;let e=0;for(;e<t.children.length;e++){let s=t.children[e];if(s.path===n){t=s;break}}e===t.children.length&&(""!==r&&(new Route({path:r},t),t=t.children[t.children.length-1]),r=n)}this.params=-1===i?[]:s}else e.splice(o--,1)}}clone(){let e=new Route;return Object.getOwnPropertyNames(this).forEach((t=>{"data"!==t&&(e[t]=this[t])})),this.data&&(e.data=Util.clone(this.data)),e}}var s;exports.EModuleState=void 0,(s=exports.EModuleState||(exports.EModuleState={}))[s.INITED=1]="INITED",s[s.UNACTIVE=2]="UNACTIVE",s[s.RENDERED=4]="RENDERED";class Router{static go(e){e!==this.currentPath&&(-1===this.waitList.indexOf(e)&&this.waitList.push(e),setTimeout((()=>{this.load()}),0))}static load(){if(0===this.waitList.length)return;let e=this.waitList.shift();this.start(e).then((()=>{this.load()}))}static start(e){return t(this,void 0,void 0,(function*(){let t,s=this.compare(this.currentPath,e);t=null===s[0]?ModuleFactory.getMain():yield this.getModule(s[0]);for(let e=s[1].length-1;e>=0;e--){const t=s[1][e];if(!t.module)continue;let i=yield this.getModule(t);Util.isFunction(this.onDefaultLeave)&&this.onDefaultLeave(i.model),Util.isFunction(t.onLeave)&&t.onLeave(i.model),this.activeFieldMap.delete(i.id),i.unactive()}if(0===s[2].length){let e=s[0];if(null!==e){let t=yield this.getModule(e);this.dependHandle(t,e,s[3]?s[3].module:null)}}else for(let e=0;e<s[2].length;e++){let i=s[2][e];if(!i||!i.module)continue;let r=yield this.getModule(i);this.dependHandle(r,i,t),Util.isFunction(this.onDefaultEnter)&&this.onDefaultEnter(r.model),Util.isFunction(i.onEnter)&&i.onEnter(r.model),t=r}if(0===this.startStyle){let t=(Router.basePath||"")+e;e.startsWith(this.currentPath)?history.replaceState(t,"",t):history.pushState(t,"",t)}this.currentPath=e,this.startStyle=0}))}static redirect(e){this.go(e)}static getModule(e){return t(this,void 0,void 0,(function*(){let t=e.module;if("object"==typeof t)return t;if(!t.__proto__.name){const e=yield t();for(let s of Object.keys(e))if(e[s].name){t=e[s];break}}return"function"==typeof t&&(t=ModuleFactory.get(t)),e.module=t,t}))}static compare(e,t){let s=null,i=null;e&&(s=this.getRouteList(e,!0)),t&&(i=this.getRouteList(t));let r=0;null!==s&&(r=s.length),null!==i?i.length<r&&(r=i.length):r=0;let o=[],n=[],a=0;for(a=0;a<r&&s[a].id===i[a].id;a++)if(JSON.stringify(s[a].data)!==JSON.stringify(i[a].data)){a++;break}null!==s&&(o=s.slice(a)),null!==i&&(n=i.slice(a));let l=null,d=null;if(i&&a>0)for(let e=a-1;e>=0;e--)if(l){if(!d&&i[e].module){d=i[e];break}}else if(i[e].module){l=i[e];continue}return[l,o,n,d]}static addActiveField(e,t,s,i){if(!s||!i)return;let r=Router.activeFieldMap.get(e.id);r?void 0===r.find((e=>e.model===s&&e.field===i))&&r.push({path:t,model:s,field:i}):Router.activeFieldMap.set(e.id,[{path:t,model:s,field:i}])}static dependHandle(e,t,s){const i=this;e.active();let r={path:t.path};Util.isEmpty(t.data)||(r.data=t.data),e.model.$route=r,s&&(s.state===exports.EModuleState.RENDERED?(e.setContainer(s.getNode(Router.routerKeyMap.get(s.id))),this.setDomActive(s,t.fullPath)):s.addRenderOps((function(t,s){e.setContainer(t.getNode(Router.routerKeyMap.get(t.id))),i.setDomActive(t,s)}),1,[s,t.fullPath],!0))}static setDomActive(e,t){let s=Router.activeFieldMap.get(e.id);if(s)for(let e of s)e.model[e.field]=e.path===t}static getRouteList(e,t){if(!this.root)return[];let s=e.split("/"),i=this.root,r=0,o=[],n="",a=this.root;for(let e=0;e<s.length;e++){let l=s[e].trim();if(""===l)continue;let d=!1;for(let e=0;e<i.children.length;e++)if(i.children[e].path===l){a!==this.root&&(a.fullPath=n,a.data=i.data,o.push(a)),i=t?i.children[e].clone():i.children[e],i.data={},a=i,d=!0,r=0;break}n+="/"+l,d||r<i.params.length&&(i.data[i.params[r++]]=l)}return i!==this.root&&(i.fullPath=n,o.push(i)),o}}Router.waitList=[],Router.startStyle=0,Router.activeFieldMap=new Map,Router.routerKeyMap=new Map,Router.root=new Route,window.addEventListener("popstate",(function(e){const t=history.state;t&&(Router.startStyle=1,Router.go(t))}));class Scheduler{static dispatch(){Scheduler.tasks.forEach((e=>{Util.isFunction(e.func)&&(e.thiser?e.func.call(e.thiser):e.func())}))}static start(e){Scheduler.dispatch(),window.requestAnimationFrame?window.requestAnimationFrame(Scheduler.start):window.setTimeout(Scheduler.start,e||50)}static addTask(e,t){if(!Util.isFunction(e))throw new NError("invoke","Scheduler.addTask","0","function");Scheduler.tasks.push({func:e,thiser:t})}static removeTask(e){if(!Util.isFunction(e))throw new NError("invoke","Scheduler.removeTask","0","function");let t=-1;-1!==(t=Scheduler.tasks.indexOf(e))&&Scheduler.tasks.splice(t,1)}}function i(e,t,s){return DirectiveManager.addType(e,t,s)}Scheduler.tasks=[],exports.NodomMessage=void 0;class Directive{constructor(e,t){if(this.id=Util.genId(),e&&(this.type=DirectiveManager.getType(e),!this.type))throw new NError("notexist1",exports.NodomMessage.TipWords.directive,e);Util.isString(t)?this.value=t.trim():t instanceof Expression?this.expression=t:this.value=t}exec(e,t,s){return!!this.disabled||(this.expression&&(this.value=this.expression.val(e,t.model)),this.type.handle.apply(this,[e,t,s]))}clone(){let e=new Directive;return e.type=this.type,e.expression=this.expression,e.value=this.value,e}}class VirtualDom{constructor(e,t,s){this.staticNum=0,this.allModelField=!0,this.key=t||(s?s.getDomKeyId():Util.genId())+"",e&&(this.tagName=e)}removeDirectives(e){this.directives&&e.forEach((e=>{this.removeDirective(e)}))}removeDirective(e){if(!this.directives)return;let t;-1!==(t=this.directives.findIndex((t=>t.type.name===e)))&&this.directives.splice(t,1),0===this.directives.length&&delete this.directives}addDirective(e,t){if(this.directives){if(this.directives.find((t=>t.type.name===e.type.name)))return}else this.directives=[];this.directives.push(e),t&&this.sortDirective()}sortDirective(){this.directives&&this.directives.length>1&&this.directives.sort(((e,t)=>DirectiveManager.getType(e.type.name).prio<DirectiveManager.getType(t.type.name).prio?-1:1))}hasDirective(e){return this.directives&&-1!==this.directives.findIndex((t=>t.type.name===e))}getDirective(e){if(this.directives)return this.directives.find((t=>t.type.name===e))}add(e,t){this.children||(this.children=[]),t?this.children.splice(t,0,e):this.children.push(e),e.parent=this}remove(e){let t=this.children.indexOf(e);-1!==t&&this.children.splice(t,1)}addClass(e){if(this.addProp("class",e),this.removedClassMap&&this.removedClassMap.size>0){let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.delete(e)}}removeClass(e){if(!this.getProp("class"))return;this.removedClassMap||(this.removedClassMap=new Map);let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.set(e,!0);this.setStaticOnce()}getClassString(e){let t=[];for(let s of e){let e=s.trim().split(/\s+/);for(let s of e)this.removedClassMap&&this.removedClassMap.has(s)||t.includes(s)||t.push(s)}if(t.length>0)return t.join(" ")}addStyle(e){if(this.addProp("style",e),"string"==typeof e&&this.removedStyleMap&&this.removedStyleMap.size>0){let t=e.trim().split(/\s*;\s*/);for(let e of t){if(""===e)continue;let t=e.split(/\s*:\s*/);""!==t[0].trim()&&this.removedClassMap.delete(t[0].trim())}}}removeStyle(e){this.removedClassMap||(this.removedClassMap=new Map);let t=e.trim().split(/\s+/);for(let e of t)""!==e&&this.removedClassMap.set(e,!0);this.setStaticOnce()}getStyleString(e){let t=new Map;for(let s of e){let e=s.trim().split(/\s*;\s*/);for(let s of e){if(""===s)continue;let e=s.split(/\s*:\s*/);this.removedStyleMap&&this.removedStyleMap.has(e[0])||t.set(e[0],e[1])}}if(t.size>0)return[...t].map((e=>e.join(":"))).join(";")}hasProp(e){if(this.props)return this.props.has(e)}getProp(e,t){if(this.props)return this.props.get(e)}setProp(e,t){this.props||(this.props=new Map),"style"===e?this.removedStyleMap&&this.removedStyleMap.clear():"class"===e&&this.removedClassMap&&this.removedClassMap.clear(),this.props.set(e,t)}addProp(e,t){let s=this.getProp(e);if(s)if(Array.isArray(s)){if(s.includes(t))return!1;s.push(t)}else{if(s===t)return!1;this.setProp(e,[s,t])}else this.setProp(e,t);return this.setStaticOnce(),!0}delProp(e){if(this.props){if(Util.isArray(e))for(let t of e)this.props.delete(t);else this.props.delete(e);this.setStaticOnce()}}setAsset(e,t){this.assets||(this.assets=new Map),this.assets.set(e,t)}delAsset(e){this.assets&&this.assets.delete(e)}getEl(e){return e.getNode(this.key)}query(e){if(this.key===e)return this;if(this.children)for(let t=0;t<this.children.length;t++){let s=this.children[t].query(e);if(s)return s}}setParam(e,t,s){e.objectManager.setDomParam(this.key,t,s)}getParam(e,t){return e.objectManager.getDomParam(this.key,t)}removeParam(e,t){e.objectManager.removeDomParam(this.key,t)}setStaticOnce(){-1!==this.staticNum&&(this.staticNum=1)}clone(){let e=new VirtualDom(this.tagName,this.key);if(this.tagName){if(this.props&&this.props.size>0)for(let t of this.props)e.setProp(t[0],t[1]);if(this.assets&&this.assets.size>0)for(let t of this.assets)e.setAsset(t[0],t[1]);if(this.directives&&this.directives.length>0){e.directives=[];for(let t of this.directives)e.directives.push(t.clone())}if(e.events=this.events,this.children)for(let t of this.children)e.add(t.clone())}else e.expressions=this.expressions,e.textContent=this.textContent;return e.staticNum=this.staticNum,e}addEvent(e){this.events||(this.events=[]),this.events.push(e)}}class Compiler{constructor(e){this.module=e}compile(e){return this.compileTemplate(e)}compileTemplate(e){const t=this;e=e.replace(/\<\!\-\-[\s\S]*?\-\-\>/g,"");const s=/('[\s\S]*?')|("[\s\S]*?")|(`[\s\S]*?`)|({{{*)|(}*}})|([\w$-]+(\s*=)?)|(<\s*[a-zA-Z][a-zA-Z0-9-_]*)|(\/?>)|(<\/\s*[a-zA-Z][a-zA-Z0-9-_]*>)/g,i=/^[a-zA-Z_$][$-\w]*?\s*?=?$/,r=/^[\s\n\r\t\v]+$/;let o,n,a,l,d=[],h=[],c=0,p=!1,u=0,m=0;for(;null!==(l=s.exec(e));){let s=l[0];s.startsWith("{{")?(0===m&&(u=l.index),m+=s.length/2|0):s.endsWith("}}")&&(m-=s.length/2|0,0===m&&M()),0===m&&("<"===s[0]?(k(e.substring(c,l.index)),"/"===s[1]?f(s):(n=s.substring(1).trim().toLowerCase(),c=void 0,p="pre"===n,a=new VirtualDom(n,this.genKey()),t.root||(t.root=a),d.push(a),h.push(!1))):">"===s?y():"/>"===s?f():a&&a.tagName&&(i.test(s)?(o&&v(),s.endsWith("=")?o=s.substring(0,s.length-1).trim():(o=s,v())):o&&v(s)))}if(d.length>1||0!==m)throw new NError("wrongTemplate");return d[0];function f(e){if(e){let t=!1;const s=e.substring(2,e.length-1).trim().toLowerCase();for(let e=d.length-1;e>=0;e--)if(!h[e]&&d[e].tagName===s){d[e].children=d.slice(e+1);for(let t of d[e].children)t.parent=d[e],g(t);d.splice(e+1),h.splice(e+1),t=!0;break}if(!t)throw new NError("wrongTemplate")}let i=d[d.length-1];i===t.root&&g(i),h[h.length-1]=!0,a=void 0,o=void 0,c=s.lastIndex,m=0,u=0}function g(e){e.tagName&&(t.postHandleNode(e),e.sortDirective(),t.handleSlot(e))}function y(){a&&(c=s.lastIndex),a=void 0,o=void 0,m=0,u=0}function v(e){a&&o&&(e&&['"',"'","`"].includes(e[0])&&['"',"'","`"].includes(e[e.length-1])&&(e=e.substring(1,e.length-1).trim()),o.startsWith("x-")?a.addDirective(new Directive(o.substring(2),e)):o.startsWith("e-")?a.addEvent(new NEvent(t.module,o.substring(2),e)):a.setProp(o,e),o=void 0)}function M(){c>0&&u>c&&k(e.substring(c,u));const t=e.substring(u+2,s.lastIndex-2);m=0,u=0;let i=new Expression(t);a&&a.tagName?v(i):(w(i),c=s.lastIndex),a.allModelField=i.allModelField}function k(e){""===e||!p&&r.test(e)||w(e=t.preHandleText(e))}function w(e){a||(a=new VirtualDom(null,t.genKey()),d.push(a),h.push(!1)),a.expressions?a.expressions.push(e):"string"==typeof e?a.textContent=e:a.textContent?(a.expressions=[a.textContent,e],delete a.textContent):a.expressions=[e]}}handleSlot(e){if(!e.children||0===e.children.length||!e.hasDirective("module"))return;let t;for(let s=0;s<e.children.length;s++){let i=e.children[s];i.hasDirective("slot")||(t?e.children.splice(s--,1):(t=new VirtualDom("div",this.genKey()),t.addDirective(new Directive("slot",null)),e.children.splice(s,1,t)),t.add(i))}}postHandleNode(e){let t=DefineElementManager.get(e.tagName);if(t&&Reflect.construct(t,[e,this.module]),ModuleFactory.hasClass(e.tagName)){const t=new Directive("module",e.tagName);t.params={srcId:this.module.id},e.addDirective(t),e.tagName="div"}}preHandleText(e){if(/&[a-z]+;/.test(e)){let t=document.createElement("div");return t.innerHTML=e,t.textContent}return e}genKey(){return this.module.getDomKeyId()+""}}class DiffTool{static compare(e,t,s){if(e.tagName){if(e.subModuleId&&e.subModuleId===t.subModuleId)return;if(e.tagName!==t.tagName)r(5,e,null,t.parent);else if(e.staticNum||t.staticNum){let s=!1;for(let i of["props","assets"])if(!e[i]&&t[i]||e[i]&&!t[i])s=!0;else if(e[i]&&t[i]){let r=Object.keys(e[i]),o=Object.keys(t[i]);if(r.length!==o.length)s=!0;else for(let o of r)if(e[i][o]!==t[i][o]){s=!0;break}}s&&r(2,e,null,t.parent)}}else t.tagName?r(5,e,null,t.parent):(e.staticNum||t.staticNum)&&e.textContent!==t.textContent&&r(2,e,null,t.parent);if(e.staticNum>0&&e.staticNum--,e.children&&0!==e.children.length)if(t.children&&0!==t.children.length){let o={},[n,a,l,d]=[0,t.children[0],t.children.length-1,t.children[t.children.length-1]],[h,c,p,u]=[0,e.children[0],e.children.length-1,e.children[e.children.length-1]];for(;n<=l&&h<=p;)if(i(a,c))DiffTool.compare(c,a,s),c=e.children[++h],a=t.children[++n];else if(i(d,u))DiffTool.compare(u,d,s),u=e.children[--p],d=t.children[--l];else if(i(c,d)){for(DiffTool.compare(c,d,s);o.hasOwnProperty(a.key);)s[o[a.key]][0]=4,delete o[a.key],a=t.children[++n];r(4,d,a,t),c=e.children[++h],d=t.children[--l]}else if(i(u,a)){for(DiffTool.compare(u,a,s);o.hasOwnProperty(d.key);)s[o[d.key]][0]=4,delete o[d.key],d=t.children[--l];r(4,a,d,t,1),u=e.children[--p],a=t.children[++n]}else{if(o.hasOwnProperty(a.key)){for(;o.hasOwnProperty(a.key);)s[o[a.key]][0]=4,delete o[a.key],a=t.children[++n];continue}o[c.key]=r(1,c,a,t)-1,c=e.children[++h]}if(n<=l||h<=p)if(n>l)for(let s=h;s<=p;s++)r(1,e.children[s],s,t);else for(let e=n;e<=l;e++){let i=t.children[e];o.hasOwnProperty(i.key)?s[o[i.key]][0]=4:r(3,i,null,t)}}else e.children.forEach((e=>r(1,e,null,t)));else t.children&&t.children.length>0&&t.children.forEach((e=>r(3,e,null,t)));function i(e,t){return e.key===t.key}function r(e,t,i,r,o){return s.push([e,t,i,r,o])}}}class DefineElement{constructor(e){e.hasProp("tag")?(e.tagName=e.getProp("tag"),e.delProp("tag")):e.tagName="div"}}class EventFactory{constructor(e){this.module=e,this.eventMap=new Map}addEvent(e,t,s){let i;this.eventMap.has(e)||this.eventMap.set(e,new Map),i=this.eventMap.get(e),i.has(t.name)||i.set(t.name,{});let r=i.get(t.name);if(s)if(r.delg){let e=r.delg;e.find((e=>e.key===s&&e.event===t))||e.push({key:s,event:t})}else r.delg=[{key:s,event:t}];else{if(t.delg)if(r.toDelg){let e=r.toDelg;-1===e.findIndex((e=>e===t))&&e.push(t)}else r.toDelg=[t];else if(r.own){let e=r.own;-1===e.findIndex((e=>e===t))&&e.push(t)}else r.own=[t];r.capture=t.capture}}getEvent(e){return this.eventMap.get(e)}removeEvent(e,t,s,i){if(!this.eventMap.has(e))return;let r=this.eventMap.get(e);if(!r.has(t.name))return;let o=r.get(t.name);if(s){if(!o.delg)return;{let e=o.delg.findIndex((e=>e.key===s&&e.event===t));-1!==e&&(o.delg.splice(e,1),0===o.delg.length&&delete o.delg)}}else if(i&&o.toDelg){let e=o.toDelg.findIndex((e=>e===t));-1!==e&&(o.toDelg.splice(e,1),0===o.toDelg.length&&delete o.toDelg)}else if(o.own){let e=o.own.findIndex((e=>e===t));-1!==e&&(o.own.splice(e,1),0===o.own.length&&delete o.own)}}bind(e,t,s,i){if(!this.eventMap.has(e))return!1;const r=this.eventMap.get(e);if(!r.has(t))return!1;if(r.bindMap){if(r.bindMap.has(t))return!1}else r.bindMap=new Map;const o=this.module.getNode(e);return o&&o.addEventListener(t,s,i),r.bindMap.set(t,{handler:s,capture:i}),!0}unbind(e,t){if(!this.eventMap.has(e))return;const s=this.eventMap.get(e);if(!s.bindMap||!s.has(t))return;const i=this.module.getNode(e),r=s.bindMap.get(t);i&&r&&i.removeEventListener(t,r.handler,r.capture),s.bindMap.delete(t)}unbindAll(e){if(!this.eventMap.has(e))return;const t=this.eventMap.get(e);if(!t.bindMap)return;const s=this.module.getNode(e);if(s)for(let e of t.bindMap)s.removeEventListener(e[0],e[1].handler,e[1].capture);t.bindMap.clear()}hasEvent(e){return this.eventMap.has(e)}cloneEvent(e,t){if(e===t)return;let s=this.eventMap.get(e);if(!s)return;let i=new Map;for(let e of s){if("bindMap"===e[0])continue;let t={capture:e[1].capture};e[1].own&&(t.own=e[1].own.slice(0)),e[1].delg&&(t.delg=e[1].delg.slice(0)),e[1].toDelg&&(t.toDelg=e[1].toDelg.slice(0)),i.set(e[0],t)}this.eventMap.set(t,i)}}class NCache{constructor(){this.subscribeMap=new Map,this.cacheData={}}get(e){let t=this.cacheData;if(-1!==e.indexOf(".")){let s=e.split(".");if(s.length>1){for(let e=0;e<s.length-1&&t;e++)t=t[s[e]];t&&(e=s[s.length-1])}}if(t)return t[e]}set(e,t){let s=this.cacheData,i=e;if(-1!==e.indexOf(".")){let t=e.split(".");if(t.length>1){for(let e=0;e<t.length-1;e++)s[t[e]]&&"object"==typeof s[t[e]]||(s[t[e]]={}),s=s[t[e]];e=t[t.length-1]}}if(s&&(s[e]=t),this.subscribeMap.has(i)){let e=this.subscribeMap.get(i);for(let s of e)this.invokeSubscribe(s.module,s.handler,t)}}remove(e){let t=this.cacheData;if(-1!==e.indexOf(".")){let s=e.split(".");if(s.length>1){for(let e=0;e<s.length-1&&t;e++)t=t[s[e]];t&&(e=s[s.length-1])}}t&&delete t[e]}subscribe(e,t,s){if(this.subscribeMap.has(t)){let i=this.subscribeMap.get(t);i.find((t=>t.module===e&&t.handler===s))||i.push({module:e,handler:s})}else this.subscribeMap.set(t,[{module:e,handler:s}]);let i=this.get(t);i&&this.invokeSubscribe(e,s,i)}invokeSubscribe(e,t,s){"string"==typeof t?e.invokeMethod(t,s):t.call(e,s)}}class GlobalCache{static set(e,t){this.cache.set(e,t)}static get(e){return this.cache.get(e)}static subscribe(e,t,s){this.cache.subscribe(e,t,s)}static remove(e){this.cache.remove(e)}}GlobalCache.cache=new NCache;class ModelManager{static addToMap(e,t){this.modelMap.set(t.$key,{data:e,model:t})}static delFromMap(e){this.modelMap.has(e)&&(this.modelMap.get(e),this.modelMap.delete(e))}static getModel(e){if(this.modelMap.has(e))return this.modelMap.get(e).model}static getData(e){if(this.modelMap.has(e))return this.modelMap.get(e).data}static bindToModule(e,t){if(!e||!this.modelMap.has(e.$key))return;let s=this.modelMap.get(e.$key),i="number"==typeof t?t:t.id;if(s.modules){let e=s.modules;-1===e.indexOf(i)&&e.push(i)}else s.modules=[i];Object.getOwnPropertyNames(e).forEach((s=>{e[s]&&"object"==typeof e[s]&&e[s].$key&&ModelManager.bindToModule(e[s],t)}))}static bindToModules(e,t){if(!this.modelMap.has(e.$key))return;let s=this.modelMap.get(e.$key);if(s.modules){let e=s.modules;for(let s of t)-1===e.indexOf(s)&&e.push(s)}else s.modules=t;Object.getOwnPropertyNames(e).forEach((s=>{"object"==typeof e[s]&&e[s].$key&&ModelManager.bindToModules(e[s],t)}))}static unbindFromModule(e,t){if(!this.modelMap.has(e.$key))return;let s=this.modelMap.get(e.$key);if(!s.modules)return;let i,r="number"==typeof t?t:t.id,o=s.modules;-1===(i=o.indexOf(r))&&o.splice(i),Object.getOwnPropertyNames(e).forEach((s=>{"object"==typeof e[s]&&e[s].$key&&ModelManager.unbindFromModule(e[s],t)}))}static getModuleIds(e){if(this.modelMap.has(e.$key))return this.modelMap.get(e.$key).modules}static update(e,t,s,i,r){const o=this.getModuleIds(e);if(o){for(let e of o){const t=ModuleFactory.get(e);t&&Renderer.add(t)}if(e.$watchers){if(e.$watchers.$this)for(let t of e.$watchers.$this)for(let r of t.modules){const o=ModuleFactory.get(r);o&&t.f.call(o,e,s,i)}if(e.$watchers[t])for(let r of e.$watchers[t])for(let t of r.modules){const o=ModuleFactory.get(t);o&&r.f.call(o,e,s,i)}}}}}ModelManager.modelMap=new Map;class Model{constructor(e,t){let s=new Proxy(e,{set(e,s,i,r){if(console.log(s,i),e[s]===i)return!0;if(["__proto__"].includes(s))return!0;let o=e[s],n=Reflect.set(e,s,i,r);return i&&!i.$key&&i.constructor===Object&&(i=new Model(i,t)),ModelManager.update(r,s,o,i),n},get(e,s,i){let r=Reflect.get(e,s,i);return!r||r.constructor!==Object&&r.constructor!==Array?r:r.$key?ModelManager.getModel(r.$key):new Model(r,t)},deleteProperty:(e,t)=>(!e[t]||!e[t].$key||Array.isArray(e)&&/^\d+$/.test(t)||ModelManager.delFromMap(e[t].$key),delete e[t],ModelManager.update(e,t,null,null,!0),!0)});for(let e of["$watch","$unwatch","$get","$set"])s[e]=this[e];return s.$key=Util.genId(),ModelManager.addToMap(e,s),t&&ModelManager.bindToModule(s,t),Array.isArray(e)&&this.arrayOverload(s),s}arrayOverload(e){e.splice=function(){const t=arguments[1];let s=Array.prototype.splice.apply(e,arguments);if(t>0)for(let e=0;e<s.length;e++)s[e].$key&&(ModelManager.delFromMap(s[e].$key),delete s[e].$key);return s},e.shift=function(){let t=e[0];return Array.prototype.shift.apply(e),t&&t.$key&&(ModelManager.delFromMap(t.$key),delete t.$key),t},e.pop=function(){let t=e[e.length-1];return Array.prototype.pop.apply(e),t&&t.$key&&(ModelManager.delFromMap(t.$key),delete t.$key),t}}$watch(e,t,s){let i=ModelManager.getModuleIds(this),r=[];if(Array.isArray(e))for(let s of e)o(this,s,t);else o(this,e,t);return()=>{for(let e of r){const t=e.m.$watchers[e.k];if(t)for(let s=0;s<t.length;s++)t[s].f===e.f&&(t.splice(s,1),0===t.length&&delete e.m.$watchers[e.k])}r=null};function o(e,t,n){let a=-1;if(-1!==(a=t.lastIndexOf("."))&&(e=this.$get(t.substring(0,a)),t=t.substring(a+1)),!e)return;const l={modules:i,f:n};if(e.$watchers||(e.$watchers={}),e.$watchers[t]?e.$watchers[t].push(l):e.$watchers[t]=[l],r.push({m:e,k:t,f:n}),s&&"object"==typeof e[t])for(let s of Object.keys(e[t]))"$key"!==s&&"function"!=typeof e[t][s]&&o(e[t],s,n)}}$get(e){let t=this;if(-1!==e.indexOf(".")){let s=e.split(".");for(let e=0;e<s.length-1&&(t=t[s[e]],t);e++);if(!t)return;e=s[s.length-1]}return t[e]}$set(e,t,s){let i=this,r=ModelManager.getModuleIds(this);if(-1!==e.indexOf(".")){let t=e.split(".");for(let e=0;e<t.length-1;e++){if(!i[t[e]]){let s=new Model({});ModelManager.bindToModules(s,r),i[t[e]]=s}i=i[t[e]]}e=t[t.length-1]}"object"==typeof t&&s&&ModelManager.bindToModule(t,s),i[e]=t}}class ObjectManager{constructor(e){this.module=e,this.cache=new NCache}set(e,t){this.cache.set(e,t)}get(e){return this.cache.get(e)}remove(e){this.cache.remove(e)}setEventParam(e,t,s,i){this.cache.set("$events."+e+".$params."+t+"."+s,i)}getEventParam(e,t,s){return this.get("$events."+e+".$params."+t+"."+s)}removeEventParam(e,t,s){this.remove("$events."+e+".$params."+t+"."+s)}clearEventParam(e,t){t?this.remove("$events."+e+".$params."+t):this.remove("$events."+e+".$params")}setDomParam(e,t,s){this.set("$domparam."+e+"."+t,s)}getDomParam(e,t){return this.get("$domparam."+e+"."+t)}removeDomParam(e,t){this.remove("$domparam."+e+"."+t)}clearDomParams(e){this.remove("$domparam."+e)}clearAllDomParams(){this.remove("$domparam")}}DefineElementManager.add([class MODULE extends DefineElement{constructor(e,t){super(e);let s=e.getProp("name");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"MODULE","className");e.delProp("name"),e.addDirective(new Directive("module",s))}},class FOR extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"FOR","cond");e.delProp("cond"),e.addDirective(new Directive("repeat",s))}},class IF extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"IF","cond");e.delProp("cond"),e.addDirective(new Directive("if",s))}},class RECUR extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");e.delProp("cond"),e.addDirective(new Directive("recur",s))}},class ELSE extends DefineElement{constructor(e,t){super(e),e.addDirective(new Directive("else",null))}},class ELSEIF extends DefineElement{constructor(e,t){super(e);let s=e.getProp("cond");if(!s)throw new NError("itemnotempty",exports.NodomMessage.TipWords.element,"ELSEIF","cond");e.delProp("cond"),e.addDirective(new Directive("elseif",s))}},class ENDIF extends DefineElement{constructor(e,t){super(e),e.addDirective(new Directive("endif",null))}},class SLOT extends DefineElement{constructor(e,t){super(e);let s=e.getProp("name")||"default";e.delProp("name"),e.addDirective(new Directive("slot",s))}}]),i("module",(function(e,t,s){let i,r=e.objectManager.getDomParam(t.key,"moduleId"),o=!0;if(r)i=ModuleFactory.get(r),o=!t.props.renderOnce;else{if(i=ModuleFactory.get(this.value),!i)return!0;this.params&&this.params.srcId&&(i.compileMid=this.params.srcId),r=i.id,e.objectManager.setDomParam(t.key,"moduleId",r),e.addChild(i),s.hasProp("useDomModel")&&(i.model=t.model,ModelManager.bindToModule(i.model,i),delete t.props.useDomModel)}if(t.subModuleId=r,delete t.tagName,o){let e={};if(t.props)for(let s of Object.keys(t.props)){let i=t.props[s];"$"===s[0]?(e.$data||(e.$data={}),e.$data[s.substring(1)]=i,delete t.props[s]):e[s]=i}i.setProps(e,t)}return!0}),8),i("model",(function(e,t,s){let i=t.model.$get(this.value);return i&&(t.model=i),!0}),1),i("repeat",(function(e,t,s){let i=this.value;if(!Util.isArray(i)||0===i.length)return!1;const r=s.getProp("$index"),o=t.parent;this.disabled=!0,delete s.model;for(let t=0;t<i.length;t++){r&&(i[t][r]=t),s.staticNum++;let n=Renderer.renderDom(e,s,i[t],o,i[t].$key+"");r&&delete n.props.$index}return this.disabled=!1,!1}),2),i("recur",(function(e,t,s){if(t.props.hasOwnProperty("ref")){s.children=[];const i="$recurs."+(t.props.ref||"default");let r=e.objectManager.get(i);if(!r)return!0;let o=t.model[r.getDirective("recur").value];if(!o)return!0;let n=r.clone();Array.isArray(o)||(n.model=o,Util.setNodeKey(n,o.$key,!0)),s.children=[n],n.parent=s}else{if(!t.model[this.value])return!0;const i="$recurs."+(t.props.name||"default");e.objectManager.get(i)||e.objectManager.set(i,s)}return!0}),2),i("if",(function(e,t,s){return e.objectManager.setDomParam(t.parent.key,"$if",this.value),this.value}),5),i("else",(function(e,t,s){return!1===e.objectManager.getDomParam(t.parent.key,"$if")}),5),i("elseif",(function(e,t,s){return!0!==e.objectManager.getDomParam(t.parent.key,"$if")&&!!this.value&&(e.objectManager.setDomParam(t.parent.key,"$if",!0),!0)}),5),i("endif",(function(e,t,s){return e.objectManager.removeDomParam(t.parent.key,"$if"),!0}),5),i("show",(function(e,t,s){return!!this.value}),5),i("field",(function(e,t,s){const i=t.props.type||"text",r=t.tagName.toLowerCase(),o=t.model;if(!o)return!0;let n=o.$get(this.value);if("radio"===i)n==t.props.value?(t.props.checked="checked",Util.setDomAsset(t,"checked",!0)):(delete t.props.checked,Util.setDomAsset(t,"checked",!1));else if("checkbox"===i){let e=t.props["yes-value"];n==e?(t.props.value=e,Util.setDomAsset(t,"checked",!0)):(t.props.value=t.props["no-value"],Util.setDomAsset(t,"checked",!1))}else if("select"===r)t.props.value=n,Util.setDomAsset(t,"value",n);else{let e=null!=n?n:"";t.props.value=e,Util.setDomAsset(t,"value",e)}let a=GlobalCache.get("$fieldChangeEvent");return a||(a=new NEvent(null,"change",(function(e,t){let s=this.getNode(t.key);if(!s)return;let i=t.vdom.getDirective("field"),r=t.props.type,o=i.value,n=s.value;"checkbox"===r?n=t.props["yes-value"]==n?t.props["no-value"]:t.props["yes-value"]:"radio"===r&&(s.checked||(n=void 0));let a=o.split(".");if(1===a.length)e[o]=n;else{let t=e;o=a.pop();for(let e=0;e<a.length&&t;e++)t=t[a[e]];t&&(t[o]=n)}})),GlobalCache.set("$fieldChangeEvent",a)),s.addEvent(a),!0}),10),i("route",(function(e,t,s){if("a"===t.tagName.toLowerCase()&&(t.props.href="javascript:void(0)"),t.props.path=this.value,t.props.active){let s=t.props.active;delete t.props.active,Router.addActiveField(e,this.value,t.model,s),this.value.startsWith(Router.currentPath)&&t.model[s]&&Router.go(this.value)}let i=GlobalCache.get("$routeClickEvent");return i||(i=new NEvent(null,"click",(function(e,t,s,i){let r=t.props.path;Util.isEmpty(r)||Router.go(r)})),GlobalCache.set("$routeClickEvent",i)),s.addEvent(i),!0})),i("router",(function(e,t,s){return Router.routerKeyMap.set(e.id,t.key),!0})),i("slot",(function(e,t,s){this.value=this.value||"default";let i=t.parent.subModuleId;if(i){let e=ModuleFactory.get(i);e&&(e.objectManager.set("$slots."+this.value,{dom:s,model:t.model}),s.parent&&s.parent.remove(s))}else{const i=e.objectManager.get("$slots."+this.value);if(i)for(let r of i.dom.children){let o;s.hasProp("innerRender")?o=t.model:(o=i.model,ModelManager.bindToModule(i.model,e)),Renderer.renderDom(e,r,o,t.parent,t.key+"s")}}return!1}),5),i("animation",(function(e,t,s){var i,r,o,n,a,l,d,h,c,p,u,m,f,g,y,v,M,k,w,E;const b=this.value;if(!Util.isObject(b))return new Error("未找到animation配置对象");const x=0!=b.tigger,D=b.type||"transition",N=0!=b.isAppear,C=(null===(i=b.name)||void 0===i?void 0:i.enter)||b.name,T=(null===(r=b.name)||void 0===r?void 0:r.leave)||b.name,P=(null===(o=b.duration)||void 0===o?void 0:o.enter)||b.duration||"",R=(null===(n=b.duration)||void 0===n?void 0:n.leavr)||b.duration||"",$=(null===(a=b.delay)||void 0===a?void 0:a.enter)||b.delay||"0s",O=(null===(l=b.delay)||void 0===l?void 0:l.leave)||b.delay||"0s",F=(null===(d=b.timingFunction)||void 0===d?void 0:d.enter)||b.timingFunction||"ease",S=(null===(h=b.timingFunction)||void 0===h?void 0:h.leave)||b.timingFunction||"ease",j=(null===(p=null===(c=b.hooks)||void 0===c?void 0:c.enter)||void 0===p?void 0:p.before)?b.hooks.enter.before:(null===(u=b.hooks)||void 0===u?void 0:u.before)||void 0,W=(null===(f=null===(m=b.hooks)||void 0===m?void 0:m.enter)||void 0===f?void 0:f.after)?b.hooks.enter.after:(null===(g=b.hooks)||void 0===g?void 0:g.after)||void 0,A=(null===(v=null===(y=b.hooks)||void 0===y?void 0:y.leave)||void 0===v?void 0:v.before)?b.hooks.leave.before:(null===(M=b.hooks)||void 0===M?void 0:M.before)||void 0,I=(null===(w=null===(k=b.hooks)||void 0===k?void 0:k.leave)||void 0===w?void 0:w.after)?b.hooks.leave.after:(null===(E=b.hooks)||void 0===E?void 0:E.after)||void 0;let L=()=>{const s=e.getNode(t.key);x?(W&&W.apply(e.model,[e]),s.classList.remove(C+"-enter-active"),"animation"==D&&s.classList.add(C+"-enter-to")):(N&&(s.style.display="none"),I&&I.apply(e.model,[e]),[s.style.width,s.style.height]=function(e){const t=e.vdom.getProp("style");let s,i;if(t){let e=t.trim().split(/;\s*/);for(const t of e)t.startsWith("width")&&(s=t.split(":")[1]),t.startsWith("height")&&(i=t.split(":")[1])}return s=s||"",i=i||"",[s,i]}(t),s.classList.remove(T+"-leave-active"),"animation"==D&&s.classList.add(T+"-leave-to")),s.removeEventListener("animationend",L),s.removeEventListener("transitionend",L)},U=e.getNode(t.key);if(x){if(U){if(-1!=U.getAttribute("class").indexOf(`${C}-enter-to`))return t.props.class+=` ${C}-enter-to`,!0;N&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),_(U)}else N&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),setTimeout((()=>{let s=e.getNode(t.key);N&&(t.props.class+=` ${C}-enter-to`,s.style.display="none"),_(s)}),0);return!0}return U?-1!=U.getAttribute("class").indexOf(`${T}-leave-to`)?(t.props.class+=` ${T}-leave-to`,N&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),!0):(V(U),!0):(N&&(t.props.style?t.props.style+=";display:none;":t.props.style="display:none;"),setTimeout((()=>{let s=e.getNode(t.key);N?(s.classList.add(`${T}-leave-to`),t.props.class+=` ${T}-leave-to`,s.style.display="none"):V(s)}),0),!0);function V(t){if("transition"==D){let[s,i]=K(t);requestAnimationFrame((()=>{t.classList.remove(C+"-enter-to"),t.classList.add(T+"-leave-active"),t.classList.add(T+"-leave-from"),"fold-height"==T?t.style.height=i:"fold-width"==T&&(t.style.width=s),t.style.transitionDelay=$,""!=P&&(t.style.transitionDuration=P),"ease"!=F&&(t.style.transitionTimingFunction=F),A&&A.apply(e.model,[e]),requestAnimationFrame((()=>{t.classList.add(T+"-leave-to"),t.classList.remove(T+"-leave-from"),"fold-height"==T?t.style.height="0px":"fold-width"==T&&(t.style.width="0px"),t.addEventListener("transitionend",L)}))}))}else requestAnimationFrame((()=>{t.classList.remove(C+"-enter-to"),t.style.animationDelay=O,""!=R&&(t.style.animationDuration=R),"ease"!=S&&(t.style.animationTimingFunction=S),A&&A.apply(e.model,[e]),t.offsetWidth,t.classList.add(T+"-leave-active"),t.addEventListener("animationend",L)}))}function _(t){if("transition"==D){t.style.transitionDelay="0s";let s=1e3*parseFloat($);setTimeout((()=>{let[s,i]=K(t);t.classList.remove(T+"-leave-to"),t.classList.add(C+"-enter-active"),t.classList.add(C+"-enter-from"),"fold-height"==C?t.style.height="0px":"fold-width"==C&&(t.style.width="0px"),""!=P&&(t.style.transitionDuration=P),"ease"!=F&&(t.style.transitionTimingFunction=F),requestAnimationFrame((()=>{N&&(t.style.display=""),requestAnimationFrame((()=>{j&&j.apply(e.model,[e]),t.classList.add(C+"-enter-to"),t.classList.remove(C+"-enter-from"),"fold-height"==C?t.style.height=i:"fold-width"==C&&(t.style.width=s),t.addEventListener("transitionend",L)}))}))}),s)}else{t.style.animationDelay="0s";let s=1e3*parseFloat($);setTimeout((()=>{requestAnimationFrame((()=>{t.classList.remove(T+"-leave-to"),""!=P&&(t.style.animationDuration=P),"ease"!=F&&(t.style.animationTimingFunction=P),N&&(t.style.display=""),j&&j.apply(e.model,[e]),t.offsetWidth,t.classList.add(C+"-enter-active"),t.addEventListener("animationend",L)}))}),s)}}function K(e){if("none"==e.style.display){const t=window.getComputedStyle(e).getPropertyValue("position"),s=window.getComputedStyle(e).getPropertyValue("visibility");e.style.position="absolute",e.style.visibility="hidden",e.style.display="";let i=window.getComputedStyle(e).getPropertyValue("width"),r=window.getComputedStyle(e).getPropertyValue("height");return e.style.position=t,e.style.visibility=s,e.style.display="none",[i,r]}return[window.getComputedStyle(e).getPropertyValue("width"),window.getComputedStyle(e).getPropertyValue("height")]}}),9),EventManager.regist("tap",{touchstart(e,t,s,i){let r=i.touches[0];s.dependEvent.setParam(t,e,"pos",{sx:r.pageX,sy:r.pageY,t:Date.now()})},touchmove(e,t,s,i){let r=s.dependEvent.getParam(t,e,"pos");if(!r)return;let o=i.touches[0],n=o.pageX-r.sx,a=o.pageY-r.sy;(Math.abs(n)>5||Math.abs(a)>5)&&(r.move=!0)},touchend(e,t,s,i){let r=s.dependEvent.getParam(t,e,"pos");if(!r)return;s.dependEvent.removeParam(t,e,"pos");let o=Date.now()-r.t;if(!r.move&&o<200){let r=s.dependEvent.handler;"string"==typeof r?t.invokeMethod(s.dependEvent.handler,e.model,e,s.dependEvent,i):r.apply(t,[e.model,e,s.dependEvent,i])}}}),EventManager.regist("swipe",{touchstart(e,t,s,i){let r=i.touches[0],o=Date.now();s.dependEvent.setParam(t,e,"swipe",{oldTime:[o,o],speedLoc:[{x:r.pageX,y:r.pageY},{x:r.pageX,y:r.pageY}],oldLoc:{x:r.pageX,y:r.pageY}})},touchmove(e,t,s,i){let r=Date.now(),o=i.touches[0],n=s.dependEvent.getParam(t,e,"swipe");r-n.oldTime[1]>50&&(n.speedLoc[0]={x:n.speedLoc[1].x,y:n.speedLoc[1].y},n.speedLoc[1]={x:o.pageX,y:o.pageY},n.oldTime[0]=n.oldTime[1],n.oldTime[1]=r),n.oldLoc={x:o.pageX,y:o.pageY}},touchend(e,t,s,i){let r=s.dependEvent.getParam(t,e,"swipe"),o=Date.now(),n=o-r.oldTime[1]<30?0:1,a=r.oldLoc.x-r.speedLoc[n].x,l=r.oldLoc.y-r.speedLoc[n].y,d=Math.sqrt(a*a+l*l),h=o-r.oldTime[n];if(h>300||d<10)return;let c=d/h;if(c>.05){let r="";if(a<0&&Math.abs(l/a)<1&&(i.v0=c,r="swipeleft"),a>0&&Math.abs(l/a)<1&&(i.v0=c,r="swiperight"),l>0&&Math.abs(a/l)<1&&(i.v0=c,r="swipedown"),l<0&&Math.abs(a/l)<1&&(i.v0=c,r="swipeup"),s.dependEvent.name===r){let r=s.dependEvent.handler;"string"==typeof r?t.invokeMethod(r,e.model,e,s.dependEvent,i):"function"==typeof r&&r.apply(t,[e.model,e,s.dependEvent,i])}}}}),EventManager.regist("swipeleft",EventManager.get("swipe")),EventManager.regist("swiperight",EventManager.get("swipe")),EventManager.regist("swipeup",EventManager.get("swipe")),EventManager.regist("swipedown",EventManager.get("swipe")),exports.Compiler=Compiler,exports.CssManager=CssManager,exports.DefineElement=DefineElement,exports.DefineElementManager=DefineElementManager,exports.DiffTool=DiffTool,exports.Directive=Directive,exports.DirectiveManager=DirectiveManager,exports.DirectiveType=DirectiveType,exports.EventFactory=EventFactory,exports.EventManager=EventManager,exports.Expression=Expression,exports.GlobalCache=GlobalCache,exports.Model=Model,exports.ModelManager=ModelManager,exports.Module=class Module{constructor(){this.children=[],this.preRenderOps=[],this.postRenderOps=[],this.keyNodeMap=new Map,this.keyElementMap=new Map,this.keyVDomMap=new Map,this.id=Util.genId(),this.objectManager=new ObjectManager(this),this.changedModelMap=new Map,this.eventFactory=new EventFactory(this),ModuleFactory.add(this)}init(){if(this.state=exports.EModuleState.INITED,this.model=new Model(this.data()||{},this),this.modules&&Array.isArray(this.modules)){for(let e of this.modules)ModuleFactory.addClass(e);delete this.modules}}template(e){return null}data(){return{}}render(){if(this.state===exports.EModuleState.UNACTIVE)return;this.dontAddToRender=!0;let e=this.template(this.props);if(e!==this.oldTemplate&&(this.oldTemplate=e,this.compile()),this.originTree)if(this.doRenderOps(0),this.doModuleEvent("onBeforeRender"))this.dontAddToRender=!1;else{if(this.renderTree){if(this.model){let e=this.renderTree;this.renderTree=Renderer.renderDom(this,this.originTree,this.model),this.doModuleEvent("onBeforeRenderToHtml");let t=[];DiffTool.compare(this.renderTree,e,t),t.length>0&&Renderer.handleChangedDoms(this,t)}}else this.doFirstRender();this.state=exports.EModuleState.RENDERED,this.doRenderOps(1),this.doModuleEvent("onRender"),this.changedModelMap.clear(),this.dontAddToRender=!1}}doFirstRender(){this.doModuleEvent("onBeforeFirstRender"),this.renderTree=Renderer.renderDom(this,this.originTree,this.model),this.doModuleEvent("onBeforeFirstRenderToHTML");let e=Renderer.renderToHtml(this,this.renderTree,null,!0);this.srcDom?(this.srcElement=this.getParent().getNode(this.srcDom.key),this.exchange()):this.container&&this.container.appendChild(e),this.doModuleEvent("onFirstRender")}addChild(e){let t;"number"==typeof e?(t=e,e=ModuleFactory.get(t)):t=e.id,this.children.includes(t)||(this.children.push(t),e.parentId=this.id,e.active())}removeChild(e){let t=this.children.indexOf(e.id);-1!==t&&(e.unactive(),this.children.splice(t,1))}active(e){if(!e&&this.srcDom){const e=this.getParent();if(e&&!e.findRenderedDom(this.srcDom.key))return}this.state=exports.EModuleState.INITED,Renderer.add(this)}unactive(){if(ModuleFactory.getMain()!==this){if(this.doModuleEvent("beforeUnActive"),this.state=exports.EModuleState.UNACTIVE,this.renderTree)if(this.container){const e=this.getNode(this.renderTree.key);e&&this.container.removeChild(e)}else this.exchange(1);if(delete this.renderTree,this.keyNodeMap.clear(),this.keyElementMap.clear(),this.keyVDomMap.clear(),this.eventFactory=new EventFactory(this),this.doModuleEvent("unActive"),this.children)for(let e of this.children){let t=ModuleFactory.get(e);t&&t.unactive()}}}getParent(){if(this.parentId)return ModuleFactory.get(this.parentId)}doModuleEvent(e){let t=this[e];if(t&&"function"==typeof t)return t.apply(this,[this.model])}getMethod(e){return this[e]}setContainer(e){this.container=e}invokeMethod(e,t,s,i,r,o,n,a,l){let d=this,h=d[e];if(!h&&this.compileMid&&(d=ModuleFactory.get(this.compileMid),d&&(h=d[e])),h&&"function"==typeof h){let e=[];for(let t=1;t<arguments.length;t++)e.push(arguments[t]);return h.apply(d,e)}}addRenderOps(e,t,s,i){if("function"!=typeof e)return;(0===t?this.preRenderOps:this.postRenderOps).push({foo:e,args:s,once:i})}doRenderOps(e){let t=0===e?this.preRenderOps:this.postRenderOps;if(t)for(let e=0;e<t.length;e++){let s=t[e];s.foo.apply(this,s.args),s.once&&t.splice(e--,1)}}setProps(e,t){let s=e.$data;if(delete e.$data,s)for(let e in s){let t=s[e];"object"==typeof t&&this.model[e]!==t&&ModelManager.bindToModule(t,this),this.model[e]=t}if(this.srcDom=t,this.state===exports.EModuleState.INITED||this.state===exports.EModuleState.UNACTIVE)this.active(1);else{let t=!1;if(this.props){const s=Object.getOwnPropertyNames(e);if(s.length!==(this.props?Object.getOwnPropertyNames(this.props):[]).length)t=!0;else for(let i of s)if(e[i]!==this.props[i]){t=!0;break}}else t=!0;t&&this.active(1)}this.props=e}compile(){if(this.domKeyId=0,this.children=[],CssManager.clearModuleRules(this),this.objectManager.clearAllDomParams(),!this.oldTemplate)return;this.originTree=new Compiler(this).compile(this.oldTemplate),this.props&&this.mergeProps(this.originTree,this.props);let e=this.getParent();if(e){const t=e.eventFactory.getEvent(this.srcDom.key);if(t)for(let e of t)if(e[1].own)for(let t of e[1].own)this.originTree.addEvent(t)}this.doModuleEvent("onCompile")}mergeProps(e,t){let s=!1;for(let i of Object.keys(t))if(e.hasProp(i)){let r=e.getProp(i);Array.isArray(r)?r[1]!==t[i]&&(e.setProp(i,[r[0],t[i]]),s=!0):(e.setProp(i,[r,t[i]]),s=!0)}else e.setProp(i,t[i]),s=!0;return s&&(e.staticNum=1),s}getNode(e){return this.keyNodeMap.get(e)}saveNode(e,t){this.keyNodeMap.set(e,t)}getElement(e){return this.keyElementMap.get(e)}saveElement(e,t){this.keyElementMap.set(e,t)}getVirtualDom(e){return this.keyVDomMap.get(e)}saveVirtualDom(e,t){this.keyVDomMap.set(t||e.key,e)}removeNode(e,t){if(e.subModuleId){let t=ModuleFactory.get(e.subModuleId);t&&t.unactive()}else if(this.keyNodeMap.delete(e.key),this.keyElementMap.delete(e.key),this.keyVDomMap.delete(e.key),this.eventFactory.unbindAll(e.key),t&&e&&e.children)for(let t of e.children)this.removeNode(t,!0)}clearDomCache(e,t){if(t&&e.children)for(let t of e.children)this.clearDomCache(t,!0);this.objectManager.clearDomParams(e.key),this.keyNodeMap.delete(e.key),this.keyVDomMap.delete(e.key)}getOrginDom(e){return this.originTree?function t(s){if(s.key===e)return s;if(s.children)for(let e of s.children){let s=t(e);if(s)return s}}(this.originTree):null}getDomKeyId(){return++this.domKeyId}exchange(e){if(!this.renderTree||!this.srcElement)return;const t=this.getNode(this.renderTree.key);if(!t)return;const s=this.getParent();e?t.parentElement&&(t.parentElement.replaceChild(this.srcElement,t),s.saveNode(this.srcDom.key,this.srcElement)):this.srcElement.parentElement&&(this.srcElement.parentElement.replaceChild(t,this.srcElement),s.saveNode(this.srcDom.key,t))}findRenderedDom(e){if(!this.renderTree)return;const t=function e(t,s){if(t.key===s)return t;if(t.children)for(let i of t.children){let t=e(i,s);if(t)return t}}(this.renderTree,e);return t}},exports.ModuleFactory=ModuleFactory,exports.NCache=NCache,exports.NError=NError,exports.NEvent=NEvent,exports.NFactory=class NFactory{constructor(e){this.items=new Map,void 0!==e&&(this.moduleId=e.id)}add(e,t){this.items.set(e,t)}get(e){return this.items.get(e)}remove(e){this.items.delete(e)}has(e){return this.items.has(e)}},exports.NodomMessage_en=e,exports.NodomMessage_zh={TipWords:{application:"应用",system:"系统",module:"模块",moduleClass:"模块类",model:"模型",directive:"指令",directiveType:"指令类型",expression:"表达式",event:"事件",method:"方法",filter:"过滤器",filterType:"过滤器类型",data:"数据",dataItem:"数据项",route:"路由",routeView:"路由容器",plugin:"插件",resource:"资源",root:"根",element:"元素"},ErrorMsgs:{unknown:"未知错误",paramException:"{0}'{1}'方法参数错误，请参考api",invoke:"{0}方法调用参数{1}必须为{2}",invoke1:"{0}方法调用参数{1}必须为{2}或{3}",invoke2:"{0}方法调用参数{1}或{2}必须为{3}",invoke3:"{0}方法调用参数{1}不能为空",exist:"{0}已存在",exist1:"{0}'{1}'已存在",notexist:"{0}不存在",notexist1:"{0}'{1}'不存在",notupd:"{0}不可修改",notremove:"{0}不可删除",notremove1:"{0}{1}不可删除",namedinvalid:"{0}{1}命名错误，请参考用户手册对应命名规范",initial:"{0}初始化参数错误",jsonparse:"JSON解析错误",timeout:"请求超时",config:"{0}配置参数错误",config1:"{0}配置参数'{1}'错误",itemnotempty:"{0} '{1}' 配置项 '{2}' 不能为空",itemincorrect:"{0} '{1}' 配置项 '{2}' 错误",compile1:"{0}标签未闭合",compile2:"结束标签{0}未找到与之匹配的开始标签",compile3:"请检查模板标签闭合情况，模板需要有一个闭合的根节点",wrongTemplate:"模版格式错误"},FormMsgs:{type:"请输入有效的{0}",unknown:"输入错误",required:"不能为空",min:"最小输入值为{0}",max:"最大输入值为{0}"},WeekDays:{0:"日",1:"一",2:"二",3:"三",4:"四",5:"五",6:"六"}},exports.Renderer=Renderer,exports.Route=Route,exports.Router=Router,exports.Scheduler=Scheduler,exports.Util=Util,exports.VirtualDom=VirtualDom,exports.createDirective=i,exports.createRoute=function(e,t){let s;if(t=t||Router.root,Util.isArray(e))for(let i of e)s=new Route(i,t);else s=new Route(e,t);return s},exports.nodom=function(t,s){Scheduler.addTask(Renderer.render,Renderer),Scheduler.start(),exports.NodomMessage=e;let i=ModuleFactory.get(t);i.setContainer(document.querySelector(s)),i.active()},exports.registModule=function(e,t){ModuleFactory.addClass(e,t)},exports.request=function(e){return t(this,void 0,void 0,(function*(){return new Promise(((t,s)=>{"string"==typeof e&&(e={url:e}),e.params=e.params||{},e.rand&&(e.params.$rand=Math.random());let i=e.url;const r=!1!==e.async,o=new XMLHttpRequest;o.withCredentials=e.withCredentials;const n=(e.method||"GET").toUpperCase();o.timeout=r?e.timeout:0,o.onload=()=>{if(200===o.status){let i=o.responseText;if("json"===e.type)try{i=JSON.parse(i)}catch(e){s({type:"jsonparse"})}t(i)}else s({type:"error",url:i})},o.ontimeout=()=>s({type:"timeout"}),o.onerror=()=>s({type:"error",url:i});let a=null;switch(n){case"GET":let t;if(Util.isObject(e.params)){let s=[];for(let t of Object.keys(e.params)){const i=e.params[t];null!=i&&s.push(t+"="+i)}t=s.join("&")}void 0!==t&&(-1!==i.indexOf("?")?i+="&"+t:i+="?"+t);break;case"POST":if(e.params instanceof FormData)a=e.params;else{let t=new FormData;for(let s of Object.keys(e.params)){const i=e.params[s];null!=i&&t.append(s,i)}a=t}}o.open(n,i,r,e.user,e.pwd),e.header&&Util.getOwnProps(e.header).forEach((t=>{o.setRequestHeader(t,e.header[t])})),o.send(a)})).catch((e=>{switch(e.type){case"error":throw new NError("notexist1",exports.NodomMessage.TipWords.resource,e.url);case"timeout":throw new NError("timeout");case"jsonparse":throw new NError("jsonparse")}}))}))};
//# sourceMappingURL=nodom.cjs.min.js.map
