{"version":3,"file":"nodom.esm.min.js","sources":["../core/defineelementmanager.ts","../core/directivetype.ts","../core/directivemanager.ts","../node_modules/_tslib@2.1.0@tslib/tslib.es6.js","../core/locales/msg_en.ts","../core/locales/msg_zh.ts","../core/modulefactory.ts","../core/expression.ts","../core/cssmanager.ts","../core/types.ts","../core/renderer.ts","../core/requestmanager.ts","../core/route.ts","../core/scheduler.ts","../core/nodom.ts","../core/error.ts","../core/util.ts","../core/directive.ts","../core/event.ts","../core/virtualdom.ts","../core/compiler.ts","../core/difftool.ts","../core/defineelement.ts","../core/eventfactory.ts","../core/cache.ts","../core/globalcache.ts","../core/model.ts","../core/modelmanager.ts","../core/objectmanager.ts","../core/dommanager.ts","../core/module.ts","../core/router.ts","../extend/elementinit.ts","../extend/directiveinit.ts"],"sourcesContent":["import { DefineElementClass} from \"./types\";\n\n/**\n * 自定义元素管理器\n * \n * @remarks\n * 所有自定义元素需要添加到管理器才能使用\n */\nexport class DefineElementManager {\n    /**\n     * 自定义元素集合\n     */\n    private static elements: Map<string, DefineElementClass> = new Map();\n    \n    /**\n     * 添加自定义元素\n     * @param clazz -   自定义元素类或类数组\n     */\n    public static add(clazz:unknown[]|unknown) {\n        if(Array.isArray(clazz)){\n            for(const c of clazz){\n                this.elements.set(c.name.toUpperCase(), <DefineElementClass>c);\n            }\n        }else{\n            this.elements.set((<DefineElementClass>clazz).name.toUpperCase(), <DefineElementClass>clazz);\n        }\n    }\n\n    /**\n     * 获取自定义元素类\n     * @param tagName - 元素名\n     * @returns         自定义元素类\n     */\n    public static get(tagName: string): DefineElementClass {\n        return this.elements.get(tagName.toUpperCase());\n    }\n\n    /**\n     * 是否存在自定义元素\n     * @param tagName - 元素名\n     * @returns         存在或不存在\n     */\n    public static has(tagName:string):boolean{\n        return this.elements.has(tagName.toUpperCase());\n    }\n}\n","import { DirectiveMethod } from \"./types\";\n\n/**\n * 指令类型\n */\nexport  class DirectiveType {\n    /**\n     * 指令类型名\n     */\n    public name:string;\n    \n    /**\n     * 优先级，越小优先级越高\n     */\n    public prio:number;\n\n    /**\n     * 渲染时执行函数\n     */\n    public handler:DirectiveMethod;\n    \n    /**\n     * 构造方法\n     * @param name -    指令类型名       \n     * @param handle -  渲染时执行方法\n     * @param prio -    类型优先级\n     */ \n    constructor(name:string,handler:DirectiveMethod, prio?:number) {\n        this.name = name;\n        this.prio = prio>=0?prio:10;\n        this.handler = handler;\n    }\n}\n","import { DirectiveType } from \"./directivetype\";\nimport { DirectiveMethod } from \"./types\";\n/**\n * 指令管理器\n */\nexport  class DirectiveManager {\n    /**\n     * 指令映射\n     */\n    private static directiveTypes:Map<string,DirectiveType> = new Map();\n    \n    /**\n     * 增加指令映射\n     * @param name -    指令类型名\n     * @param handle -  渲染处理函数\n     * @param prio -    类型优先级\n     */\n    public static addType(name:string,handler:DirectiveMethod,prio?:number) {\n        this.directiveTypes.set(name, new DirectiveType(name,handler,prio));\n    }\n\n    /**\n     * 移除指令映射\n     * @param name -    指令类型名\n     */\n    public static removeType(name:string) {\n        this.directiveTypes.delete(name);\n    }\n\n    /**\n     * 获取指令\n     * @param name -    指令类型名\n     * @returns         指令类型或undefined\n     */\n    public static getType(name:string) {\n        return this.directiveTypes.get(name);\n    }\n\n    /**\n     * 是否含有某个指令\n     * @param name -    指令类型名\n     * @returns         true/false\n     */\n    public static hasType(name:string) {\n        return this.directiveTypes.has(name);\n    }\n}\n","/*! *****************************************************************************\r\nCopyright (c) Microsoft Corporation.\r\n\r\nPermission to use, copy, modify, and/or distribute this software for any\r\npurpose with or without fee is hereby granted.\r\n\r\nTHE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\r\nREGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY\r\nAND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\r\nINDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM\r\nLOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR\r\nOTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR\r\nPERFORMANCE OF THIS SOFTWARE.\r\n***************************************************************************** */\r\n/* global Reflect, Promise */\r\n\r\nvar extendStatics = function(d, b) {\r\n    extendStatics = Object.setPrototypeOf ||\r\n        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\r\n        function (d, b) { for (var p in b) if (Object.prototype.hasOwnProperty.call(b, p)) d[p] = b[p]; };\r\n    return extendStatics(d, b);\r\n};\r\n\r\nexport function __extends(d, b) {\r\n    if (typeof b !== \"function\" && b !== null)\r\n        throw new TypeError(\"Class extends value \" + String(b) + \" is not a constructor or null\");\r\n    extendStatics(d, b);\r\n    function __() { this.constructor = d; }\r\n    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\r\n}\r\n\r\nexport var __assign = function() {\r\n    __assign = Object.assign || function __assign(t) {\r\n        for (var s, i = 1, n = arguments.length; i < n; i++) {\r\n            s = arguments[i];\r\n            for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];\r\n        }\r\n        return t;\r\n    }\r\n    return __assign.apply(this, arguments);\r\n}\r\n\r\nexport function __rest(s, e) {\r\n    var t = {};\r\n    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)\r\n        t[p] = s[p];\r\n    if (s != null && typeof Object.getOwnPropertySymbols === \"function\")\r\n        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {\r\n            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))\r\n                t[p[i]] = s[p[i]];\r\n        }\r\n    return t;\r\n}\r\n\r\nexport function __decorate(decorators, target, key, desc) {\r\n    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;\r\n    if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);\r\n    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\r\n    return c > 3 && r && Object.defineProperty(target, key, r), r;\r\n}\r\n\r\nexport function __param(paramIndex, decorator) {\r\n    return function (target, key) { decorator(target, key, paramIndex); }\r\n}\r\n\r\nexport function __metadata(metadataKey, metadataValue) {\r\n    if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(metadataKey, metadataValue);\r\n}\r\n\r\nexport function __awaiter(thisArg, _arguments, P, generator) {\r\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n}\r\n\r\nexport function __generator(thisArg, body) {\r\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\r\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\r\n    function verb(n) { return function (v) { return step([n, v]); }; }\r\n    function step(op) {\r\n        if (f) throw new TypeError(\"Generator is already executing.\");\r\n        while (_) try {\r\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\r\n            if (y = 0, t) op = [op[0] & 2, t.value];\r\n            switch (op[0]) {\r\n                case 0: case 1: t = op; break;\r\n                case 4: _.label++; return { value: op[1], done: false };\r\n                case 5: _.label++; y = op[1]; op = [0]; continue;\r\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\r\n                default:\r\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\r\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\r\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\r\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\r\n                    if (t[2]) _.ops.pop();\r\n                    _.trys.pop(); continue;\r\n            }\r\n            op = body.call(thisArg, _);\r\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\r\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\r\n    }\r\n}\r\n\r\nexport var __createBinding = Object.create ? (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });\r\n}) : (function(o, m, k, k2) {\r\n    if (k2 === undefined) k2 = k;\r\n    o[k2] = m[k];\r\n});\r\n\r\nexport function __exportStar(m, o) {\r\n    for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(o, p)) __createBinding(o, m, p);\r\n}\r\n\r\nexport function __values(o) {\r\n    var s = typeof Symbol === \"function\" && Symbol.iterator, m = s && o[s], i = 0;\r\n    if (m) return m.call(o);\r\n    if (o && typeof o.length === \"number\") return {\r\n        next: function () {\r\n            if (o && i >= o.length) o = void 0;\r\n            return { value: o && o[i++], done: !o };\r\n        }\r\n    };\r\n    throw new TypeError(s ? \"Object is not iterable.\" : \"Symbol.iterator is not defined.\");\r\n}\r\n\r\nexport function __read(o, n) {\r\n    var m = typeof Symbol === \"function\" && o[Symbol.iterator];\r\n    if (!m) return o;\r\n    var i = m.call(o), r, ar = [], e;\r\n    try {\r\n        while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);\r\n    }\r\n    catch (error) { e = { error: error }; }\r\n    finally {\r\n        try {\r\n            if (r && !r.done && (m = i[\"return\"])) m.call(i);\r\n        }\r\n        finally { if (e) throw e.error; }\r\n    }\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spread() {\r\n    for (var ar = [], i = 0; i < arguments.length; i++)\r\n        ar = ar.concat(__read(arguments[i]));\r\n    return ar;\r\n}\r\n\r\n/** @deprecated */\r\nexport function __spreadArrays() {\r\n    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;\r\n    for (var r = Array(s), k = 0, i = 0; i < il; i++)\r\n        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)\r\n            r[k] = a[j];\r\n    return r;\r\n}\r\n\r\nexport function __spreadArray(to, from) {\r\n    for (var i = 0, il = from.length, j = to.length; i < il; i++, j++)\r\n        to[j] = from[i];\r\n    return to;\r\n}\r\n\r\nexport function __await(v) {\r\n    return this instanceof __await ? (this.v = v, this) : new __await(v);\r\n}\r\n\r\nexport function __asyncGenerator(thisArg, _arguments, generator) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var g = generator.apply(thisArg, _arguments || []), i, q = [];\r\n    return i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i;\r\n    function verb(n) { if (g[n]) i[n] = function (v) { return new Promise(function (a, b) { q.push([n, v, a, b]) > 1 || resume(n, v); }); }; }\r\n    function resume(n, v) { try { step(g[n](v)); } catch (e) { settle(q[0][3], e); } }\r\n    function step(r) { r.value instanceof __await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r); }\r\n    function fulfill(value) { resume(\"next\", value); }\r\n    function reject(value) { resume(\"throw\", value); }\r\n    function settle(f, v) { if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]); }\r\n}\r\n\r\nexport function __asyncDelegator(o) {\r\n    var i, p;\r\n    return i = {}, verb(\"next\"), verb(\"throw\", function (e) { throw e; }), verb(\"return\"), i[Symbol.iterator] = function () { return this; }, i;\r\n    function verb(n, f) { i[n] = o[n] ? function (v) { return (p = !p) ? { value: __await(o[n](v)), done: n === \"return\" } : f ? f(v) : v; } : f; }\r\n}\r\n\r\nexport function __asyncValues(o) {\r\n    if (!Symbol.asyncIterator) throw new TypeError(\"Symbol.asyncIterator is not defined.\");\r\n    var m = o[Symbol.asyncIterator], i;\r\n    return m ? m.call(o) : (o = typeof __values === \"function\" ? __values(o) : o[Symbol.iterator](), i = {}, verb(\"next\"), verb(\"throw\"), verb(\"return\"), i[Symbol.asyncIterator] = function () { return this; }, i);\r\n    function verb(n) { i[n] = o[n] && function (v) { return new Promise(function (resolve, reject) { v = o[n](v), settle(resolve, reject, v.done, v.value); }); }; }\r\n    function settle(resolve, reject, d, v) { Promise.resolve(v).then(function(v) { resolve({ value: v, done: d }); }, reject); }\r\n}\r\n\r\nexport function __makeTemplateObject(cooked, raw) {\r\n    if (Object.defineProperty) { Object.defineProperty(cooked, \"raw\", { value: raw }); } else { cooked.raw = raw; }\r\n    return cooked;\r\n};\r\n\r\nvar __setModuleDefault = Object.create ? (function(o, v) {\r\n    Object.defineProperty(o, \"default\", { enumerable: true, value: v });\r\n}) : function(o, v) {\r\n    o[\"default\"] = v;\r\n};\r\n\r\nexport function __importStar(mod) {\r\n    if (mod && mod.__esModule) return mod;\r\n    var result = {};\r\n    if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\r\n    __setModuleDefault(result, mod);\r\n    return result;\r\n}\r\n\r\nexport function __importDefault(mod) {\r\n    return (mod && mod.__esModule) ? mod : { default: mod };\r\n}\r\n\r\nexport function __classPrivateFieldGet(receiver, privateMap) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to get private field on non-instance\");\r\n    }\r\n    return privateMap.get(receiver);\r\n}\r\n\r\nexport function __classPrivateFieldSet(receiver, privateMap, value) {\r\n    if (!privateMap.has(receiver)) {\r\n        throw new TypeError(\"attempted to set private field on non-instance\");\r\n    }\r\n    privateMap.set(receiver, value);\r\n    return value;\r\n}\r\n","/*\n * 英文消息文件\n */\nexport const NodomMessage_en = {\n    /**\n     * tip words\n     */\n    TipWords:{\n        application:\"Application\",\n        system:\"System\",\n        module:\"Module\",\n        clazz:\"类\",\n        moduleClass:'ModuleClass',\n        model:\"Model\",\n        directive:\"Directive\",\n        directiveType:\"Directive-type\",\n        expression:\"Expression\",\n        event:\"Event\",\n        method:\"Method\",\n        filter:\"Filter\",\n        filterType:\"Filter-type\",\n        data:\"Data\",\n        dataItem:'Data-item',\n        route:'Route',\n        routeView:'Route-container',\n        plugin:'Plugin',\n        resource:'Resource',\n        root:'Root',\n        element:'VirtualDom'\n    },\n    /**\n     * error info\n     */\n    ErrorMsgs:{\n        unknown:\"unknown error\",\n        uninit:\"{0}未初始化\",\n        paramException:\"{0} '{1}' parameter error，see api\",\n        invoke:\"method {0} parameter {1} must be {2}\",\n        invoke1:\"method {0} parameter {1} must be {2} or {3}\",\n        invoke2:\"method {0} parameter {1} or {2} must be {3}\",\n        invoke3:\"method {0} parameter {1} not allowed empty\",\n        exist:\"{0} is already exist\",\n        exist1:\"{0} '{1}' is already exist\",\n        notexist:\"{0} is not exist\",\n        notexist1:\"{0} '{1}' is not exist\",\n        notupd:\"{0} not allow to change\",\n        notremove:\"{0} not allow to delete\",\n        notremove1:\"{0} {1} not allow to delete\",\n        namedinvalid:\"{0} {1} name error，see name rules\",\n        initial:\"{0} init parameter error\",\n        jsonparse:\"JSON parse error\",\n        timeout:\"request overtime\",\n        config:\"{0} config parameter error\",\n        config1:\"{0} config parameter '{1}' error\",\n        itemnotempty:\"{0} '{1}' config item '{2}' not allow empty\",\n\t\titemincorrect:\"{0} '{1}' config item '{2}' error\",\n        needEndTag: \"element {0} is not closed\",\n        needStartTag: \"without start tag matchs {0}\",\n        tagError:\"element {0} error\",\n        wrongTemplate:\"wrong template\",\n        wrongExpression:\"expression error: {0} \"\n    },\n\n    WeekDays:[\"Sun\",\"Mon\",\"Tue\",\"Wed\",\"Thu\",\"Fri\",\"Sat\"]\n}\n","/*\n * 中文消息文件\n */\nexport const NodomMessage_zh = {\n    /**\n     * 提示单词\n     */\n    TipWords: {\n        application: \"应用\",\n        system: \"系统\",\n        module: \"模块\",\n        clazz:\"类\",\n        moduleClass: '模块类',\n        model: \"模型\",\n        directive: \"指令\",\n        directiveType: \"指令类型\",\n        expression: \"表达式\",\n        event: \"事件\",\n        method: \"方法\",\n        filter: \"过滤器\",\n        filterType: \"过滤器类型\",\n        data: \"数据\",\n        dataItem: '数据项',\n        route: '路由',\n        routeView: '路由容器',\n        plugin: '插件',\n        resource: '资源',\n        root: '根',\n        element: '元素'\n    },\n    /**\n     * 异常信息\n     */\n    ErrorMsgs: {\n        unknown: \"未知错误\",\n        uninit:\"{0}未初始化\",\n        paramException: \"{0}'{1}'方法参数错误，请参考api\",\n        invoke: \"{0} 方法参数 {1} 必须为 {2}\",\n        invoke1: \"{0} 方法参数 {1} 必须为 {2} 或 {3}\",\n        invoke2: \"{0} 方法参数 {1} 或 {2} 必须为 {3}\",\n        invoke3: \"{0} 方法参数 {1} 不能为空\",\n        exist: \"{0} 已存在\",\n        exist1: \"{0} '{1}' 已存在\",\n        notexist: \"{0} 不存在\",\n        notexist1: \"{0} '{1}' 不存在\",\n        notupd: \"{0} 不可修改\",\n        notremove: \"{0} 不可删除\",\n        notremove1: \"{0} {1} 不可删除\",\n        namedinvalid: \"{0} {1} 命名错误，请参考用户手册对应命名规范\",\n        initial: \"{0} 初始化参数错误\",\n        jsonparse: \"JSON解析错误\",\n        timeout: \"请求超时\",\n        config: \"{0} 配置参数错误\",\n        config1: \"{0} 配置参数 '{1}' 错误\",\n        itemnotempty: \"{0} '{1}' 配置项 '{2}' 不能为空\",\n        itemincorrect: \"{0} '{1}' 配置项 '{2}' 错误\",\n        needEndTag: \"{0} 标签未闭合\",\n        needStartTag: \"未找到与 {0} 匹配的开始标签\",\n        tagError:\"标签 {0} 错误\",\n        wrongTemplate:\"模版格式错误\",\n        wrongExpression:\"表达式 {0} 错误\"\n    },\n    WeekDays: [\"星期日\",\"星期一\", \"星期二\",\"星期三\",\"星期四\",\"星期五\",\"星期六\"]\n}\n","import { Module } from \"./module\";\nimport { UnknownClass } from \"./types\";\n\n/**\n * 模块工厂\n * @remarks\n * 管理所有模块类、模块实例\n */\nexport class ModuleFactory {\n    /**\n     * 模块对象集合 \n     * @remarks\n     * 格式为map，其中：\n     * \n     * key: 模块id\n     * \n     * value: 模块对象\n     */\n    private static modules: Map<number, Module> = new Map();\n\n    /**\n     * 模块类集合\n     * @remarks\n     * 格式为map，其中：\n     * \n     *  key:    模块类名或别名\n     * \n     *  value:  模块类\n     */\n    public static classes: Map<string, UnknownClass> = new Map();\n\n    /**\n     * 别名map\n     * @remarks\n     * 格式为map，其中：\n     * \n     * key:     别名\n     * \n     * value:   类名\n     */\n    public static aliasMap:Map<string,string> = new Map();\n\n    /**\n     * 主模块\n     */\n    private static mainModule: Module;\n\n    /**\n     * 添加模块实例到工厂\n     * @param item -  模块对象\n     */\n    public static add(item: Module) {\n        // 第一个为主模块\n        if (this.modules.size === 0) {\n            this.mainModule = item;\n        }\n        this.modules.set(item.id, item);\n        //添加模块类\n        this.addClass(<UnknownClass>item.constructor);\n    }\n\n    /**\n     * 获得模块\n     * @remarks\n     * 当name为id时，则获取对应id的模块\n     * \n     * 当name为字符串时，表示模块类名\n     * \n     * 当name为class时，表示模块类\n     * \n     * @param name -  类或实例id\n     */\n    public static get(name: number|string|UnknownClass): Module {\n        const tp = typeof name;\n        let mdl:Module;\n        if (tp === 'number') {  //数字，模块id\n            return this.modules.get(<number>name);\n        } else{\n            if(tp === 'string'){ //字符串，模块类名\n                name = (<string>name).toLowerCase();\n                if(!this.classes.has(name)){  //为别名\n                    name = this.aliasMap.get(name);\n                }\n                if(this.classes.has(name)){\n                    mdl = Reflect.construct(<UnknownClass>this.classes.get(name),[]);\n                }\n            } else{ //模块类\n                mdl = Reflect.construct(<UnknownClass>name,[]);\n            }\n            if(mdl){\n                mdl.init();\n                return mdl;\n            }\n        } \n    }\n\n    /**\n     * 是否存在模块类\n     * @param clazzName -   模块类名\n     * @returns     true/false\n     */\n    public static hasClass(clazzName: string): boolean {\n        const name = clazzName.toLowerCase();\n        return this.classes.has(name) || this.aliasMap.has(name);\n    }\n\n    /**\n     * 添加模块类\n     * @param clazz -   模块类\n     * @param alias -   别名\n     */\n    public static addClass(clazz: unknown, alias?: string) {\n        //转换成小写\n        const name = (<UnknownClass>clazz).name.toLowerCase();\n        if (this.classes.has(name)) {\n            return;\n        }\n        this.classes.set(name, <UnknownClass>clazz);\n        //添加别名\n        if (alias) {\n            this.aliasMap.set(alias.toLowerCase(),name);\n        }\n    }\n\n    /**\n     * 获取模块类\n     * @param name -    类名或别名 \n     * @returns         模块类\n     */\n    public static getClass(name:string):UnknownClass{\n        name = name.toLowerCase();\n        return this.classes.has(name)?this.classes.get(name):this.classes.get(this.aliasMap.get(name));\n    }\n    \n    /**\n     * 加载模块\n     * @remarks\n     * 用于实现模块懒加载\n     * @param modulePath -   模块类路径\n     * @returns              模块类\n     */\n    public static async load(modulePath:string):Promise<UnknownClass>{\n        const m = await import(modulePath);\n        if(m){\n            //通过import的模块，查找模块类\n            for(const k of Object.keys(m)){\n                if(m[k].name){\n                    this.addClass(m[k]);\n                    return m[k];\n                }\n            }\n        }\n    }\n    \n    /**\n     * 从工厂移除模块\n     * @param id -    模块id\n     */\n    public static remove(id: number) {\n        this.modules.delete(id);\n    }\n\n    /**\n     * 设置应用主模块\n     * @param m - \t模块 \n     */\n    public static setMain(m: Module) {\n        this.mainModule = m;\n    }\n\n    /**\n     * 获取应用主模块\n     * @returns \t应用的主模块\n     */\n    public static getMain() {\n        return this.mainModule;\n    }\n}\n","import { NError } from \"./error\";\nimport { Model } from \"./model\";\nimport { Module } from \"./module\";\nimport { Nodom } from \"./nodom\";\nimport { ExpressionMethod } from \"./types\";\nimport { Util } from \"./util\";\n\n/**\n * 表达式类\n * @remarks\n * 表达式中的特殊符号\n * \n *  this:指向渲染的module\n * \n *  $model:指向当前dom的model\n */\nexport class Expression {\n    /**\n      * 表达式id\n      */\n    id: number;\n\n    /**\n     * 执行函数\n     */\n    execFunc:ExpressionMethod;\n\n    /**\n     * 源表达式串\n     */\n    exprStr: string;\n\n    /**\n     * @param exprStr -\t表达式串\n     */\n    constructor(exprStr: string) {\n        this.id = Util.genId();\n        if (!exprStr || (exprStr=exprStr.trim())==='') {\n            return;\n        }\n        if(Nodom.isDebug){\n            this.exprStr = exprStr;\n        }\n        const funStr = this.compile(exprStr);\n        this.execFunc = <ExpressionMethod> new Function('$model','return ' + funStr);\n    }\n\n    /**\n     * 编译表达式串，替换字段和方法\n     * @param exprStr -   表达式串\n     * @returns         编译后的表达式串\n     */\n    private compile(exprStr:string){\n        //字符串，object key，有效命名(函数或字段)\n        const reg = /('[\\s\\S]*?')|(\"[\\s\\S]*?\")|(`[\\s\\S]*?`)|([a-zA-Z$_][\\w$]*\\s*?:)|((\\.{3}|\\.)?[a-zA-Z$_][\\w$]*(\\.[a-zA-Z$_][\\w$]*)*(\\s*[\\[\\(](\\s*\\))?)?)/g;\n        let r;\n        let retS = '';\n        let index = 0;  //当前位置\n\n        while((r=reg.exec(exprStr)) !== null){\n            let s = r[0];\n            if(index < r.index){\n                retS += exprStr.substring(index,r.index);\n            }\n            if(s[0] === \"'\" || s[0] === '\"' || s[0] === '`'){ //字符串\n                retS += s;\n            }else{\n                const lch = s[s.length-1];\n                if(lch === ':'){  //object key\n                    retS += s;\n                }else if(lch === '(' || lch === ')'){ //函数，非内部函数\n                    retS += handleFunc(s);\n                }else { //字段 this $model .field等不做处理\n                    if(s.startsWith('this.') \n                        || Util.isKeyWord(s) \n                        || (s[0] === '.' && s[1]!=='.')\n                        || s==='$model'\n                        ){ //非model属性\n                        retS += s; \n                    }else{  //model属性\n                        let s1 = '';\n                        if(s.startsWith('...')){ // ...属性名\n                            s1 = '...';\n                            s = s.substring(3);\n                        }\n                        retS += s1 +'$model.' + s;\n                    }\n                }\n            } \n            index = reg.lastIndex;\n        }\n        if(index < exprStr.length){\n            retS += exprStr.substring(index);\n        }\n        return retS;\n\n        /**\n         * 处理函数串\n         * @param str -   源串\n         * @returns     处理后的串\n         */\n        function handleFunc(str):string{\n            //去除空格\n            str = str.replace(/\\s+/g,'');\n            const ind1 = str.lastIndexOf('(');\n            const ind2 = str.indexOf('.');\n            //第一段\n            const fn1 = (ind2 !== -1?str.substring(0,ind2):str.substring(0,ind1));\n            //保留字或第一个为.\n            if(Util.isKeyWord(fn1) || str[0] === '.'){\n                return str;\n            }\n            if(ind2 === -1){\n                let s = \"this.invokeMethod('\" + fn1 + \"'\";\n                s += str[str.length-1] !== ')'?',':')';\n                return s;\n            }\n            return '$model.' + str;\n        }\n    }\n\n    /**\n     * 表达式计算\n     * @param module -  模块\n     * @param model - \t模型\n     * @returns \t\t计算结果\n     */\n    public val(module:Module,model: Model):unknown {\n        if(!this.execFunc){\n            return;\n        }\n        let v;\n        try {\n            v = this.execFunc.call(module,model);\n        } catch (e) {\n            if(Nodom.isDebug){\n                console.error(new NError(\"wrongExpression\",this.exprStr).message);\n                console.error(e);\n            }\n        }\n        return v;\n    }\n}","import {Module} from \"./module\";\nimport { RenderedDom } from \"./types\";\n/**\n * css 管理器\n * @privateRemarks\n * 针对不同的rule，处理方式不同\n * \n * CssStyleRule 进行保存和替换，同时模块作用域scope有效\n * \n * CssImportRule 路径不重复添加，因为必须加在stylerule前面，所以需要记录最后的import索引号\n */\nexport class CssManager{\n\n    /**\n     * style sheet\n     */\n    private static sheet:CSSStyleSheet;\n\n    /**\n     * import url map，用于存储import的url路径\n     */\n    private static importMap = new Map();\n\n    /**\n     * importrule 位置\n     */\n    private static importIndex = 0;\n\n    /**\n     * css class 前置名\n     */\n    private static cssPreName = '___nodommodule___';\n    \n    /**\n     * 处理style 元素\n     * @param module -  模块\n     * @param dom -     虚拟dom\n     * @param root -    模块root dom\n     * @param add -     是否添加根模块类名\n     * @returns         如果是styledom，则返回true，否则返回false\n     */\n    public static handleStyleDom(module:Module,dom:RenderedDom,root:RenderedDom):void{\n        if(dom.props['scope'] === 'this'){\n            const cls = this.cssPreName + module.id;\n            if(root.props['class']){\n                root.props['class'] = dom.props['class'] + ' ' + cls;\n            }else{\n                root.props['class'] = cls;\n            }\n        }\n    }\n\n    /**\n     * 处理 style 下的文本元素\n     * @param module -  模块\n     * @param dom -     style text element\n     * @returns         如果是styleTextdom返回true，否则返回false\n     */\n    public static handleStyleTextDom(module:Module,dom:RenderedDom):boolean{\n        if(!dom.parent || dom.parent.tagName !== 'style'){\n            return false;\n        }\n        //scope=this，在模块根节点添加 限定 class\n        CssManager.addRules(module,dom.textContent,dom.parent&&dom.parent.props['scope'] === 'this'?'.' + this.cssPreName + module.id:undefined);\n        return true;\n    }\n\n    /**\n     * 添加多个css rule\n     * @param cssText -     rule集合 \n     * @param module -      模块\n     * @param scopeName -   作用域名(前置选择器)\n     */\n    private static addRules(module:Module,cssText:string,scopeName?:string){\n        //sheet 初始化\n        if(!this.sheet){\n            //safari不支持 cssstylesheet constructor，用 style代替\n            const sheet = document.createElement('style');\n            document.head.appendChild(sheet);\n            this.sheet = document.styleSheets[0];\n        }\n        //如果有作用域，则清除作用域下的rule\n        if(scopeName){\n            this.clearModuleRules(module);\n        }\n        //是否限定在模块内\n        //cssRule 获取正则式  @import\n        const reg = /(@[a-zA-Z]+\\s+url\\(.+?\\))|([.#@a-zA-Z]\\S*(\\s*\\S*\\s*?)?{)|\\}/g;\n        //import support url正则式\n        const regImp = /@[a-zA-Z]+\\s+url/;\n        // keyframe font page support... 开始 位置\n        let startIndex:number=-1;\n        // { 个数，遇到 } -1 \n        let beginNum:number = 0;\n        let re;\n        while((re=reg.exec(cssText)) !== null){\n            if(regImp.test(re[0])){ //import namespace\n                handleImport(re[0]);\n            }else if(re[0] === '}'){ //回收括号，单个样式结束判断\n                if(startIndex>=0 && --beginNum <= 0){  //style @ end\n                    const txt = cssText.substring(startIndex,re.index+1);\n                    if(txt[0] === '@'){ //@开头\n                        this.sheet.insertRule(txt,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0);\n                    }else{  //style\n                        handleStyle(module,txt,scopeName);\n                    }\n                    startIndex = -1;\n                    beginNum = 0;\n                }\n            }else{ //style 或 @内部\n                if(startIndex === -1){\n                    startIndex = re.index;\n                    beginNum++;\n                }else{\n                    beginNum++;\n                }\n            }\n        }\n        \n        /**\n         * 处理style rule\n         * @param module -      模块\n         * @param cssText -     css 文本\n         * @param scopeName -   作用域名(前置选择器)\n         */\n        function handleStyle(module:Module,cssText:string,scopeName?:string){\n            const reg = /.+(?=\\{)/; //匹配字符\"{\"前出现的所有字符\n            const r = reg.exec(cssText);\n            if(!r){\n                return;\n            }\n            // 保存样式名，在模块 object manager 中以数组存储\n            if(scopeName){\n                let arr = module.objectManager.get('$cssRules');\n                if(!arr){\n                    arr = [];\n                    module.objectManager.set('$cssRules',arr);\n                }\n                arr.push((scopeName + ' ' + r[0]));\n                //为样式添加 scope name\n                cssText = scopeName + ' ' + cssText;\n            }\n            //加入到样式表\n            CssManager.sheet.insertRule(cssText,CssManager.sheet.cssRules?CssManager.sheet.cssRules.length:0);\n        } \n\n        /**\n         * 处理import rule\n         * @param cssText - css文本\n         * @returns         如果cssText中\"()\"内有字符串且importMap中存在键值为\"()\"内字符串的第一个字符，则返回void\n         */\n        function handleImport(cssText:string){\n            const ind = cssText.indexOf('(');\n            const ind1 = cssText.lastIndexOf(')');\n            if(ind === -1 || ind1 === -1 || ind>=ind1){\n                return;\n            }\n            const css = cssText.substring(ind,ind1);\n            if(CssManager.importMap.has(css)){\n                return;\n            }\n            //插入import rule\n            CssManager.sheet.insertRule(cssText,CssManager.importIndex++);\n            CssManager.importMap.set(css,true);\n        }\n    }\n\n    /**\n     * 清除模块css rules\n     * @param module -  模块\n     */\n    public static clearModuleRules(module:Module){\n        const rules = module.objectManager.get('$cssRules');\n        if(!rules || rules.length === 0){\n            return;\n        }\n        //从sheet清除\n        for(let i=0;i<this.sheet.cssRules.length;i++){\n            const r = <CSSStyleRule>this.sheet.cssRules[i];\n            if(r.selectorText && rules.indexOf(r.selectorText) !== -1){\n                this.sheet.deleteRule(i--);\n            }\n        }\n        //置空cache\n        module.objectManager.set('$cssRules',[]);\n    }\n}","import { DefineElement } from \"./defineelement\";\nimport { NEvent } from \"./event\";\nimport { Model } from \"./model\";\nimport { Module } from \"./module\";\nimport { Route } from \"./route\";\nimport { VirtualDom } from \"./virtualdom\";\n\n/**\n * 路由配置\n */\nexport type RouteCfg = {\n    /**\n     * 路由路径，可以带通配符*，可以带参数 /:\n     */\n    path?: string;\n    \n    /**\n     * 路由对应模块对象或类或模块类名\n     */\n    module?:Module;\n\n    /**\n     * 模块路径，当module为类名时需要，默认执行延迟加载\n     */\n    modulePath?:string;\n\n    /**\n     * 子路由数组\n     */\n    routes?: Array<RouteCfg>;\n\n    /**\n     * 进入路由事件方法\n     */\n\n    onEnter?: (module,url)=>void;\n    /**\n     * 离开路由方法\n     */\n    onLeave?: (module,url)=>void;\n    \n    /**\n     * 父路由\n     */\n    parent?: Route;\n}\n\n/**\n * 模块状态类型\n */\nexport enum EModuleState {\n    /**\n     * 已初始化\n     */\n    INIT = 1,\n    /**\n     * 未挂载到html dom\n     */\n    UNMOUNTED = 2,\n    /**\n     * 已挂载到dom树\n     */\n    MOUNTED = 3,\n    \n    /**\n     * 准备渲染\n     */\n    READY = 4\n}\n\n/**\n * 渲染后的节点接口\n */\nexport type RenderedDom = {\n    /**\n     * 元素名，如div\n     */\n    tagName?: string;\n\n    /**\n     * key:节点key，整棵渲染树唯一\n     */\n    key: string|number;\n \n    /**\n      * 绑定模型\n     */\n    model?: Model;\n\n    /**\n     * 直接属性 不是来自于attribute，而是直接作用于html element，如el.checked,el.value等\n     */\n    assets?: object;\n\n    /**\n     * 静态属性(attribute)集合\n     */\n    props?: object;\n\n    /**\n     * 事件集合\n     */\n    events?:NEvent[];\n \n    /**\n     * element为textnode时有效\n     */\n    textContent?: string;\n\n    /**\n     * 子节点数组\n     */\n    children?: Array<RenderedDom>;\n\n    /**\n     * 父虚拟dom\n     */\n    parent?: RenderedDom;\n\n    /**\n     * staticNum 静态标识数\n     *  0 表示静态，不进行比较\n     *  1 每次比较后-1\n     *  -1 每次渲染\n     */\n    staticNum?: number;\n \n    /**\n     * 子模块id，模块容器时有效\n     */\n    moduleId?: number;\n\n    /**\n     * 源虚拟dom(vdomTree中的对应节点)\n     */\n    vdom?: VirtualDom;\n\n    /**\n\t * 是否为svg节点\n\t */\n\tisSvg?:boolean;\n\n    /**\n     * 所属模块id\n     */\n    mid?:number;\n\n    /**\n     * 渲染到的模块id，当作为slot时有效\n     */\n    rmid?:number;\n\n    /**\n     * 添加到domkey 后面形成实际domkey\n     */\n    postKey?:string;\n}\n\n/**\n * 未知类\n */\nexport type UnknownClass = ()=>void;\n\n/**\n * 自定义element 类\n */\nexport type DefineElementClass = (dom:VirtualDom,module:Module)=>DefineElement;\n\n/**\n * 未知方法\n */\nexport type UnknownMethod = ()=>void;\n\n/**\n * 事件方法\n */\n\nexport type EventMethod = (model,dom,evobj,event)=>void;\n\n/**\n * 指令方法\n */\nexport type DirectiveMethod = (module:Module,dom:RenderedDom)=>boolean;\n\n/**\n * 表达式方法\n */\nexport type ExpressionMethod = (model:Model)=>unknown;\n\n/**\n * 新旧dom树比较后更改的节点\n * \n * @remarks\n * 元素依次为：\n * ```js\n * 0：修改类型，可选值 1: add（添加）, 2: upd（更新）,3: del（删除）, 4: move（移动） ,5: rep（替换） \n * 1：目标节点\n * 2：相对节点（rep时有效）\n * 3：目标节点的父节点\n * 4：目标节点在父节点中的index\n * 5：被移动前位置(move时有效)\n * ```\n */\nexport type ChangedDom = [number,RenderedDom,RenderedDom?,RenderedDom?,number?,number?];\n","import { Module } from \"./module\";\nimport { ModuleFactory } from \"./modulefactory\";\nimport { VirtualDom } from \"./virtualdom\";\nimport { Model } from \"./model\";\nimport { Expression } from \"./expression\";\nimport { CssManager } from \"./cssmanager\";\nimport { ChangedDom, EModuleState, RenderedDom } from \"./types\";\n\n/**\n * 渲染器\n * @remarks\n * nodom渲染操作在渲染器中实现\n */\nexport class Renderer {\n    /**\n     * 应用根El\n     */\n    private static rootEl:HTMLElement;\n\n    /**\n     * 等待渲染列表\n     */\n    private static waitList: Array < number > = [];\n\n    /**\n     * 当前渲染模块\n     * @remarks\n     * slot渲染时，如果未使用`innerRender`，则渲染过程中指令、表达式依赖的模块会切换成templateModuleId对应模块，但currentModule不变。\n     */\n    public static currentModule:Module;\n\n    /**\n     * 当前模块根dom\n     */\n    private static currentRootDom:RenderedDom;\n\n    /**\n     * 设置根容器\n     * @param rootEl - 根html element\n     */\n    public static setRootEl(rootEl){\n        this.rootEl = rootEl;\n    }\n\n    /**\n     * 获取根容器\n     * @returns 根 html element\n     */\n    public static getRootEl():HTMLElement{\n        return this.rootEl;\n    }\n\n    /**\n     * 获取当前渲染模块\n     * @returns     当前渲染模块\n     */\n    public static getCurrentModule():Module{\n        return this.currentModule;\n    }\n\n    /**\n     * 添加到渲染列表\n     * @param module - 模块\n     */\n    public static add(module:Module) {\n        if(!module){\n            return;\n        }\n        //如果已经在列表中，不再添加\n        if ((module.state === EModuleState.READY || module.state === EModuleState.MOUNTED) && !this.waitList.includes(module.id)) {\n            //计算优先级\n            this.waitList.push(module.id);\n        }\n    }\n    \n    /**\n     * 从渲染队列移除\n     * @param moduleId - 模块id\n     */\n    public static remove(module:Module){\n        let index;\n        if((index = this.waitList.indexOf(module.id)) !== -1){\n            //不能破坏watiList顺序，用null替换\n            this.waitList.splice(index,1,null);\n        }\n    }\n\n    /**\n     * 渲染\n     * @remarks\n     * 如果存在渲染队列，则从队列中取出并依次渲染\n     */\n    public static render() {\n        for(;this.waitList.length>0;){\n            const id = this.waitList[0];\n            if(id){ //存在id为null情况，remove方法造成\n                const m = ModuleFactory.get(id);\n                this.currentModule = m;\n                m.render();\n                this.currentModule = null;\n            }\n            //渲染后移除\n            this.waitList.shift();\n        }\n    }\n\n    /**\n     * 渲染dom\n     * @remarks\n     * 此过程将VirtualDom转换为RenderedDom\n     * \n     * @param module -      模块 \n     * @param src -         源dom\n     * @param model -       模型\n     * @param parent -      父dom\n     * @param key -         key 附加key，放在domkey的后面\n     * @returns             渲染后节点\n     */\n    public static renderDom(module:Module,src:VirtualDom,model:Model,parent?:RenderedDom,key?:number|string):RenderedDom{\n        //初始化渲染节点\n        const dst:RenderedDom = {\n            key:key?src.key+'_'+key:src.key,\n            model:model,\n            vdom:src,\n            staticNum:src.staticNum\n        }\n        // 从父继承附加key和rmid\n        if(parent){\n            // if(parent.postKey){\n            //     dst.postKey = parent.postKey;\n            // }\n            // if(dst.postKey){\n            //     dst.key += dst.postKey;\n            // }\n            if(parent.rmid){\n                dst.rmid = parent.rmid;\n                dst.key += '_' + dst.rmid + 's';\n            }\n        }\n\n        //静态节点只渲染1次\n        if(src.staticNum>0){\n            src.staticNum--;\n        }\n\n        if(src.tagName){ //标签\n            dst.tagName = src.tagName;\n            //添加key属性\n            dst.props = {};\n            //设置svg标志\n            if(src.isSvg){\n                dst.isSvg = src.isSvg\n            }\n        }\n        //设置当前根root\n        if(!parent){\n            this.currentRootDom = dst;\n        }else{\n            // 设置父对象\n            dst.parent = parent;\n        }\n        //处理model指令\n        const mdlDir = src.getDirective('model');\n        if(mdlDir){\n            mdlDir.exec(module,dst);\n        }\n        \n        if(dst.tagName){  //标签节点\n            this.handleProps(module,src,dst);\n            //处理style标签，如果为style，则不处理assets\n            if(src.tagName === 'style'){\n                CssManager.handleStyleDom(module,dst,Renderer.currentRootDom);\n            }else if(src.assets && src.assets.size>0){\n                dst.assets ||= {};\n                for(const p of src.assets){\n                    dst.assets[p[0]] = p[1];\n                }\n            }\n            //处理directive时，导致禁止后续渲染，则不再渲染，如show指令\n            if(!this.handleDirectives(module,src,dst)){\n                return null;\n            }\n            //非module dom，添加dst事件到事件工厂\n            if(src.events && !src.hasDirective('module')){\n                if(!dst.events){\n                    dst.events = [];\n                }\n                // 可能存在事件变化，需要先移除\n                // TODO 全部移除性能较低，需优化\n                module.eventFactory.removeAllEvents(dst);\n                for(const ev of src.events){\n                    //当事件串为表达式时，需要处理\n                    ev.handleExpr(module,model);\n                    //如果不是根节点，设置事件module为渲染module\n                    if(src.key !== 1){\n                        ev.module = module;\n                    }\n                    // 保存event以便比较\n                    dst.events.push(ev);\n                    //添加到当前模块eventfactory\n                    this.currentModule.eventFactory.addEvent(dst,ev);\n                }\n            }\n            //子节点渲染\n            if(src.children && src.children.length>0){\n                dst.children = [];\n                for(const c of src.children){\n                    this.renderDom(module,c,dst.model,dst,key);\n                }\n            }\n        }else{ //文本节点\n            if(src.expressions){ //文本节点\n                let value = '';\n                for(const expr of src.expressions){\n                    if (expr instanceof Expression) { //处理表达式\n                        const v1 = expr.val(module,dst.model);\n                        value += v1 !== undefined ? v1 : '';\n                    } else {\n                        value += expr;\n                    }\n                }\n                dst.textContent = value;\n            }else{\n                dst.textContent = src.textContent;\n            }\n        }\n        //添加到dom tree，必须放在handleDirectives后，因为有可能directive执行后返回false\n        if(parent){\n            if(!parent.children){\n                parent.children = [];\n            }\n            parent.children.push(dst);\n        }\n        return dst;\n    }\n\n    /**\n     * 处理指令\n     * @param module -  模块\n     * @param src -     编译节点\n     * @param dst -     渲染节点\n     * @returns         true继续执行，false不执行后续渲染代码，也不加入渲染树\n    */\n    private static handleDirectives(module,src,dst):boolean {\n        if(!src.directives || src.directives.length===0){\n            return true;\n        }\n        for(const d of src.directives){\n            //model指令不执行\n            if(d.type.name==='model'){\n                continue;\n            }\n            if(!d.exec(module,dst)){\n                return false;\n            }\n        }\n        return true;\n    }\n    /**\n     * 处理属性\n     * @param module -  模块\n     * @param src -     编译节点\n     * @param dst -     渲染节点\n     */\n    private static handleProps(module:Module,src:VirtualDom,dst:RenderedDom){\n        if(dst === this.currentRootDom){\n            module.handleRootProps(src,dst);\n            return;\n        }\n        if(!src.props || src.props.size === 0){\n            return;\n        }\n        for(const k of src.props){\n            let v = <unknown>k[1];\n            if(v instanceof Expression){\n                src.staticNum = -1;\n                v = v.val(module,dst.model);\n                dst.staticNum = -1;\n            }\n            dst.props[k[0]] = v;\n        }\n    }\n\n    /**\n     * 更新到html树\n     * @param module -  模块\n     * @param src -     渲染节点\n     * @returns         渲染后的节点    \n     */\n    public static updateToHtml(module: Module,dom:RenderedDom,pEl?):Node {\n        const el = module.getElement(dom.key);\n        if(!el){\n            return this.renderToHtml(module,dom,pEl,true);\n        }else if(dom.tagName){   //html dom节点已存在\n            //设置element key属性\n            (<object>el)['key'] = dom.key;\n            const attrs = (<HTMLElement>el).attributes;\n            const arr = [];\n            if(attrs){\n                for(let i=0;i<attrs.length;i++){\n                    arr.push(attrs[i].name);\n                }\n            }\n            //设置属性\n            for(const p of Object.keys(dom.props)){\n                (<HTMLElement>el).setAttribute(p,dom.props[p]===undefined?'':dom.props[p]);\n                let ind;\n                if((ind=arr.indexOf(p)) !== -1){\n                    arr.splice(ind,1);\n                }\n            }\n            //清理多余attribute\n            if(arr.length>0){\n                for(const a of arr){\n                    (<HTMLElement>el).removeAttribute(a);\n                }\n            }\n            //处理asset\n            if (dom.assets) {\n                for (const k of Object.keys(dom.assets)) {\n                    el[k] = dom.assets[k];\n                }    \n            }\n            //解绑之前绑定事件\n            module.eventFactory.unbindAll(dom.key);\n            //绑定事件\n            module.eventFactory.bind(dom.key);\n        }else{  //文本节点\n            (<object>el)['textContent'] = dom.textContent;\n        }\n        return el;\n    }\n\n    /**\n     * 渲染到html树\n     * @param module - \t        模块\n     * @param src -             渲染节点\n     * @param parentEl - \t    父html\n     * @param isRenderChild -   是否渲染子节点\n     * @returns                 渲染后的html节点\n     */\n    public static renderToHtml(module: Module,src:RenderedDom, parentEl:Node,isRenderChild?:boolean):Node {\n        let el;\n        if(src.tagName){\n            el = newEl(src);\n        }else{\n            el = newText(src);\n        }\n        // element、渲染子节点且不为子模块，处理子节点\n        if(el && src.tagName && isRenderChild && !src.moduleId){\n            genSub(el, src);\n        }\n        if(el && parentEl){\n            parentEl.appendChild(el);\n        }\n        return el;\n        \n        /**\n         * 新建element节点\n         * @param dom - \t虚拟dom\n         * @returns \t\t新的html element\n         */\n        function newEl(dom:RenderedDom): HTMLElement {\n            let el; \n            //rmid !== moduleid，则不渲染\n            if(dom.rmid && dom.rmid !== module.id){\n                return;\n            }\n            \n            // 子模块不渲染\n            if(dom.moduleId){\n                const m = ModuleFactory.get(dom.moduleId);\n                //创建替代节点\n                if(m){\n                    el = document.createTextNode('');\n                    m.srcDom = dom;\n                    m.srcElement = el;\n                    module.addChild(m);\n                    module.saveElement(dom.key,el);\n                    \n                    m.active();\n                    return el;\n                }\n                return;\n            }\n            //style，只处理文本节点\n            if(dom.tagName === 'style'){\n                genSub(el,dom);\n                return;\n            }\n            \n            if(dom.isSvg){   //是svg节点\n                el = document.createElementNS(\"http://www.w3.org/2000/svg\",dom.tagName);\n                if(dom.tagName === 'svg'){\n                    el.setAttribute('xmlns','http://www.w3.org/2000/svg');\n                }\n            }else{      //普通节点\n                el = document.createElement(dom.tagName);\n            }\n            //把el引用与key关系存放到cache中\n            module.saveElement(dom.key,el);\n            //设置element key属性\n            (<object>el)['key'] = dom.key;\n            // el.setAttribute('key',dom.key)\n            \n            //设置属性\n            for(const p of Object.keys(dom.props)){\n                if(dom.props[p] !== undefined && dom.props[p] !== null && dom.props[p] !== ''){\n                    el.setAttribute(p,dom.props[p]);\n                }\n            }\n            //asset\n            if(dom.assets){\n                for (const p of Object.keys(dom.assets)) {\n                    el[p] = dom.assets[p];\n                }\n            }\n            //绑定事件\n            module.eventFactory.bind(dom.key);\n            return el;\n        }\n\n        /**\n         * 新建文本节点\n         */\n        function newText(dom:RenderedDom): Node {\n            //样式表处理，如果是样式表文本，则不添加到dom树\n            if(CssManager.handleStyleTextDom(module,dom)){\n                return;\n            }\n            const node = document.createTextNode(<string>dom.textContent || '');\n            module.saveElement(dom.key,node);\n            return node;\n        }\n\n        /**\n         * 生成子节点\n         * @param pEl -     父节点\n         * @param dom -     dom节点\t\n         */\n        function genSub(pEl: Node, dom: RenderedDom) {\n            if (dom.children && dom.children.length > 0) {\n                dom.children.forEach(item => {\n                    let el1;\n                    if (item.tagName) {\n                        el1 = newEl(item);\n                        //element节点，产生子节点\n                        if(el1 instanceof Element){\n                            genSub(el1, item);\n                        }\n                        \n                    } else {\n                        el1 = newText(item);\n                    }\n                    if(el1){\n                        pEl.appendChild(el1);\n                    }\n                });\n            }\n        }\n    }\n\n    /**\n     * 处理更改的dom节点\n     * @param module -        待处理模块\n     * @param changeDoms -    修改后的dom节点数组\n     */\n    public static handleChangedDoms(module:Module,changeDoms:ChangedDom[]){\n        let slotDoms = {};\n        //替换数组\n        const repArr =[];\n        //添加数组\n        const addArr = [];\n        //移动数组\n        const moveArr = [];\n        //保留原有html节点\n        for (const item of changeDoms) {\n            //如果为slot节点，则记录，单独处理\n            if(item[1].rmid && item[1].rmid !== module.id){\n                if(slotDoms[item[1].rmid]){\n                    slotDoms[item[1].rmid].push(item);\n                }else{\n                    slotDoms[item[1].rmid]=[item];\n                }\n                continue;\n            }\n            let pEl;\n            switch(item[0]){\n                case 1:  //添加\n                    addArr.push(item);\n                    break;\n                case 2: //修改\n                    //子模块不处理，由setProps处理\n                    if(item[1].moduleId){\n                        Renderer.add(ModuleFactory.get(item[1].moduleId));\n                        continue;\n                    }\n                    if(item[1].parent){\n                         pEl = module.getElement(item[1].parent.key);\n                    }\n                    Renderer.updateToHtml(module, item[1],pEl);\n                    break;\n                case 3: //删除\n                    module.domManager.freeNode(item[1]);\n                    // const n1 = module.getElement(item[1].key);\n                    // pEl = module.getElement(item[3].key);\n                    // if (pEl && n1 && n1.parentElement === pEl) {\n                    //     pEl.removeChild(n1);\n                    // }\n                    break;\n                case 4: //移动\n                    moveArr.push(item);\n                    break;\n                default: //替换\n                    repArr.push(item);\n            }\n        }\n        //替换\n        if(repArr.length>0){\n            for(const item of repArr){\n                this.replace(module,item[1],item[2]);\n            }\n        }\n        //addArr 按index排序\n        if(addArr.length > 1){\n            addArr.sort((a,b)=>a[4]>b[4]?1:-1);\n        }\n        //操作map，用于存放添加或移动过的位置\n        const opMap = moveArr.length>0?{}:undefined;\n        //处理添加元素\n        for(const item of addArr){\n            const pEl = <HTMLElement>module.getElement(item[3].key);\n            if(!pEl){\n                continue;\n            }\n            const n1 = Renderer.renderToHtml(module, item[1], null, true);\n            if(n1){\n                if (pEl.childNodes && pEl.childNodes.length > item[4]) {\n                    pEl.insertBefore(n1, pEl.childNodes[item[4]]);\n                }\n                else {\n                    pEl.appendChild(n1);\n                }\n                //记录操作位置\n                if(opMap){\n                    opMap[item[3].key + '_' + item[4]] = true;\n                }\n            }\n        }\n        //处理move元素\n        for(const item of moveArr){\n            const pEl = <HTMLElement>module.getElement(item[3].key);\n            if(!pEl){\n                continue;\n            }\n            const n1 = module.getElement(item[1].key);\n            if(!n1 || n1 === pEl.childNodes[item[4]]){\n                continue;\n            }\n            //判断是否需要用空节点填充移走后的位置\n            if(!opMap[item[3].key + '_' + item[5]]){\n                const emptyDom = document.createTextNode('');\n                //新放到指定位置\n                if (pEl.childNodes.length > item[5]) {\n                    pEl.insertBefore(emptyDom, pEl.childNodes[item[5]]);\n                }else { //最后一个与当前节点不相同，则放在最后\n                    pEl.appendChild(emptyDom);\n                }\n            }\n            //替换到指定位置\n            pEl.replaceChild(n1,pEl.childNodes[item[4]]);\n            //记录操作的位置\n            opMap[item[3].key + '_' + item[4]] = true;\n        }\n\n        //处理改变的子模块\n        const keys = Object.keys(slotDoms);\n        if(keys && keys.length > 0){\n            for(let k of keys){\n                const m = ModuleFactory.get(parseInt(k));\n                if(m){\n                    Renderer.add(m);\n                }\n            }\n        }\n    }\n\n    /**\n     * 替换解ID那\n     * @param module -  模块\n     * @param src -     待替换节点\n     * @param dst -     被替换节点    \n     */\n    private static replace(module,src,dst){\n        if(!dst.parent){\n            return;\n        }\n        const pEl = <HTMLElement>module.getElement(dst.parent.key);\n        if(!pEl){\n            return;\n        }\n        const el = Renderer.renderToHtml(module,src,null);\n        let oldEl;\n        if(dst.moduleId){\n            const m1 = ModuleFactory.get(dst.moduleId);\n            oldEl = m1.getElement(1);\n        }else{\n            oldEl = module.getElement(dst.key);\n        }\n        \n        if(pEl && oldEl && oldEl.parentElement === pEl){\n            pEl.replaceChild(el,oldEl);\n        }\n        module.domManager.freeNode(dst);\n    }\n}","import { NError } from \"./error\";\nimport { NodomMessage } from \"./nodom\";\nimport { Util } from \"./util\";\n\nexport class RequestManager{\n    /**\n     * 拒绝相同请求（url，参数）时间间隔\n     */\n    public static rejectReqTick:number = 0;\n\n    /**\n     * 请求map，用于缓存之前的请求url和参数\n     * key:     url\n     * value:   请求参数\n     */\n    private static requestMap:Map<string,object> = new Map();\n\n    /**\n     * 设置相同请求拒绝时间间隔\n     * @param time -  时间间隔（ms）\n     */\n    public static setRejectTime(time:number){\n        this.rejectReqTick = time;\n    }\n    /**\n     * ajax 请求\n     * \n     * @param config -  object 或 string，如果为string，则表示url，直接以get方式获取资源，如果为 object，配置项如下:\n     * ```\n     *  参数名|类型|默认值|必填|可选值|描述\n     *  -|-|-|-|-|-\n     *  url|string|无|是|无|请求url\n     *\tmethod|string|GET|否|GET,POST,HEAD|请求类型\n     *\tparams|object/FormData|空object|否|无|参数，json格式\n     *\tasync|bool|true|否|true,false|是否异步\n     *  timeout|number|0|否|无|请求超时时间\n     *  type|string|text|否|json,text|\n     *\twithCredentials|bool|false|否|true,false|同源策略，跨域时cookie保存\n     *  header|Object|无|否|无|request header 对象\n     *  user|string|无|否|无|需要认证的请求对应的用户名\n     *  pwd|string|无|否|无|需要认证的请求对应的密码\n     *  rand|bool|无|否|无|请求随机数，设置则浏览器缓存失效\n     * ```\n     */\n     public static async request(config): Promise<unknown> {\n        const time = Date.now();\n        //如果设置了rejectReqTick，则需要进行判断\n        if(this.rejectReqTick>0){\n            if(this.requestMap.has(config.url)){\n                const obj = this.requestMap.get(config.url);\n                if(time - obj['time'] < this.rejectReqTick && Util.compare(obj['params'],config.params)){\n                    return new Promise((resolve)=>{\n                        resolve(null)\n                    });\n                }\n            }\n            //加入请求集合\n            this.requestMap.set(config.url,{\n                time:time,\n                params:config.params\n            });\n        }\n        \n        return new Promise((resolve, reject) => {\n            if (typeof config === 'string') {\n                config = {\n                    url: config\n                }\n            }\n            config.params = config.params || {};\n            //随机数\n            if (config.rand) { //针对数据部分，仅在app中使用\n                config.params.$rand = Math.random();\n            }\n            let url: string = config.url;\n            const async: boolean = config.async === false ? false : true;\n            const req: XMLHttpRequest = new XMLHttpRequest();\n            //设置同源策略\n            req.withCredentials = config.withCredentials;\n            //类型默认为get\n            const method: string = (config.method || 'GET').toUpperCase();\n            //超时，同步时不能设置\n            req.timeout = async ? config.timeout : 0;\n\n            req.onload = () => {\n                //正常返回处理\n                if (req.status === 200) {\n                    let r = req.responseText;\n                    if (config.type === 'json') {\n                        try {\n                            r = JSON.parse(r);\n                        } catch (e) {\n                            reject({ type: \"jsonparse\" });\n                        }\n                    }\n                    resolve(r);\n                } else { //异常返回处理\n                    reject({ type: 'error', url: url });\n                }\n            }\n            //设置timeout和error\n            req.ontimeout = () => reject({ type: 'timeout' });\n            req.onerror = () => reject({ type: 'error', url: url });\n            //上传数据\n            let data = null;\n            switch (method) {\n                case 'GET':\n                    //参数\n                    let pa: string;\n                    if (Util.isObject(config.params)) {\n                        const ar: string[] = [];\n                        for(const k of Object.keys(config.params)){\n                            const v = config.params[k];\n                            if(v === undefined || v === null){\n                                continue;\n                            }\n                            ar.push(k + '=' + v);\n                        }\n                        pa = ar.join('&');\n                    }\n                    if (pa !== undefined) {\n                        if (url.indexOf('?') !== -1) {\n                            url += '&' + pa;\n                        } else {\n                            url += '?' + pa;\n                        }\n                    }\n                    break;\n                case 'POST':\n                    if (config.params instanceof FormData) {\n                        data = config.params;\n                    } else {\n                        const fd: FormData = new FormData();\n                        for(const k of Object.keys(config.params)){\n                            const v = config.params[k];\n                            if(v === undefined || v === null){\n                                continue;\n                            }\n                            fd.append(k, v);\n                        }\n                        data = fd;                  \n                    }\n                    break;\n            }\n            //打开请求\n            req.open(method, url, async, config.user, config.pwd);\n            //设置request header\n            if (config.header) {\n                Util.getOwnProps(config.header).forEach((item) => {\n                    req.setRequestHeader(item, config.header[item]);\n                })\n            }\n            //发送请求\n            req.send(data);\n        }).catch((re) => {\n            switch (re.type) {\n                case \"error\":\n                    throw new NError(\"notexist1\",NodomMessage.TipWords['resource'], re.url);\n                case \"timeout\":\n                    throw new NError(\"timeout\");\n                case \"jsonparse\":\n                    throw new NError(\"jsonparse\");\n            }\n        });\n    }\n\n    /**\n     * 清除超时的缓存请求\n     */\n    public static clearCache(){\n        const time = Date.now();\n        if(this.rejectReqTick>0){\n            if(this.requestMap){\n                for(const kv of this.requestMap){\n                    if(time - kv[1]['time'] > this.rejectReqTick){\n                        this.requestMap.delete(kv[0]);\n                    }\n                }\n            }\n        }\n    }\n}","import { Module } from \"./module\";\nimport { RouteCfg, UnknownClass } from \"./types\";\nimport { Util } from \"./util\";\n\n/**\n * 路由类\n */\n export class Route {\n    /**\n     * 路由id\n     */\n    public id:number;\n    /**\n     * 路由参数名数组\n     */\n    public params:Array<string> = [];\n    /**\n     * 路由参数数据\n     */\n    public data:object = {};\n    /**\n     * 子路由\n     */\n    public children:Array<Route> = [];\n    /**\n     * 进入路由事件方法\n     */\n    public onEnter:(module:Module,path:string)=>void;\n    /**\n     * 离开路由方法\n     */\n    public onLeave:(module:Module,path:string)=>void;\n    \n    /**\n     * 路由路径\n     */\n    public path:string;\n    /**\n     * 完整路径\n     */\n    public fullPath:string;\n\n    /**\n     * 路由对应模块对象或类或模块类名\n     */\n    public module:string|UnknownClass|Module;\n    \n    /**\n     * 父路由\n     */\n    public parent:Route;\n\n    /**\n     * 构造器\n     * @param config - 路由配置项\n     */\n    constructor(config?:RouteCfg,parent?:Route) {\n        if (!config || Util.isEmpty(config.path)) {\n            return;\n        }\n        this.id = Util.genId();\n        //参数赋值\n        for(const o of Object.keys(config)){\n            this[o] = config[o];   \n        }\n        this.parent = parent;\n        //解析路径\n        if(this.path){\n            this.parse();\n        }\n        if(parent){\n            parent.addChild(this);\n        }\n        //子路由\n        if (config.routes && Array.isArray(config.routes)) {\n            config.routes.forEach((item) => {\n                new Route(item,this);\n            });\n        }\n    }\n    \n    /**\n     * 添加子路由\n     * @param child - 字路由\n     */\n    public addChild(child:Route){\n        this.children.push(child);\n        child.parent = this;\n    }\n\n    /**\n     * 通过路径解析路由对象\n     */\n    private parse(){\n        const pathArr:Array<string> = this.path.split('/');\n        let node:Route = this.parent;\n        let param:Array<string> = [];\n        let paramIndex:number = -1; //最后一个参数开始\n        let prePath:string = '';    //前置路径\n        for (let i = 0; i < pathArr.length; i++) {\n            const v = pathArr[i].trim();\n            if (v === '') {\n                pathArr.splice(i--, 1);\n                continue;\n            }\n\n            if (v.startsWith(':')) { //参数\n                if (param.length === 0) {\n                    paramIndex = i;\n                }\n                param.push(v.substring(1));\n            } else {\n                paramIndex = -1;\n                param = []; //上级路由的参数清空\n                this.path = v; //暂存path\n                let j = 0;\n                for (; j < node.children.length; j++) {\n                    const r = node.children[j];\n                    if (r.path === v) {\n                        node = r;\n                        break;\n                    }\n                }\n                //没找到，创建新节点\n                if (j === node.children.length) {\n                    if (prePath !== '') {\n                        new Route({ path: prePath},node);\n                        node = node.children[node.children.length - 1];\n                    }\n                    prePath = v;\n                }\n            }\n            //不存在参数\n            this.params = paramIndex===-1?[]:param;\n        }\n    }\n\n    /**\n     * 克隆\n     * @returns 克隆对象\n     */\n    public clone():Route{\n        const r = new Route();\n        Object.getOwnPropertyNames(this).forEach(item=>{\n            if(item === 'data'){    \n                return;\n            }\n            r[item] = this[item];\n        });\n        if(this.data){\n            r.data = Util.clone(this.data);\n        }\n        return r;\n    }\n}","import { NError } from \"./error\";\nimport { Util } from \"./util\";\n\n/**\n * 调度器\n * @remarks\n * 管理所有需调度的任务并进行循环调度，默认采用requestAnimationFrame方式进行循环\n */\nexport class Scheduler{\n\t/**\n\t * 待执行任务列表\n\t */\n\tprivate static tasks:Array<object> = [];\n\t\n\t/**\n\t * 执行任务\n\t */\n\tpublic static dispatch(){\n\t\tScheduler.tasks.forEach((item)=>{\n\t\t\tif(Util.isFunction(item['func'])){\n\t\t\t\tif(item['thiser']){\n\t\t\t\t\titem['func'].call(item['thiser']);\n\t\t\t\t}else{\n\t\t\t\t\titem['func']();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * 启动调度器\n\t * @param scheduleTick - \t渲染间隔（ms），默认50ms\n\t */\n\tpublic static start(scheduleTick?:number){\n\t\tScheduler.dispatch();\n\t\tif(window.requestAnimationFrame){\n\t\t\twindow.requestAnimationFrame(Scheduler.start);\n\t\t}else{\n\t\t\twindow.setTimeout(Scheduler.start,scheduleTick||50);\n\t\t}\t\t\n\t}\n\n\t/**\n\t * 添加任务\n\t * @param foo - \t待执行任务函数\n\t * @param thiser - \tthis指向\n\t */\n\tpublic static addTask(foo:()=>void,thiser?:object){\n\t\tif(!Util.isFunction(foo)){\n\t\t\tthrow new NError(\"invoke\",\"Scheduler.addTask\",\"0\",\"function\");\n\t\t}\n\t\tScheduler.tasks.push({func:foo,thiser:thiser});\n\t}\n\n\t/**\n\t * 移除任务\n\t * @param foo - \t任务函数\n\t */\n\tpublic static removeTask(foo){\n\t\tif(!Util.isFunction(foo)){\n\t\t\tthrow new NError(\"invoke\",\"Scheduler.removeTask\",\"0\",\"function\");\n\t\t}\n\t\tlet ind = -1;\n\t\tif((ind = Scheduler.tasks.indexOf(foo)) !== -1){\n\t\t\tScheduler.tasks.splice(ind,1);\n\t\t}\t\n\t}\n}\n","import { DirectiveManager } from \"./directivemanager\";\nimport { NError } from \"./error\";\nimport { NodomMessage_en } from \"./locales/msg_en\";\nimport { NodomMessage_zh } from \"./locales/msg_zh\";\nimport { ModuleFactory } from \"./modulefactory\";\nimport { Renderer } from \"./renderer\";\nimport { RequestManager } from \"./requestmanager\";\nimport { Route } from \"./route\";\nimport { Scheduler } from \"./scheduler\";\nimport { DirectiveMethod, RouteCfg, UnknownClass } from \"./types\";\nimport { Util } from \"./util\";\n\n/**\n * nodom提示消息\n */\nexport let NodomMessage = NodomMessage_zh;\n\n/**\n * Nodom接口暴露类\n */\nexport class Nodom{\n    /**\n     * 是否为debug模式，开启后，表达式编译异常会输出到控制台\n     */\n    public static isDebug:boolean;\n\n    /**\n     * 应用初始化\n     * @param clazz -     模块类\n     * @param selector -  根模块容器选择器，默认使用document.body\n     */\n    public static app(clazz:unknown,selector?:string){\n        //设置渲染器的根 element\n        Renderer.setRootEl(document.querySelector(selector)||document.body);\n        //渲染器启动渲染任务\n        Scheduler.addTask(Renderer.render, Renderer);\n        //添加请求清理任务\n        Scheduler.addTask(RequestManager.clearCache);\n        //启动调度器\n        Scheduler.start();\n        ModuleFactory.get(<UnknownClass>clazz).active();\n    }\n\n    /**\n     * 启用debug模式\n     */\n    public static debug(){\n        this.isDebug = true;\n    }\n\n    /**\n     * 设置语言\n     * @param lang -  语言（zh,en），默认zh\n     */\n    public static setLang(lang:string){\n        //设置nodom语言\n        switch(lang||'zh'){\n            case 'zh':\n                NodomMessage = NodomMessage_zh;\n                break;\n            case 'en':\n                NodomMessage = NodomMessage_en;\n        }\n    }\n\n    /**\n     * use插件（实例化）\n     * @remarks\n     * 插件实例化后以单例方式存在，第二次use同一个插件，将不进行任何操作，实例化后可通过Nodom['$类名']方式获取\n     * @param clazz -   插件类\n     * @param params -  参数\n     * @returns         实例化后的插件对象\n     */\n    public static use(clazz:unknown,params?:unknown[]):unknown{\n        if(!clazz['name']){\n            new NError('notexist',NodomMessage.TipWords.plugin);\n        }\n        if(!this['$'+clazz['name']]){\n            this['$'+clazz['name']] = Reflect.construct(<UnknownClass>clazz,params||[]); \n        }\n        return this['$'+clazz['name']];\n    }\n\n    /**\n     * 创建路由\n     * @remarks\n     * 配置项可以用嵌套方式\n     * @example\n     * ```js\n     * Nodom.createRoute([{\n     *   path: '/router',\n     *   //直接用模块类，需import\n     *   module: MdlRouteDir,\n     *   routes: [\n     *       {\n     *           path: '/route1',\n     *           module: MdlPMod1,\n     *           routes: [{\n     *               path: '/home',\n     *               //直接用路径，实现懒加载\n     *               module:'/examples/modules/route/mdlmod1.js'\n     *           }, ...]\n     *       }, {\n     *           path: '/route2',\n     *           module: MdlPMod2,\n     *           //设置进入事件\n     *           onEnter: function (module,path) {},\n     *           //设置离开事件\n     *           onLeave: function (module,path) {},\n     *           ...\n     *       }\n     *   ]\n     * }])\n     * ```\n     * @param config -  路由配置\n     * @param parent -  父路由\n     */\n    public static createRoute(config: RouteCfg | Array<RouteCfg>,parent?:Route): Route {\n        if(!Nodom['$Router']){\n            throw new NError('uninit',NodomMessage.TipWords.route)\n        }\n        \n        let route:Route;\n        parent = parent || Nodom['$Router'].getRoot();\n        if (Util.isArray(config)) {\n            for (const item of <Array<RouteCfg>>config) {\n                route = new Route(item,parent);\n            }\n        } else {\n            route = new Route(<RouteCfg>config,parent);\n        }\n        return route;\n    }\n\n    /**\n     * 创建指令\n     * @param name -      指令名 \n     * @param priority -  优先级（1最小，1-10为框架保留优先级）\n     * @param handler -   渲染时方法\n     */\n    public static createDirective(name: string, handler: DirectiveMethod,priority?: number) {\n        return DirectiveManager.addType(name,handler,priority);\n    }\n\n    /**\n     * 注册模块\n     * @param clazz -   模块类\n     * @param name -    注册名，如果没有，则为类名\n     */\n    public static registModule(clazz:unknown,name?:string){\n        ModuleFactory.addClass(<UnknownClass>clazz,name);\n    }\n\n    /**\n     * ajax 请求，如果需要用第三方ajax插件替代，重载该方法\n     * @param config -  object 或 string，如果为string，则表示url，直接以get方式获取资源，如果为 object，配置项如下:\n     * ```\n     *  参数名|类型|默认值|必填|可选值|描述\n     *  -|-|-|-|-|-\n     *  url|string|无|是|无|请求url\n     *\tmethod|string|GET|否|GET,POST,HEAD|请求类型\n     *\tparams|object/FormData|空object|否|无|参数，json格式\n     *\tasync|bool|true|否|true,false|是否异步\n     *  timeout|number|0|否|无|请求超时时间\n     *  type|string|text|否|json,text|\n     *\twithCredentials|bool|false|否|true,false|同源策略，跨域时cookie保存\n     *  header|Object|无|否|无|request header 对象\n     *  user|string|无|否|无|需要认证的请求对应的用户名\n     *  pwd|string|无|否|无|需要认证的请求对应的密码\n     *  rand|bool|无|否|无|请求随机数，设置则浏览器缓存失效\n     * ```\n     */\n    public static async request(config): Promise<unknown> {\n        return await RequestManager.request(config);\n    }\n\n    /**\n     * 重复请求拒绝时间间隔\n     * @remarks\n     * 如果设置此项，当url一致时且间隔时间小于time，则拒绝请求\n     * @param time -  时间间隔（ms）\n     */\n    public static setRejectTime(time:number){\n        RequestManager.setRejectTime(time);\n    }\n}\n\n\n","import { NodomMessage } from \"./nodom\";\nimport { Util } from \"./util\";\n\n/**\n * 异常处理类\n */\nexport  class NError extends Error{\n    constructor(errorName:string,...params){\n        super(errorName);\n        const msg:string = NodomMessage.ErrorMsgs[errorName];\n        if(msg === undefined){\n            this.message = \"未知错误\";\n            return;\n        }\n        //编译提示信息\n        this.message = Util.compileStr(msg,params);\n    }\n}   \n","import { NError } from \"./error\";\nimport { NodomMessage } from \"./nodom\";\n/**\n * 基础服务库\n */\nexport class Util {\n    /**\n     * 全局id\n     */\n    private static generatedId: number = 1;\n    \n    /**\n     * js 保留字 map\n     */\n    public static keyWordMap = new Map();\n    \n    /**\n     * 唯一主键\n     */\n    public static genId() {\n        return this.generatedId++;\n    }\n\n    /**\n     * 初始化保留字map\n     */\n    public static initKeyMap(){\n        [\n            'arguments','boolean','break','byte','catch',\n            'char','const','default','delete','do',\n            'double','else','enum','eval','false',\n            'float','for','function','goto','if',\n            'in','instanceof','int','let','long',\n            'null','return','short','switch','this',\n            'throw','true','try','this','throw',\n            'typeof','var','while','with','Array',\n            'Date','JSON', 'Set','Map','eval',\n            'Infinity','isFinite','isNaN','isPrototypeOf','Math',\n            'new','NaN','Number','Object','prototype','String',\n            'isPrototypeOf','undefined','valueOf'\n        ].forEach(item=>{\n            this.keyWordMap.set(item,true);\n        });\n    }\n\n    /**\n     * 是否为 js 保留关键字\n     * @param name -    名字\n     * @returns         如果为保留字，则返回true，否则返回false\n     */\n    public static isKeyWord(name:string):boolean{\n        return this.keyWordMap.has(name);\n    }\n\n    /******对象相关******/\n\n    /**\n     * 对象复制\n     * @param srcObj -  源对象\n     * @param expKey -  不复制的键正则表达式或属性名\n     * @param extra -   附加参数\n     * @returns         复制的对象\n     */\n\n    public static clone(srcObj: object, expKey?: RegExp | string[], extra?: object): object {\n        const map: WeakMap<object, object> = new WeakMap();\n        return clone(srcObj, expKey, extra);\n\n        /**\n         * clone对象\n         * @param src -      待clone对象\n         * @param expKey -   不克隆的键\n         * @param extra -    clone附加参数\n         * @returns        克隆后的对象\n         */\n        function clone(src, expKey, extra?) {\n            //非对象或函数，直接返回            \n            if (!src || typeof src !== 'object' || Util.isFunction(src)) {\n                return src;\n            }\n            let dst;\n\n            //带有clone方法，则直接返回clone值\n            if (src.clone && Util.isFunction(src.clone)) {\n                return src.clone(extra);\n            } else if (Util.isObject(src)) {\n                dst = new Object();\n                //把对象加入map，如果后面有新克隆对象，则用新克隆对象进行覆盖\n                map.set(src, dst);\n                Object.getOwnPropertyNames(src).forEach((prop) => {\n                    //不克隆的键\n                    if (expKey) {\n                        if (expKey.constructor === RegExp && (<RegExp>expKey).test(prop) //正则表达式匹配的键不复制\n                            || Util.isArray(expKey) && expKey.includes(prop)    //被排除的键不复制\n                        ) {\n                            return;\n                        }\n                    }\n                    dst[prop] = getCloneObj(src[prop], expKey, extra);\n                });\n            } else if (Util.isMap(src)) {\n                dst = new Map();\n                //把对象加入map，如果后面有新克隆对象，则用新克隆对象进行覆盖\n                src.forEach((value, key) => {\n                    //不克隆的键\n                    if (expKey) {\n                        if (expKey.constructor === RegExp && (<RegExp>expKey).test(key)       //正则表达式匹配的键不复制\n                            || expKey.includes(key)) {     //被排除的键不复制\n                            return;\n                        }\n                    }\n                    dst.set(key, getCloneObj(value, expKey, extra));\n                });\n            } else if (Util.isArray(src)) {\n                dst = [];\n                //把对象加入map，如果后面有新克隆对象，则用新克隆对象进行覆盖\n                src.forEach(function (item, i) {\n                    dst[i] = getCloneObj(item, expKey, extra);\n                });\n            }\n            return dst;\n        }\n\n        /**\n         * 获取clone对象\n         * @param value -     待clone值\n         * @param expKey -    排除键\n         * @param extra -     附加参数\n         */\n        function getCloneObj(value, expKey, extra) {\n            if (typeof value === 'object' && !Util.isFunction(value)) {\n                let co = null;\n                if (!map.has(value)) {  //clone新对象\n                    co = clone(value, expKey, extra);\n                } else {                    //从map中获取对象\n                    co = map.get(value);\n                }\n                return co;\n            }\n            return value;\n        }\n    }\n    \n    /**\n     * 比较两个对象值是否相同(只比较object和array)\n     * @param src - 源对象\n     * @param dst - 目标对象 \n     * @returns     值相同则返回true，否则返回false \n     */\n    public static compare(src:object,dst:object):boolean{\n        return cmp(src,dst);\n        function cmp(o1,o2){\n            if(o1 === o2){\n                return true;\n            }\n            const keys1 = Object.keys(o1);\n            const keys2 = Object.keys(o2);\n            if(keys1.length !== keys2.length){\n                return false;\n            }\n            for(const k of keys1){\n                if(typeof o1[k] === 'object' && typeof o2[k] === 'object'){\n                    if(!cmp(o1[k],o2[k])){\n                        return false;\n                    }\n                }else if(o1[k] !== o2[k]){\n                    return false;\n                }\n            }\n            return true;\n        }\n    }\n    \n    /**\n     * 获取对象自有属性\n     * @param obj - 需要获取属性的对象\n     * @returns     返回属性数组\n     */\n    public static getOwnProps(obj): Array<string> {\n        if (!obj) {\n            return [];\n        }\n        return Object.getOwnPropertyNames(obj);\n    }\n    \n    /**************对象判断相关************/\n    /**\n     * 判断是否为函数\n     * @param foo - 检查的对象\n     * @returns     true/false\n     */\n    public static isFunction(foo): boolean {\n        return foo !== undefined && foo !== null && foo.constructor === Function;\n    }\n\n    /**\n     * 判断是否为数组\n     * @param obj -   检查的对象\n     * @returns     true/false\n     */\n    public static isArray(obj): boolean {\n        return Array.isArray(obj);\n    }\n\n    /**\n     * 判断是否为map\n     * @param obj -   检查的对象\n     */\n    public static isMap(obj): boolean {\n        return obj !== null && obj !== undefined && obj.constructor === Map;\n    }\n\n    /**\n     * 判断是否为对象\n     * @param obj -   检查的对象\n     * @returns     true/false\n     */\n    public static isObject(obj): boolean {\n        return obj !== null && obj !== undefined && obj.constructor === Object;\n    }\n\n    /**\n     * 判断对象/字符串是否为空\n     * @param obj - 检查的对象\n     * @returns     true/false\n     */\n    public static isEmpty(obj): boolean {\n        if (obj === null || obj === undefined)\n            return true;\n        if (this.isObject(obj)) {\n            const keys = Object.keys(obj);\n            return keys.length === 0;\n        } else if (typeof obj === 'string') {\n            return obj === '';\n        }\n        return false;\n    }\n\n    /******日期相关******/\n    /**\n     * 日期格式化\n     * @param timestamp -   时间戳\n     * @param format -      日期格式\n     * @returns             日期串\n     */\n    public static formatDate(timeStamp: string | number, format: string): string {\n        if (typeof timeStamp === 'string') {\n            //排除日期格式串,只处理时间戳\n            if (/^\\d+$/.test(<string>timeStamp)) {\n                timeStamp = Number(<string>timeStamp);\n            } else {\n                throw new NError('invoke', 'Util.formatDate','0', 'date string', 'date');\n            }\n        } \n        //得到日期\n        const date: Date = new Date(timeStamp);\n        // invalid date\n        if (isNaN(date.getDay())) {\n            throw new NError('invoke', 'Util.formatDate','0', 'date string', 'date');\n        }\n\n        const o = {\n            \"M+\": date.getMonth() + 1, //月份\n            \"d+\": date.getDate(), //日\n            \"h+\": date.getHours(), //小时\n            \"H+\": date.getHours(), //小时\n            \"m+\": date.getMinutes(), //分\n            \"s+\": date.getSeconds(), //秒\n            \"S\": date.getMilliseconds() //毫秒\n        };\n\n        let re;\n        //年\n        if (re=/(y+)/.exec(format)) {\n            format = format.replace(re[0], (date.getFullYear() + \"\").substring(4 - re[0].length));\n        }\n        //月日\n        this.getOwnProps(o).forEach(function (k) {\n            if (re=new RegExp(\"(\" + k + \")\").exec(format)) {\n                format = format.replace(re[0], re[0].length===1?o[k]:(\"00\" + o[k]).substring((o[k]+'').length));\n            }\n        });\n\n        //星期\n        format = format.replace(/(E+)/, NodomMessage.WeekDays[date.getDay() + \"\"]);\n        return format;\n    }\n\n    /******字符串相关*****/\n    /**\n     * 编译字符串，把 \\{n\\}替换成带入值\n     * @param src -     待编译的字符串\n     * @param params -  参数数组\n     * @returns     转换后的消息\n     */\n    public static compileStr(src: string, ...params): string {\n        if(!params || params.length === 0){\n            return src;\n        }\n        let reg: RegExp;\n        for (let i=0;i<params.length;i++) {\n            if (src.indexOf('\\{' + i + '\\}') !== -1) {\n                reg = new RegExp('\\\\{' + i + '\\\\}', 'g');\n                src = src.replace(reg, params[i]);\n            } else {\n                break;\n            }\n        }\n        return src;\n    }\n}\n\n//初始化keymap\nUtil.initKeyMap();","import { DirectiveManager } from \"./directivemanager\";\nimport { DirectiveType } from \"./directivetype\";\nimport { Module } from \"./module\";\nimport { Util } from \"./util\";\nimport { Expression } from \"./expression\";\nimport { NError } from \"./error\";\nimport { NodomMessage } from \"./nodom\";\nimport { RenderedDom } from \"./types\";\n\n/**\n * 指令类\n */\nexport  class Directive {\n    /**\n     * 指令id\n     */\n    public id:number;\n\n    /**\n     * 指令类型\n     */\n    public type:DirectiveType;\n    \n    /**\n     * 指令值\n     */\n    public value:unknown;\n    \n    /**\n     * 表达式\n     */\n    public expression:Expression;\n\n    /**\n     * 禁用指令\n     */\n    public disabled:boolean;\n\n    /**\n     * 模板所属模块id\n     * @remarks\n     * 使用该指令的模板对应的module id\n     * \n     * 下例中，`if`指令对应的templateModule 是`Main`模块，即`templateModuleId`是模块`Main`的id。\n     * @example\n     * ```js\n     *  class Main extends Module{\n     *      template(props){\n     *          return `\n     *              <div>\n     *                  <Module1>\n     *                      <div x-if={{r}}>yes</div>\n     *                  </Module1>\n     *              </div>\n     *          `\n     *      }\n     *  }\n     * ```\n     */\n    public templateModuleId:number;\n\n    /**\n     * 构造方法\n     * @param type -  \t    类型名\n     * @param value - \t    指令值\n     * @param templateMid - 模板所属的module id\n     */\n    constructor(type?:string,value?:string|Expression,templateMid?:number) {\n        this.id = Util.genId();\n        if(type){\n            this.type = DirectiveManager.getType(type);\n            if(!this.type){\n                throw new NError('notexist1',NodomMessage.TipWords['directive'],type);\n            }\n        }\n        if (typeof value === 'string') {\n            this.value = (<string>value).trim();\n        }else if(value instanceof Expression){\n            this.expression = value;\n        }else{\n            this.value = value;\n        }\n        this.templateModuleId = templateMid;\n    }\n\n    /**\n     * 执行指令\n     * @param module -  模块\n     * @param dom -     渲染目标节点对象\n     * @returns         是否继续渲染\n     */\n    public exec(module:Module,dom:RenderedDom):boolean {\n        //禁用，不执行\n        if(this.disabled){\n            return true;\n        }\n        if(this.expression){\n            this.value = this.expression.val(module,dom.model);\n        }\n        return this.type.handler.apply(this,[module,dom]);\n    }\n\n    /**\n     * 克隆\n     * @returns     新克隆的指令\n     */\n    public clone():Directive{\n        const d = new Directive();\n        d.type = this.type;\n        d.expression = this.expression;\n        d.value = this.value;\n        d.templateModuleId = this.templateModuleId;\n        return d;\n    }\n}\n","import { Module } from \"./module\";\nimport { Util } from \"./util\";\nimport { EventMethod, RenderedDom} from \"./types\";\nimport { Expression } from \"./expression\";\n\n/**\n * 事件类\n * @remarks\n * 事件分为自有事件和代理事件，事件默认传递参数为：\n * \n * 0: model(事件对应数据模型)\n * \n * 1: dom(事件target对应的虚拟dom节点)\n * \n * 2: evObj(Nodom Event对象)\n * \n * 3: e(Html Event对象)\n */\nexport class NEvent {\n    /**\n     * 事件id\n     */\n    public id: number;\n\n    /**\n     * 事件所属模块\n     */\n    public module:Module;\n\n    /**\n     * 事件名\n     */\n    public name: string;\n\n    /**\n     * 事件处理方法\n     * @remarks\n     * 事件钩子对应的方法函数、方法名或表达式，如果为方法名，需要在模块中定义\n     */\n    public handler: string | EventMethod;\n\n    /**\n     * 表达式，当定义的事件串为表达式时有效\n     */\n    private expr:Expression;\n\n    /**\n     * 代理模式，事件代理到父对象\n     */\n    public delg: boolean;\n\n    /**\n     * 禁止冒泡，代理模式下无效\n     */\n    public nopopo: boolean;\n\n    /**\n     * 只执行一次\n     */\n    public once: boolean;\n\n    /**\n     * 使用capture，代理模式下无效\n     */\n    public capture: boolean;\n\n    /**\n     * 依赖事件\n     * @remarks \n     * 当事件为扩展事件时，用于存储原始事件\n     */\n    public dependEvent:NEvent;\n\n    /**\n     * @param eventName -   事件名\n     * @param eventStr -    事件串或事件处理函数,以“:”分割,中间不能有空格,结构为: `方法名:delg:nopopo:once:capture`，`\":\"`后面的内容选择使用，如果eventStr为函数，则替代第三个参数\n     * @param handler -     事件执行函数，如果方法不在module methods中定义，则通过此参数设置事件钩子，此时，eventStr第一个参数失效，即eventStr可以是\":delg:nopopo\"\n     */\n    constructor(module:Module,eventName: string, eventStr?: string | Expression | EventMethod, handler?: EventMethod) {\n        this.id = Util.genId();\n        this.module = module;\n        this.name = eventName;\n        this.init(eventStr,handler);\n    }\n\n    /**\n     * 事件串初始化\n     * @param eventStr -  事件串 \n     * @param handler -   事件钩子函数\n     */\n    private init(eventStr?: string | Expression | EventMethod, handler?: EventMethod){\n        //如果事件串不为空，则不需要处理\n        if (eventStr) {\n            const tp = typeof eventStr;\n            if (tp === 'string') {\n                this.parseEvent((<string>eventStr).trim());\n            } else if(tp === 'function'){\n                this.handler = <EventMethod>eventStr;\n            }else if(eventStr instanceof Expression){\n                this.expr = eventStr;\n            }\n        }\n        //新增事件方法（不在methods中定义）\n        if (handler) {\n            this.handler = <EventMethod>handler;\n        }\n        this.touchOrNot();\n    }\n\n    /**\n     * 表达式处理\n     * @remarks\n     * 用于动态事件名传递，当handler为expression时有效\n     * @param module -    模块\n     * @param model -     对应model\n     */\n    public handleExpr(module,model){\n        if(this.expr){\n            const evtStr = <string>this.expr.val(module,model);\n            this.init(evtStr);\n        }\n        return this;\n    }\n\n    /**\n     * 解析事件字符串\n     * @param eventStr -  待解析的字符串\n     */\n    private parseEvent(eventStr){\n        eventStr.split(':').forEach((item, i) => {\n            item = item.trim();\n            if (i === 0) { //事件方法\n                this.handler = item;\n            } else { //事件附加参数\n                switch (item) {\n                    case 'delg':\n                        this.delg = true;\n                        break;\n                    case 'nopopo':\n                        this.nopopo = true;\n                        break;\n                    case 'once':\n                        this.once = true;\n                        break;\n                    case 'capture':\n                        this.capture = true;\n                        break;\n                }\n            }\n        });\n    }\n\n    /**\n     * 触屏转换\n     */\n    private touchOrNot(){\n        if (document.ontouchend) { //触屏设备\n            switch (this.name) {\n                case 'click':\n                    this.name = 'tap';\n                    break;\n                case 'mousedown':\n                    this.name = 'touchstart';\n                    break;\n                case 'mouseup':\n                    this.name = 'touchend';\n                    break;\n                case 'mousemove':\n                    this.name = 'touchmove';\n                    break;\n            }\n        } else { //转非触屏\n            switch (this.name) {\n                case 'tap':\n                    this.name = 'click';\n                    break;\n                case 'touchstart':\n                    this.name = 'mousedown';\n                    break;\n                case 'touchend':\n                    this.name = 'mouseup';\n                    break;\n                case 'touchmove':\n                    this.name = 'mousemove';\n                    break;\n            }\n        }\n    }\n    /**\n     * 设置附加参数值\n     * @param module -    模块\n     * @param dom -       虚拟dom\n     * @param name -      参数名\n     * @param value -     参数值\n     */\n    public setParam(dom:RenderedDom,name: string, value: unknown) {\n        this.module.objectManager.setEventParam(this.id,dom.key,name,value);\n    }\n\n    /**\n     * 获取附加参数值\n     * @param dom -       虚拟dom\n     * @param name -      参数名\n     * @returns         附加参数值\n     */\n    public getParam(dom:RenderedDom,name: string):unknown {\n        return this.module.objectManager.getEventParam(this.id,dom.key,name);\n    }\n\n    /**\n     * 移除参数\n     * @param dom -       虚拟dom\n     * @param name -      参数名\n     */\n    public removeParam(dom:RenderedDom,name: string) {\n        return this.module.objectManager.removeEventParam(this.id,dom.key,name);\n    }\n    /**\n     * 清参数cache\n     * @param dom -       虚拟dom\n     */\n    public clearParam(dom:RenderedDom){\n        this.module.objectManager.clearEventParams(this.id,dom.key);\n    }\n}\n","import { Directive } from './directive'\nimport { DirectiveManager } from './directivemanager'\nimport { NEvent } from './event'\nimport { Expression } from './expression'\nimport { Module } from './module'\nimport { Util } from './util'\n\n/**\n * 虚拟dom\n * @remarks\n * 编译后的dom节点，与渲染后的dom节点(RenderedDom)不同\n */\nexport class VirtualDom {\n\t/**\n\t * 元素名，如div\n\t */\n\tpublic tagName: string\n\n\t/**\n\t * key，数字或字符串，整颗虚拟dom树唯一\n\t */\n\tpublic key: number|string\n\n\t/**\n\t * 文本内容\n\t * @remarks\n\t * element为textnode时有效\n\t */\n\tpublic textContent: string\n\n\t/**\n\t * 表达式+字符串数组，用于text node\n\t */\n\tpublic expressions: Array<Expression | string>\n\n\t/**\n\t * 指令集\n\t */\n\tpublic directives: Directive[]\n\n\t/**\n\t * 直接属性\n\t * @remarks\n\t * 不是来自于attribute，而是直接作用于html element，如el.checked,el.value等\n\t */\n\tpublic assets: Map<string, string|number|boolean>\n\n\t/**\n\t * 属性(attribute)集合\n\t * @remarks\n\t * 属性值可能是值，也可能是表达式\n\t */\n\tpublic props: Map<string, string|number|boolean|object|Expression>\n\n\t/**\n\t * 事件数组\n\t */\n\tpublic events: Array<NEvent>\n\n\t/**\n\t * 子节点数组[]\n\t */\n\tpublic children: Array<VirtualDom>\n\n\t/**\n\t * 父虚拟dom\n\t */\n\tpublic parent: VirtualDom;\n\n\t/**\n\t * 是否为svg节点\n\t */\n\tpublic isSvg:boolean;\n\n\t/**\n\t * 静态标识数\n\t * @remarks\n\t * 用于判断是否为静态节点，默认为1，表示至少渲染1次\n\t * \n\t *  0 表示静态，不进行比较\n\t * \n\t *  1 渲染后 -1\n\t * \n\t *  -1 每次都渲染\n\t */\n\tpublic staticNum: number\n\n\t/**\n\t * @param tag -     标签名\n\t * @param key -     key\n\t * @param module - \t模块\n\t */\n\tconstructor(tag?: string, key?: number|string, module?: Module) {\n\t\tthis.key = key || (module ? module.getDomKeyId() : Util.genId())\n\t\tthis.staticNum = 1;\n\t\tif (tag) {\n\t\t\tthis.tagName = tag\n\t\t}\n\t}\n\n\t/**\n\t * 移除多个指令\n\t * @param directives - \t待删除的指令类型数组或指令类型\n\t * @returns             如果虚拟dom上的指令集为空，则返回void\n\t */\n\tpublic removeDirectives(directives: string[]) {\n\t\tif (!this.directives) {\n\t\t\treturn\n\t\t}\n\t\t//数组\n\t\tdirectives.forEach((d) => {\n\t\t\tthis.removeDirective(d)\n\t\t})\n\t}\n\n\t/**\n\t * 移除指令\n\t * @param directive - \t待删除的指令类型名\n\t * @returns             如果虚拟dom上的指令集为空，则返回void\n\t */\n\tpublic removeDirective(directive: string) {\n\t\tif (!this.directives) {\n\t\t\treturn\n\t\t}\n\n\t\tlet ind\n\t\tif ((ind = this.directives.findIndex(\n\t\t\t\t(item) => item.type.name === directive\n\t\t\t)) !== -1\n\t\t) {\n\t\t\tthis.directives.splice(ind, 1)\n\t\t}\n\t\tif (this.directives.length === 0) {\n\t\t\tdelete this.directives\n\t\t}\n\t}\n\n\t/**\n\t * 添加指令\n\t * @param directive -     指令对象\n\t * @param sort -          是否排序\n\t * @returns             如果虚拟dom上的指令集不为空，且指令集中已经存在传入的指令对象，则返回void\n\t */\n\tpublic addDirective(directive: Directive, sort?: boolean) {\n\t\tif (!this.directives) {\n\t\t\tthis.directives = [directive];\n\t\t\treturn;\n\t\t} else if (this.directives.find((item) => item.type.name === directive.type.name)){\n\t\t\treturn\n\t\t}\n\t\tthis.directives.push(directive)\n\t\t//指令按优先级排序\n\t\tif (sort) {\n\t\t\tthis.sortDirective()\n\t\t}\n\t}\n\n\t/**\n\t * 指令排序\n\t * @returns           如果虚拟dom上指令集为空，则返回void\n\t */\n\tpublic sortDirective() {\n\t\tif (!this.directives) {\n\t\t\treturn\n\t\t}\n\t\tif (this.directives.length > 1) {\n\t\t\tthis.directives.sort((a, b) => {\n\t\t\t\treturn DirectiveManager.getType(a.type.name).prio <\n\t\t\t\t\tDirectiveManager.getType(b.type.name).prio\n\t\t\t\t\t? -1\n\t\t\t\t\t: 1\n\t\t\t})\n\t\t}\n\t}\n\n\t/**\n\t * 是否有某个类型的指令\n\t * @param typeName - \t    指令类型名\n\t * @returns             如果指令集不为空，且含有传入的指令类型名则返回true，否则返回false\n\t */\n\tpublic hasDirective(typeName: string): boolean {\n\t\treturn this.directives && this.directives.find(item => item.type.name === typeName) !== undefined;\n\t}\n\n\t/**\n\t * 获取某个类型的指令\n\t * @param module -            模块\n\t * @param directiveType - \t指令类型名\n\t * @returns                 如果指令集为空，则返回void；否则返回指令类型名等于传入参数的指令对象\n\t */\n\tpublic getDirective(directiveType: string): Directive {\n\t\tif (!this.directives) {\n\t\t\treturn\n\t\t}\n\t\treturn this.directives.find((item) => item.type.name === directiveType)\n\t}\n\n\t/**\n\t * 添加子节点\n\t * @param dom -       子节点\n\t * @param index -     指定位置，如果不传此参数，则添加到最后\n\t */\n\tpublic add(dom: VirtualDom, index?: number) {\n\t\tif (!this.children) {\n\t\t\tthis.children = []\n\t\t}\n\t\tif (index) {\n\t\t\tthis.children.splice(index, 0, dom)\n\t\t} else {\n\t\t\tthis.children.push(dom)\n\t\t}\n\t\tdom.parent = this\n\t}\n\n\t/**\n\t * 移除子节点\n\t * @param dom -   子节点\n\t */\n\tpublic remove(dom: VirtualDom) {\n\t\tconst index = this.children.indexOf(dom)\n\t\tif (index !== -1) {\n\t\t\tthis.children.splice(index, 1)\n\t\t}\n\t}\n\n\t/**\n\t * 是否拥有属性\n\t * @param propName -  属性名\n\t * @param isExpr -    是否只检查表达式属性\n\t * @returns         如果属性集含有传入的属性名返回true，否则返回false\n\t */\n\tpublic hasProp(propName: string) {\n\t\tif (this.props) {\n\t\t\treturn this.props.has(propName)\n\t\t}\n\t}\n\n\t/**\n\t * 获取属性值\n\t * @param propName -  属性名\n\t * @returns         传入属性名的value\n\t */\n\tpublic getProp(propName: string) {\n\t\tif (this.props) {\n\t\t\treturn this.props.get(propName)\n\t\t}\n\t}\n\n\t/**\n\t * 设置属性值\n\t * @param propName -  属性名\n\t * @param v -         属性值\n\t */\n\tpublic setProp(propName: string, v: string|number|boolean|object|Expression) {\n\t\tif (!this.props) {\n\t\t\tthis.props = new Map()\n\t\t}\n\t\tthis.props.set(propName, v)\n\t}\n\n\t/**\n\t * 删除属性\n\t * @param props -     属性名或属性名数组\n\t * @returns         如果虚拟dom上的属性集为空，则返回void\n\t */\n\tpublic delProp(props: string | string[]) {\n\t\tif (!this.props) {\n\t\t\treturn\n\t\t}\n\t\tthis.props.delete(<string>props)\n\t}\n\n\t/**\n\t * 设置asset\n\t * @param assetName -     asset name\n\t * @param value -         asset value\n\t */\n\tpublic setAsset(assetName: string, value: string|number|boolean) {\n\t\tif (!this.assets) {\n\t\t\tthis.assets = new Map()\n\t\t}\n\t\tthis.assets.set(assetName, value)\n\t\tthis.setStaticOnce();\n\t}\n\n\t/**\n\t * 删除asset\n\t * @param assetName -     asset name\n\t * @returns             如果虚拟dom上的直接属性集为空，则返回void\n\t */\n\tpublic delAsset(assetName: string) {\n\t\tif (!this.assets) {\n\t\t\treturn\n\t\t}\n\t\tthis.assets.delete(assetName)\n\t\tthis.setStaticOnce();\n\t}\n\n\t/**\n\t * 设置cache参数\n\t * @param module -    模块\n\t * @param name -      参数名\n\t * @param value -     参数值\n\t */\n\tpublic setParam(module: Module, name: string, value: string|boolean|number|object) {\n\t\tmodule.objectManager.setDomParam(this.key, name, value)\n\t}\n\n\t/**\n\t * 获取参数值\n\t * @param module -    模块\n\t * @param name -      参数名\n\t * @returns         参数值\n\t */\n\tpublic getParam(module: Module, name: string) {\n\t\treturn module.objectManager.getDomParam(this.key, name)\n\t}\n\n\t/**\n\t * 移除参数\n\t * @param module -    模块\n\t * @param name -      参数名\n\t */\n\tpublic removeParam(module: Module, name: string) {\n\t\tmodule.objectManager.removeDomParam(this.key, name)\n\t}\n\n\t/**\n\t * 设置单次静态标志\n\t */\n\tprivate setStaticOnce() {\n\t\tif (this.staticNum !== -1) {\n\t\t\tthis.staticNum = 1;\n\t\t}\n\t}\n\n\t/**\n\t * 克隆\n\t */\n\tpublic clone(): VirtualDom {\n\t\tconst dst: VirtualDom = new VirtualDom(this.tagName, this.key)\n\t\tif (this.tagName) {\n\t\t\t//属性\n\t\t\tif (this.props && this.props.size > 0) {\n\t\t\t\tfor (const p of this.props) {\n\t\t\t\t\tdst.setProp(p[0], p[1])\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.assets && this.assets.size > 0) {\n\t\t\t\tfor (const p of this.assets) {\n\t\t\t\t\tdst.setAsset(p[0], p[1])\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.directives && this.directives.length > 0) {\n\t\t\t\tdst.directives = []\n\t\t\t\tfor (const d of this.directives) {\n\t\t\t\t\tdst.directives.push(d.clone())\n\t\t\t\t}\n\t\t\t}\n\t\t\t//复制事件\n\t\t\tdst.events = this.events\n\n\t\t\t//子节点clone\n\t\t\tif (this.children) {\n\t\t\t\tfor (const c of this.children) {\n\t\t\t\t\tdst.add(c.clone())\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tdst.expressions = this.expressions\n\t\t\tdst.textContent = this.textContent\n\t\t}\n\t\tdst.staticNum = this.staticNum\n\t\treturn dst\n\t}\n\n\t/**\n\t * 保存事件\n\t * @param event -     事件对象\n\t * @param index - \t位置\n\t */\n\tpublic addEvent(event: NEvent,index?:number) {\n\t\tif (!this.events) {\n\t\t\tthis.events = [event]\n\t\t}else if(!this.events.includes(event)){\n\t\t\tif(index >= 0){\n\t\t\t\tthis.events.splice(index,0,event)\n\t\t\t}else{\n\t\t\t\tthis.events.push(event)\n\t\t\t}\n\t\t}\n\t}\n}\n","import { DefineElementManager } from './defineelementmanager'\r\nimport { Directive } from './directive'\r\nimport { NError } from './error'\r\nimport { NEvent } from './event'\r\nimport { Expression } from './expression'\r\nimport { Module } from './module'\r\nimport { ModuleFactory } from './modulefactory'\r\nimport { VirtualDom } from './virtualdom'\r\n\r\nconst voidTagMap = new Set(\r\n\t'area,base,br,col,embed,hr,img,input,link,meta,param,source,track,wbr'.split(',')\r\n)\r\n\r\n/**\r\n * 编译器\r\n * \r\n * @remarks\r\n * 用于编译模板串为虚拟dom(VirtualDom)节点，存放于模块的 domManager.vdomTree\r\n */\r\nexport class Compiler {\r\n\t/**\r\n\t * 模块\r\n\t */\r\n\tprivate module: Module\r\n\r\n\t/**\r\n\t * 当前节点\r\n\t */\r\n\tprivate current: VirtualDom\r\n\r\n\t/**\r\n\t * 虚拟dom数组\r\n\t */\r\n\tprivate domArr: Array<VirtualDom> = []\r\n\r\n\t/**\r\n\t * 文本节点\r\n\t */\r\n\tprivate textArr: Array<string|Expression> = []\r\n\r\n\t/**\r\n\t * 是否是表达式文本节点\r\n\t */\r\n\tprivate isExprText: boolean = false\r\n\r\n\t/**\r\n\t * 当前编译的模板，用于报错的时候定位\r\n\t */\r\n\tprivate template: string = ''\r\n\r\n\t/**\r\n\t * 根节点\r\n\t */\r\n\tprivate root:VirtualDom;\r\n\r\n\t/**\r\n\t * 当前处理标签是否在svg区域\r\n\t */\r\n\tprivate isSvg:boolean;\r\n\r\n\t/**\r\n\t * 构造器\r\n\t * @param module - 模块\r\n\t */\r\n\tconstructor(module: Module) {\r\n\t\tthis.module = module\r\n\t}\r\n\r\n\t/**\r\n\t * 编译\r\n\t * @param elementStr - \t待编译html串\r\n\t * @returns             虚拟dom树根节点\r\n\t */\r\n\tpublic compile(elementStr: string): VirtualDom {\r\n\t\tif(!elementStr){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\t// 清除注释\r\n\t\tthis.template = elementStr.replace(/\\<\\!\\-\\-[\\s\\S]*?\\-\\-\\>/g, '').trim()\r\n\t\telementStr = this.template\r\n\t\t// 编译\r\n\t\tthis.compileTemplate(elementStr)\r\n\t\t//处理未关闭节点\r\n\t\tif(this.domArr.length>0){\r\n\t\t\tthis.forceClose(0)\r\n\t\t}\r\n\t\treturn this.root\r\n\t}\r\n\r\n\t/**\r\n\t * 产生dom key\r\n\t * @returns   dom key\r\n\t */\r\n\tprivate genKey(): number {\r\n\t\treturn this.module.getDomKeyId()\r\n\t}\r\n\r\n\t/**\r\n\t * 编译模板\r\n\t * @param srcStr - \t源串\r\n\t */\r\n\tprivate compileTemplate(srcStr: string) {\r\n\t\twhile (srcStr.length !== 0) {\r\n\t\t\tif (srcStr.startsWith('<')) {\r\n\t\t\t\t// 标签\r\n\t\t\t\tif (srcStr[1] == '/') {\r\n\t\t\t\t\t// 结束标签\r\n\t\t\t\t\tsrcStr = this.compileEndTag(srcStr)\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// 开始标签\r\n\t\t\t\t\tsrcStr = this.compileStartTag(srcStr)\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// 文本节点\r\n\t\t\t\tsrcStr = this.compileText(srcStr)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 处理开始标签\r\n\t * @param srcStr - 待编译字符串\r\n\t * @returns 编译处理后的字符串\r\n\t */\r\n\tprivate compileStartTag(srcStr: string): string {\r\n\t\t// 抓取<div\r\n\t\tconst match = /^<\\s*([a-z][^\\s\\/\\>]*)/i.exec(srcStr)\r\n\t\t// 抓取成功\r\n\t\tif (match) {\r\n\t\t\t// 设置当前正在编译的节点\r\n\t\t\tconst dom = new VirtualDom(\r\n\t\t\t\tmatch[1].toLowerCase(),\r\n\t\t\t\tthis.genKey(),\r\n\t\t\t\tthis.module\r\n\t\t\t)\r\n\t\t\tif(dom.tagName === 'svg'){\r\n\t\t\t\tthis.isSvg = true;\r\n\t\t\t}\r\n\t\t\t//设置svg标志\r\n\t\t\tdom.isSvg = this.isSvg;\r\n\r\n\t\t\tif(!this.root){\r\n\t\t\t\tthis.root = dom;\r\n\t\t\t}\r\n\t\t\tif(this.current){\r\n\t\t\t\tthis.current.add(dom)\r\n\t\t\t}\r\n\t\t\t//设置当前节点\r\n\t\t\tthis.current = dom\r\n\t\t\t// 当前节点入栈\r\n\t\t\tthis.domArr.push(dom)\r\n\t\t\t// 截断字符串 准备处理属性\r\n\t\t\tsrcStr = srcStr.substring(match.index + match[0].length).trimStart()\r\n\t\t} else {\r\n\t\t\t// <!-- 或者<后跟符号不是字符\r\n\t\t\t// 当作text节点\r\n\t\t\tthis.textArr.push(srcStr[0])\r\n\t\t\treturn srcStr.substring(1)\r\n\t\t}\r\n\r\n\t\t// 处理属性\r\n\t\tsrcStr = this.compileAttributes(srcStr)\r\n\t\t// 属性处理完成之后 判断是否结束\r\n\t\tif (srcStr.startsWith('>')) {\r\n\t\t\tif (this.isVoidTab(this.current)) {  //属于自闭合，则处理闭合\r\n\t\t\t\tthis.handleCloseTag(this.current,true)\r\n\t\t\t}\r\n\t\t\treturn srcStr.substring(1).trimStart()\r\n\t\t}\r\n\t\treturn srcStr;\r\n\t}\r\n\r\n\t/**\r\n\t * 处理标签属性\r\n\t * @param srcStr - 待编译字符串\r\n\t * @returns 编译后字符串\r\n\t */\r\n\tprivate compileAttributes(srcStr: string): string {\r\n\t\twhile (srcStr.length !== 0 && srcStr[0]!=='>') {\r\n\t\t\t// 抓取形如： /> a='b' a={{b}} a=\"b\" a=`b` a $data={{***}} a={{***}}的属性串;\r\n\t\t\tconst match = /^((\\/\\>)|\\$?[a-z_][\\w-]*)(?:\\s*=\\s*((?:'[^']*')|(?:\"[^\"]*\")|(?:`[^`]*`)|(?:{{[^}}]*}})))?/i.exec(srcStr)\r\n\t\t\t// 抓取成功 处理属性\r\n\t\t\tif (match) {\r\n\t\t\t\tif (match[0] === '/>') {  //自闭合标签结束则退出\r\n\t\t\t\t\t// 是自闭合标签\r\n\t\t\t\t\tthis.handleCloseTag(this.current,true);\r\n\t\t\t\t\tsrcStr = srcStr.substring(match.index + match[0].length).trimStart()\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t} else { //属性\r\n\t\t\t\t\tconst name = match[1][0]!=='$'?match[1].toLowerCase():match[1];\r\n\t\t\t\t\t// 是普通属性\r\n\t\t\t\t\tlet value:string|Expression = !match[3]\r\n\t\t\t\t\t\t? undefined\r\n\t\t\t\t\t\t: match[3].startsWith(`\"`)\r\n\t\t\t\t\t\t? match[3].substring(1, match[3].length - 1)\r\n\t\t\t\t\t\t: match[3].startsWith(`'`)\r\n\t\t\t\t\t\t? match[3].substring(1, match[3].length - 1)\r\n\t\t\t\t\t\t: match[3]\r\n\t\t\t\t\tif (value && value.startsWith('{{')) {\r\n\t\t\t\t\t\tvalue = new Expression(value.substring(2, value.length - 2))\r\n\t\t\t\t\t\t//表达式 staticNum为-1\r\n\t\t\t\t\t\tthis.current.staticNum = -1;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif (name.startsWith('x-')) {\r\n\t\t\t\t\t\t// 指令\r\n\t\t\t\t\t\tthis.current.addDirective(new Directive(name.substring(2), value,this.module.id))\r\n\t\t\t\t\t} else if (name.startsWith('e-')) {\r\n\t\t\t\t\t\t// 事件\r\n\t\t\t\t\t\tthis.current.addEvent(\r\n\t\t\t\t\t\t\tnew NEvent(this.module, name.substring(2), value)\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\t//普通属性\r\n\t\t\t\t\t\tthis.current.setProp(name, value)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tsrcStr = srcStr.substring(match.index + match[0].length).trimStart()\r\n\t\t\t} else {\r\n\t\t\t\tif (this.current) {\r\n\t\t\t\t\tthrow new NError('tagError', this.current.tagName)\r\n\t\t\t\t}\r\n\t\t\t\tthrow new NError('wrongTemplate')\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn srcStr\r\n\t}\r\n\r\n\t/**\r\n\t * 编译结束标签\r\n\t * @param srcStr - \t源串\r\n\t * @returns \t\t剩余的串\r\n\t */\r\n\tprivate compileEndTag(srcStr: string): string {\r\n\t\t// 抓取结束标签\r\n\t\tconst match = /^<\\/\\s*([a-z][^\\>]*)/i.exec(srcStr)\r\n\t\tif(match){\r\n\t\t\tconst name = match[1].toLowerCase().trim();\r\n\t\t\t//如果找不到匹配的标签头则丢弃\r\n\t\t\tlet index;\r\n\t\t\tfor(let i=this.domArr.length-1;i>=0;i--){\r\n\t\t\t\tif(this.domArr[i].tagName === name){\r\n\t\t\t\t\tindex = i;\r\n\t\t\t\t\tbreak;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t//关闭\r\n\t\t\tif(index){\r\n\t\t\t\tthis.forceClose(index);\r\n\t\t\t}\r\n\t\t\treturn srcStr.substring(match.index + match[0].length + 1)\r\n\t\t}\r\n\t\treturn srcStr;\r\n\t}\r\n\r\n\t/**\r\n\t * 强制闭合\r\n\t * @param index - 在domArr中的索引号\r\n\t * @returns \r\n\t */\r\n\tprivate forceClose(index){\r\n\t\tif(index===-1 || index > this.domArr.length-1){\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tfor(let i=this.domArr.length-1;i>=index;i--){\r\n\t\t\tthis.handleCloseTag(this.domArr[i])\r\n\t\t}\r\n\t}\r\n\t\r\n\t/**\r\n\t * 编译text\r\n\t * @param srcStr - \t源串\r\n\t * @returns \t\t\r\n\t */\r\n\tprivate compileText(srcStr: string): string {\r\n\t\t// 字符串最开始变为< 或者字符串消耗完 则退出循环\r\n\t\twhile (!srcStr.startsWith('<') && srcStr.length !== 0) {\r\n\t\t\tif (srcStr.startsWith('{')) {\r\n\t\t\t\t// 可能是表达式\r\n\t\t\t\tconst matchExp = /^{{([\\s\\S]*?)}}/i.exec(srcStr)\r\n\t\t\t\tif (matchExp) {\r\n\t\t\t\t\t// 抓取成功\r\n\t\t\t\t\tthis.textArr.push(new Expression(matchExp[1]))\r\n\t\t\t\t\tthis.isExprText = true\r\n\t\t\t\t\tsrcStr = srcStr.substring(matchExp.index + matchExp[0].length)\r\n\t\t\t\t} else {\r\n\t\t\t\t\t// 跳过单独的{\r\n\t\t\t\t\ttypeof this.textArr[this.textArr.length] === 'string'\r\n\t\t\t\t\t\t? (this.textArr[this.textArr.length] += '{')\r\n\t\t\t\t\t\t: this.textArr.push('{')\r\n\t\t\t\t\tsrcStr = srcStr.substring(1)\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// 非表达式，处理成普通字符节点\r\n\t\t\t\tconst match = /([^\\<\\{]*)/.exec(srcStr)\r\n\t\t\t\tif (match) {\r\n\t\t\t\t\tlet txt: string\r\n\t\t\t\t\tif (this.current && this.current.tagName === 'pre') {\r\n\t\t\t\t\t\t// 在pre标签里\r\n\t\t\t\t\t\ttxt = this.preHandleText(\r\n\t\t\t\t\t\t\tsrcStr.substring(0, match.index + match[0].length)\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\ttxt = this.preHandleText(\r\n\t\t\t\t\t\t\tsrcStr.substring(0, match.index + match[0].length).trim()\r\n\t\t\t\t\t\t)\r\n\t\t\t\t\t}\r\n\t\t\t\t\tif(txt !== ''){\r\n\t\t\t\t\t\tthis.textArr.push(txt)\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tsrcStr = srcStr.substring(match.index + match[0].length)\r\n\t\t\t}\r\n\t\t}\r\n\t\t// 最开始是< 或者字符消耗完毕 退出循环\r\n\t\tconst text = new VirtualDom(undefined, this.genKey())\r\n\t\tif(this.isExprText){\r\n\t\t\ttext.expressions = [...this.textArr];\r\n\t\t\t//动态文本节点，staticNum=-1\r\n\t\t\ttext.staticNum = -1;\r\n\t\t}else{\r\n\t\t\ttext.textContent = this.textArr.join('')\r\n\t\t}\r\n\t\tif (this.current && (this.isExprText || text.textContent.length !== 0)) {\r\n\t\t\tthis.current.add(text)\r\n\t\t} \r\n\t\t// 重置状态\r\n\t\tthis.isExprText = false\r\n\t\tthis.textArr = []\r\n\t\t// 返回字符串\r\n\t\treturn srcStr\r\n\t}\r\n\r\n\t/**\r\n\t * 预处理html保留字符 如 &nbsp;,&lt;等\r\n\t * @param str -   待处理的字符串\r\n\t * @returns     解析之后的串\r\n\t */\r\n\tprivate preHandleText(str: string): string {\r\n\t\tconst reg = /&[a-z]+;/\r\n\t\tif (reg.test(str)) {\r\n\t\t\tconst div = document.createElement('div')\r\n\t\t\tdiv.innerHTML = str\r\n\t\t\treturn div.textContent\r\n\t\t}\r\n\t\treturn str\r\n\t}\r\n\r\n\t/**\r\n\t * 处理当前节点是模块或者自定义节点\r\n\t * @param dom - \t虚拟dom节点\r\n\t */\r\n\tprivate postHandleNode(dom:VirtualDom) {\r\n\t\tconst clazz = DefineElementManager.get(dom.tagName)\r\n\t\tif (clazz) {\r\n\t\t\tReflect.construct(clazz, [dom, this.module])\r\n\t\t}\r\n\t\t// 是否是模块类\r\n\t\tif (ModuleFactory.hasClass(dom.tagName)) {\r\n\t\t\tdom.addDirective(new Directive('module', dom.tagName,this.module.id))\r\n\t\t\tdom.tagName = 'div'\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * 处理插槽\r\n\t * @param dom - \t虚拟dom节点\r\n\t */\r\n\tprivate handleSlot(dom:VirtualDom) {\r\n\t\tif (\r\n\t\t\t!dom.children ||\r\n\t\t\tdom.children.length === 0 ||\r\n\t\t\t!dom.hasDirective('module')\r\n\t\t) {\r\n\t\t\treturn\r\n\t\t}\r\n\t\tlet slotCt: VirtualDom\r\n\t\tfor (let j = 0; j < dom.children.length; j++) {\r\n\t\t\tconst c = dom.children[j]\r\n\t\t\tif (c.hasDirective('slot')) {\r\n\t\t\t\t//带slot的不处理\r\n\t\t\t\tcontinue\r\n\t\t\t}\r\n\t\t\tif (!slotCt) { //初始化default slot container\r\n\t\t\t\t//第一个直接被slotCt替换\r\n\t\t\t\tslotCt = new VirtualDom('div', this.genKey())\r\n\t\t\t\tslotCt.addDirective(new Directive('slot','default',this.module.id))\r\n\t\t\t\t//当前位置，用slot替代\r\n\t\t\t\tdom.children.splice(j, 1, slotCt)\r\n\t\t\t} else { \t\t//添加到default slot container\r\n\t\t\t\t//直接删除\r\n\t\t\t\tdom.children.splice(j--, 1)\r\n\t\t\t}\r\n\t\t\tslotCt.add(c)\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * 标签闭合\r\n\t */\r\n\tprivate handleCloseTag(dom:VirtualDom,isSelfClose?:boolean) {\r\n\t\tthis.postHandleNode(dom)\r\n\t\tdom.sortDirective()\r\n\t\tif(!isSelfClose){\r\n\t\t\tthis.handleSlot(dom)\r\n\t\t}\r\n\t\t//闭合节点出栈\r\n\t\tthis.domArr.pop();\r\n\t\t//设置current为最后一个节点\r\n\t\tif(this.domArr.length>0){\r\n\t\t\tthis.current = this.domArr[this.domArr.length-1];\r\n\t\t}\r\n\t\t// 取消isSvg标识\r\n\t\tif(dom.tagName === 'svg'){\r\n\t\t\tthis.isSvg = false;\r\n\t\t}\r\n\t}\r\n\t/**\r\n\t * 判断节点是否为空节点\r\n\t * @param dom -\t带检测节点\r\n\t * @returns\r\n\t */\r\n\tprivate isVoidTab(dom: VirtualDom) {\r\n\t\treturn voidTagMap.has(dom.tagName)\r\n\t}\r\n}","import { ChangedDom, RenderedDom } from \"./types\";\n/**\n * dom比较器\n */\nexport class DiffTool{\n    /**\n     * 比较节点\n     * \n     * @param src -         待比较节点（新树节点）\n     * @param dst - \t    被比较节点 (旧树节点)\n     * @param changeArr -   增删改的节点数组\n     * @returns\t            改变的节点数组\n     */\n    public static compare(src:RenderedDom,dst:RenderedDom):ChangedDom[] {\n        const changeArr = [];\n        compare(src,dst);\n        return changeArr;\n\n        /**\n         * 比较节点\n         * @param src -     待比较节点（新节点）\n         * @param dst - \t被比较节点 (旧节点)\n         */\n        function compare(src:RenderedDom,dst:RenderedDom) {\n            if (!src.tagName) { //文本节点\n                if (!dst.tagName) {\n                    if ((src.staticNum || dst.staticNum) && src.textContent !== dst.textContent) {\n                        addChange(2,src,dst,dst.parent);\n                    }else if(src.moduleId !== dst.moduleId){\n                        addChange(5,src,dst, dst.parent);\n                    }\n                } else { //节点类型不同，替换\n                    addChange(5,src,dst, dst.parent);\n                }\n            } else {\n                //节点类型不同或对应的子模块不同，替换\n                if((src.moduleId || dst.moduleId) && src.moduleId !== dst.moduleId || src.tagName !== dst.tagName){\n                    addChange(5,src,dst, dst.parent);\n                }else{//节点类型相同，但有一个不是静态节点，进行属性比较\n                    if((src.staticNum || dst.staticNum) && isChanged(src,dst)){\n                        addChange(2,src,dst,dst.parent);\n                    }\n                    // 非子模块不比较子节点或者作为slot的子模块\n                    // if(!src.moduleId || src.rmid){\n                        compareChildren(src,dst);\n                    // }\n                }\n            }\n        }\n\n        /**\n         * 比较子节点\n         * @param src -   新节点\n         * @param dst -   旧节点\n         */\n        function compareChildren(src,dst){\n            //子节点处理\n            if (!src.children || src.children.length === 0) {\n                // 旧节点的子节点全部删除\n                if (dst.children && dst.children.length > 0) {\n                    dst.children.forEach(item => addChange(3,item,null,dst));\n                }\n            } else {\n                //全部新加节点\n                if (!dst.children || dst.children.length === 0) {\n                    src.children.forEach((item,index) => addChange(1, item,null, dst,index));\n                } else { //都有子节点\n                    //存储比较后需要add的key\n                    const addObj={};\n                    //子节点对比策略\n                    let [newStartIdx,newEndIdx,oldStartIdx,oldEndIdx] = [0,src.children.length-1,0,dst.children.length-1];\n                    let [newStartNode,newEndNode,oldStartNode,oldEndNode] = [\n                        src.children[newStartIdx],\n                        src.children[newEndIdx],\n                        dst.children[oldStartIdx],\n                        dst.children[oldEndIdx]\n                    ]\n                    while(newStartIdx <= newEndIdx && oldStartIdx <= oldEndIdx) {\n                        if (oldStartNode.key === newStartNode.key) {  //新前旧前\n                            compare(newStartNode,oldStartNode);\n                            if(newStartIdx !== oldStartIdx){\n                                addChange(4,newStartNode,null,dst,newStartIdx,oldStartIdx);\n                            }\n                            newStartNode = src.children[++newStartIdx];\n                            oldStartNode = dst.children[++oldStartIdx];\n                        } else if (oldEndNode.key === newEndNode.key) { //新后旧后\n                            compare(newEndNode,oldEndNode);\n                            if(oldEndIdx !== newEndIdx){\n                                addChange(4,newEndNode,null,dst,newEndIdx,oldEndIdx);\n                            }\n                            newEndNode = src.children[--newEndIdx];\n                            oldEndNode = dst.children[--oldEndIdx];\n                        } else if (newStartNode.key === oldEndNode.key) { //新前旧后\n                            //新前旧后\n                            compare(newStartNode,oldEndNode);\n                            //放在指定位置\n                            if(newStartIdx !== oldEndIdx){\n                                addChange(4,newStartNode,null,dst,newStartIdx,oldEndIdx);\n                            }\n                            newStartNode = src.children[++newStartIdx];\n                            oldEndNode = dst.children[--oldEndIdx];\n                            \n                        } else if (newEndNode.key === oldStartNode.key) {  //新后旧前\n                            compare(newEndNode,oldStartNode);\n                            if(newEndIdx !== oldStartIdx){\n                                addChange(4, newEndNode, null,dst, newEndIdx,oldStartIdx);\n                            }\n                            newEndNode = src.children[--newEndIdx];\n                            oldStartNode = dst.children[++oldStartIdx];\n                        } else {\n                            //加入到addObj\n                            addObj[newStartNode.key]= addChange(1, newStartNode, null,dst,newStartIdx);\n                            //新前指针后移\n                            newStartNode = src.children[++newStartIdx];\n                        }\n                    }\n\n                    //多余新节点，需要添加\n                    if(newStartIdx<=newEndIdx) {\n                        for (let i = newStartIdx; i <= newEndIdx; i++) {\n                            // 添加到dst.children[i]前面\n                            addChange(1,src.children[i], null ,dst,i);\n                        }\n                    }\n                    \n                    //有多余老节点，需要删除或变成移动\n                    if(oldStartIdx<=oldEndIdx){\n                        for (let i = oldStartIdx,index=i; i <= oldEndIdx; i++,index++) {\n                            const ch=dst.children[i];\n                            //如果要删除的节点在addArr中，则表示move，否则表示删除\n                            if(addObj.hasOwnProperty(ch.key)){ \n                                const o = addObj[ch.key];\n                                if(index !== o[4]){ //修改add为move\n                                    o[0] = 4;\n                                    //设置move前位置\n                                    o[5] = i;\n                                    //从add转为move，需要比较新旧节点\n                                    compare(o[1],ch);\n                                }else{  //删除不需要移动的元素\n                                    let ii;\n                                    if((ii=changeArr.findIndex(item=>item[1].key === o[1].key)) !== -1){\n                                        changeArr.splice(ii,1);\n                                    }\n                                }\n                            }else{\n                                addChange(3,ch,null,dst);\n                                //删除的元素索引号-1，用于判断是否需要移动节点\n                                index--;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        \n        /**\n         * 判断节点是否修改\n         * @param src - 新树节点\n         * @param dst - 旧树节点\n         * @returns     true/false\n         */\n        function isChanged(src:RenderedDom,dst:RenderedDom):boolean{\n            for(const p of ['props','assets','events']){\n                //属性比较\n                if(!src[p] && dst[p] || src[p] && !dst[p]){\n                    return true;\n                }else if(src[p] && dst[p]){\n                    const keys = Object.keys(src[p]);\n                    const keys1 = Object.keys(dst[p]);\n                    if(keys.length !== keys1.length){\n                        return true;\n                    }else{\n                        for(const k of keys){\n                            if(src[p][k] !== dst[p][k]){\n                                return true;\n                            }\n                        }\n                    }\n                }\n            }\n            return false;\n        }\n        \n        /**\n         * 添加到修改数组\n         * @param type -    类型 add 1, upd 2,del 3,move 4 ,rep 5\n         * @param dom -     目标节点       \n         * @param dom1 -    相对节点（被替换时有效）\n         * @param parent -  父节点\n         * @param loc -     添加或移动的目标index\n         * @param loc1 -    被移动前位置\n         * @returns         changed dom\n        */\n        function addChange(type:number,dom:RenderedDom, dom1:RenderedDom,parent?:RenderedDom,loc?:number,loc1?:number):unknown{\n            const o = [type,dom,dom1,parent,loc,loc1];\n            changeArr.push(o);\n            return o;\n        }\n    }\n}\n","import { Module } from \"./module\";\nimport { VirtualDom } from \"./virtualdom\";\n/**\n * 自定义元素\n * \n * @remarks\n * 用于扩充标签，主要用于指令简写，参考 ./extend/elementinit.ts。\n * \n * 如果未指定标签名，默认为`div`，也可以用`tag`属性指定\n * \n * @example\n * ```html\n *   <!-- 渲染后标签名为div -->\n *   <if cond={{any}}>hello</if>\n *   <!-- 渲染后标签名为p -->\n *   <if cond={{any}} tag='p'>hello</if>\n * ```\n */\nexport class DefineElement {\n    /**\n     * 构造器，在dom编译后执行\n     * @param node -    虚拟dom节点\n     * @param module -  所属模块\n     */\n    constructor(node:VirtualDom,module:Module){\n        if (node.hasProp('tag')) {\n            node.tagName = <string>node.getProp('tag');\n            node.delProp('tag');\n        } else {\n            node.tagName = 'div';\n        }\n    }\n}\n","import { NEvent } from \"./event\";\nimport { Module } from \"./module\";\nimport { RenderedDom } from \"./types\";\n\n/**\n * 事件工厂\n * \n * @remarks\n * 每个模块一个事件工厂，用于管理模块内虚拟dom对应的事件对象\n */\nexport class EventFactory{\n    /**\n     * 所属模块\n     */\n    private module:Module;\n    /**\n     * 事件map\n     * key:虚拟domkey，\n     * value: object\n     * ```js\n     * {\n     *      bindMap:{},\n     *      eventName1:{\n     *          own:[event对象,...],\n     *          delg:[{key:被代理key,event:event对象,...],\n     *          toDelg:[event对象],\n     *          capture:useCapture\n     *      },\n     *      eventName2:,\n     *      eventNamen:\n     * }\n     * ```\n     * 其中：\n     *    eventName:事件名，如click等\n     *    配置项说明:\n     *      bindMap:已绑定事件map，其中键为事件名，值为capture，解绑时需要\n     *      own:自己的事件数组\n     *      delg:代理事件数组（代理子对象）\n     *      capture:在own和delg都存在时，如果capture为true，则先执行own，再执行delg，为false时则相反。如果只有own，则和html event的cature事件处理机制相同。\n     */\n    private eventMap:Map<number|string,object>;\n\n    /**\n     * domkey对应event对象数组\n     * key: dom key\n     * value: NEvent数组\n     */\n    private addedEvents:Map<number|string,NEvent[]>;\n\n    /**\n     * 构造器\n     * @param module - 模块\n     */\n    constructor(module:Module){\n        this.module = module;\n        this.eventMap = new Map();\n        this.addedEvents = new Map();\n    }\n\n    /**\n     * 保存事件\n     * @param key -     dom key \n     * @param event -   事件对象\n     */\n    public addEvent(dom:RenderedDom,event: NEvent){\n        const key = dom.key;\n        //判断是否已添加，避免重复添加\n        if(this.addedEvents.has(key) && this.addedEvents.get(key).includes(event)){\n            return;\n        }\n        //代理事件，如果无父节点，则直接处理为自有事件\n        if(event.delg){\n            if(dom.parent){\n                this.addToArr(dom.parent.key,event,dom.key);\n            }else{ //不存在父对象，设置delg为false\n                event.delg = false;\n            }\n        }\n        // 自有事件\n        if(!event.delg){\n            this.addToArr(dom.key,event);\n        }\n        //添加到addedEvents\n        if(!this.addedEvents.has(key)){\n            this.addedEvents.set(key,[event]);\n        }else{\n            this.addedEvents.get(key).push(event);\n        }\n    }\n\n    /**\n     * 添加到dom的own或delg事件队列\n     * @param key -       dom key \n     * @param event -     事件对象\n     * @param key1 -      被代理dom key，仅对代理事件有效\n     */\n    private addToArr(key:number|string,event:NEvent,key1?:number|string){\n        let cfg;\n        if(!this.eventMap.has(key)){\n            cfg = {bindMap:{}};\n            this.eventMap.set(key,cfg);\n        }else{\n            cfg = this.eventMap.get(key);\n        }\n        if(!cfg[event.name]){\n            cfg[event.name] = { //eventname对应配置不存在\n                delg:[],\n                own:[]\n            }\n        }\n        //类型：delg或own\n        let type;\n        let value;\n        //代理事件\n        if(key1){\n            type = 'delg';\n            value = {key:key1,event:event};\n        }else{ //非代理事件\n            type = 'own';\n            value = event;\n            cfg[event.name].capture = event.capture||false;\n        }\n        cfg[event.name][type].push(value);\n    }\n\n    /**\n     * 获取事件对象\n     * @param key -   dom key\n     * @returns     事件对象\n     */\n    public getEvent(key:number):object{\n        return this.eventMap.get(key);\n    }\n\n    /**\n     * 移除所有事件\n     * @param dom - \n     */\n    public removeAllEvents(dom:RenderedDom){\n        if(!this.addedEvents.has(dom.key)){\n            return;\n        }\n        for(const ev of this.addedEvents.get(dom.key)){\n            this.removeEvent(dom,ev);\n        }\n        this.addedEvents.delete(dom.key);\n    }  \n\n    /**\n     * 删除事件\n     * @param event -     事件对象\n     * @param key -       对应dom keys\n     */\n    public removeEvent(dom:RenderedDom,event: NEvent) {\n        if(!this.addedEvents.has(dom.key) || !this.addedEvents.get(dom.key).includes(event)){\n            return;\n        }\n        //从dom event数组移除\n        const arr = this.addedEvents.get(dom.key);\n        arr.splice(arr.indexOf(event),1);\n        //处理delg和own数组\n        if(event.delg){ //代理事件\n            //找到父对象\n            if(!dom.parent || !this.eventMap.has(dom.parent.key)){\n                return;\n            }\n            const cfg = this.eventMap.get(dom.parent.key);\n            if(!cfg[event.name]){\n                return;\n            }\n            const obj = cfg[event.name];\n            const index = obj.delg.findIndex(item=>item.key===dom.key && item.event===event);\n            if(index !== -1){\n                obj.delg.splice(index,1);\n            }\n        }else{ //own\n            const cfg = this.eventMap.get(dom.key);\n            if(!cfg[event.name]){\n                return;\n            }\n            const obj = cfg[event.name];\n            const index = obj.own.findIndex(item=>item===event);\n            if(index !== -1){\n                obj.own.splice(index,1);\n            }\n        }\n    }\n\n    /**\n     * 绑定key对应节点所有事件\n     * @remarks\n     * 执行addEventListener操作\n     * @param key -   dom key\n     */\n    public bind(key:string|number){\n        if(!this.eventMap.has(key)){\n            return;\n        }\n        const el = this.module.getElement(key);\n        const cfg = this.eventMap.get(key);\n        for(const key of Object.keys(cfg)){\n            // bindMap 不是事件名\n            if(key === 'bindMap'){\n                continue;\n            }\n            el.addEventListener(key,handler,cfg[key].capture);\n            cfg['bindMap'][key] = {handler:handler,capture:cfg[key].capture};\n        }\n        const me = this;\n        function handler(e){\n            me.handler.apply(me,[me.module,e]);\n        }\n    }\n\n    /**\n     * 解绑key对应节点的指定事件\n     * @remarks\n     * 执行removeEventListener操作\n     * @param key -         dom key\n     * @param eventName -   事件名\n     */\n    public unbind(key:number,eventName:string){\n        if(!this.eventMap.has(key)){\n            return;\n        }\n        const eobj = this.eventMap.get(key);\n        if(!eobj['bindMap'] || !eobj[eventName]){\n            return;\n        }\n        const el = this.module.getElement(key);\n        const cfg = eobj['bindMap'][eventName];\n        //从html element解绑\n        if(el && cfg){\n            el.removeEventListener(eventName,cfg.handler,cfg.capture);\n        }\n        delete eobj['bindMap'][eventName];\n    }\n\n    /**\n     * 解绑key对应节点所有事件\n     * @param key - dom key\n     */\n    public unbindAll(key:number|string){\n        if(!this.eventMap.has(key)){\n            return;\n        }\n        const eobj = this.eventMap.get(key);\n        if(!eobj['bindMap']){\n            return;\n        }\n        const el = this.module.getElement(key);\n        if(el){\n            for(const key of Object.keys(eobj['bindMap'])){\n                const v = eobj['bindMap'][key];\n                el.removeEventListener(key,v.handler,v.capture);\n            }\n        }\n        eobj['bindMap'] = {};\n    }\n\n    /**\n     * 是否拥有key对应的事件对象\n     * @param key - dom key\n     * @returns     如果key对应事件存在，返回true，否则返回false\n     */\n    private hasEvent(key:number):boolean{\n        return this.eventMap.has(key);\n    }\n\n    /**\n     * 清除工厂所有事件\n     */\n    public clear(){\n        //解绑事件\n        for(const key of this.addedEvents.keys()){\n            this.unbindAll(key);\n        }\n        this.addedEvents.clear();\n        this.eventMap.clear();\n    }\n\n    /**\n     * 事件处理函数\n     * @param module - 模块\n     * @param e - HTML Event\n     */\n    private handler(module,e){\n        //从事件element获取事件\n        const el = e.currentTarget;\n        const key = el.key;\n        const dom = module.domManager.getRenderedDom(key);\n        if(!dom){\n            return;\n        }\n        const eobj = this.eventMap.get(key);\n        if(!eobj || !eobj[e.type]){\n            return;\n        }\n        const evts = eobj[e.type];\n        if(evts.capture){ //先执行自己的事件\n            doOwn(evts.own);\n            doDelg(evts.delg);\n        }else{\n            if(!doDelg(evts.delg)){\n                doOwn(evts.own);\n            }\n        }\n    \n        /**\n         * 处理自有事件\n         * @param events - \n         * @returns \n         */\n        function doOwn(events){\n            if(!events){\n                return;\n            }\n            // 禁止冒泡为false，如果绑定的多个事件中存在1个nopopo，则全部nopopo\n            let nopopo = false;\n            for(let i=0;i<events.length;i++){\n                const ev = events[i];\n                if(!ev.handler){\n                    continue;\n                }\n                //外部事件且为根dom，表示为父模块外部传递事件，则model为模块srcDom对应model，否则使用dom对应model\n                const model = ev.module!==module&&dom.key===1?module.srcDom.model:dom.model;\n                //判断为方法名还是函数\n                if(typeof ev.handler === 'string'){\n                    ev.module.invokeMethod(ev.handler,model,dom,ev,e);\n                }else if(typeof ev.handler === 'function'){\n                    ev.handler.apply(ev.module,[model,dom,ev,e]);\n                }\n                // 只执行1次，则handler置空\n                if(ev.once){\n                    ev.handler = undefined;\n                }\n                if(!nopopo){\n                    nopopo = ev.nopopo;\n                }\n            }\n            if(nopopo){\n                e.stopPropagation();\n            }\n        }\n\n        /**\n         * 处理代理事件\n         * @param events - \n         * @returns         是否禁止冒泡\n         */\n        function doDelg(events):boolean{\n            if(!events){\n                return false;\n            }\n            const elArr = e.path || (e.composedPath?e.composedPath():[]);\n            let nopopo = false;\n            for(let i=0;i<events.length;i++){\n                const evo = events[i];\n                const ev = evo.event;\n                for(let j=0;j<elArr.length && elArr[j]!==el;j++){\n                    const k = elArr[j].key;\n                    if(k === evo.key){\n                        const dom1 = dom.children.find(item=>item.key===k);\n                        if(!dom1){\n                            continue;\n                        }\n                        //外部事件且为根dom，表示为父模块外部传递事件，则model为模块srcDom对应model，否则使用dom对应model\n                        const model = ev.module!==module&&dom1.key===1?module.srcDom.model:dom1.model;\n                        if(typeof ev.handler === 'string'){\n                            ev.module.invokeMethod(ev.handler,model,dom1,ev, e);\n                        }else if(typeof ev.handler === 'function'){\n                            ev.handler.apply(ev.module,model,dom1,ev,e);\n                        }\n                        // 保留nopopo\n                        nopopo = ev.nopopo;\n                        // 只执行1次,移除代理事件\n                        if(ev.once){  \n                            //从当前dom删除\n                            events.splice(i--,1);\n                        }\n                        break;\n                    }\n                }\n            }\n            return nopopo;\n        }\n    }\n}","import { Module } from \"./module\";\n\n/**\n * 缓存模块\n */\nexport class NCache{\n    /**\n     * 缓存数据容器\n     */\n    private cacheData:object = {};\n\n    /**\n     * 订阅map，格式为 \n     * ```js\n     * {\n     *  key:[{\n     *      module:订阅模块,\n     *      handler:回调钩子\n     * },...]}\n     * ```\n     */\n    private subscribeMap = new Map();\n    \n    /**\n     * 通过提供的键名从内存中拿到对应的值\n     * @param key - 键，支持\".\"（多级数据分割）\n     * @returns     值或undefined\n     */\n    public get(key:string){\n        let p = this.cacheData;\n        if(key.indexOf('.') !== -1){\n            const arr = key.split('.');\n            if(arr.length>1){\n                for(let i=0;i<arr.length-1 && p;i++){\n                    p = p[arr[i]];\n                }\n                if(p){\n                    key = arr[arr.length-1];\n                }\n            }\n        }\n        if(p){\n            return p[key];\n        }\n    }\n\n    /**\n     * 通过提供的键名和值将其存储在内存中\n     * @param key -     键 \n     * @param value -   值\n     */\n    public set(key:string,value:unknown){\n        let p = this.cacheData;\n        const key1 = key;\n        if(key.indexOf('.') !== -1){\n            const arr = key.split('.');\n            if(arr.length>1){\n                for(let i=0;i<arr.length-1;i++){\n                    if(!p[arr[i]] || typeof p[arr[i]] !== 'object'){\n                        p[arr[i]] = {};\n                    }\n                    p = p[arr[i]];        \n                }\n                key = arr[arr.length-1];\n            }\n        }\n        if(p){\n            p[key] = value;\n        }\n        //处理订阅\n        if(this.subscribeMap.has(key1)){\n            const arr = this.subscribeMap.get(key1);\n            for(const a of arr){\n                this.invokeSubscribe(a.module,a.handler,value);\n            }\n        }\n    }\n\n    /**\n     * 通过提供的键名将其移除\n     * @param key -   键 \n     */\n    public remove(key:string){\n        let p = this.cacheData;\n        if(key.indexOf('.') !== -1){\n            const arr = key.split('.');\n            if(arr.length>1){\n                for(let i=0;i<arr.length-1 && p;i++){\n                    p = p[arr[i]];\n                }\n                if(p){\n                    key = arr[arr.length-1];\n                }\n            }\n        }\n        if(p){\n            delete p[key];\n        }       \n    }\n    /**\n     * 订阅\n     * @param module -    订阅的模块\n     * @param key -       订阅的属性名\n     * @param handler -   回调函数或方法名（方法属于module），方法传递参数为订阅属性名对应的值 \n     */\n    public subscribe(module:Module,key:string,handler:string|((value)=>void)){\n        if(!this.subscribeMap.has(key)){\n            this.subscribeMap.set(key,[{module:module,handler:handler}]);\n        }else{\n            const arr = this.subscribeMap.get(key);\n            if(!arr.find(item=>item.module === module && item.handler === handler)){\n                arr.push({module:module,handler:handler});\n            }\n        }\n        //如果存在值，则执行订阅回调\n        const v = this.get(key);\n        if(v){\n            this.invokeSubscribe(module,handler,v);\n        }\n    }\n\n    /**\n     * 调用订阅方法\n     * @param module -  模块\n     * @param foo -     方法或方法名\n     * @param v -       值\n     */\n    private invokeSubscribe(module:Module,foo:string|((value)=>void),v:unknown){\n        if(typeof foo === 'string'){\n            module.invokeMethod(<string>foo,v);\n        }else{\n            foo.call(module,v);\n        }\n    }\n}","import { NCache } from \"./cache\";\nimport { Module } from \"./module\";\n\n/**\n * 全局缓存\n * \n * @remarks\n * 用于所有模块共享数据，实现模块通信\n */\nexport class GlobalCache{\n    /**\n     * NCache实例，用于存放缓存对象\n     */ \n    private static cache:NCache = new NCache();\n\n    /**\n     * 保存到cache\n     * @param key -     键，支持\".\"（多级数据分割）\n     * @param value -   值\n     */\n    public static set(key:string,value:unknown){\n        this.cache.set(key,value);\n    }\n\n    /**\n     * 从cache读取\n     * @param key - 键，支持\".\"（多级数据分割）\n     * @returns     缓存的值或undefined\n     */\n    public static get(key):unknown{\n        return this.cache.get(key);\n    }\n\n    /**\n     * 订阅\n     * \n     * @remarks\n     * 如果订阅的数据发生改变，则会触发handler\n     * \n     * @param module -    订阅的模块\n     * @param key -       订阅的属性名\n     * @param handler -   回调函数或方法名（方法属于module），方法传递参数为订阅属性名对应的值\n     */\n    public static subscribe(module:Module,key:string,handler:string|((value)=>void)){\n        this.cache.subscribe(module,key,handler);\n    }\n\n    /**\n     * 从cache移除\n     * @param key -   键，支持\".\"（多级数据分割）\n     */\n    public static remove(key){\n        this.cache.remove(key);\n    }\n}","import { Module } from \"./module\";\n/**\n * 模型类\n * \n * @remarks\n * 模型就是对数据做代理\n * \n * 注意：数据对象中，以下5个属性名（保留字）不能用，可以通过如：`model.__source`的方式获取保留属性\n * \n *      __source:源数据对象\n * \n *      __key:模型的key\n * \n *      __module:所属模块\n * \n *      __parent:父模型\n * \n *      __name:在父模型中的属性名\n * \n */\nexport class Model {\n    /**\n     * @param data -    数据\n     * @param module - \t模块对象\n     * @param parent -  父模型\n     * @param name -    模型在父对象中的prop name\n     * @returns         模型\n     */\n    constructor(data: object, module: Module, parent?:Model, name?:string) {\n        //数据不存在或已经代理，无需再创建\n        if(!data || data['__source']){\n            return data;\n        }\n        // 创建模型\n        const proxy = new Proxy(data, {\n            set(src: object, key: string, value: unknown, receiver: Model){\n                const value1 = preHandle(value,module,receiver,key,false);\n                //值未变,proxy 不处理\n                if (src[key] === value1) {\n                    return true;\n                }\n                const ov = src[key];\n                const r = Reflect.set(src, key, value1, receiver);\n                module.modelManager.update(receiver, key, ov, value1);\n                return r;\n            },\n            get(src: object, key: string, receiver){\n                //如果为代理，则返回源数据\n                if(key === '__source'){\n                    return receiver?src:undefined;\n                }\n                //如果为代理，则返回module\n                if(key === '__module'){\n                    return receiver?module:undefined;\n                }\n                //如果为代理，则返回key\n                if(key === '__key'){\n                    return receiver?module.modelManager.getModelKey(src):undefined;\n                }\n                //父模型\n                if(key === '__parent'){\n                    return parent;\n                }\n\n                if(key === '__name'){\n                    return name;\n                }\n\n                let res = Reflect.get(src, key, receiver);\n                return preHandle(res,module,receiver,key,true);\n            },\n            deleteProperty(src: object, key: string){\n                const oldValue = src[key];\n                delete src[key];\n                module.modelManager.update(proxy,key,oldValue,undefined);\n                return true;\n            }\n        });\n        module.modelManager.add(data,proxy);\n        return proxy;\n\n        /**\n         * 预处理\n         * 当data为model且源module与当前module不一致时，需要绑定到新module\n         * @param data -    数据对象或model\n         * @param module-   新模块\n         * @param parent -  父对象\n         * @param key-      父对象中的名字\n         * @param force-    如果data不为model，是否转为model\n         * @returns         数据对象\n         */\n        function preHandle(data,module:Module,parent,key,force?:boolean){\n            if(!data || (data.constructor !== Object && data.constructor !== Array)){\n                return data;\n            }\n            const oldMdl = data['__module'];\n            //未代理\n            if(!oldMdl){\n                if(!force){\n                    return data;\n                }\n                return new Model(data,module,parent,key);\n            }\n            if(oldMdl !== module){  //目标模块不一致，需要处理绑定和model.__name\n                module.modelManager.add(data['__source'],data);\n                oldMdl.modelManager.bindModel(data,module);\n                //名字不一致，需要在module中保存\n                if(key && key !== data['__name']){\n                    module.modelManager.setModelName(data,key);\n                }\n            }\n            return data;\n        }\n    }\n}","import { ModuleFactory } from \"./modulefactory\";\nimport { Model } from \"./model\";\nimport { Module } from \"./module\";\nimport { Renderer } from \"./renderer\";\nimport { Util } from \"./util\";\n\n/**\n * 模型工厂\n * @remarks\n * 管理模块的model\n */\nexport class ModelManager {\n    /**\n     * 所属模块\n     */\n    public module:Module;\n\n    /**\n     * model与module绑定map\n     * @remarks\n     * slot引用外部数据或模块传值时有效会导致model被不同模块引用，`bindMap`用来存放对应的模块数组\n     * \n     * key:    model\n     * \n     * value:  model绑定的module id 数组\n     */\n    public bindMap:WeakMap<object,number[]> = new WeakMap();\n\n    /**\n     * 数据map\n     * ```js\n     * {\n     *      data1:{\n     *          model:model,\n     *          key:key\n     *      },\n     *      data2:,\n     *      datan\n     * }\n     * ```\n     * 其中：\n     *   datan: 初始数据对象\n     *   model: model对象\n     *   key:   model key\n     */\n    private dataMap: WeakMap<object,{model:Model,key:number}> = new WeakMap();\n\n    /**\n     * 存储模型对应属性名，如果为父传子，则需要保存属于该模型的属性名\n     * key: model\n     * value: model名字\n     */\n    \n    private nameMap:WeakMap<object,string> = new WeakMap();\n    /** \n     * model对应监听器map \n     * key:model\n     * value:object\n     * ```js\n     * {\n     *      key1:{\n     *          f:foo1,\n     *          deep:true/false\n     *      },\n     *      key2:,\n     *      kn:\n     * }\n     * ```\n     *        其中：prop为被监听属性，foo为监听器方法，deep为是否深度监听\n     */\n    private watchMap:WeakMap<object,object> = new WeakMap();\n\n    /**\n     * 是否存在深度watcher\n     */\n    private hasDeepWatch:boolean = false;\n\n    /**\n     * 构造器\n     * @param module -    模块\n     */\n    constructor(module:Module){\n        this.module = module;\n    }\n\n    /**\n     * 获取model，不存在则新建\n     * @param data -    数据\n     * @returns         model\n     */\n    public getModel(data:object):Model{\n        return this.dataMap.has(data)?this.dataMap.get(data).model:undefined;\n    }\n\n    /**\n     * 获取model key\n     * @remarks\n     * 每个model都有一个唯一 key\n     * @param model -   model对象\n     * @returns         model对应key\n     */\n    public getModelKey(data:object):number{\n        return this.dataMap.has(data)?this.dataMap.get(data).key:undefined;\n    }\n\n    /**\n     * 设置model名\n     * @param model - 模型 \n     * @param name -  名\n     */\n    public setModelName(model:Model,name:string){\n        if(!this.nameMap.has(model)){\n            this.nameMap.set(model,name);\n        }\n    }    \n\n    /**\n     * 获取模型名\n     * @param model - 模型 \n     * @returns     模型名\n     */\n    public getModelName(model:Model):string{\n        return this.nameMap.get(model);\n    }\n\n    /**\n     * 添加数据到map\n     * @param data -      原始数据\n     * @param model -     模型\n     */\n    public add(data,model){\n        //避免重复添加\n        if(this.dataMap.has(data)){\n            return;\n        }\n        this.dataMap.set(data,{model:model,key:model.__key || Util.genId()});\n    }\n    \n    /**\n     * 添加绑定\n     * @remarks\n     * 当一个model被多个module引用时，需要添加绑定，以便修改时触发多个模块渲染。\n     * @param model -   模型 \n     * @param module -  模块\n     */\n    public bindModel(model:Model,module:Module){\n        if(!model){\n            return;\n        }\n        bind(this.bindMap,model,module);\n        /**\n         * 绑定\n         * @param bindMap -     model factory 的bindmap\n         * @param model -       model\n         * @param module -      待绑定module\n         */\n        function bind(bindMap,model,module){\n            if(model.__module === module){\n                return;\n            }\n            if(!bindMap.has(model)){\n                bindMap.set(model,[module.id]);\n            }else{\n                const mids = bindMap.get(model);\n                //已经绑定，不再处理子model\n                if(mids.includes(module.id)){\n                    return;\n                }\n                mids.push(module.id);\n            }\n            //级联绑定\n            for(const key of Object.keys(model)){\n                if(model[key] && (model[key].constructor === Object || model[key].constructor === Array)){\n                    bind(bindMap,model[key],module);\n                }\n            }\n        }\n    }\n\n    /**\n     * 更新导致渲染\n     * @remarks\n     * 如果不设置oldValue和newValue，则直接强制渲染\n     * \n     * @param model -     model\n     * @param key -       属性\n     * @param oldValue -  旧值\n     * @param newValue -  新值\n     */\n    public update(model: Model, key: string, oldValue?: unknown, newValue?: unknown) {\n        //处理watch\n        handleWatcher(this.module,model);\n        //添加module渲染\n        Renderer.add(this.module);\n        //对绑定模块添加渲染\n        if(this.bindMap.has(model)){\n            for(const id of this.bindMap.get(model)){\n                const m = ModuleFactory.get(id);\n                if(m){\n                    handleWatcher(m,model);\n                    Renderer.add(m);\n                }\n            }\n        }\n        \n        /**\n         * 处理watcher\n         * @param module -  模块\n         * @param model -   模型\n         */  \n        function handleWatcher(module,model){\n            const map = module.modelManager.watchMap;\n            const watcher = map.get(model);\n            //当前model存在watcher\n            if(watcher && watcher[key]){\n                //查找对应key是否存在watch\n                watcher[key].f.call(module,model,key,oldValue,newValue);\n            }else if(module.modelManager.hasDeepWatch){   //进行deep查找\n                for(let m = model;m && m.__parent;m=m.__parent){\n                    //如果已经跨模块，则表示为父传子，父模块指向当前模块\n                    const pm = m.__parent.__module === module?m.__parent:module.model;\n                    if(!map.has(pm)){\n                        continue;\n                    }\n                    const watcher = map.get(pm);\n                    const name = module.modelManager.getModelName(m)||m.__name;\n                    if(watcher && watcher[name]){\n                        const cfg = watcher[name];\n                        // 当前model或父model deep watch\n                        if(cfg.deep){\n                            cfg.f.call(module,model,key,oldValue,newValue);\n                            //找到即跳出循环\n                            break;\n                        }\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * 监听数据项\n     * \n     * @param model -   被监听model\n     * @param key -     监听数据项名\n     * @param operate - 数据项变化时执行方法\n     * @param deep -    是否深度观察，如果是深度观察，则子对象更改，也会触发观察事件\n     * \n     * @returns         unwatch函数，执行此函数，可取消监听\n     */\n    public watch(model:Model,key: string|string[], operate: (m,k,ov,nv)=>void,deep?:boolean):()=>void {\n        if(!operate || typeof operate !== 'function'){\n            return;\n        }\n        const me = this;\n        //设置深度watch标志\n        this.hasDeepWatch = deep;\n        //撤销watch数组，数据项为{m:model,k:监听属性,f:触发方法}\n        let arr = [];\n        if(Array.isArray(key)){\n            for(const k of key){\n                watchOne(model,k,operate);\n            }\n        }else{\n            watchOne(model,key,operate);\n        }\n\n        //返回取消watch函数\n        return ()=>{\n            //避免二次取消\n            if(!Array.isArray(arr)){\n                return;\n            }\n            for(const f of arr){\n                const obj = me.watchMap.get(f.m);\n                if(!obj){\n                    continue;\n                }\n                delete obj[f.k];\n                //已经无监听从watchMap移除\n                if(Object.keys(obj).length === 0){\n                    me.watchMap.delete(f.m);\n                }\n            }\n            //释放arr\n            arr = null;\n        }\n        \n        /**\n         * 监听一个\n         * @param model -     当前model  \n         * @param key -       监听属性，可以支持多级属性，如果为多级属性，倒数第二级对应数据项必须为对象\n         * @param operate -   操作方法\n         */\n        function watchOne(model:Model,key:string,operate:(m,k,ov,nv)=>void){\n            if (!model || typeof model !== 'object') {\n                return;\n            }\n            let index;\n            //如果带'.'，则只取最里面那个对象\n            if ((index = key.lastIndexOf('.')) !== -1) {\n                model = me.get(model,key.substring(0, index));\n                key = key.substring(index + 1);\n                if (!model || typeof model !== 'object') {\n                    return;\n                }\n            }\n            \n            if(!me.watchMap.has(model)){\n                me.watchMap.set(model,{});\n            }\n            const obj= me.watchMap.get(model);\n            obj[key] = {f:operate,deep:deep};\n            //保存用于撤销watch\n            arr.push({m:model,k:key});\n        }\n    }\n\n    \n    /**\n     * 获取model属性值\n     * @param key -     属性名，可以分级，如 name.firstName\n     * @param model -   模型\n     * @returns         属性值\n     */\n    public get(model:Model, key?: string):unknown {\n        if(key){\n            if (key.indexOf('.') !== -1) {    //层级字段\n                const arr = key.split('.');\n                for (let i = 0; i < arr.length - 1; i++) {\n                    model = model[arr[i]];\n                    if (!model) {\n                        break;\n                    }\n                }\n                if (!model) {\n                    return;\n                }\n                key = arr[arr.length - 1];\n            }\n            model = model[key];\n        }\n        return model;\n    }\n\n    /**\n     * 设置model属性值\n     * @param model -   模型\n     * @param key -     属性名，可以分级，如 name.firstName\n     * @param value -   属性值\n     */\n    public set(model:Model,key:string,value:unknown){\n        if (key.indexOf('.') !== -1) {    //层级字段\n            const arr = key.split('.');\n            for (let i = 0; i < arr.length - 1; i++) {\n                //不存在，则创建新的model\n                if (!model[arr[i]]) {\n                    model[arr[i]] = {};\n                }\n                model = model[arr[i]];\n            }\n            key = arr[arr.length - 1];\n        }\n        model[key] = value;\n    }\n}","import { NCache } from \"./cache\";\nimport { Module } from \"./module\";\n\n/**\n * 对象管理器\n * @remarks\n * 用于存储模块的内存变量，`$`开始的数据项可能被nodom占用，使用时禁止使用。\n * \n * 默认属性集\n * \n *  $events     事件集\n * \n *  $domparam   dom参数\n */\nexport  class ObjectManager {\n    /**\n     * NCache对象\n     */\n    public cache:NCache;\n\n    /**\n     * 所属模块\n     */\n    public module:Module;\n\n    /**\n     * module   模块\n     * @param module - 模块\n     */\n    constructor(module:Module){\n        this.module = module;\n        this.cache = new NCache();\n    }\n\n    /**\n     * 保存到cache\n     * @param key -     键，支持\".\"（多级数据分割）\n     * @param value -   值\n     */\n     public set(key:string,value:unknown){\n        this.cache.set(key+'',value);\n    }\n\n    /**\n     * 从cache读取\n     * @param key - 键，支持多级数据，如\"x.y.z\"\n     * @returns     缓存的值或undefined\n     */\n    public get(key:string){\n        return this.cache.get(key);\n    }\n\n    /**\n     * 从cache移除\n     * @param key -   键，支持\".\"（多级数据分割）\n     */\n    public remove(key:string){\n        this.cache.remove(key);\n    }\n\n    /**\n     * 设置事件参数\n     * @param id -      事件id\n     * @param key -     dom key\n     * @param name -    参数名  \n     * @param value -   参数值\n     */\n    public setEventParam(id:number,key:number|string,name:string,value:unknown){\n        this.cache.set('$events.' + id + '.$params.' + key + '.' + name,value);\n    }\n\n    /**\n     * 获取事件参数值\n     * @param id -      事件id\n     * @param key -     dom key \n     * @param name -    参数名\n     * @returns         参数值\n     */\n    public getEventParam(id:number,key:number|string,name:string){\n        return this.get('$events.' + id + '.$params.' + key + '.' + name);\n    }\n\n    /**\n     * 移除事件参数\n     * @param id -      事件id\n     * @param key -     dom key\n     * @param name -    参数名\n     */\n    public removeEventParam(id:number,key:number|string,name:string){\n        this.remove('$events.' + id + '.$params.' + key + '.' + name);\n    }\n\n    /**\n     * 清空事件参数\n     * @param id -      事件id\n     * @param key -     dom key \n     */\n    public clearEventParams(id:number,key?:number|string){\n        if(key){    //删除对应dom的事件参数\n            this.remove('$events.' + id + '.$params.' + key);    \n        }else{      //删除所有事件参数\n            this.remove('$events.' + id + '.$params');\n        }\n    }\n\n    /**\n     * 设置dom参数值\n     * @param key -     dom key \n     * @param name -    参数名\n     * @param value -   参数值\n     */\n    public setDomParam(key:number|string,name:string,value:unknown){\n        this.set('$domparam.' + key + '.' + name ,value);\n    }\n\n    /**\n     * 获取dom参数值\n     * @param key -     dom key\n     * @param name -    参数名\n     * @returns         参数值\n     */\n    public getDomParam(key:number|string,name:string):unknown{\n        return this.get('$domparam.' + key + '.' + name);\n    }\n\n    /**\n     * 移除dom参数值\n     * @param key -     dom key\n     * @param name -    参数名\n     */\n    public removeDomParam(key:number|string,name:string){\n        this.remove('$domparam.' + key + '.' + name);\n    }\n\n    /**\n     * 清除element 参数集\n     * @param key -     dom key\n     */\n    public clearDomParams(key:number|string){\n        this.remove('$domparam.' + key);\n    }\n    \n    /**\n     * 清除缓存dom对象集\n     */\n    public clearAllDomParams(){\n        this.remove('$domparam');\n    }\n}\n","import { Module } from \"./module\";\nimport { ModuleFactory } from \"./modulefactory\";\nimport { RenderedDom } from \"./types\";\nimport { VirtualDom } from \"./virtualdom\";\n\n/**\n * dom管理器\n * @remarks\n * 用于管理module的虚拟dom树，渲染树，html节点\n */\nexport class DomManager{\n    /**\n     * 所属模块\n     */\n    private module:Module;\n\n    /**\n     * 编译后的虚拟dom树\n     */\n    public vdomTree:VirtualDom;\n\n    /**\n     * 渲染后的dom树\n     */\n    public renderedTree:RenderedDom;\n\n    /**\n     * html节点map\n     * @remarks\n     * 用于存放dom key对应的html节点 \n     */\n    private elementMap:Map<number|string,Node> = new Map();\n\n    /**\n     * 构造方法\n     * @param module -  所属模块\n     */\n    constructor(module:Module){\n        this.module = module;\n    }\n    /**\n     * 从virtual dom 树获取虚拟dom节点\n     * @param key - dom key 或 props键值对\n     * @returns     编译后虚拟节点 \n     */\n    public getVirtualDom(key:string|number|object):VirtualDom{\n        if(!this.vdomTree){\n            return null;\n        }\n        return find(this.vdomTree);\n        function find(dom:VirtualDom){\n            //对象表示未props查找\n            if(typeof key === 'object'){\n                if(!Object.keys(key).find(k=>key[k] !== dom.props.get(k))){\n                    return dom;\n                }\n            }else if(dom.key === key){ //key查找\n                return dom;\n            }\n            if(dom.children){\n                for(const d of dom.children){\n                    const d1 = find(d);\n                    if(d1){\n                        return d1;\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * 从渲染树获取key对应的渲染节点\n     * @param key - dom key 或 props键值对\n     * @returns     渲染后虚拟节点\n     */\n    public getRenderedDom(key:object|string|number):RenderedDom{\n        if(!this.renderedTree){\n            return;\n        }\n        return find(this.renderedTree,key);\n        /**\n         * 递归查找\n         * @param dom - 渲染dom  \n         * @param key -   待查找key\n         * @returns     key对应renderdom 或 undefined\n         */\n        function find(dom:RenderedDom,key:object|string|number):RenderedDom{\n            //对象表示未props查找\n            if(typeof key === 'object'){\n                if(dom.props && !Object.keys(key).find(k=>key[k] !== dom.props[k])){\n                    return dom;\n                }\n            }else if(dom.key === key){ //key查找\n                return dom;\n            }\n            if(dom.children){\n                for(const d of dom.children){\n                    if(!d){\n                        continue;\n                    }\n                    const d1 = find(d,key);\n                    if(d1){\n                        return d1;\n                    }\n                }\n            }\n        }\n    }\n\n    /**\n     * 清除html element map 节点\n     * @param dom -   dom节点，如果为空，则清空map\n     */\n    public clearElementMap(dom?:RenderedDom){\n        if(dom){\n            this.elementMap.delete(dom.key);\n            //带自定义key的移除\n            if(dom.props && dom.props['key']){\n                this.elementMap.delete(dom.props['key']);\n            }\n        }else{\n            this.elementMap.clear();\n        }\n    }\n\n    /**\n     * 获取html节点\n     * @remarks\n     * 当key为数字或字符串时，表示dom key，当key为对象时，表示根据dom属性进行查找\n     * \n     * @param key - dom key 或 props键值对\n     * @returns     html节点\n     */\n    public getElement(key:number|string|object):Node{\n        if(typeof key === 'object'){\n            const dom = this.getRenderedDom(key);\n            if(dom){\n                key = dom.key;\n            }else{\n                return;\n            }\n        }\n        return this.elementMap.get(<string|number>key);\n    }\n\n    /**\n     * 保存html节点\n     * @param key -   dom key\n     * @param node -  html node\n     */\n    public saveElement(key:number|string,node:Node){\n        this.elementMap.set(key,node);\n    }\n\n    /**\n     * 释放节点\n     * @remarks\n     * 释放操作包括：如果被释放节点包含子模块，则子模块需要unmount；释放对应节点资源\n     * @param dom - 虚拟dom\n     */\n    public freeNode(dom:RenderedDom){\n        if(dom.moduleId){  //子模块\n            const m = ModuleFactory.get(dom.moduleId);\n            if(m){\n                m.unmount();\n            }\n        }else{      //普通节点\n            const el = this.module.getElement(dom.key);\n            //从map移除\n            this.clearElementMap(dom);\n            //解绑所有事件\n            this.module.eventFactory.unbindAll(dom.key);\n            //子节点递归操作\n            if(dom.children){\n                for(const d of dom.children){\n                    this.freeNode(d);\n                }\n            }\n            //从html移除\n            if(el && el.parentElement){\n                el.parentElement.removeChild(el);\n            }\n        }\n    }\n\n    /**\n     * 重置节点相关信息\n     */\n    public reset(){\n        this.renderedTree = null;\n        this.elementMap.clear();\n    }\n}","import { Compiler } from \"./compiler\";\nimport { CssManager } from \"./cssmanager\";\nimport { Model } from \"./model\";\nimport { ModuleFactory } from \"./modulefactory\";\nimport { ObjectManager } from \"./objectmanager\";\nimport { Renderer } from \"./renderer\";\nimport { Util } from \"./util\";\nimport { DiffTool } from \"./difftool\";\nimport { EModuleState, RenderedDom, UnknownMethod } from \"./types\";\nimport { EventFactory } from \"./eventfactory\";\nimport { DomManager } from \"./dommanager\";\nimport { ModelManager } from \"./modelmanager\";\nimport { NEvent } from \"./event\";\nimport { Expression } from \"./expression\";\nimport { VirtualDom } from \"./virtualdom\";\n\n/**\n * 模块类\n * \n * @remarks\n * 模块方法说明：模板内使用的方法，包括事件方法，都在模块内定义\n *\n *  方法this：指向module实例\n * \n *  事件参数: model(当前按钮对应model),dom(事件对应虚拟dom),eventObj(事件对象),e(实际触发的html event)  \n * \n *  表达式方法：参数按照表达式方式给定即可，如：\n * ```html\n *  <div>\n *      <div class={{getCls(st)}} e-click='click'>Hello Nodom</div>\n *  </div>\n * ```\n * ```js\n *  //事件方法\n *  click(model,dom,eventObj,e){\n *      //do something\n *  }\n *  //表达式方法\n *  //state 由表达式中给定，state由表达式传递，为当前dom model的一个属性\n *  getCls(state){\n *      //do something\n *  } \n * ```\n * \n * 模块事件，在模块不同阶段执行\n * \n * onInit              初始化后（constructor后，已经有model对象，但是尚未编译，只执行1次）\n * \n * onBeforeFirstRender 首次渲染前（只执行1次）\n * \n * onFirstRender       首次渲染后（只执行1次）\n * \n * onBeforeRender      渲染前\n * \n * onRender            渲染后\n * \n * onCompile           编译后\n * \n * onBeforeMount       挂载到document前\n * \n * onMount             挂载到document后\n * \n * onBeforeUnMount     从document脱离前\n * \n * onUnmount           从document脱离后\n * \n * onBeforeUpdate      更新到document前\n * \n * onUpdate            更新到document后\n */\nexport class Module {\n    /**\n     * 模块id(全局唯一)\n     */\n    public id: number;\n\n    /**\n     * 模型，代理过的data\n     */\n    public model:Model;\n\n    /**\n     * 子模块id数组\n     */\n    public children: Array<number> = [];\n\n    /**\n     * 模块状态\n     */\n    public state: EModuleState;\n\n    /**\n     * 模型管理器\n     */\n    public modelManager:ModelManager;\n    \n    /**\n     * 对象管理器，用于管理虚拟dom节点、指令、表达式、事件对象及其运行时参数\n     */\n    public objectManager:ObjectManager;\n\n    /**\n     * dom 管理器，管理虚拟dom、渲染dom和html node\n     */\n    public domManager:DomManager;\n\n    /**\n     * 事件工厂\n     */\n    public eventFactory:EventFactory;\n\n    /**\n     * 来源dom，子模块对应dom\n     */\n    public srcDom:RenderedDom;\n\n    /**\n     * 源节点传递的事件，需要追加到模块根节点上\n     */\n    public events:NEvent[];\n\n    /**\n     * 模板对应模块id，作为子模块时有效\n     */\n    public templateModuleId:number;\n\n    /**\n     * 父模块通过dom节点传递的属性\n     */\n    public props:object;\n\n    /**\n     * 子模块类集合，模板中引用的模块类需要声明\n     * 如果类已经通过registModule注册过，这里不再需要定义，只需import即可\n     */\n    public modules: unknown[];\n\n    /**\n     * 不渲染的属性（这些属性用于生产模板，不作为属性渲染到模块根节点）\n     */\n    private excludedProps:string[];\n\n    /**\n     * 父模块 id\n     */\n    private parentId: number;\n\n    /**\n     * 源element\n     */\n    public srcElement:Node;\n\n    /**\n     * 生成dom时的keyid，每次编译置0\n     */\n    private domKeyId:number;\n\n    /**\n     * 旧模板串\n     */\n    private oldTemplate:string;\n\n    \n    /**\n     * slot map\n     * \n     * key: slot name\n     * \n     * value: {type:0(外部渲染)/1(内部渲染innerrender),dom:渲染节点,vdom:虚拟节点,start:在父节点中的开始位置}\n     * \n     */\n    public slots:Map<string,{type?:number,dom?:RenderedDom,vdom?:VirtualDom,start?:number}> = new Map();\n\n    /**\n     * 构造器\n     */\n    constructor() {\n        this.id = Util.genId();\n        this.modelManager = new ModelManager(this);\n        this.domManager = new DomManager(this);\n        this.objectManager = new ObjectManager(this);\n        this.eventFactory = new EventFactory(this);\n        //加入模块工厂\n        ModuleFactory.add(this);\n    }\n\n    /**\n     * 初始化操作\n     */\n    public init(){\n        this.state = EModuleState.INIT;\n        //初始化model\n        this.model = new Model(this.data()||{} , this);\n        this.doModuleEvent('onInit');\n    }\n\n    /**\n     * 模板串方法，使用时需重载\n     * @param props -   props对象，在模板中进行配置，从父模块传入\n     * @returns         模板串\n     * @virtual\n     */\n    public template(props?:object):string{\n        return null;\n    }\n\n    /**\n     * 数据方法，使用时需重载\n     * @returns  数据对象\n     */\n    public data():object{\n        return {};\n    }\n    \n    /**\n     * 模型渲染\n     * @remarks\n     * 渲染流程：\n     * \n     * 1. 获取首次渲染标志\n     * \n     * 2. 执行template方法获得模板串\n     * \n     * 3. 与旧模板串比较，如果不同，则进行编译\n     * \n     * 4. 判断是否存在虚拟dom树（编译时可能导致模板串为空），没有则结束\n     * \n     * 5. 如果为首次渲染，执行onBeforeFirstRender事件 \n     * \n     * 6. 执行onBeforeRender事件\n     * \n     * 7. 保留旧渲染树，进行新渲染\n     * \n     * 8. 执行onRender事件\n     * \n     * 9. 如果为首次渲染，执行onFirstRender事件 \n     * \n     * 10. 渲染树为空，从document解除挂载\n     * \n     * 11. 如果未挂载，执行12，否则执行13\n     * \n     * 12. 执行挂载，结束\n     * \n     * 13. 新旧渲染树比较，比较结果为空，结束，否则执行14\n     * \n     * 14. 执行onBeforeUpdate事件\n     * \n     * 15. 更新到document\n     * \n     * 16. 执行onUpdate事件，结束\n     */\n    public render(): boolean {\n        //获取首次渲染标志\n        const firstRender = this.oldTemplate===undefined;\n        //检测模板并编译\n        const templateStr = this.template(this.props);\n        //与旧模板不一样，需要重新编译\n        if(templateStr !== this.oldTemplate){\n            this.oldTemplate = templateStr;\n            this.compile();\n        }\n        //不存在domManager.vdomTree，不渲染\n        if(!this.domManager.vdomTree){\n            return;\n        }\n        //首次渲染\n        if(firstRender){\n            this.doModuleEvent('onBeforeFirstRender');\n        }\n        //渲染前事件\n        this.doModuleEvent('onBeforeRender');\n        //保留旧树\n        const oldTree = this.domManager.renderedTree;\n        //渲染\n        this.domManager.renderedTree = Renderer.renderDom(this,this.domManager.vdomTree,this.model);\n        //每次渲染后事件\n        this.doModuleEvent('onRender');\n        //首次渲染\n        if(firstRender){\n            this.doModuleEvent('onFirstRender');    \n        }\n        //渲染树为空，从html卸载\n        if(!this.domManager.renderedTree){\n            this.unmount();\n            return;\n        }\n        //已经挂载\n        if(this.state === EModuleState.MOUNTED){\n            if(oldTree && this.model){\n                //新旧渲染树节点diff\n                const changeDoms = DiffTool.compare(this.domManager.renderedTree,oldTree);\n                //执行更改\n                if(changeDoms.length>0){\n                    //html节点更新前事件\n                    this.doModuleEvent('onBeforeUpdate');\n                    Renderer.handleChangedDoms(this,changeDoms);\n                    //html节点更新后事件\n                    this.doModuleEvent('onUpdate');\n                }\n            }\n        }else { //未挂载\n            this.mount();\n        }\n    }\n\n    /**\n     * 添加子模块\n     * @param module -    模块id或模块\n     */\n    public addChild(module: number|Module) {\n        if(typeof module === 'number'){\n            module = ModuleFactory.get(module);\n        }\n        if(module){\n            if (!this.children.includes(module.id)) {\n                this.children.push(module.id);\n                module.parentId = this.id;\n            }\n        }\n    }\n\n    /**\n     * 移除子模块\n     * @param module -    子模块\n     */\n    public removeChild(module: Module) {\n        const ind=this.children.indexOf(module.id);\n        if (ind !== -1) {\n            module.unmount();\n            this.children.splice(ind,1);\n        }\n    }\n\n    /**\n     * 激活模块(准备渲染)\n     */\n    public active() {\n        //如果为unmounted，则设置为准备好状态\n        if(this.state === EModuleState.UNMOUNTED || this.state === EModuleState.INIT){\n            this.state = EModuleState.READY;\n        }\n        Renderer.add(this);\n    }\n\n    /**\n     * 挂载到document\n     */\n    public mount(){\n        //执行挂载前事件\n        this.doModuleEvent('onBeforeMount');\n        //渲染到fragment\n        const rootEl = new DocumentFragment();\n        const el = Renderer.renderToHtml(this,this.domManager.renderedTree,rootEl,true);\n        //主模块，直接添加到根模块\n        if(this === ModuleFactory.getMain()){\n            Renderer.getRootEl().appendChild(el);\n        }else if(this.srcDom){ //挂载到父模块中\n            const pm = this.getParent();\n            this.srcElement = pm.getElement(this.srcDom.key);\n            if(this.srcElement && this.srcElement.parentElement){\n                this.srcElement.parentElement.replaceChild(el,this.srcElement);\n                pm.saveElement(this.srcDom.key,el);\n            }\n        }\n        //执行挂载后事件\n        this.doModuleEvent('onMount');\n        this.state = EModuleState.MOUNTED;\n    }\n\n    /**\n     * 从document移除\n     */\n    public unmount(){\n        // 主模块或状态为unmounted的模块不用处理\n        if (this.state === EModuleState.UNMOUNTED || ModuleFactory.getMain() === this) {\n            return;\n        }\n        //从render列表移除\n        Renderer.remove(this);\n        //清空event factory\n        this.eventFactory.clear();\n        //执行卸载前事件\n        this.doModuleEvent('onBeforeUnMount');\n        //module根与源el切换\n        const el = this.getElement(1);\n        if (el) {\n            if (this.srcDom) {\n                const pm = this.getParent();\n                if(el.parentElement){\n                    el.parentElement.replaceChild(this.srcElement,el);\n                    pm.saveElement(this.srcDom.key,this.srcElement);\n                }\n            }\n        }\n        this.domManager.reset();\n        //设置状态\n        this.state = EModuleState.UNMOUNTED;\n        //子模块递归卸载\n        if (this.children) {\n            for (const id of this.children) {\n                const m = ModuleFactory.get(id);\n                if (m) {\n                    m.unmount();\n                }\n            }\n        }\n        //执行卸载后事件\n        this.doModuleEvent('onUnMount');\n    }\n    \n    /**\n     * 获取父模块\n     * @returns     父模块   \n     */\n    public getParent(): Module {\n        if (this.parentId) {\n            return ModuleFactory.get(this.parentId);\n        }\n    }\n\n    /**\n     * 执行模块事件\n     * @param eventName -   事件名\n     * @returns             执行结果\n     */\n    public doModuleEvent(eventName: string):boolean{\n        const foo = this[eventName];\n        if(foo && typeof foo==='function'){\n            return foo.apply(this,[this.model]);\n        }\n    }\n\n    /**\n     * 获取模块方法\n     * @param name -    方法名\n     * @returns         方法\n     */\n    public getMethod(name: string): UnknownMethod {\n        return this[name];\n    }\n\n    /**\n     * 设置props\n     * @param props -   属性值\n     * @param dom -     子模块对应渲染后节点\n     */\n    public setProps(props:object,dom:RenderedDom){\n        const dataObj = props['$data'];\n        delete props['$data'];\n        //props数据复制到模块model\n        if(dataObj){\n            for(const d of Object.keys(dataObj)){\n                this.model[d] = dataObj[d];\n            }\n        }\n        \n        //保留src dom\n        this.srcDom = dom;\n        //如果不存在旧的props，则change为true，否则初始化为false\n        let change:boolean = false;\n        if(!this.props){\n            change = true;\n        }else{\n            for(const k of Object.keys(props)){\n                // object 默认改变\n                if(props[k] !== this.props[k]){\n                    change = true;\n                }\n            }\n        }\n        //保存事件数组\n        this.events = dom.vdom.events;\n        //props发生改变或unmounted，激活模块\n        //如果属于slot，则由所属slot触发渲染\n        if((change || this.state === EModuleState.UNMOUNTED) && !dom.rmid){\n            this.active();\n        }\n        //保存props\n        this.props = props;\n    }\n\n    /**\n     * 编译\n     */\n    public compile(){\n        //注册子模块\n        if(this.modules && Array.isArray(this.modules)){\n            for (const cls of this.modules) {\n                ModuleFactory.addClass(cls);\n            }\n            delete this.modules;\n        }\n        if(!this.oldTemplate){\n            return;\n        }\n        //重置初始domkey\n        this.domKeyId = 0;\n        //清空孩子节点\n        this.children = [];\n        //清理css url\n        CssManager.clearModuleRules(this);\n        //清除dom参数\n        this.objectManager.clearAllDomParams();\n        //编译\n        this.domManager.vdomTree = new Compiler(this).compile(this.oldTemplate);\n        if(!this.domManager.vdomTree){\n            return;\n        }\n        \n        //添加从源dom传递的事件\n        if(this.events){\n            for(const ev of this.events){\n                this.domManager.vdomTree.addEvent(ev);\n            }\n        }\n        //增加编译后事件\n        this.doModuleEvent('onCompile');\n    }\n\n    /**\n     * 设置不渲染到根dom的属性集合\n     * @param props -   待移除的属性名属组\n     */\n    public setExcludeProps(props:string[]){\n        this.excludedProps = props;\n    }\n\n    /**\n     * 处理根节点属性\n     * @param src -     编译节点\n     * @param dst -     dom节点\n     */\n    public handleRootProps(src,dst){\n        //已合并属性集合\n        const added = {};\n        if(src.props && src.props.size>0){\n            for(const k of src.props){\n                let value;\n                if(this.excludedProps && this.excludedProps.includes(k[0])){\n                    continue;\n                }\n                if(k[1] instanceof Expression){\n                    value = k[1].val(this,dst.model);\n                }else{\n                    value = k[1];\n                }\n                // 合并属性\n                if(this.props && this.props.hasOwnProperty(k[0])){\n                    let v = this.props[k[0]];\n                    if(v){\n                        if('style' === k[0]){\n                            v = v.trim();\n                            if(!value){\n                                value = v;\n                            }else{\n                                value = (value + ';' + v).replace(/;{2,}/g,';');\n                            }\n                        }else if('class' === k[0]){\n                            v = v.trim();\n                            if(!value){\n                                value = v;\n                            }else{\n                                value += ' ' + v;\n                            }\n                        }else{\n                            value = v;\n                        }\n                    }\n                    // 设置已处理标志\n                    added[k[0]] = true;\n                }\n                dst.props[k[0]] = value;\n            }\n        }\n        if(this.props){\n            //处理未添加的属性\n            for(const p of Object.keys(this.props)){\n                if(added[p] || this.excludedProps && this.excludedProps.includes(p)){\n                    continue;\n                }\n                dst.props[p] = this.props[p];\n            }\n        }\n    }\n\n    /**\n     * 获取html节点\n     * @remarks\n     * 当key为数字或字符串时，表示dom key，当key为对象时，表示根据dom属性进行查找\n     * \n     * @param key - dom key 或 props键值对\n     * @returns     html节点\n     */\n    public getElement(key:object|string|number):Node{\n        return this.domManager.getElement(key);\n    }\n\n    /**\n     * 保存html节点\n     * @param key -   dom key\n     * @param node -  html节点\n     */\n    public saveElement(key:number|string,node:Node){\n        this.domManager.saveElement(key,node);\n    }\n\n    /**\n     * 按模块类名获取子模块\n     * @remarks\n     * 找到第一个满足条件的子模块，如果deep=true，则深度优先\n     * \n     * 如果attrs不为空，则同时需要匹配子模块属性\n     * \n     * @example\n     * ```html\n     *  <div>\n     *      <Module1 />\n     *      //other code\n     *      <Module1 v1='a' v2='b' />\n     *  </div>\n     * ```\n     * ```js\n     *  const m = getModule('Module1',true, {v1:'a'});\n     *  //m 为模板中的第二个Module1\n     * ```\n     * @param name -    子模块类名或别名\n     * @param deep -    是否深度获取\n     * @param attrs -   属性集合\n     * \n     * @returns         符合条件的子模块或undefined\n     */\n    public getModule(name:string,deep?:boolean,attrs?:object):Module{\n        if(!this.children){\n            return;\n        }\n        const cls = ModuleFactory.getClass(name);\n        if(!cls){\n            return;\n        }\n        return find(this);\n        /**\n         * 查询\n         * @param mdl -   模块\n         * @returns     符合条件的子模块\n         */\n        function find(mdl){\n            for(const id of mdl.children){\n                const m:Module = ModuleFactory.get(id);\n                if(m){\n                    if(m.constructor === cls){\n                        if(attrs){  //属性集合不为空\n                            //全匹配标识\n                            let matched:boolean = true;\n                            for(const k of Object.keys(attrs)){\n                                if(!m.props || m.props[k] !== attrs[k]){\n                                    matched = false;\n                                    break;\n                                }\n                            }\n                            if(matched){\n                                return m;\n                            }\n                        }else{\n                            return m;\n                        }\n                    }\n                    //递归查找\n                    if(deep){\n                        const r = find(m);\n                        if(r){\n                            return r;\n                        }\n                    }\n                }\n            }\n        }\n        \n    }\n\n    /**\n     * 获取模块类名对应的所有子模块\n     * @param className -   子模块类名\n     * @param deep -        深度查询\n     */\n     public getModules(className:string,deep?:boolean):Module[]{\n        if(!this.children){\n            return;\n        }\n        const arr = [];\n        find(this);\n        return arr;\n\n        /**\n         * 查询\n         * @param module - \n         */\n        function find(module:Module){\n            if(!module.children){\n                return;\n            }\n            for(const id of module.children){\n                const m:Module = ModuleFactory.get(id);\n                if(m && m.constructor){\n                    if(m.constructor.name === className){\n                        arr.push(m);\n                    }\n                    if(deep){\n                        find(m);\n                    }\n                }\n            }   \n        }\n    }\n\n    /**\n     * 监听model\n     * @remarks\n     * 参数个数可变，如果第一个参数为属性名，则第二个参数为钩子函数，第三个参数为deep，默认model为根模型\n     * \n     * 否则按照参数说明\n     * @param model -     模型或属性\n     * @param key -       属性/属性数组，支持多级属性\n     * @param operate -   钩子函数\n     * @param deep -      是否深度监听\n     * @returns           回收监听器函数，执行后取消监听\n     */\n    public watch(model:Model|string|string[],key:string|string[]|((m,k,ov,nv)=>void),operate?:boolean| ((m,k,ov,nv)=>void),deep?:boolean){\n        //是model才能watch，否则watch根model\n        if (model['__key']) {\n            return this.modelManager.watch(model,<string>key,<()=>void>operate,deep);\n        }else{\n            return this.modelManager.watch(this.model,<string>model,<()=>void>key,<boolean>operate);\n        }\n    }\n\n    /**\n     * 设置模型属性值\n     * @remarks\n     * 参数个数可变，如果第一个参数为属性名，则第二个参数为属性值，默认model为根模型，否则按照参数说明\n     * \n     * @param model -     模型\n     * @param key -       子属性，可以分级，如 name.firstName\n     * @param value -     属性值\n     */\n    public set(model:Model|string,key:unknown,value?:unknown){\n        if (typeof key === 'string') {\n            this.modelManager.set(model,<string>key,value);\n        }else{\n            this.modelManager.set(this.model,<string>model,key);\n        }\n    }\n\n    /**\n     * 获取模型属性值\n     * @remarks\n     * 参数个数可变，如果第一个参数为属性名，默认model为根模型，否则按照参数说明\n     * \n     * @param model -   模型\n     * @param key -     属性名，可以分级，如 name.firstName，如果为null，则返回自己\n     * @returns         属性值\n     */\n    public get(model:Model|string, key?:string):unknown {\n        if (typeof key === 'string') {\n            return this.modelManager.get(model,key);\n        }else{\n            return this.modelManager.get(this.model,<string>model);\n        }\n    }\n\n    /**\n     * 调用模块内方法\n     * @remarks\n     * 参数个数可变，参数个数最多10个\n     * \n     * @param methodName -  方法名\n     * @param args -        参数\n     */\n    public invokeMethod(methodName:string,...args){\n        if(typeof this[methodName] === 'function'){\n            return this[methodName](...args);\n        }\n    }\n\n    /**\n     * 调用模块外方法\n     * @remarks\n     * 当该模块作为子模块使用时，调用方法属于使用此模块的模板对应的模块\n     * \n     * 对于下面的例子，模块`Module1`需要调用模块`Main`的`outerFoo方法`，则采用`invokeOuterMethod`进行调用。\n     * @example\n     * ```js\n     *  //Module1\n     *  class Module1 extends Module{\n     *      //your code\n     *  }\n     * \n     *  //Main\n     *  class Main extends Module{\n     *      modules=[Module1];\n     *      template(){\n     *          return `\n     *              <div>\n     *                  <Module1 />\n     *              </div>\n     *          `\n     *      }\n     *      outerFoo(){\n     * \n     *      }    \n     *  }\n     *  \n     * ```\n     * @param methodName -  方法名\n     * @param args -        参数\n     * @returns             方法返回值\n     */\n    public invokeOuterMethod(methodName:string,...args):unknown{\n        if(!this.templateModuleId){\n            return;\n        }\n        const m = ModuleFactory.get(this.templateModuleId);\n        if(!m){\n            return;\n        }\n        return m.invokeMethod(methodName,...args);\n    }\n    \n    /**\n     * 获取模块当前dom key编号\n     * @remarks\n     * 主要在手动增加节点时需要，避免key重复\n     * @returns   key编号\n     */\n    public getDomKeyId():number{\n        return ++this.domKeyId;\n    }\n}","import { Model } from \"./model\";\nimport { Module } from \"./module\";\nimport { ModuleFactory } from \"./modulefactory\";\nimport { Route } from \"./route\";\nimport { Util } from \"./util\";\n\n/**\n * 路由管理类\n */\nexport class Router {\n    /**\n     * 根路由\n     */\n    private root:Route = new Route();\n\n    /**\n     * 基础路径，实际显示路径为 basePath+routePath\n     */\n    private basePath:string;\n    \n    /**\n     * 当前路径\n     */\n    public currentPath: string;\n\n    /**\n     * path等待链表\n     */\n    private waitList: Array<string> = [];\n\n    /**\n     * 默认路由进入事件方法\n     */\n    private onDefaultEnter: (module,path)=>void;\n    /**\n     * 默认路由离开事件\n     */\n    private onDefaultLeave: (module,path)=>void;\n\n    /**\n     * 启动方式 0:直接启动 1:popstate 启动\n     */\n    private startType: number;\n\n\n    /**\n     * 激活Dom map\n     * key: path\n     * value: object，格式为：\n     * ```js\n     *  {\n     *      moduleId:dom所属模板模块id，\n     *      model:对应model,\n     *      field:激活字段名\n     *  }\n     * ```\n     */\n    private activeModelMap: Map<string, object> = new Map();\n\n    /**\n     * 绑定到module的router指令对应的key，即router容器对应的key，格式为:\n     * ```js\n     *  {\n     *      moduleId:{\n     *          mid:router所在模块id,\n     *          key:routerKey(路由key),\n     *          paths:active路径数组\n     *          wait:{mid:待渲染的模块id,path:route.path}\n     *      }\n     *      ,...\n     *  }\n     * ```\n     *  moduleId: router所属模块id（如果为slot且slot不是innerRender，则为模板对应模块id，否则为当前模块id）\n     */\n    private routerMap: Map<number, object> = new Map();\n    \n    /**\n     * 构造器\n     * @param basePath -          路由基础路径，显示的完整路径为 basePath + route.path\n     * @param defaultEnter -      默认进入时事件函数，传递参数： module,离开前路径\n     * @param defaultLeave -      默认离开时事件函数，传递参数： module,进入时路径\n     */\n    constructor(basePath?:string,defaultEnter?:(module,path)=>void,defaultLeave?:(module,path)=>void){\n        this.basePath = basePath;\n        this.onDefaultEnter = defaultEnter;\n        this.onDefaultLeave = defaultLeave;\n        //添加popstate事件\n        window.addEventListener('popstate', ()=>{\n            //根据state切换module\n            const state = history.state;\n            if (!state) {\n                return;\n            }\n            this.startType = 1;\n            this.go(state.url);\n        });\n    }\n\n    /**\n     * 跳转\n     * @remarks\n     * 只是添加到跳转列表，并不会立即进行跳转\n     * \n     * @param path -    路径 \n     * @param type -    启动路由类型，参考startType，默认0\n     */\n    public go(path: string) {\n        // 当前路径的父路径不处理\n        if (this.currentPath && this.currentPath.startsWith(path)) {\n            return;\n        }\n        //添加路径到等待列表，已存在，不加入\n        if (this.waitList.indexOf(path) === -1) {\n            this.waitList.push(path);\n        }\n        //延迟加载，避免同一个路径多次加入\n        setTimeout(() => {\n            this.load();\n        }, 0);\n    }\n\n    /**\n     * 启动加载\n     */\n    private load() {\n        //在加载，或无等待列表，则返回\n        if (this.waitList.length === 0) {\n            return;\n        }\n        //从等待队列拿路径加载\n        this.start(this.waitList.shift()).then(() => {\n            //继续加载\n            this.load();\n        });\n    }\n\n    /**\n     * 切换路由\n     * @param path - \t路径\n     */\n    private async start(path: string) {\n        // 当前路径的父路径不处理\n        if (this.currentPath && this.currentPath.startsWith(path)) {\n            return;\n        }\n        const diff = this.compare(this.currentPath, path);\n        // 不存在上一级模块,则为主模块，否则为上一级模块\n        let parentModule: Module = diff[0] === null?ModuleFactory.getMain():await this.getModule(diff[0]);\n        //onleave事件，从末往前执行\n        for (let i = diff[1].length - 1; i >= 0; i--) {\n            const r = diff[1][i];\n            if (!r.module) {\n                continue;\n            }\n            const module: Module = await this.getModule(r);\n            if (Util.isFunction(this.onDefaultLeave)) {\n                this.onDefaultLeave(module,this.currentPath);\n            }\n            if (Util.isFunction(r.onLeave)) {\n                r.onLeave(module,this.currentPath);\n            }\n            //从父模块移除\n            const pm = module.getParent();\n            if(pm){\n                pm.removeChild(module);\n            }\n            // 取消挂载\n            module.unmount();\n        }\n        if (diff[2].length === 0) { //路由相同，参数不同\n            const route: Route = diff[0];\n            if (route !== null) {\n                const module: Module = await this.getModule(route);\n                // 模块处理\n                this.dependHandle(module, route, diff[3] ? <Module>diff[3].module : null);\n            }\n        } else { //路由不同\n            //加载模块\n            for (let ii = 0; ii < diff[2].length; ii++) {\n                const route: Route = diff[2][ii];\n                //路由不存在或路由没有模块（空路由）\n                if (!route || !route.module) {\n                    continue;\n                }\n                const module: Module = await this.getModule(route);\n                // 模块处理\n                this.dependHandle(module, route, parentModule);\n                //默认全局路由enter事件\n                if (Util.isFunction(this.onDefaultEnter)) {\n                    this.onDefaultEnter(module,path);\n                }\n                //当前路由进入事件\n                if (Util.isFunction(route.onEnter)) {\n                    route.onEnter(module,path);\n                }\n                parentModule = module;\n            }\n        }\n        //如果是history popstate或新路径是当前路径的子路径，则不加入history\n        if (this.startType !== 1) {\n            const path1:string = (this.basePath||'') + path;\n            //子路由或父路由，替换state\n            if (path.startsWith(this.currentPath)) {\n                history.replaceState({url:path1}, '', path1);\n            } else { //路径push进history\n                history.pushState({url:path1}, '', path1);\n            }\n        }\n        //修改currentPath\n        this.currentPath = path;\n        //设置start类型为正常start\n        this.startType = 0;\n    }\n\n    /**\n     * 获取module\n     * @param route - 路由对象 \n     * @returns     路由对应模块\n     */\n    private async getModule(route: Route): Promise<Module> {\n        let module = route.module;\n        //已经是模块实例\n        if (typeof module === 'object') {\n            return module;\n        }\n        //模块路径\n        if(typeof module === 'string'){\n            module = await ModuleFactory.load(module);\n        }\n        //模块类\n        if (typeof module === 'function') {\n            route.module = ModuleFactory.get(module);\n        }\n        return <Module>route.module;\n    }\n    /**\n     * 比较两个路径对应的路由链\n     * @param path1 - \t第一个路径\n     * @param path2 - \t第二个路径\n     * @returns \t\t数组 [父路由或不同参数的路由，需要销毁的路由数组，需要增加的路由数组，不同参数路由的父路由]\n     */\n    private compare(path1: string, path2: string): [Route,Route[],Route[],Route] {\n        // 获取路由id数组\n        let arr1: Array<Route> = null;\n        let arr2: Array<Route> = null;\n        if (path1) {\n            //采用克隆方式复制，避免被第二个路径返回的路由覆盖参数\n            arr1 = this.getRouteList(path1, true);\n        }\n        if (path2) {\n            arr2 = this.getRouteList(path2);\n        }\n        let len = 0;\n        if (arr1 !== null) {\n            len = arr1.length;\n        }\n\n        if (arr2 !== null) {\n            if (arr2.length < len) {\n                len = arr2.length;\n            }\n        } else {\n            len = 0;\n        }\n        //需要销毁的旧路由数组\n        let retArr1 = [];\n        //需要加入的新路由数组\n        let retArr2 = [];\n        let i = 0;\n        for (i = 0; i < len; i++) {\n            //找到不同路由开始位置\n            if (arr1[i].id === arr2[i].id) {\n                //比较参数\n                if (JSON.stringify(arr1[i].data) !== JSON.stringify(arr2[i].data)) {\n                    i++;\n                    break;\n                }\n            } else {\n                break;\n            }\n        }\n        //旧路由改变数组\n        if (arr1 !== null) {\n            retArr1 = arr1.slice(i);\n        }\n        //新路由改变数组（相对于旧路由）\n        if (arr2 !== null) {\n            retArr2 = arr2.slice(i);\n        }\n        //上一级路由或参数不同的当前路由\n        let p1: Route = null;\n        //上二级路由或参数不同路由的上一级路由\n        let p2: Route = null;\n        if (arr2 && i > 0) {\n            // 可能存在空路由，需要向前遍历\n            for (let j = i - 1; j >= 0; j--) {\n                if (!p1) {\n                    if (arr2[j].module) {\n                        p1 = arr2[j];\n                        continue;\n                    }\n                } else if (!p2) {\n                    if (arr2[j].module) {\n                        p2 = arr2[j];\n                        break;\n                    }\n                }\n            }\n        }\n        return [p1, retArr1, retArr2, p2];\n    }\n\n    /**\n     * 添加激活对象\n     * @param moduleId -  模块id\n     * @param path -      路由路径\n     * @param model -     激活字段所在model\n     * @param field -     字段名\n     */\n    public addActiveModel(moduleId:number,path: string, model: Model, field: string) {\n        if (!model || !field) {\n            return;\n        }\n        //保存path对应active 模型信息\n        this.activeModelMap.set(path,{moduleId:moduleId,model:model,field:field});\n        //保存path到routerMap\n        if(this.routerMap.has(moduleId)){\n            const o = this.routerMap.get(moduleId)\n            if(!o['paths']){\n                o['paths'] = [path];\n            }else{\n                if(!o['paths'].includes(path)){\n                    o['paths'].push(path);\n                }\n            }\n        }else{\n            this.routerMap.set(moduleId,{paths:[path]});\n        }\n    }\n\n    /**\n     * 依赖模块相关处理\n     * @param module - \t模块\n     * @param pm -        依赖模块\n     * @param path - \t\tview对应的route路径\n     */\n    private dependHandle(module: Module, route: Route, pm: Module) {\n        //设置参数\n        const o = {\n            path: route.path\n        };\n        if (!Util.isEmpty(route.data)) {\n            o['data'] = route.data;\n        }\n        module.model['$route'] = o;\n        if(pm){\n            const mobj = this.routerMap.get(pm.id);\n            //尚未渲染，添加到等待渲染对象\n            if(!mobj){\n                this.routerMap.set(pm.id,{wait:{mid:module.id,path:route.path}});\n                // this.waitedRenderMap.set(pm.id,);\n            }else{\n                //得到router实际所在module\n                pm = ModuleFactory.get(mobj['mid']);\n                module.srcDom = mobj['dom'].children[0];\n\n                mobj['']\n                pm.addChild(module);\n                //激活\n                module.active();\n                this.setDomActive(route.fullPath);\n            }\n        }\n    }\n\n    /**\n     * 设置路由元素激活属性\n     * @param module -    模块 \n     * @param path -      路径\n     * @returns \n     */\n    private setDomActive(path: string) {\n        if(!this.activeModelMap.has(path)){\n            return;\n        }\n        const obj = this.activeModelMap.get(path);\n        if(!this.routerMap.has(obj['moduleId'])){\n            return;\n        }\n        //获取模块 active path数组\n        const arr = this.routerMap.get(obj['moduleId'])['paths'];\n        if(!arr){\n            return;\n        }\n        //当前路径对应model置true\n        obj['model'][obj['field']] = true;\n        //同模块下的其他路径对应model置false\n        for(const p of arr){\n            if(p !== path && this.activeModelMap.has(p)){\n                const o = this.activeModelMap.get(p);\n                o['model'][o['field']] = false;\n            }\n        }\n    }\n    \n    /**\n     * 获取路由数组\n     * @param path - \t要解析的路径\n     * @param clone - 是否clone，如果为false，则返回路由树的路由对象，否则返回克隆对象\n     * @returns     路由对象数组\n     */\n    private getRouteList(path: string, clone?: boolean): Array<Route> {\n        if (!this.root) {\n            return [];\n        }\n        const pathArr: string[] = path.split('/');\n        let node: Route = this.root;\n        let paramIndex: number = 0;      //参数索引\n        const retArr: Array<Route> = [];\n        let fullPath: string = '';       //完整路径\n        let preNode: Route = this.root;  //前一个节点\n        for (let i = 0; i < pathArr.length; i++) {\n            const v: string = pathArr[i].trim();\n            if (v === '') {\n                continue;\n            }\n            let find: boolean = false;\n            for (let j = 0; j < node.children.length; j++) {\n                if (node.children[j].path === v) {\n                    //设置完整路径\n                    if (preNode !== this.root) {\n                        preNode.fullPath = fullPath;\n                        preNode.data = node.data;\n                        retArr.push(preNode);\n                    }\n\n                    //设置新的查找节点\n                    node = clone ? node.children[j].clone() : node.children[j];\n                    //参数清空\n                    node.data = {};\n                    preNode = node;\n                    find = true;\n                    //参数索引置0\n                    paramIndex = 0;\n                    break;\n                }\n            }\n            //路径叠加\n            fullPath += '/' + v;\n            //不是孩子节点,作为参数\n            if (!find) {\n                if (paramIndex < node.params.length) { //超出参数长度的废弃\n                    node.data[node.params[paramIndex++]] = v;\n                }\n            }\n        }\n        //最后一个节点\n        if (node !== this.root) {\n            node.fullPath = fullPath;\n            retArr.push(node);\n        }\n        return retArr;\n    }\n\n    /**\n     * 获取根路由\n     * @returns     根路由对象\n     */\n    public getRoot():Route{\n        return this.root;\n    }\n\n    /**\n     * 注册路由容器\n     * @param moduleId -      模块id\n     * @param module -        路由实际所在模块（当使用slot时，与moduleId对应模块不同）\n     * @param key -           路由容器key\n     */\n    public registRouter(moduleId:number,module:Module,dom){\n        let obj;\n        if(!this.routerMap.has(moduleId)){\n            obj = {mid:module.id,dom:dom}\n            this.routerMap.set(moduleId,obj);\n        }else{\n            obj = this.routerMap.get(moduleId);\n            obj.mid = module.id;\n            obj.dom = dom;\n        }\n        \n        if(obj.wait){\n            const m = <Module>ModuleFactory.get(obj.wait.mid);\n            m.srcDom = dom.children[0];\n            module.addChild(m);\n            //激活\n            m.active();\n            //处理带active属性的dom\n            this.setDomActive(obj.path);\n            //执行后删除\n            delete obj.wait;\n        }\n    }\n\n    /**\n     * 尝试激活路径\n     * @param path -  待激活的路径\n     */\n    public activePath(path:string){\n        // 如果当前路径为空或待激活路径是当前路径的子路径\n        if(!this.currentPath || path.startsWith(this.currentPath)){\n            this.go(path);\n        }\n    }\n}\n","import { DefineElement } from \"../core/defineelement\";\nimport { DefineElementManager } from \"../core/defineelementmanager\";\nimport { NError } from \"../core/error\";\nimport { NodomMessage } from \"../core/nodom\";\nimport { VirtualDom } from \"../core/virtualdom\";\nimport { Directive } from \"../core/directive\";\nimport { Module } from \"../core/module\";\nimport { Expression } from \"../core/expression\";\n\n/**\n * module 元素\n * @remarks\n * module指令标签，用`<module name='class name' /> 代替 x-module='class name'`\n */\nclass MODULE extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        //类名\n        const clazz = <string>node.getProp('name');\n        if (!clazz) {\n            throw new NError('itemnotempty', NodomMessage.TipWords['element'],'MODULE', 'className');\n        }\n        node.delProp('name');\n        node.addDirective(new Directive('module',clazz,module.id));\n    }\n}\n\n/**\n * for 元素\n * @remarks\n * repeat指令标签，用`<for cond={{your expression}} /> 代替 x-repeat={{your expression}}`\n */\nclass FOR extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        //条件\n        const cond = <Expression>node.getProp('cond');\n        if (!cond) {\n            throw new NError('itemnotempty', NodomMessage.TipWords['element'], 'FOR', 'cond');\n        }\n        node.delProp('cond');\n        node.addDirective(new Directive('repeat',cond,module.id));\n    }\n}\n/**\n * 递归元素\n * @remarks\n * recur指令标签，用`<recur cond='recur field' /> 代替 x-recur='recur field'`\n */\nclass RECUR extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        //条件\n        const cond = <Expression>node.getProp('cond');\n        node.delProp('cond');\n        node.addDirective(new Directive('recur',cond,module.id));\n    }\n}\n\n/**\n * IF 元素\n * @remarks\n * if指令标签，用`<if cond={{your expression}} /> 代替 x-if={{your expression}}`\n */\nclass IF extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        //条件\n        const cond = <Expression>node.getProp('cond');\n        if (!cond) {\n            throw new NError('itemnotempty', NodomMessage.TipWords['element'], 'IF', 'cond');\n        }\n        node.delProp('cond');\n        node.addDirective(new Directive('if',cond,module.id));\n    }\n}\n\n/**\n * ELSE 元素\n * @remarks\n * else指令标签，用`<else/> 代替 x-else`\n */\nclass ELSE extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        node.addDirective(new Directive('else',null,module.id));\n    }\n}\n\n/**\n * ELSEIF 元素\n * @remarks\n * elseif指令标签，用`<elseif cond={{your expression}} /> 代替 x-elseif={{your expression}}`\n */\nclass ELSEIF extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        //条件\n        const cond = <Expression>node.getProp('cond');\n        if (!cond) {\n            throw new NError('itemnotempty',NodomMessage.TipWords['element'], 'ELSEIF', 'cond');\n        }\n        node.delProp('cond');\n        node.addDirective(new Directive('elseif',cond,module.id));\n    }\n}\n\n/**\n * ENDIF 元素\n * @remarks\n * endif指令标签，用`<endif /> 代替 x-endif`\n */\nclass ENDIF extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        node.addDirective(new Directive('endif',null,module.id));\n    }\n}\n\n/**\n * SHOW 元素\n * @remarks\n * show指令标签，用`<show cond={{your expression}} /> 代替 x-show={{your expression}}`\n */\nclass SHOW extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        //条件\n        const cond = <Expression>node.getProp('cond');\n        if (!cond) {\n            throw new NError('itemnotempty', NodomMessage.TipWords['element'], 'SHOW', 'cond');\n        }\n        node.delProp('cond');\n        node.addDirective(new Directive('show',cond,module.id));\n    }\n}\n\n/**\n * 插槽\n * @remarks\n * slot指令标签，用`<slot name='slotname' > 代替 x-slot='slotname'`\n */\nclass SLOT extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        //条件\n        const cond = node.getProp('name') || 'default';\n        node.delProp('name');\n        node.addDirective(new Directive('slot',<string>cond,module.id));\n    }\n}\n\n/**\n * 路由\n * @remarks\n * route指令标签，用`<route path='routepath' > 代替 x-route='routepath'`\n */\nclass ROUTE extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        //默认标签为a\n        if(!node.hasProp('tag')){\n            node.setProp('tag','a');\n        }\n        super(node,module);\n        //条件\n        const cond = node.getProp('path');\n        if (!cond) {\n            throw new NError('itemnotempty', NodomMessage.TipWords['element'], 'ROUTE', 'path');\n        }\n        node.addDirective(new Directive('route',<string>cond,module.id));\n    }\n}\n\n/**\n * 路由容器\n * @remarks\n * router指令标签，用`<router /> 代替 x-router`\n */\nclass ROUTER extends DefineElement{\n    constructor(node: VirtualDom,module:Module){\n        super(node,module);\n        node.addDirective(new Directive('router',null,module.id));\n    }\n}\n\n//添加到自定义元素管理器\nDefineElementManager.add([MODULE,FOR,RECUR,IF,ELSE,ELSEIF,ENDIF,SHOW,SLOT,ROUTE,ROUTER]);","import { NError } from \"../core/error\";\nimport { NEvent } from \"../core/event\";\nimport { GlobalCache } from \"../core/globalcache\";\nimport { Model } from \"../core/model\";\nimport { Module } from \"../core/module\";\nimport { ModuleFactory } from \"../core/modulefactory\";\nimport { Nodom, NodomMessage} from \"../core/nodom\";\nimport { Renderer } from \"../core/renderer\";\nimport { RenderedDom } from \"../core/types\";\nimport { Util } from \"../core/util\";\n\n/**\n     * 指令类型初始化\n     * @remarks\n     * 每个指令类型都有一个名字、处理函数和优先级，处理函数`不能用箭头函数`\n     * 处理函数在渲染时执行，包含两个参数 module(模块)、dom(目标虚拟dom)\n     * 处理函数的this指向指令对象\n     * 处理函数的返回值`true`表示继续，`false`表示后续指令不再执行，同时该节点不加入渲染树 \n     */\n(function () {\n    /**\n     * module 指令\n     * 用于指定该元素为模块容器，表示子模块\n     * 用法 x-module='模块类名'\n     */\n    Nodom.createDirective(\n        'module',\n        function (module: Module, dom: RenderedDom) {\n            let m: Module;\n            //存在moduleId，表示已经渲染过，不渲染\n            let mid = <number>module.objectManager.getDomParam(dom.key, 'moduleId');\n            if (mid) {\n                m = ModuleFactory.get(mid);\n            } else {\n                const cls = this.value;\n                m = ModuleFactory.get(cls);\n                if (!m) {\n                    return true;\n                }\n                m.templateModuleId = this.templateModuleId;\n                mid = m.id;\n                //保留modelId\n                module.objectManager.setDomParam(dom.key, 'moduleId', mid);\n                Renderer.getCurrentModule().addChild(m);\n            }\n            //保存到dom上，提升渲染性能\n            dom.moduleId = <number>mid;\n            //变成文本节点，作为子模块占位符，子模块渲染后替换占位符\n            delete dom.tagName;\n            //设置props，如果改变了props，启动渲染\n            const o = {};\n            if (dom.props) {\n                for (const p of Object.keys(dom.props)) {\n                    const v = dom.props[p];\n                    if (p[0] === '$') { //数据\n                        if (!o['$data']) {\n                            o['$data'] = {};\n                        }\n                        o['$data'][p.substring(1)] = v;\n                        //删除属性\n                        delete dom.props[p];\n                    } else {\n                        o[p] = v;\n                    }\n                }\n            }\n            //传递给模块\n            m.setProps(o, dom);\n            return true;\n        },\n        8\n    );\n\n    /**\n     *  model指令\n     */\n    Nodom.createDirective(\n        'model',\n        function (module: Module, dom: RenderedDom) {\n            const model: Model = module.get(dom.model,this.value);\n            if (model) {\n                dom.model = model;\n            }\n            return true;\n        },\n        1\n    );\n\n    /**\n     * 指令名 repeat\n     * 描述：重复指令\n     */\n    Nodom.createDirective(\n        'repeat',\n        function (module: Module, dom: RenderedDom) {\n            const rows = this.value;\n            // 无数据不渲染\n            if (!Util.isArray(rows) || rows.length === 0) {\n                return false;\n            }\n            const src = dom.vdom;\n            //索引名\n            const idxName = src.getProp('index');\n            const parent = dom.parent;\n            //禁用该指令\n            this.disabled = true;\n            //避免在渲染时对src设置了model，此处需要删除\n            for(let i = 0; i < rows.length; i++) {\n                if(!rows[i]){\n                    continue;\n                }\n                if (idxName && typeof rows[i] === 'object') {\n                    rows[i][<string>idxName] = i;\n                }\n                const d = Renderer.renderDom(module, src, rows[i], parent, rows[i].__key);\n                //删除index属性\n                if (idxName) {\n                    delete d.props['index'];\n                }\n            }\n            //启用该指令\n            this.disabled = false;\n            return false;\n        },\n        2\n    );\n\n    /**\n     * 递归指令\n     * 作用：在dom内部递归，用于具有相同数据结构的节点递归生成\n     * 递归指令不允许嵌套\n     * name表示递归名字，必须与内部的recur标签的ref保持一致，名字默认为default\n     * 典型模版\n     * ```\n     * <recur name='r1'>\n     *      <element1>...</element1>\n     *      <element2>...</element2>\n     *      <recur ref='r1' />\n     * </recur>\n     * ```\n     */\n    Nodom.createDirective(\n        'recur',\n        function (module: Module, dom: RenderedDom) {\n            const src = dom.vdom;\n            //当前节点是递归节点存放容器\n            if (dom.props.hasOwnProperty('ref')) {\n                //如果出现在repeat中，src为单例，需要在使用前清空子节点，避免沿用上次的子节点\n                src.children = [];\n                //递归存储名\n                const name = '$recurs.' + (dom.props['ref'] || 'default');\n                const node = module.objectManager.get(name);\n                if (!node) {\n                    return true;\n                }\n                const model = dom.model;\n                const cond = node.getDirective('recur');\n                const m = model[cond.value];\n                //不存在子层数组，不再递归\n                if (!m) {\n                    return true;\n                }\n                //克隆，后续可以继续用\n                const node1 = node.clone();\n                node1.removeDirective('recur');\n                dom.children ||= [];\n                if (!Array.isArray(m)) {  //非数组recur\n                    Renderer.renderDom(module,node1,m,dom,m.__key);\n                }else{  //数组内recur，依赖repeat得到model，repeat会取一次数组元素，所以需要dom model\n                    Renderer.renderDom(module,node1,model,dom,m['__key']);\n                }\n                //删除ref属性\n                delete dom.props['ref'];\n            } else { //递归节点\n                const data = dom.model[this.value];\n                if (!data) {\n                    return true;\n                }\n                //递归名，默认default\n                const name = '$recurs.' + (dom.props['name'] || 'default');\n                //删除name属性\n                delete dom.props['name'];\n                //保存递归定义的节点\n                if (!module.objectManager.get(name)) {\n                    module.objectManager.set(name, src);\n                }\n            }\n            return true;\n        },\n        2\n    );\n\n    /**\n     * 指令名 if\n     * 描述：条件指令\n     */\n    Nodom.createDirective('if',\n        function (module: Module, dom: RenderedDom) {\n            if(!dom.parent){\n                return;\n            }\n            module.objectManager.setDomParam(dom.parent.key, '$if', this.value);\n            return this.value;\n        },\n        5\n    );\n\n    /**\n     * 指令名 else\n     * 描述：else指令\n     */\n    Nodom.createDirective(\n        'else',\n        function (module: Module, dom: RenderedDom) {\n            if(!dom.parent){\n                return;\n            }\n            return  !module.objectManager.getDomParam(dom.parent.key, '$if');\n        },\n        5\n    );\n\n    /**\n     * elseif 指令\n     */\n    Nodom.createDirective('elseif',\n        function (module: Module, dom: RenderedDom) {\n            if(!dom.parent){\n                return;\n            }\n            const v = module.objectManager.getDomParam(dom.parent.key, '$if');\n            if (v === true) {\n                return false;\n            } else {\n                if (!this.value) {\n                    return false;\n                } else {\n                    module.objectManager.setDomParam(dom.parent.key, '$if', true);\n                }\n            }\n            return true;\n        },\n        5\n    );\n\n    /**\n     * elseif 指令\n     */\n    Nodom.createDirective(\n        'endif',\n        function (module: Module, dom: RenderedDom) {\n            if(!dom.parent){\n                return;\n            }\n            module.objectManager.removeDomParam(dom.parent.key, '$if');\n            //endif 不显示\n            return false;\n        },\n        5\n    );\n\n    /**\n     * 指令名 show\n     * 描述：显示指令\n     */\n    Nodom.createDirective(\n        'show',\n        function (module: Module, dom: RenderedDom) {\n            //show指令参数 {origin:通过style设置的初始display属性,rendered:是否渲染过}\n            let showParam = module.objectManager.getDomParam(dom.key, '$show');\n            //为false且未渲染过，则不渲染\n            if(!this.value && (!showParam || !showParam['rendered'])){\n                return false;\n            }\n            if(!showParam){\n                showParam = {};\n                module.objectManager.setDomParam(dom.key, '$show',showParam);\n            }\n            let style = dom.props['style'];\n            const reg =  /display\\s*\\:[\\w\\-]+/;\n            let regResult;\n            let display;\n            if(style){\n                regResult = reg.exec(style);\n                //保存第一个style display属性\n                if(regResult !== null){\n                    const ra = regResult[0].split(':');\n                    display = ra[1].trim();\n                    //保存第一个display属性\n                    if(!showParam['origin'] && display !== 'none'){\n                        showParam['origin'] = display;\n                    }\n                }\n            }\n\n            // 渲染标识，value为false且尚未进行渲染，则不渲染\n            if(!this.value){  \n                if(style){\n                    if(display){\n                        //把之前的display替换为none\n                        if(display!=='none'){\n                            style = style.substring(0,regResult.index) + 'display:none' + style.substring(regResult.index + regResult[0].length);\n                        }\n                    }else{\n                        style += ';display:none';\n                    }\n                }else{\n                    style = 'display:none';\n                }\n            }else{\n                //设置渲染标志\n                showParam['rendered'] = true;\n                if(display === 'none'){\n                    if(style){\n                        if(showParam['origin']){\n                            style = style.substring(0,regResult.index) + 'display:' + showParam['origin'] + style.substring(regResult.index + regResult[0].length);\n                        }else{\n                            style = style.substring(0,regResult.index) + style.substring(regResult.index + regResult[0].length);\n                        }\n                    }\n                }\n            }\n            if(style){\n                dom.props['style'] = style;\n            }\n            return true;\n        },\n        5\n    );\n    \n    /**\n     * 指令名 field\n     * 描述：字段指令\n     */\n    Nodom.createDirective('field',\n        function (module: Module, dom: RenderedDom) {\n            dom.assets ||= {};\n            //修正staticnum\n            if(dom.staticNum === 0){\n                dom.staticNum = 1;\n            }\n            const dataValue = module.get(dom.model,this.value);\n            if(dom.tagName === 'select'){\n                dom.props['value'] = dataValue;\n                //延迟设置value，避免option尚未渲染\n                setTimeout(()=>{\n                    const el = <HTMLSelectElement>module.domManager.getElement(dom.key);\n                    if(el){\n                        el.value = <string>dataValue;\n                    }\n                },0)\n            }else if(dom.tagName === 'input'){\n                switch(dom.props['type']){\n                    case 'radio':\n                        const value = dom.props['value'];\n                        dom.props['name'] = this.value;\n                        if (dataValue == value) {\n                            dom.props['checked'] = 'checked';\n                            dom.assets['checked'] = true;\n                        } else {\n                            delete dom.props['checked'];\n                            dom.assets['checked'] = false;\n                        }\n                        break;\n                    case 'checkbox':\n                        //设置状态和value\n                        const yv = dom.props['yes-value'];\n                        //当前值为yes-value\n                        if (dataValue == yv) {\n                            dom.props['value'] = yv;\n                            dom.assets['checked'] = true;\n                        } else { //当前值为no-value\n                            dom.props['value'] = dom.props['no-value'];\n                            dom.assets['checked'] = false;\n                        }\n                        break;\n                    default:\n                        const v = (dataValue !== undefined && dataValue !== null) ? dataValue : '';\n                        dom.props['value'] = v;\n                        dom.assets['value'] = v;\n                }\n            }else{\n                const v = (dataValue !== undefined && dataValue !== null) ? dataValue : '';\n                dom.props['value'] = v;\n                dom.assets['value'] = v;\n            }\n            //设置dom参数，避免二次添加事件\n            if (!module.objectManager.getDomParam(dom.key,'$addedFieldEvent')) {\n                module.objectManager.setDomParam(dom.key,'$addedFieldEvent',true);\n                const event = new NEvent(null, 'change',\n                    function (model, dom) {\n                        const el = this.getElement(dom.key);\n                        if (!el) {\n                            return;\n                        }\n                        const directive = dom.vdom.getDirective('field');\n                        const type = dom.props['type'];\n                        let field = directive.value;\n                        let v = el.value;\n                        //根据选中状态设置checkbox的value\n                        if (type === 'checkbox') {\n                            if (dom.props['yes-value'] == v) {\n                                v = dom.props['no-value'];\n                            } else {\n                                v = dom.props['yes-value'];\n                            }\n                        } else if (type === 'radio') {\n                            if (!el.checked) {\n                                v = undefined;\n                            }\n                        }\n                        //修改字段值,需要处理.运算符\n                        const arr = field.split('.')\n                        if (arr.length === 1) {\n                            model[field] = v;\n                        } else {\n                            let temp = model;\n                            field = arr.pop();\n                            for (let i = 0; i < arr.length && temp; i++) {\n                                temp = temp[arr[i]];\n                            }\n                            if (temp) {\n                                temp[field] = v;\n                            }\n                        }\n                    }\n                );\n                dom.vdom.addEvent(event,0);\n            }\n            return true;\n        },\n        10\n    );\n\n    /**\n     * route指令\n     */\n    Nodom.createDirective('route',\n        function (module: Module, dom: RenderedDom) {\n            if(!Nodom['$Router']){\n                throw new NError('uninit',NodomMessage.TipWords.route);\n            }\n            //a标签需要设置href\n            if (dom.tagName === 'a') {\n                dom.props['href'] = 'javascript:void(0)';\n            }\n            dom.props['path'] = this.value;\n            //有激活属性\n            if (dom.props['active']) {\n                const acName = dom.props['active'];\n                delete dom.props['active'];\n                //active 转expression\n                const router = Nodom['$Router'];\n                //添加激活model\n                router.addActiveModel(module.id,this.value, dom.model, acName);\n                //路由状态为激活，尝试激活路径\n                if (dom.model[acName]) {\n                    router.activePath(this.value);\n                }\n            }\n            //添加click事件,避免重复创建事件对象，创建后缓存\n            let event: NEvent = <NEvent>GlobalCache.get('$routeClickEvent');\n            if (!event) {\n                event = new NEvent(module, 'click',\n                    function (model, dom) {\n                        const path = dom.props['path'];\n                        if (Util.isEmpty(path)) {\n                            return;\n                        }\n                        Nodom['$Router'].go(path);\n                    }\n                );\n                GlobalCache.set('$routeClickEvent', event);\n            }\n            //为virtual dom添加事件\n            dom.vdom.addEvent(event);\n            return true;\n        },\n        10\n    );\n\n    /**\n     * 增加router指令\n     */\n    Nodom.createDirective('router',\n        function (module: Module, dom: RenderedDom) {\n            if(!Nodom['$Router']){\n                throw new NError('uninit',NodomMessage.TipWords.route)\n            }\n            //建立新子节点            \n            dom.children = [{key:dom.key+'_r',model:dom.model}];\n            Nodom['$Router'].registRouter(module.id, Renderer.getCurrentModule(),dom);\n            return true;\n        },\n        10\n    );\n\n    /**\n     * 插头指令\n     * 用于模块中，可实现同名替换\n     */\n    Nodom.createDirective('slot',\n        function (module: Module, dom: RenderedDom) {\n            this.value = this.value || 'default';\n            const mid = dom.parent.moduleId;\n            const src = dom.vdom;\n            const slotName = '$slots.' + this.value;\n            //父dom有module指令，表示为替代节点，替换子模块中的对应的slot节点；否则为子模块定义slot节点\n            if (mid) {\n                const m = ModuleFactory.get(mid);\n                if (m) {\n                    let cfg = m.objectManager.get(slotName);\n                    if(!cfg){\n                        cfg = {};\n                        m.objectManager.set(slotName,cfg);\n                    }\n                    cfg.dom = src;\n                    cfg.model = dom.model;\n                    cfg.module = module;\n                }\n            } else { //源slot节点\n                let cfg = module.objectManager.get(slotName);\n                //内部有slot，但是使用时并未设置slot\n                if(!cfg){\n                    cfg = {type:1};\n                }else if(!cfg.type){\n                    //1 innerrender(通过当前模块渲染），2outerrender(通过模板所属模块渲染)\n                    cfg.type = src.hasProp('innerrender')?1:2;\n                    //首次渲染，需要检测是否绑定父dom model\n                    for (const d of cfg.dom.children) {\n                        if(check(d)){\n                            //设定bind标志\n                            cfg.needBind = true;\n                            break;\n                        }\n                    }\n                    /**\n                     * 检测是否存在节点的statickNum=-1\n                     * @param d -   带检测节点\n                     * @returns     true/false\n                     */\n                    function check(d){\n                        if(d.staticNum === -1){\n                            return true;\n                        }\n                        //深度检测\n                        if(d.children){\n                            for(const d1 of d.children){\n                                if(check(d1)){\n                                    return true;\n                                }\n                            }\n                        }\n                    }\n                }\n                //渲染时添加s作为后缀，避免与模块内dom key冲突（相同model情况下）\n                if(cfg.dom && cfg.dom.children && cfg.dom.children.length>0){\n                    //渲染时添加s作为后缀，避免与模块内dom key冲突（相同model情况下）\n                    if (cfg.type === 1) { //inner render模式\n                        for (const d of cfg.dom.children) {\n                            Renderer.renderDom(module, d, dom.model, dom.parent, dom.model['__key']+'s');\n                        }\n                    }else { // 外部渲染模式\n                        //绑定数据\n                        if(cfg.needBind){\n                            cfg.module.modelManager.bindModel(cfg.model, module);\n                        }\n                        for (const d of cfg.dom.children) {\n                            Renderer.renderDom(cfg.module, d, cfg.model, dom.parent, cfg.model['__key']+'s');\n                        }\n                    }\n                }else{  //未在父模块配置slot，则直接渲染\n                    return true;\n                }\n            }\n            return false;\n        },\n        5\n    );\n}());"],"names":["DefineElementManager","static","clazz","Array","isArray","c","this","elements","set","name","toUpperCase","tagName","get","has","Map","DirectiveType","constructor","handler","prio","DirectiveManager","directiveTypes","delete","__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","NodomMessage_en","TipWords","application","system","module","moduleClass","model","directive","directiveType","expression","event","method","filter","filterType","data","dataItem","route","routeView","plugin","resource","root","element","ErrorMsgs","unknown","uninit","paramException","invoke","invoke1","invoke2","invoke3","exist","exist1","notexist","notexist1","notupd","notremove","notremove1","namedinvalid","initial","jsonparse","timeout","config","config1","itemnotempty","itemincorrect","needEndTag","needStartTag","tagError","wrongTemplate","wrongExpression","WeekDays","NodomMessage_zh","ModuleFactory","item","modules","size","mainModule","id","addClass","tp","mdl","toLowerCase","classes","aliasMap","Reflect","construct","init","clazzName","alias","modulePath","m","import","k","Object","keys","Expression","exprStr","Util","genId","trim","Nodom","isDebug","funStr","compile","execFunc","Function","reg","r","retS","index","exec","s","substring","lch","length","handleFunc","startsWith","isKeyWord","s1","lastIndex","str","ind1","replace","lastIndexOf","ind2","indexOf","fn1","val","v","call","console","error","NError","message","CssManager","dom","props","cls","cssPreName","parent","addRules","textContent","undefined","cssText","scopeName","sheet","document","createElement","head","appendChild","styleSheets","clearModuleRules","regImp","re","startIndex","beginNum","test","handleImport","txt","insertRule","cssRules","handleStyle","arr","objectManager","push","ind","css","importMap","importIndex","rules","i","selectorText","deleteRule","EModuleState","Renderer","rootEl","currentModule","state","READY","MOUNTED","waitList","includes","splice","render","shift","src","key","dst","vdom","staticNum","rmid","isSvg","currentRootDom","mdlDir","getDirective","handleProps","handleStyleDom","assets","p","handleDirectives","events","hasDirective","eventFactory","removeAllEvents","ev","handleExpr","addEvent","children","renderDom","expressions","expr","v1","directives","d","type","handleRootProps","pEl","el","getElement","renderToHtml","attrs","attributes","setAttribute","a","removeAttribute","unbindAll","bind","parentEl","isRenderChild","newEl","newText","moduleId","genSub","createTextNode","srcDom","srcElement","addChild","saveElement","active","createElementNS","handleStyleTextDom","node","forEach","el1","Element","changeDoms","slotDoms","repArr","addArr","moveArr","add","updateToHtml","domManager","freeNode","sort","b","opMap","n1","childNodes","insertBefore","emptyDom","replaceChild","parseInt","oldEl","parentElement","RequestManager","time","rejectReqTick","Date","now","requestMap","url","obj","compare","params","rand","$rand","Math","random","async","req","XMLHttpRequest","withCredentials","onload","status","responseText","JSON","parse","ontimeout","onerror","pa","isObject","ar","join","FormData","fd","append","open","user","pwd","header","getOwnProps","setRequestHeader","send","catch","NodomMessage","kv","Route","isEmpty","path","o","routes","child","pathArr","split","param","paramIndex","prePath","j","clone","getOwnPropertyNames","Scheduler","tasks","isFunction","scheduleTick","dispatch","window","requestAnimationFrame","start","setTimeout","foo","thiser","func","selector","setRootEl","querySelector","body","addTask","clearCache","lang","getRoot","priority","addType","request","setRejectTime","Error","errorName","super","msg","compileStr","generatedId","keyWordMap","srcObj","expKey","extra","map","WeakMap","prop","RegExp","getCloneObj","isMap","co","cmp","o1","o2","keys1","keys2","timeStamp","format","Number","date","isNaN","getDay","getMonth","getDate","getHours","getMinutes","getSeconds","S","getMilliseconds","getFullYear","initKeyMap","Directive","templateMid","getType","templateModuleId","disabled","NEvent","eventName","eventStr","parseEvent","touchOrNot","evtStr","delg","nopopo","once","capture","ontouchend","setParam","setEventParam","getParam","getEventParam","removeParam","removeEventParam","clearParam","clearEventParams","VirtualDom","tag","getDomKeyId","removeDirectives","removeDirective","findIndex","addDirective","find","sortDirective","typeName","remove","hasProp","propName","getProp","setProp","delProp","setAsset","assetName","setStaticOnce","delAsset","setDomParam","getDomParam","removeDomParam","voidTagMap","Set","Compiler","elementStr","template","compileTemplate","domArr","forceClose","genKey","srcStr","compileEndTag","compileStartTag","compileText","match","textArr","current","trimStart","compileAttributes","isVoidTab","handleCloseTag","matchExp","isExprText","preHandleText","text","div","innerHTML","postHandleNode","hasClass","handleSlot","slotCt","isSelfClose","pop","DiffTool","changeArr","addChange","isChanged","addObj","newStartIdx","newEndIdx","oldStartIdx","oldEndIdx","newStartNode","newEndNode","oldStartNode","oldEndNode","ch","hasOwnProperty","ii","compareChildren","dom1","loc","loc1","DefineElement","EventFactory","eventMap","addedEvents","addToArr","key1","cfg","bindMap","own","getEvent","removeEvent","addEventListener","me","unbind","eobj","removeEventListener","hasEvent","clear","currentTarget","getRenderedDom","evts","doOwn","invokeMethod","stopPropagation","doDelg","elArr","composedPath","evo","NCache","cacheData","subscribeMap","invokeSubscribe","subscribe","GlobalCache","cache","Model","proxy","Proxy","receiver","value1","preHandle","ov","modelManager","update","getModelKey","deleteProperty","oldValue","force","oldMdl","bindModel","setModelName","ModelManager","getModel","dataMap","nameMap","getModelName","__key","__module","mids","newValue","handleWatcher","watchMap","watcher","f","hasDeepWatch","__parent","pm","__name","deep","watch","operate","watchOne","ObjectManager","clearDomParams","clearAllDomParams","DomManager","getVirtualDom","vdomTree","d1","renderedTree","clearElementMap","elementMap","unmount","removeChild","reset","Module","INIT","doModuleEvent","firstRender","oldTemplate","templateStr","oldTree","handleChangedDoms","mount","parentId","UNMOUNTED","DocumentFragment","getMain","getRootEl","getParent","getMethod","setProps","dataObj","change","domKeyId","setExcludeProps","excludedProps","added","getModule","getClass","matched","getModules","className","methodName","args","invokeOuterMethod","Router","basePath","defaultEnter","defaultLeave","onDefaultEnter","onDefaultLeave","history","startType","go","currentPath","load","diff","parentModule","onLeave","dependHandle","onEnter","path1","replaceState","pushState","path2","arr1","arr2","getRouteList","len","retArr1","retArr2","stringify","slice","p1","p2","addActiveModel","field","activeModelMap","routerMap","paths","mobj","setDomActive","fullPath","wait","mid","retArr","preNode","registRouter","activePath","MODULE","FOR","cond","RECUR","IF","ELSE","ELSEIF","ENDIF","SHOW","SLOT","ROUTE","ROUTER","createDirective","getCurrentModule","rows","idxName","node1","showParam","regResult","display","style","dataValue","yv","checked","temp","acName","router","slotName","check","needBind"],"mappings":"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"}